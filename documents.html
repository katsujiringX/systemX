<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>資料管理 | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        :root {
            --primary: #4338ca;
            --primary-hover: #3730a3;
            --primary-light: #e0e7ff;
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --secondary-light: #e0f2fe;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --accent-light: #fff7ed;
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;
            --info: #3b82f6;
            --info-hover: #2563eb;
            --info-light: #eff6ff;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --bg-color: var(--gray-50);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            
            --header-height: 4rem;
            --sidebar-width: 280px;
            --transition-normal: 0.3s ease;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.25rem;
            --radius: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #2d2a63;
            
            --bg-color: #0f172a;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #1f2937;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* サイドバー */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            color: white;
            z-index: 50;
            transition: transform var(--transition-normal), width var(--transition-normal);
            box-shadow: var(--shadow);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo img {
            width: 2rem;
            height: 2rem;
        }
        
        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        .menu-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.75rem 1.5rem 0.5rem;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: background-color var(--transition-normal);
            position: relative;
            margin: 0.125rem 0.75rem;
            border-radius: var(--radius);
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.25rem;
            height: 1.5rem;
            background-color: white;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        
        .menu-item i {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: var(--primary);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            z-index: 100;
            box-shadow: var(--shadow-md);
            border: none;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-hover);
        }
        
        /* ユーザープロフィール表示 */
        .user-profile {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 600;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
            overflow: hidden;
        }
        
        .user-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-status {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.5rem 0;
            width: 100%;
            transition: color var(--transition-normal);
        }
        
        .theme-toggle:hover {
            color: white;
        }
        
        .theme-toggle i {
            margin-right: 0.5rem;
        }
        
        /* メインコンテンツ */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            transition: margin var(--transition-normal);
        }
        
        .page-header {
            margin-bottom: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* Breadcrumb navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.8125rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
            transition: color var(--transition-normal);
            display: flex;
            align-items: center;
        }
        
        .breadcrumb a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }
        
        .breadcrumb i {
            font-size: 0.625rem;
            margin: 0 0.25rem;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        .breadcrumb-item.active {
            color: var(--text-color);
            font-weight: 500;
        }
        
        /* ファイル管理スタイル */
        .file-manager-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 12rem);
            overflow: hidden;
        }
        
        .file-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .file-manager-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-tab {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color var(--transition-normal);
        }
        
        .file-tab:hover {
            color: var(--text-color);
        }
        
        .file-tab.active {
            color: var(--primary);
        }
        
        .file-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }
        
        .file-manager-header .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-search {
            position: relative;
            width: 240px;
        }
        
        .file-search input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
        }
        
        .file-search i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .file-manager-body {
            display: flex;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
        }
        
        .file-sidebar {
            width: 220px;
            border-right: 1px solid var(--border-color);
            padding-right: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }
        
        .sidebar-list {
            list-style: none;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            color: var(--text-color);
            text-decoration: none;
            border-radius: var(--radius);
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .sidebar-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
        }
        
        [data-theme="dark"] .sidebar-item.active {
            background-color: rgba(99, 102, 241, 0.2);
        }
        
        .sidebar-item i {
            margin-right: 0.75rem;
        }
        
        .storage-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--radius);
        }
        
        [data-theme="dark"] .storage-info {
            background-color: #1e293b;
        }
        
        .storage-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--gray-200);
            border-radius: var(--radius-full);
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        [data-theme="dark"] .storage-bar {
            background-color: #2d3748;
        }
        
        .storage-progress {
            height: 100%;
            background-color: var(--primary);
            border-radius: var(--radius-full);
        }
        
        .storage-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .file-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.5rem;
    padding: 0.5rem;
}
        
        .file-list {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .file-list-header {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr auto;
            padding: 0.5rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
        }
        
        .file-list-item {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr auto;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            transition: background-color var(--transition-normal);
        }
        
        .file-list-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        [data-theme="dark"] .file-list-item:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
       /* モダンなファイルカードデザイン */
.file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.5rem;
    padding: 0.5rem;
}

.file-card {
    position: relative;
    display: flex;
    flex-direction: column;
    border-radius: 12px;
    background-color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    overflow: hidden;
    height: 100%;
    max-width: 100%;
    margin: 0;
    border: none;
}

[data-theme="dark"] .file-card {
    background-color: var(--gray-800);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.file-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border: none;
}

.file-card.selected {
    box-shadow: 0 0 0 2px var(--primary), 0 8px 20px rgba(0, 0, 0, 0.1);
    background-color: var(--primary-light);
}

[data-theme="dark"] .file-card.selected {
    background-color: rgba(99, 102, 241, 0.15);
    box-shadow: 0 0 0 2px var(--primary), 0 8px 20px rgba(0, 0, 0, 0.2);
}

/* ファイルイメージコンテナ */
.file-card-media {
    position: relative;
    width: 100%;
    height: 130px;
    overflow: hidden;
    border-radius: 8px 8px 0 0;
    background-color: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
}

[data-theme="dark"] .file-card-media {
    background-color: var(--gray-700);
}

/* イメージファイルの場合 */
.file-image {
    width: 100%;
    height: 130px;
    object-fit: cover;
    margin-bottom: 0;
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
}

.file-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

/* アイコン表示 */
.file-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 1.25rem;
    margin: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.folder-icon {
    background: linear-gradient(135deg, var(--warning-light) 0%, #ffedc9 100%);
    color: var(--warning);
}

.pdf-icon {
    background: linear-gradient(135deg, var(--danger-light) 0%, #ffe5e5 100%);
    color: var(--danger);
}

.doc-icon {
    background: linear-gradient(135deg, var(--info-light) 0%, #e0f2ff 100%);
    color: var(--info);
}

.image-icon {
    background: linear-gradient(135deg, var(--success-light) 0%, #d1fae5 100%);
    color: var(--success);
}

/* カードコンテンツ部分 */
.file-card-content {
    display: flex;
    flex-direction: column;
    padding: 0.75rem;
    flex: 1;
}

.file-card-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-800);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    margin-bottom: 0.25rem;
    min-height: auto;
    max-height: 2.8em;
}

[data-theme="dark"] .file-card-name {
    color: var(--gray-100);
}

.file-card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: auto;
    padding-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.file-card-date {
    margin: 0;
}

.file-type-badge {
    padding: 0.125rem 0.375rem;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.file-type-image {
    background-color: var(--success-light);
    color: var(--success);
}

.file-type-pdf {
    background-color: var(--danger-light);
    color: var(--danger);
}

.file-type-document {
    background-color: var(--info-light);
    color: var(--info);
}

.file-type-folder {
    background-color: var(--warning-light);
    color: var(--warning);
}

/* アクションボタン */
.file-card-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: none;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    padding: 0.25rem;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

[data-theme="dark"] .file-card-actions {
    background-color: rgba(30, 41, 59, 0.8);
}

.file-card:hover .file-card-actions {
    display: flex;
}

.file-card-action {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    margin-left: 0.125rem;
    cursor: pointer;
    color: var(--gray-700);
    transition: all 0.2s ease;
}

.file-card-action:hover {
    background-color: var(--primary);
    color: white;
}

[data-theme="dark"] .file-card-action {
    color: var(--gray-300);
}

/* チェックボックス */
.file-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 20px;
    height: 20px;
    border-radius: 20px;
    border: 2px solid white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    z-index: 5;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s ease;
}

.file-card:hover .file-checkbox {
    opacity: 1;
    transform: scale(1);
}

.file-checkbox.checked {
    opacity: 1;
    transform: scale(1);
    background-color: var(--primary);
    border-color: var(--primary);
    color: white;
}

/* 共有インジケーター */
.share-indicator {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 0.125rem 0.375rem;
    display: flex;
    align-items: center;
    font-size: 0.7rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
    z-index: 4;
}

[data-theme="dark"] .share-indicator {
    background-color: rgba(30, 41, 59, 0.8);
}

.file-card:hover .share-indicator {
    display: none;
}

.share-indicator-icon {
    margin-right: 0.25rem;
    font-size: 0.75rem;
}

/* 所有者表示 */
.file-owner {
    display: flex;
    align-items: center;
    margin-top: 0.25rem;
    font-size: 0.7rem;
    color: var(--text-muted);
}

.file-owner i {
    font-size: 0.7rem;
    margin-right: 0.25rem;
}

        
        
        /* 選択操作バー */
        .selection-bar {
            display: none;
            align-items: center;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 0.5rem 1rem;
            margin-bottom: 0.75rem;
        }
        
        [data-theme="dark"] .selection-bar {
            background-color: var(--gray-800);
        }
        
        .selection-bar.show {
            display: flex;
        }
        
        .selection-count {
            margin-right: 1rem;
            font-weight: 500;
        }
        
        .selection-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-menu {
            position: absolute;
            top: 0;
            right: 0;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            z-index: 10;
            min-width: 150px;
            display: none;
        }
        
        [data-theme="dark"] .action-menu {
            background-color: var(--gray-700);
        }
        
        .action-menu.show {
            display: block;
        }
        
        .action-menu-item {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .action-menu-item:hover {
            background-color: var(--gray-100);
        }
        
        [data-theme="dark"] .action-menu-item:hover {
            background-color: var(--gray-600);
        }
        
        .action-menu-item i {
            margin-right: 0.75rem;
            width: 1rem;
            text-align: center;
        }
        
        /* モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal);
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }
        
        [data-theme="dark"] .modal {
            background-color: var(--gray-800);
        }
        
        .modal-overlay.show .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.25rem;
            transition: color var(--transition-normal);
        }
        
        .modal-close:hover {
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* 画像プレビューモーダル */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .image-preview-modal.show {
            display: flex;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius);
        }

        .image-preview-actions {
            position: absolute;
            top: -40px;
            right: 0;
            display: flex;
            gap: 0.5rem;
        }
        
        .image-preview-action {
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .image-preview-action:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* フォーム */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color var(--transition-normal);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-control:disabled {
            background-color: var(--gray-100);
            cursor: not-allowed;
        }
        
        [data-theme="dark"] .form-control:disabled {
            background-color: var(--gray-700);
        }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color var(--transition-normal);
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5rem;
        }
        
        /* 共有ユーザーUIの改善 */
        .shared-users-container {
            margin-top: 1rem;
        }
        
        .shared-user-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-top: 0.5rem;
        }
        
        .shared-user-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-normal);
        }
        
        .shared-user-item:last-child {
            border-bottom: none;
        }
        
        .shared-user-item:hover {
            background-color: var(--gray-100);
        }
        
        [data-theme="dark"] .shared-user-item:hover {
            background-color: var(--gray-700);
        }
        
        .shared-user-item.selected {
            background-color: var(--primary-light);
        }
        
        [data-theme="dark"] .shared-user-item.selected {
            background-color: rgba(99, 102, 241, 0.2);
        }
        
        .shared-user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 500;
            overflow: hidden;
        }
        
        .shared-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .shared-user-info {
            flex: 1;
        }
        
        .shared-user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .shared-user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .shared-user-role {
            margin-left: auto;
            padding-left: 1rem;
            display: flex;
            align-items: center;
        }
        
        .shared-user-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background-color: white;
        }
        
        [data-theme="dark"] .shared-user-checkbox {
            background-color: var(--gray-800);
        }
        
        .shared-user-checkbox.checked {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .shared-user-search {
            position: relative;
            margin-bottom: 0.5rem;
        }
        
        .shared-user-search input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
        }
        
        .shared-user-search i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .user-select-container {
            position: relative;
        }
        
        .selected-users-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .selected-user-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
        }
        
        [data-theme="dark"] .selected-user-tag {
            background-color: rgba(99, 102, 241, 0.2);
        }
        
        .selected-user-tag i {
            margin-left: 0.25rem;
            cursor: pointer;
        }
        
        .user-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        
        [data-theme="dark"] .user-select-dropdown {
            background-color: var(--gray-800);
        }
        
        .user-select-dropdown.show {
            display: block;
        }
        
        .add-user-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px dashed var(--border-color);
            border-radius: var(--radius);
            color: var(--primary);
            background: none;
            cursor: pointer;
            width: 100%;
            transition: background-color var(--transition-normal);
        }
        
        .add-user-btn:hover {
            background-color: var(--primary-light);
        }
        
        .add-user-btn i {
            margin-right: 0.5rem;
        }
        
        /* ドラッグ＆ドロップ関連 */
        .dropzone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 2rem 1rem;
            text-align: center;
            transition: border-color var(--transition-normal);
            cursor: pointer;
        }
        
        .dropzone:hover {
            border-color: var(--primary);
        }
        
        .dropzone i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .dropzone-text {
            margin-bottom: 0.5rem;
        }
        
        .dropzone-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .dropping {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        
        /* トースト通知 */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            background-color: white;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            animation: slideIn 0.3s forwards, slideOut 0.3s forwards 3s;
        }
        
        [data-theme="dark"] .toast {
            background-color: var(--gray-800);
        }
        
        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(120%);
            }
        }
        
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-error .toast-icon {
            color: var(--danger);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        
        .toast-info .toast-icon {
            color: var(--info);
        }
        
        /* ボタンスタイル */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            border: none;
            line-height: 1.5;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--success-hover);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            border-radius: 50%;
        }
        
        .btn-icon i {
            margin-right: 0;
        }
        
        /* バッジ */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        /* ユーティリティクラス */
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        
        .bg-primary { background-color: var(--primary); color: white; }
        .bg-secondary { background-color: var(--secondary); color: white; }
        .bg-success { background-color: var(--success); color: white; }
        .bg-warning { background-color: var(--warning); color: white; }
        .bg-danger { background-color: var(--danger); color: white; }
        .bg-info { background-color: var(--info); color: white; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mt-5 { margin-top: 3rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-5 { margin-bottom: 3rem; }
        
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-3 { margin-left: 1rem; }
        .ml-4 { margin-left: 1.5rem; }
        .ml-5 { margin-left: 3rem; }
        
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 1rem; }
        .mr-4 { margin-right: 1.5rem; }
        .mr-5 { margin-right: 3rem; }
        
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 1rem; }
        .p-4 { padding: 1.5rem; }
        .p-5 { padding: 3rem; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        .d-flex { display: flex; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .flex-1 { flex: 1; }
        
        /* 戻るボタン */
        .back-button {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: var(--gray-100);
            border-radius: var(--radius);
            color: var(--text-color);
            text-decoration: none;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .back-button:hover {
            background-color: var(--gray-200);
        }
        
        [data-theme="dark"] .back-button {
            background-color: var(--gray-700);
        }
        
        [data-theme="dark"] .back-button:hover {
            background-color: var(--gray-600);
        }
        
        .back-button i {
            margin-right: 0.5rem;
        }
        
        /* 共有インジケーター */
        .share-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
            font-size: 0.75rem;
        }
        
        .share-indicator-icon {
            margin-right: 0.25rem;
        }
        
        .share-indicator-text {
            font-size: 0.7rem;
            font-weight: normal;
        }
        
        .file-permissions-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: var(--info-light);
            border-radius: var(--radius);
            color: var(--info);
            font-size: 0.875rem;
        }
        
        /* レスポンシブデザイン */
        @media (max-width: 1024px) {
            .file-manager-body {
                flex-direction: column;
            }
            
            .file-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 1rem;
                overflow-y: visible;
            }
            
            .sidebar-section {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .file-manager-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .file-search {
                width: 100%;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .file-list-header, .file-list-item {
                grid-template-columns: 40px 2fr 1fr auto;
            }
            
            .file-list-header .date-col, .file-list-item .date-col,
            .file-list-header .size-col, .file-list-item .size-col {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .file-tab {
                padding: 0.75rem 1rem;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* ローディングアニメーション */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        [data-theme="dark"] .loading-spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- サイドバー -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="mainpage.html" class="logo">
                <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
                <span>KatsujiRingX</span>
            </a>
        </div>
        
        <div class="sidebar-menu">
            <p class="menu-label">メインメニュー</p>
            <a href="mainpage.html" class="menu-item">
                <i class="fas fa-home"></i> ダッシュボード
            </a>
            <a href="documents.html" class="menu-item active">
                <i class="fas fa-file-alt"></i> 資料管理
            </a>
            <a href="search.html" class="menu-item">
                <i class="fas fa-book"></i> 資料検索システム
            </a>
            
            <p class="menu-label">学習・コミュニティ</p>
            <a href="learning.html" class="menu-item">
                <i class="fas fa-gamepad"></i> 学習ゲーム
            </a>
            <a href="community.html" class="menu-item">
                <i class="fas fa-users"></i> コミュニティ広場
            </a>
            <a href="blog.html" class="menu-item">
                <i class="fas fa-pen"></i> ブログ
            </a>
            
            <p class="menu-label">ユーザー</p>
            <a href="profile.html" class="menu-item">
                <i class="fas fa-user"></i> プロフィール
            </a>

            <p class="menu-label">サポート</p>
            <a href="helpcenter.html" class="menu-item">
                <i class="fas fa-question-circle"></i>ヘルプデスク
            </a>
            <a href="feedback.html" class="menu-item">
                <i class="fas fa-comment-dots"></i>フィードバック
            </a>

            <p class="menu-label">管理者</p>
            <a href="admin.html" class="menu-item">
                <i class="fas fa-user-cog"></i>管理ページ
            </a>
        </div>
        
        <div class="sidebar-footer">
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i> ダークモード
            </button>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">
                    <span id="user-initial">U</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-user-name">ユーザー名</div>
                    <div class="user-status">オンライン</div>
                </div>
            </div>
            
            <a href="#" id="logout-btn" class="btn btn-outline w-100 mt-3" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </a>
        </div>
    </aside>
    
    <!-- モバイル用サイドバー切替ボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="page-header">
            <div id="breadcrumb-container" class="breadcrumb">
                <a href="mainpage.html">ダッシュボード</a>
                <i class="fas fa-chevron-right"></i>
                <span class="breadcrumb-item active">資料管理</span>
            </div>
            <h1 class="page-title">資料管理</h1>
        </div>
        
        <!-- ファイル管理エリア -->
        <div class="file-manager-container">
            <div class="file-manager-header">
                <div class="d-flex align-center">
                    <button id="upload-btn" class="btn btn-primary">
                        <i class="fas fa-upload"></i> アップロード
                    </button>
                    <button id="new-folder-btn" class="btn btn-outline ml-2">
                        <i class="fas fa-folder-plus"></i> 新規フォルダ
                    </button>
                </div>
                
                <div class="file-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="file-search-input" placeholder="ファイルを検索...">
                </div>
            </div>
            
            <!-- 選択操作バー (選択時のみ表示) -->
            <div class="selection-bar" id="selection-bar">
                <div class="selection-count" id="selection-count">0 項目を選択中</div>
                <div class="selection-actions">
                    <button id="deselect-all-btn" class="btn btn-sm btn-outline">
                        <i class="fas fa-times"></i> 選択解除
                    </button>
                    <button id="share-selected-btn" class="btn btn-sm btn-outline">
                        <i class="fas fa-share-alt"></i> 共有
                    </button>
                    <button id="delete-selected-btn" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i> 削除
                    </button>
                </div>
            </div>
            
            <div class="file-manager-tabs">
                <div class="file-tab active" data-view="personal">個人用</div>
                <div class="file-tab" data-view="shared">指定共有</div>
                <div class="file-tab" data-view="public">全体共有</div>
                <div class="file-tab" data-view="trashed">ゴミ箱</div>
            </div>
            
           
                
                <div class="file-content">
                    <!-- 戻るボタン (ファイルを表示中に表示される) -->
                    <div id="back-navigation" class="back-button" style="display: none;">
                        <i class="fas fa-arrow-left"></i> 一覧に戻る
                    </div>
                    
                    <div id="file-view-container" class="d-flex flex-column" style="display: none;">
                        <!-- ファイルプレビューエリア -->
                        <div id="file-preview" class="mb-3"></div>
                        <div id="file-info" class="mb-3"></div>
                        <div id="file-permissions-info" class="file-permissions-info" style="display: none;">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span id="file-permissions-text">このファイルは共有されています。</span>
                        </div>
                        <div id="file-actions" class="d-flex gap-2 mt-3"></div>
                    </div>
                
                    <div id="file-list-container">
                        <div class="d-flex justify-between mb-3">
                            <div class="d-flex align-center">
                                <div class="file-checkbox" id="select-all-checkbox" title="全て選択">
                                    <i class="fas fa-check" style="display: none;"></i>
                                </div>
                                <button id="view-grid-btn" class="btn btn-sm btn-outline active ml-2">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button id="view-list-btn" class="btn btn-sm btn-outline ml-1">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                            
                            <div class="d-flex align-center">
                                <select id="sort-select" class="form-select" style="width: auto; padding-right: 2rem;">
                                    <option value="name-asc">名前（昇順）</option>
                                    <option value="name-desc">名前（降順）</option>
                                    <option value="date-desc" selected>日付（新しい順）</option>
                                    <option value="date-asc">日付（古い順）</option>
                                    <option value="size-desc">サイズ（大きい順）</option>
                                    <option value="size-asc">サイズ（小さい順）</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ファイル一覧（グリッドビュー） -->
                        <div id="file-grid" class="file-grid">
                            <!-- ファイルはここに動的に追加されます -->
                        </div>
                        
                        <!-- ファイル一覧（リストビュー） -->
                        <div id="file-list" class="file-list" style="display: none;">
                            <div class="file-list-header">
                                <div>
                                    <div class="file-checkbox" id="list-select-all-checkbox" title="全て選択">
                                        <i class="fas fa-check" style="display: none;"></i>
                                    </div>
                                </div>
                                <div>名前</div>
                                <div class="owner-col">所有者</div>
                                <div class="date-col">更新日</div>
                                <div class="size-col">サイズ</div>
                                <div></div>
                            </div>
                            <!-- ファイルはここに動的に追加されます -->
                        </div>
                    </div>
                    
                    <!-- 空の状態表示 -->
                    <div id="empty-state" class="d-flex flex-column align-center justify-center" style="height: 300px; display: none;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                        <h3>フォルダが空です</h3>
                        <p class="text-muted mt-2">ファイルやフォルダをアップロードして始めましょう</p>
                        <button id="empty-upload-btn" class="btn btn-primary mt-3">
                            <i class="fas fa-upload"></i> アップロード
                        </button>
                    </div>
                    
                    <!-- ローディング表示 -->
                    <div id="loading-state" class="d-flex flex-column align-center justify-center" style="height: 300px;">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-3">ファイルを読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右クリックメニュー -->
        <div id="context-menu" class="action-menu">
            <div class="action-menu-item" data-action="open">
                <i class="fas fa-folder-open"></i> 開く
            </div>
            <div class="action-menu-item" data-action="download">
                <i class="fas fa-download"></i> ダウンロード
            </div>
            <div class="action-menu-item" data-action="rename">
                <i class="fas fa-edit"></i> 名前変更
            </div>
            <div class="action-menu-item" data-action="share">
                <i class="fas fa-share-alt"></i> 共有
            </div>
            <div class="action-menu-item" data-action="move">
                <i class="fas fa-folder-minus"></i> 移動
            </div>
            <div class="action-menu-item" data-action="delete">
                <i class="fas fa-trash"></i> 削除
            </div>
        </div>
        
        <!-- アップロードモーダル -->
        <div id="upload-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ファイルアップロード</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="dropzone" id="upload-dropzone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p class="dropzone-text">ファイルをドラッグ＆ドロップするか、クリックして選択</p>
                        <p class="dropzone-hint">最大ファイルサイズ: 100MB</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>
                    
                    <div class="form-group mt-3">
                        <label class="form-label">アップロード先フォルダ</label>
                        <select id="upload-folder" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="upload-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                    </div>
                    
                    <div id="share-users-container" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <div class="shared-user-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="shared-user-search" placeholder="ユーザーを検索...">
                        </div>
                        
                        <div class="selected-users-display" id="upload-selected-users">
                            <!-- 選択されたユーザータグがここに表示されます -->
                        </div>
                        
                        <div class="shared-user-list" id="shared-user-list">
                            <!-- ユーザーリストが表示されます -->
                        </div>
                    </div>
                    
                    <div id="upload-progress-container" style="display: none;">
                        <div class="mt-3 mb-2 d-flex justify-between">
                            <span id="upload-progress-text">アップロード中 (0%)</span>
                            <span id="upload-progress-size">0 KB / 0 KB</span>
                        </div>
                        <div class="storage-bar">
                            <div id="upload-progress-bar" class="storage-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="upload-submit" class="btn btn-primary">アップロード</button>
                </div>
            </div>
        </div>
        
        <!-- 新規フォルダモーダル -->
        <div id="folder-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">新規フォルダ作成</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">フォルダ名</label>
                        <input type="text" id="folder-name" class="form-control" placeholder="フォルダ名を入力">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">親フォルダ</label>
                        <select id="parent-folder" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="folder-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                    </div>
                    
                    <div id="folder-share-users" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <div class="shared-user-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="folder-shared-user-search" placeholder="ユーザーを検索...">
                        </div>
                        
                        <div class="selected-users-display" id="folder-selected-users">
                            <!-- 選択されたユーザータグがここに表示されます -->
                        </div>
                        
                        <div class="shared-user-list" id="folder-shared-user-list">
                            <!-- ユーザーリストが表示されます -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="folder-submit" class="btn btn-primary">作成</button>
                </div>
            </div>
        </div>
        
        <!-- 名前変更モーダル -->
        <div id="rename-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">名前変更</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">新しい名前</label>
                        <input type="text" id="new-name" class="form-control" placeholder="新しい名前を入力">
                        <input type="hidden" id="rename-file-id">
                        <input type="hidden" id="rename-file-type">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="rename-submit" class="btn btn-primary">変更</button>
                </div>
            </div>
        </div>
        
        <!-- 共有設定モーダル -->
        <div id="share-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">共有設定</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="share-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                        <input type="hidden" id="share-file-id">
                        <input type="hidden" id="share-file-type">
                    </div>
                    
                    <div id="share-settings-users" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <div class="shared-user-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="share-settings-user-search" placeholder="ユーザーを検索...">
                        </div>
                        
                        <div class="selected-users-display" id="share-selected-users">
                            <!-- 選択されたユーザータグがここに表示されます -->
                        </div>
                        
                        <div class="shared-user-list" id="share-settings-user-list">
                            <!-- ユーザーリストが表示されます -->
                        </div>
                    </div>
                    
                    <div id="share-link-container" class="form-group" style="display: none;">
                        <label class="form-label">共有リンク</label>
                        <div class="d-flex">
                            <input type="text" id="share-link" class="form-control" readonly>
                            <button id="copy-link-btn" class="btn btn-outline ml-2">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group mt-3" id="share-permissions-info">
                        <div class="file-permissions-info">
                            <strong>共有設定について:</strong>
                            <ul class="mt-2" style="padding-left: 1.5rem;">
                                <li>指定共有: 選択したユーザーとファイルを共有します。共有されたユーザーは閲覧、編集、移動などの操作が可能です。</li>
                                <li>全体共有: すべてのユーザーがこのファイルを閲覧、編集できます。</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="share-submit" class="btn btn-primary">適用</button>
                </div>
            </div>
        </div>
        
        <!-- 一括共有設定モーダル -->
        <div id="batch-share-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">複数項目の共有設定</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="batch-share-info" class="mb-3">選択された項目を一括で共有設定します。</p>
                    
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="batch-share-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                    </div>
                    
                    <div id="batch-share-users" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <div class="shared-user-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="batch-shared-user-search" placeholder="ユーザーを検索...">
                        </div>
                        
                        <div class="selected-users-display" id="batch-selected-users">
                            <!-- 選択されたユーザータグがここに表示されます -->
                        </div>
                        
                        <div class="shared-user-list" id="batch-shared-user-list">
                            <!-- ユーザーリストが表示されます -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="batch-share-submit" class="btn btn-primary">適用</button>
                </div>
            </div>
        </div>
        
        <!-- 移動モーダル -->
        <div id="move-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ファイル移動</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">移動先フォルダ</label>
                        <select id="move-destination" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                        <input type="hidden" id="move-file-id">
                        <input type="hidden" id="move-file-type">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="move-submit" class="btn btn-primary">移動</button>
                </div>
            </div>
        </div>
        
        <!-- 一括移動モーダル -->
        <div id="batch-move-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">複数項目の移動</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="batch-move-info" class="mb-3">選択された項目を一括で移動します。</p>
                    
                    <div class="form-group">
                        <label class="form-label">移動先フォルダ</label>
                        <select id="batch-move-destination" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="batch-move-submit" class="btn btn-primary">移動</button>
                </div>
            </div>
        </div>
        
        <!-- 削除確認モーダル -->
        <div id="delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="delete-message">このファイルをゴミ箱に移動しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--text-muted);">ゴミ箱から復元することができます。</p>
                    <input type="hidden" id="delete-file-id">
                    <input type="hidden" id="delete-file-type">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="delete-submit" class="btn btn-danger">削除</button>
                </div>
            </div>
        </div>
        
        <!-- 一括削除確認モーダル -->
        <div id="batch-delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">一括削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body"><p id="batch-delete-message">選択した項目をゴミ箱に移動しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--text-muted);">ゴミ箱から復元することができます。</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="batch-delete-submit" class="btn btn-danger">削除</button>
                </div>
            </div>
        </div>
        
        <!-- 完全削除確認モーダル (ゴミ箱から) -->
        <div id="permanent-delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">完全削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="permanent-delete-message">このファイルを完全に削除しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--danger);">この操作は取り消せません。</p>
                    <input type="hidden" id="permanent-delete-file-id">
                    <input type="hidden" id="permanent-delete-file-type">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="permanent-delete-submit" class="btn btn-danger">完全に削除</button>
                </div>
            </div>
        </div>
        
        <!-- 一括完全削除確認モーダル -->
        <div id="batch-permanent-delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">一括完全削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="batch-permanent-delete-message">選択した項目を完全に削除しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--danger);">この操作は取り消せません。</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="batch-permanent-delete-submit" class="btn btn-danger">完全に削除</button>
                </div>
            </div>
        </div>
        
        <!-- 画像プレビューモーダル -->
        <div id="image-preview-modal" class="image-preview-modal">
            <div class="image-preview-content">
                <div class="image-preview-actions">
                    <button class="image-preview-action" id="open-editor-btn" title="活字化エディタで開く">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="image-preview-action" id="download-preview-btn" title="ダウンロード">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="image-preview-action close-preview" title="閉じる">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <img id="preview-image" src="" alt="">
            </div>
        </div>
        
        <!-- トースト通知コンテナ -->
        <div class="toast-container" id="toast-container">
            <!-- トースト通知はここに動的に追加されます -->
        </div>
    </div>

    <!-- JavaScript -->
    <script>
     // Firebase設定
const firebaseConfig = {
    apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
    authDomain: "katsujiringx.firebaseapp.com",
    projectId: "katsujiringx",
    storageBucket: "katsujiringx.firebasestorage.app",
    messagingSenderId: "831784731743",
    appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
    measurementId: "G-LPCRE3WYZR"
};

// Firebase初期化
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

// Firebaseサービスへの参照
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// 日本語ロケールの設定
auth.languageCode = 'ja';

// 現在のユーザー
let currentUser = null;

// 現在の表示
let currentView = 'personal'; // personal, shared, public, trashed
let currentFileType = 'all'; // all, documents, images, pdfs, others
let currentFolder = 'root'; // root または folder ID
let currentViewMode = 'grid'; // grid または list

// パンくずリストの履歴
let folderHistory = [];
let folderNameMap = { 'root': 'ルート' };

// 共有ユーザーリスト
let sharedUsers = [];

// 現在プレビュー中のファイル
let currentPreviewFile = null;

// アクティブなファイル/フォルダ（右クリックメニューなどで使用）
let activeFile = null;

// 選択中のファイル/フォルダID配列
let selectedItems = [];

// 選択されたユーザーのIDセット
let selectedUserIds = new Set();

// ユーザー権限チェック関数 - 改善版
function canUserEdit(item) {
    // 所有者の場合は完全な権限
    if (item.userId === currentUser.uid) {
        return true;
    }
    
    // 全体共有の場合は誰でも編集可能（全操作許可）
    if (item.visibility === 'public') {
        return true;
    }
    
    // 指定共有の場合は共有されている人のみ操作可能
    if (item.visibility === 'shared' && 
        item.sharedWith && 
        item.sharedWith.includes(currentUser.uid)) {
        return true;
    }
    
    // 上記以外は操作不可
    return false;
}

// ファイルの完全削除権限チェック関数
function canUserPermanentDelete(item) {
    // 所有者のみが完全削除可能
    return item.userId === currentUser.uid;
}

// 初期データの作成
async function setupInitialUser(user) {
    try {
        // まずユーザードキュメントがあるか確認
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // ユーザードキュメントがなければ作成
            const userData = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || (user.email ? user.email.split('@')[0] : '新規ユーザー'),
                profileImageUrl: user.photoURL || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(user.uid).set(userData);
            console.log("ユーザープロファイル作成完了");
        }
    } catch (error) {
        console.error("初期設定エラー:", error);
        showToast('ユーザー情報の初期化に失敗しました', 'error');
    }
}

// ユーザーデータの取得
async function fetchUserData(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            
            // ユーザー名を表示
            if (sidebarUserName) {
                sidebarUserName.textContent = userData.displayName || 'ゲスト';
            }
            
            // ユーザーアバターを設定
            if (userAvatar) {
                if (userData.profileImageUrl) {
                    // 画像URLがある場合は画像を表示
                    userAvatar.innerHTML = `<img src="${userData.profileImageUrl}" alt="${userData.displayName || 'ユーザー'}">`;
                } else {
                    // 画像URLがない場合はイニシャル表示
                    const initial = (userData.displayName || 'U').charAt(0).toUpperCase();
                    userAvatar.innerHTML = `<span id="user-initial">${initial}</span>`;
                }
            }
        } else {
            console.log("ユーザーデータが見つかりません");
        }
    } catch (error) {
        console.error("ユーザーデータ取得エラー:", error);
        showToast('ユーザー情報の取得に失敗しました', 'warning');
    }
}

// ファイル一覧取得
async function loadFiles() {
    try {
        // ファイルプレビューを非表示、ファイル一覧を表示
        hideFilePreview();
        
        // ローディング表示
        showLoading();
        
        // 既存のファイル表示をクリア
        fileGridContainer.innerHTML = '';
        fileListContainer.innerHTML = '';
        fileListContainer.appendChild(createListHeader());
        
        // 選択もクリア
        clearSelection();
        
        // 検索クエリ取得
        const searchQuery = fileSearchInput.value.toLowerCase();
        
        let filesArray = [];
        let foldersArray = [];
        
        try {
            // クエリの実行 - 効率化のためにファイル/フォルダで分けてクエリ
            const filesRef = db.collection('files');
            const foldersRef = db.collection('folders');
            
            // クエリ条件の準備
            let filesQuery = filesRef;
            let foldersQuery = foldersRef;
            
            // ゴミ箱表示のフィルタ
            filesQuery = filesQuery.where('trashed', '==', currentView === 'trashed');
            foldersQuery = foldersQuery.where('trashed', '==', currentView === 'trashed');
            
            // 表示モードによるフィルタ適用
            if (currentView === 'personal') {
                // 個人用表示
                filesQuery = filesQuery.where('userId', '==', currentUser.uid)
                                      .where('visibility', '==', 'personal');
                foldersQuery = foldersQuery.where('userId', '==', currentUser.uid)
                                         .where('visibility', '==', 'personal');
            } else if (currentView === 'shared') {
                // 指定共有モードでは、自分のものと自分に共有されたものをクライアントで結合
                const mySharedFilesQuery = filesQuery.where('userId', '==', currentUser.uid)
                                                   .where('visibility', '==', 'shared');
                const sharedWithMeFilesQuery = filesQuery.where('visibility', '==', 'shared')
                                                        .where('sharedWith', 'array-contains', currentUser.uid);
                
                const mySharedFoldersQuery = foldersQuery.where('userId', '==', currentUser.uid)
                                                      .where('visibility', '==', 'shared');
                const sharedWithMeFoldersQuery = foldersQuery.where('visibility', '==', 'shared')
                                                           .where('sharedWith', 'array-contains', currentUser.uid);
                
                // クエリの実行と結果の結合
                const [mySharedFiles, sharedWithMeFiles, mySharedFolders, sharedWithMeFolders] = await Promise.all([
                    mySharedFilesQuery.get(),
                    sharedWithMeFilesQuery.get(),
                    mySharedFoldersQuery.get(),
                    sharedWithMeFoldersQuery.get()
                ]);
                
                // 結果の追加
                mySharedFiles.forEach(doc => {
                    const fileData = { id: doc.id, ...doc.data() };
                    if (fileData.parentFolder === currentFolder || 
                        (currentFolder === 'root' && fileData.parentFolder === 'root')) {
                        filesArray.push(fileData);
                    }
                });
                
                sharedWithMeFiles.forEach(doc => {
                    const fileData = { id: doc.id, ...doc.data() };
                    if (fileData.parentFolder === currentFolder || 
                        (currentFolder === 'root' && fileData.parentFolder === 'root')) {
                        filesArray.push(fileData);
                    }
                });
                
                mySharedFolders.forEach(doc => {
                    const folderData = { id: doc.id, ...doc.data(), isFolder: true };
                    if (folderData.parentFolder === currentFolder || 
                        (currentFolder === 'root' && folderData.parentFolder === 'root')) {
                        foldersArray.push(folderData);
                        // フォルダ名をマッピングに追加
                        folderNameMap[folderData.id] = folderData.name;
                    }
                });
                
                sharedWithMeFolders.forEach(doc => {
                    const folderData = { id: doc.id, ...doc.data(), isFolder: true };
                    if (folderData.parentFolder === currentFolder || 
                        (currentFolder === 'root' && folderData.parentFolder === 'root')) {
                        foldersArray.push(folderData);
                        // フォルダ名をマッピングに追加
                        folderNameMap[folderData.id] = folderData.name;
                    }
                });
                
                // 続行しないためにreturn
                const allItems = [...foldersArray, ...filesArray].filter(item => {
                    return !searchQuery || item.name.toLowerCase().includes(searchQuery);
                });
                
                return renderFileList(allItems);
            } else if (currentView === 'public') {
                // 公開表示
                filesQuery = filesQuery.where('visibility', '==', 'public');
                foldersQuery = foldersQuery.where('visibility', '==', 'public');
            } else if (currentView === 'trashed') {
                // ゴミ箱表示（自分のもののみ）
                filesQuery = filesQuery.where('userId', '==', currentUser.uid);
                foldersQuery = foldersQuery.where('userId', '==', currentUser.uid);
            }
            
            // フォルダフィルタを適用（通常表示の場合のみ）
            if (currentView !== 'trashed') {
                filesQuery = filesQuery.where('parentFolder', '==', currentFolder);
                foldersQuery = foldersQuery.where('parentFolder', '==', currentFolder);
            }
            
            // ファイルタイプフィルタを適用（allではない場合のみ）
            if (currentFileType !== 'all') {
                filesQuery = filesQuery.where('fileType', '==', currentFileType);
            }
            
            // クエリ実行
            const [filesSnapshot, foldersSnapshot] = await Promise.all([
                filesQuery.get(),
                foldersQuery.get()
            ]);
            
            // 結果の処理
            filesSnapshot.forEach(doc => {
                const fileData = { id: doc.id, ...doc.data() };
                filesArray.push(fileData);
            });
            
            foldersSnapshot.forEach(doc => {
                const folderData = { id: doc.id, ...doc.data(), isFolder: true };
                foldersArray.push(folderData);
                // フォルダ名をマッピングに追加
                folderNameMap[folderData.id] = folderData.name;
            });
        } catch (error) {
            console.error("クエリエラー:", error);
            showToast('データの取得中にエラーが発生しました', 'error');
        }
        
        // 検索フィルターを適用
        if (searchQuery) {
            filesArray = filesArray.filter(file => file.name.toLowerCase().includes(searchQuery));
            foldersArray = foldersArray.filter(folder => folder.name.toLowerCase().includes(searchQuery));
        }
        
        // 結合して表示
        const allItems = [...foldersArray, ...filesArray];
        renderFileList(allItems);
        
    } catch (error) {
        console.error("ファイル一覧取得エラー:", error);
        showToast('ファイル一覧の取得中にエラーが発生しました', 'error');
        hideLoading();
        showEmptyState();
    }
}

// ファイル一覧のレンダリング
function renderFileList(items) {
    // 結果をソートして表示
    if (items.length === 0) {
        showEmptyState();
    } else {
        hideEmptyState();
        hideLoading();
        
        // ソート
        const sortOption = sortSelect.value;
        items.sort((a, b) => {
            // フォルダを先に表示
            if (a.isFolder && !b.isFolder) return -1;
            if (!a.isFolder && b.isFolder) return 1;
            
            // 同じタイプならソート条件で比較
            switch (sortOption) {
                case 'name-asc':
                    return a.name.localeCompare(b.name, 'ja');
                case 'name-desc':
                    return b.name.localeCompare(a.name, 'ja');
                case 'date-desc':
                    return new Date(b.updatedAt?.seconds * 1000 || 0) - new Date(a.updatedAt?.seconds * 1000 || 0);
                case 'date-asc':
                    return new Date(a.updatedAt?.seconds * 1000 || 0) - new Date(b.updatedAt?.seconds * 1000 || 0);
                case 'size-desc':
                    return (b.size || 0) - (a.size || 0);
                case 'size-asc':
                    return (a.size || 0) - (b.size || 0);
                default:
                    return new Date(b.updatedAt?.seconds * 1000 || 0) - new Date(a.updatedAt?.seconds * 1000 || 0);
            }
        });
        
        // ファイルをレンダリング
        items.forEach(item => {
            // グリッドビュー用のカード作成
            fileGridContainer.appendChild(createFileCard(item));
            
            // リストビュー用の行作成
            fileListContainer.appendChild(createFileListItem(item));
        });
    }
    
    // パンくずリスト更新
    updateBreadcrumb();
}

// フォルダ一覧の取得（サイドバー用）
async function loadFolders() {
    try {
        // ルートフォルダは常に表示
        const rootItem = document.createElement('li');
        rootItem.className = currentFolder === 'root' ? 'sidebar-item active' : 'sidebar-item';
        rootItem.setAttribute('data-folder', 'root');
        rootItem.innerHTML = '<i class="fas fa-folder"></i> ルート';
        rootItem.addEventListener('click', () => changeFolder('root'));
        
        // フォルダリストをクリア
        folderListContainer.innerHTML = '';
        folderListContainer.appendChild(rootItem);
        
        // モーダル内のフォルダリストもクリア
        uploadFolder.innerHTML = '<option value="root">ルート</option>';
        parentFolder.innerHTML = '<option value="root">ルート</option>';
        moveDestination.innerHTML = '<option value="root">ルート</option>';
        batchMoveDestination.innerHTML = '<option value="root">ルート</option>';
        
        try {
            // ユーザーのフォルダを取得（ゴミ箱以外）
            const myFoldersQuery = db.collection('folders')
                .where('userId', '==', currentUser.uid)
                .where('trashed', '==', false);
            
            const myFoldersSnapshot = await myFoldersQuery.get();
            myFoldersSnapshot.forEach(doc => addFolderToSidebar(doc));
            
            // 共有フォルダの取得（自分に共有されているフォルダ）
            const sharedFoldersQuery = db.collection('folders')
                .where('visibility', '==', 'shared')
                .where('sharedWith', 'array-contains', currentUser.uid)
                .where('trashed', '==', false);
            
            const sharedFoldersSnapshot = await sharedFoldersQuery.get();
            sharedFoldersSnapshot.forEach(doc => addFolderToSidebar(doc, '共有'));
            
            // 公開フォルダの取得
            const publicFoldersQuery = db.collection('folders')
                .where('visibility', '==', 'public')
                .where('trashed', '==', false);
            
            const publicFoldersSnapshot = await publicFoldersQuery.get();
            publicFoldersSnapshot.forEach(doc => {
                // 自分のフォルダは除外（すでに表示済み）
                if (doc.data().userId !== currentUser.uid) {
                    addFolderToSidebar(doc, '公開');
                }
            });
            
        } catch (error) {
            console.error("フォルダ一覧取得エラー:", error);
            showToast('フォルダ一覧の取得に失敗しました', 'warning');
        }
    } catch (error) {
        console.error("フォルダ一覧取得エラー:", error);
    }
}

// フォルダをサイドバーに追加
function addFolderToSidebar(doc, shareType) {
    const folder = { id: doc.id, ...doc.data() };
    
    // フォルダ名をマッピングに追加
    folderNameMap[folder.id] = folder.name;
    
    // サイドバー項目の作成
    const folderItem = document.createElement('li');
    folderItem.className = currentFolder === folder.id ? 'sidebar-item active' : 'sidebar-item';
    folderItem.setAttribute('data-folder', folder.id);
    
    // 共有アイコンの設定
    let shareIcon = '';
    if (shareType === '共有' || folder.visibility === 'shared') {
        shareIcon = '<i class="fas fa-share-alt ml-1" style="color: var(--info); font-size: 0.75rem;"></i>';
    } else if (shareType === '公開' || folder.visibility === 'public') {
        shareIcon = '<i class="fas fa-globe ml-1" style="color: var(--success); font-size: 0.75rem;"></i>';
    }
    
    folderItem.innerHTML = `<i class="fas fa-folder"></i> ${folder.name} ${shareIcon}`;
    folderItem.addEventListener('click', () => changeFolder(folder.id));
    folderListContainer.appendChild(folderItem);
    
    // 各選択リストにフォルダを追加
    const folderLabel = shareType ? `${folder.name} (${shareType})` : folder.name;
    
    // アップロードモーダル用
    const uploadOption = document.createElement('option');
    uploadOption.value = folder.id;
    uploadOption.textContent = folderLabel;
    uploadFolder.appendChild(uploadOption);
    
    // 新規フォルダモーダル用
    const parentOption = document.createElement('option');
    parentOption.value = folder.id;
    parentOption.textContent = folderLabel;
    parentFolder.appendChild(parentOption);
    
    // 移動モーダル用
    const moveOption = document.createElement('option');
    moveOption.value = folder.id;
    moveOption.textContent = folderLabel;
    moveDestination.appendChild(moveOption);
    
    // 一括移動モーダル用
    const batchMoveOption = document.createElement('option');
    batchMoveOption.value = folder.id;
    batchMoveOption.textContent = folderLabel;
    batchMoveDestination.appendChild(batchMoveOption);
}

// ユーザー一覧の取得（共有設定用）
async function loadUsers() {
    try {
        // 共有ユーザーリストをクリア
        sharedUsers = [];
        
        // ユーザー一覧を取得
        const usersSnapshot = await db.collection('users').get();
        
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            
            // 自分以外のユーザーをリストに追加
            if (user.uid !== currentUser.uid) {
                sharedUsers.push({
                    uid: user.uid,
                    displayName: user.displayName || user.email || 'ユーザー',
                    email: user.email || '',
                    profileImageUrl: user.profileImageUrl || ''
                });
            }
        });
        
        // 共有ユーザーリストの更新
        updateUserList(sharedUserList, 'upload');
        updateUserList(folderSharedUserList, 'folder');
        updateUserList(shareSettingsUserList, 'share');
        updateUserList(batchSharedUserList, 'batch');
    } catch (error) {
        console.error("ユーザー一覧取得エラー:", error);
        showToast('ユーザー一覧を取得できませんでした', 'warning');
    }
}

// ユーザーリスト表示更新
function updateUserList(container, context, filterText = '') {
    if (!container) return;
    
    // リストをクリア
    container.innerHTML = '';
    
    // 検索フィルター適用
    const filteredUsers = sharedUsers.filter(user => {
        const searchText = filterText.toLowerCase();
        return (
            !searchText || 
            user.displayName.toLowerCase().includes(searchText) || 
            (user.email && user.email.toLowerCase().includes(searchText))
        );
    });
    
    if (filteredUsers.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'p-3 text-center';
        emptyMessage.textContent = filterText ? '該当するユーザーがいません' : 'ユーザーが見つかりません';
        container.appendChild(emptyMessage);
        return;
    }
    
    // ユーザーリスト作成
    filteredUsers.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'shared-user-item';
        userItem.dataset.uid = user.uid;
        
        // ユーザーアバター
        let avatarContent;
        if (user.profileImageUrl) {
            avatarContent = `<img src="${user.profileImageUrl}" alt="${user.displayName}">`;
        } else {
            const initial = user.displayName.charAt(0).toUpperCase();
            avatarContent = initial;
        }
        
        // 選択済みかどうかをチェック
        const isSelected = selectedUserIds.has(user.uid);
        
        // チェックボックスを表示
        userItem.innerHTML = `
            <div class="shared-user-avatar">${avatarContent}</div>
            <div class="shared-user-info">
                <div class="shared-user-name">${user.displayName}</div>
                <div class="shared-user-email">${user.email || ''}</div>
            </div>
            <div class="shared-user-role">
                <div class="shared-user-checkbox ${isSelected ? 'checked' : ''}">
                    <i class="fas fa-check" style="${isSelected ? '' : 'display: none;'}"></i>
                </div>
            </div>
        `;
        
        // クリックイベント - ユーザー選択切替
        userItem.addEventListener('click', () => {
            const checkbox = userItem.querySelector('.shared-user-checkbox');
            const checkIcon = checkbox.querySelector('i');
            const isNowSelected = !selectedUserIds.has(user.uid);
            
            // ユーザー選択を切り替え
            if (isNowSelected) {
                selectedUserIds.add(user.uid);
                checkbox.classList.add('checked');
                checkIcon.style.display = '';
                
                // 選択表示を更新
                addSelectedUserTag(user, context);
            } else {
                selectedUserIds.delete(user.uid);
                checkbox.classList.remove('checked');
                checkIcon.style.display = 'none';
                
                // 選択表示を更新
                removeSelectedUserTag(user.uid, context);
            }
        });
        
        container.appendChild(userItem);
    });
}

// 選択済みユーザーのタグを追加
function addSelectedUserTag(user, context) {
    const containerId = getSelectedUsersContainerId(context);
    if (!containerId) return;
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // すでに存在するか確認
    if (document.querySelector(`.selected-user-tag[data-uid="${user.uid}"]`)) {
        return;
    }
    
    // 選択タグを作成
    const tag = document.createElement('div');
    tag.className = 'selected-user-tag';
    tag.dataset.uid = user.uid;
    tag.innerHTML = `
        ${user.displayName}
        <i class="fas fa-times" data-remove="${user.uid}"></i>
    `;
    
    // 削除ボタンのクリックイベント
    tag.querySelector('i').addEventListener('click', (e) => {
        e.stopPropagation();
        const userId = e.target.dataset.remove;
        selectedUserIds.delete(userId);
        
        // タグを削除
        tag.remove();
        
        // チェックボックスの状態を更新
        const checkbox = document.querySelector(`.shared-user-item[data-uid="${userId}"] .shared-user-checkbox`);
        if (checkbox) {
            checkbox.classList.remove('checked');
            checkbox.querySelector('i').style.display = 'none';
        }
    });
    
    container.appendChild(tag);
}

// 選択済みユーザーのタグを削除
function removeSelectedUserTag(userId, context) {
    const containerId = getSelectedUsersContainerId(context);
    if (!containerId) return;
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const tag = container.querySelector(`.selected-user-tag[data-uid="${userId}"]`);
    if (tag) {
        tag.remove();
    }
}

// コンテキストに応じた選択ユーザー表示コンテナのIDを取得
function getSelectedUsersContainerId(context) {
    switch (context) {
        case 'upload': return 'upload-selected-users';
        case 'folder': return 'folder-selected-users';
        case 'share': return 'share-selected-users';
        case 'batch': return 'batch-selected-users';
        default: return '';
    }
}

// ファイルの共有ユーザーを選択済みにセット
function setSelectedUsers(userIds) {
    // 前の選択をクリア
    selectedUserIds.clear();
    
    // 選択をセット
    if (userIds && userIds.length > 0) {
        userIds.forEach(id => selectedUserIds.add(id));
    }
    
    // 選択表示を更新
    const containerIds = [
        'upload-selected-users',
        'folder-selected-users',
        'share-selected-users',
        'batch-selected-users'
    ];
    
    containerIds.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = '';
        }
    });
    
    // 各ユーザーのタグとチェックボックスを更新
    if (userIds && userIds.length > 0) {
        userIds.forEach(id => {
            const user = sharedUsers.find(u => u.uid === id);
            if (user) {
                addSelectedUserTag(user, 'upload');
                addSelectedUserTag(user, 'folder');
                addSelectedUserTag(user, 'share');
                addSelectedUserTag(user, 'batch');
                
                // チェックボックスの状態も更新
                document.querySelectorAll(`.shared-user-item[data-uid="${id}"] .shared-user-checkbox`).forEach(checkbox => {
                    checkbox.classList.add('checked');
                    checkbox.querySelector('i').style.display = '';
                });
            }
        });
    }
}

// ストレージ使用量の取得
async function fetchStorageUsage() {
    try {
        let totalUsage = 0;
        
        try {
            // ユーザーのファイル一覧を取得して合計サイズを計算
            const filesSnapshot = await db.collection('files')
                .where('userId', '==', currentUser.uid)
                .where('trashed', '==', false)
                .get();
            
            filesSnapshot.forEach(doc => {
                const file = doc.data();
                totalUsage += file.size || 0;
            });
        } catch (error) {
            console.error("ファイルサイズ計算エラー:", error);
        }
        
        // 1GB（基本プラン）
        const storageLimit = 1 * 1024 * 1024 * 1024; // 1GB in bytes
        
        // 表示更新
        const usagePercent = Math.min(100, (totalUsage / storageLimit) * 100);
        storageProgress.style.width = `${usagePercent}%`;
        
        // 使用量表示
        storageUsed.textContent = formatFileSize(totalUsage);
        storageTotal.textContent = formatFileSize(storageLimit);
        
        // 使用量が多い場合は警告表示
        if (usagePercent > 90) {
            storageBadge.textContent = "限界";
            storageBadge.className = "badge badge-danger";
        } else if (usagePercent > 70) {
            storageBadge.textContent = "警告";
            storageBadge.className = "badge badge-warning";
        }
    } catch (error) {
        console.error("ストレージ使用量取得エラー:", error);
    }
}

// ファイルカードの作成（グリッドビュー用）
function createFileCard(file) {
    const card = document.createElement('div');
    card.className = 'file-card';
    card.setAttribute('data-id', file.id);
    card.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
    
    // 選択チェックボックス
    const checkbox = document.createElement('div');
    checkbox.className = 'file-checkbox';
    checkbox.innerHTML = '<i class="fas fa-check" style="display: none;"></i>';
    
    // チェックボックスクリックイベント
    checkbox.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleItemSelection(card);
    });
    
    // アイコンまたはサムネイル
    let iconHtml = '';
    if (file.isFolder) {
        iconHtml = `<div class="file-icon folder-icon"><i class="fas fa-folder"></i></div>`;
    } else if (file.fileType === 'image' && file.thumbnail) {
        iconHtml = `<div class="file-image"><img src="${file.thumbnail}" alt="${file.name}" loading="lazy"></div>`;
    } else {
        // ファイルタイプ別のアイコン
        let iconClass = 'file-icon';
        let faIcon = 'fa-file';
        
        switch (file.fileType) {
            case 'pdf':
                iconClass += ' pdf-icon';
                faIcon = 'fa-file-pdf';
                break;
            case 'document':
                iconClass += ' doc-icon';
                faIcon = 'fa-file-alt';
                break;
            case 'image':
                iconClass += ' image-icon';
                faIcon = 'fa-file-image';
                break;
            default:
                iconClass += '';
                faIcon = 'fa-file';
        }
        
        iconHtml = `<div class="${iconClass}"><i class="fas ${faIcon}"></i></div>`;
    }
    
    // 更新日
    const updatedAt = file.updatedAt ? new Date(file.updatedAt.seconds * 1000) : new Date();
    const formattedDate = updatedAt.toLocaleDateString('ja-JP');
    
    // 共有インジケータ
    let shareIndicator = '';
    if (file.visibility === 'shared') {
        shareIndicator = `
            <div class="share-indicator">
                <i class="fas fa-share-alt share-indicator-icon" style="color: var(--info);"></i>
                <span class="share-indicator-text">指定共有</span>
            </div>
        `;
    } else if (file.visibility === 'public') {
        shareIndicator = `
            <div class="share-indicator">
                <i class="fas fa-globe share-indicator-icon" style="color: var(--success);"></i>
                <span class="share-indicator-text">全体共有</span>
            </div>
        `;
    }
    
    // 所有者表示
    let ownerIndicator = '';
    if (file.userId !== currentUser.uid) {
        const ownerName = file.ownerName || '他のユーザー';
        ownerIndicator = `
            <div class="mt-1" style="font-size: 0.7rem; color: var(--text-muted);">
                <i class="fas fa-user mr-1"></i> ${ownerName}
            </div>
        `;
    }
    
    // HTML作成
    card.innerHTML = `
        ${iconHtml}
        <div>
            <div class="file-card-name" title="${file.name}">${file.name}${shareIndicator}</div>
            <div class="file-card-date">${formattedDate}</div>
            ${ownerIndicator}
        </div>
        <div class="file-card-actions">
            <span class="file-card-action" data-action="more"><i class="fas fa-ellipsis-v"></i></span>
        </div>
    `;
    
    // チェックボックスを追加
    card.appendChild(checkbox);
    
    // 選択状態かチェック
    if (selectedItems.includes(file.id)) {
        card.classList.add('selected');
        updateCheckboxState(checkbox, true);
    }
    
    // イベントリスナー
    card.addEventListener('click', (e) => {
        if (!e.target.closest('.file-checkbox') && !e.target.closest('.file-card-action')) {
            // フォルダの場合は開く
            if (file.isFolder) {
                changeFolder(file.id);
            } else {
                // ファイルの場合はプレビューまたはダウンロード
                openFile(file);
            }
        }
    });
    
    // 右クリックメニュー
    card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        activeFile = file;
        showContextMenu(e.clientX, e.clientY, file);
    });
    
    // 「...」ボタンクリック
    const moreBtn = card.querySelector('[data-action="more"]');
    if (moreBtn) {
        moreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            activeFile = file;
            const rect = moreBtn.getBoundingClientRect();
            showContextMenu(rect.right, rect.bottom, file);
        });
    }
    
    return card;
}

// ファイルリスト行の作成（リストビュー用）
function createFileListItem(file) {
    const item = document.createElement('div');
    item.className = 'file-list-item';
    item.setAttribute('data-id', file.id);
    item.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
    
    // 選択チェックボックス
    const checkboxCell = document.createElement('div');
    const checkbox = document.createElement('div');
    checkbox.className = 'file-checkbox';
    checkbox.innerHTML = '<i class="fas fa-check" style="display: none;"></i>';
    
    // チェックボックスクリックイベント
    checkbox.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleItemSelection(item);
    });
    
    checkboxCell.appendChild(checkbox);
    
    // アイコン選択
    let iconClass = 'fa-file';
    if (file.isFolder) {
        iconClass = 'fa-folder';
    } else {
        switch (file.fileType) {
            case 'pdf':
                iconClass = 'fa-file-pdf';
                break;
            case 'document':
                iconClass = 'fa-file-alt';
                break;
            case 'image':
                iconClass = 'fa-file-image';
                break;
        }
    }
    
    // 更新日
    const updatedAt = file.updatedAt ? new Date(file.updatedAt.seconds * 1000) : new Date();
    const formattedDate = updatedAt.toLocaleDateString('ja-JP');
    
    // 共有インジケータ
    let shareIndicator = '';
    if (file.visibility === 'shared') {
        shareIndicator = `
            <span class="ml-2" style="color: var(--info); font-size: 0.8rem;">
                <i class="fas fa-share-alt"></i>
                <span style="font-size: 0.7rem; font-weight: normal;">指定共有</span>
            </span>
        `;
    } else if (file.visibility === 'public') {
        shareIndicator = `
            <span class="ml-2" style="color: var(--success); font-size: 0.8rem;">
                <i class="fas fa-globe"></i>
                <span style="font-size: 0.7rem; font-weight: normal;">全体共有</span>
            </span>
        `;
    }
    
    // 各セル作成
    const nameCell = document.createElement('div');
    nameCell.innerHTML = `<i class="fas ${iconClass} mr-2"></i> ${file.name} ${shareIndicator}`;
    
    // 所有者セルに所有者情報表示
    const ownerCell = document.createElement('div');
    ownerCell.className = 'owner-col';
    ownerCell.textContent = file.userId === currentUser.uid ? '自分' : (file.ownerName || '他のユーザー');
    
    const dateCell = document.createElement('div');
    dateCell.className = 'date-col';
    dateCell.textContent = formattedDate;
    
    const sizeCell = document.createElement('div');
    sizeCell.className = 'size-col';
    sizeCell.textContent = file.isFolder ? '-' : formatFileSize(file.size || 0);
    
    const actionsCell = document.createElement('div');
    actionsCell.innerHTML = `
        <span class="btn btn-sm btn-icon btn-outline" data-action="more">
            <i class="fas fa-ellipsis-v"></i>
        </span>
    `;
    
    // 各セルを行に追加
    item.appendChild(checkboxCell);
    item.appendChild(nameCell);
    item.appendChild(ownerCell);
    item.appendChild(dateCell);
    item.appendChild(sizeCell);
    item.appendChild(actionsCell);
    
    // 選択状態かチェック
    if (selectedItems.includes(file.id)) {
        item.classList.add('selected');
        updateCheckboxState(checkbox, true);
    }
    
    // イベントリスナー
    item.addEventListener('click', (e) => {
        if (!e.target.closest('.file-checkbox') && !e.target.closest('[data-action]')) {
            // フォルダの場合は開く
            if (file.isFolder) {
                changeFolder(file.id);
            } else {
                // ファイルの場合はプレビューまたはダウンロード
                openFile(file);
            }
        }
    });
    
    // 右クリックメニュー
    item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        activeFile = file;
        showContextMenu(e.clientX, e.clientY, file);
    });
    
    // 「...」ボタンクリック
    const moreBtn = item.querySelector('[data-action="more"]');
    if (moreBtn) {
        moreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            activeFile = file;
            const rect = moreBtn.getBoundingClientRect();
            showContextMenu(rect.right, rect.bottom, file);
        });
    }
    
    return item;
}

// リストビューのヘッダー行作成
function createListHeader() {
    const header = document.createElement('div');
    header.className = 'file-list-header';
    
    // 全選択チェックボックス
    const checkboxCell = document.createElement('div');
    checkboxCell.appendChild(listSelectAllCheckbox);
    
    // 各ヘッダーセル
    const nameCell = document.createElement('div');
    nameCell.textContent = '名前';
    
    const ownerCell = document.createElement('div');
    ownerCell.className = 'owner-col';
    ownerCell.textContent = '所有者';
    
    const dateCell = document.createElement('div');
    dateCell.className = 'date-col';
    dateCell.textContent = '更新日';
    
    const sizeCell = document.createElement('div');
    sizeCell.className = 'size-col';
    sizeCell.textContent = 'サイズ';
    
    const actionsCell = document.createElement('div');
    actionsCell.textContent = '';
    
    // 各セルをヘッダーに追加
    header.appendChild(checkboxCell);
    header.appendChild(nameCell);
    header.appendChild(ownerCell);
    header.appendChild(dateCell);
    header.appendChild(sizeCell);
    header.appendChild(actionsCell);
    
    return header;
}

// パンくずリスト更新
function updateBreadcrumb() {
    // パンくずリストをクリア
    breadcrumbContainer.innerHTML = '';
    
    // ホームリンク
    const homeLink = document.createElement('a');
    homeLink.href = "index.html";
    homeLink.textContent = "ホーム";
    breadcrumbContainer.appendChild(homeLink);
    
    // 区切り
    const divider1 = document.createElement('i');
    divider1.className = "fas fa-chevron-right";
    breadcrumbContainer.appendChild(divider1);
    
    // 資料管理リンク
    const docItem = document.createElement('span');
    docItem.className = "breadcrumb-item";
    docItem.textContent = "資料管理";
    docItem.addEventListener('click', () => {
        currentFolder = 'root';
        folderHistory = [];
        loadFiles();
    });
    breadcrumbContainer.appendChild(docItem);
    
    // フォルダ階層を表示
    if (currentFolder !== 'root' && folderHistory.length > 0) {
        for (let i = 0; i < folderHistory.length; i++) {
            const folder = folderHistory[i];
            
            // 区切り
            const divider = document.createElement('i');
            divider.className = "fas fa-chevron-right";
            breadcrumbContainer.appendChild(divider);
            
            // フォルダリンク（最後のアイテムはアクティブ）
            const folderItem = document.createElement('span');
            folderItem.className = "breadcrumb-item";
            if (i === folderHistory.length - 1) {
                folderItem.classList.add('active');
            }
            folderItem.textContent = folderNameMap[folder] || folder;
            
            // クリックイベントで対応するフォルダへ移動
            if (i < folderHistory.length - 1) {
                folderItem.style.cursor = 'pointer';
                folderItem.addEventListener('click', () => {
                    currentFolder = folder;
                    folderHistory = folderHistory.slice(0, i + 1);
                    loadFiles();
                });
            }
            
            breadcrumbContainer.appendChild(folderItem);
        }
    }
    
    // 現在のフォルダ（rootでない場合）
    if (currentFolder !== 'root') {
        // 区切り
        const divider = document.createElement('i');
        divider.className = "fas fa-chevron-right";
        breadcrumbContainer.appendChild(divider);
        
        // 現在のフォルダ
        const currentFolderItem = document.createElement('span');
        currentFolderItem.className = "breadcrumb-item active";
        currentFolderItem.textContent = folderNameMap[currentFolder] || currentFolder;
        breadcrumbContainer.appendChild(currentFolderItem);
    }
}

// フォルダ変更
async function changeFolder(folderId) {
    try {
        // 前のフォルダを履歴に追加（ルートから別のフォルダに移動する場合）
        if (folderId !== currentFolder && currentFolder !== 'root') {
            folderHistory.push(currentFolder);
        }
        
        // 直接ルートに戻る場合は履歴をクリア
        if (folderId === 'root') {
            folderHistory = [];
        }
        
        // フォルダ変更
        currentFolder = folderId;
        
        // サイドバーのアクティブ項目更新
        document.querySelectorAll('#folder-list .sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const activeItem = document.querySelector(`#folder-list [data-folder="${folderId}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
        }
        
        // フォルダのアクセス権を確認して、UIの表示制御
        await updateFolderPermissionUI(folderId);
        
        // ファイル一覧再読み込み
        await loadFiles();
    } catch (error) {
        console.error("フォルダ変更エラー:", error);
        showToast('フォルダを開けませんでした', 'error');
    }
}

// フォルダの権限確認とUI更新
async function updateFolderPermissionUI(folderId) {
    let canEdit = true; // デフォルトはtrue（rootの場合）
    
    if (folderId !== 'root') {
        try {
            const folderDoc = await db.collection('folders').doc(folderId).get();
            if (folderDoc.exists) {
                const folderData = folderDoc.data();
                canEdit = canUserEdit(folderData);
            }
        } catch (error) {
            console.error("フォルダ権限確認エラー:", error);
        }
    }
    
    // UIの表示制御
    document.getElementById('upload-btn').style.display = canEdit ? 'inline-flex' : 'none';
    document.getElementById('new-folder-btn').style.display = canEdit ? 'inline-flex' : 'none';
    
    // 空の状態メッセージ
    const emptyStateMsg = document.querySelector('#empty-state p');
    if (emptyStateMsg) {
        emptyStateMsg.textContent = canEdit 
            ? 'ファイルやフォルダをアップロードして始めましょう'
            : 'このフォルダにはファイルがありません';
    }
    
    // 空の状態のアップロードボタン
    if (emptyUploadBtn) {
        emptyUploadBtn.style.display = canEdit ? 'inline-flex' : 'none';
    }
}

// ファイルを開く
function openFile(file) {
    try {
        if (file.fileType === 'image') {
            // 画像プレビュー表示
            showFilePreview(file);
        } else if (file.fileType === 'pdf') {
            // PDFプレビュー表示
            showFilePreview(file);
        } else {
            // その他のファイルはダウンロード
            downloadFile(file);
        }
    } catch (error) {
        console.error("ファイルを開くエラー:", error);
        showToast('ファイルを開けませんでした', 'error');
    }
}

// ファイルプレビュー表示
function showFilePreview(file) {
    // 現在のファイルを保存
    currentPreviewFile = file;
    
    // ユーザーが操作可能かチェック
    const canEdit = canUserEdit(file);
    
    // プレビューコンテナの表示
    document.getElementById('file-list-container').style.display = 'none';
    fileViewContainer.style.display = 'flex';
    backNavigation.style.display = 'flex';
    
    // プレビュー内容をクリア
    filePreview.innerHTML = '';
    fileInfo.innerHTML = '';
    fileActions.innerHTML = '';
    
    // 権限情報表示
    const filePermissionsInfo = document.getElementById('file-permissions-info');
    if (file.userId === currentUser.uid) {
        // 自分のファイル
        filePermissionsInfo.style.display = 'none';
    } else {
        // 他人のファイル
        filePermissionsInfo.style.display = 'block';
        const permissionsText = document.getElementById('file-permissions-text');
        
        if (file.visibility === 'public') {
            permissionsText.innerHTML = 'このファイルは全体共有されています。<br>元のファイルの所有者は <strong>' + (file.ownerName || '他のユーザー') + '</strong> です。';
            filePermissionsInfo.className = 'file-permissions-info';
            filePermissionsInfo.style.backgroundColor = 'var(--success-light)';
            filePermissionsInfo.style.color = 'var(--success)';
        } else if (file.visibility === 'shared') {
            permissionsText.innerHTML = 'このファイルはあなたと共有されています。<br>元のファイルの所有者は <strong>' + (file.ownerName || '他のユーザー') + '</strong> です。';
            filePermissionsInfo.className = 'file-permissions-info';
            filePermissionsInfo.style.backgroundColor = 'var(--info-light)';
            filePermissionsInfo.style.color = 'var(--info)';
        }
    }
    
    // ファイル情報の表示
    fileInfo.innerHTML = `
        <h2>${file.name}</h2>
        <div class="mt-2">
            <p><strong>タイプ:</strong> ${getFileTypeLabel(file.fileType)}</p>
            <p><strong>サイズ:</strong> ${formatFileSize(file.size || 0)}</p>
            <p><strong>アップロード日:</strong> ${file.createdAt ? new Date(file.createdAt.seconds * 1000).toLocaleString('ja-JP') : '-'}</p>
            <p><strong>最終更新日:</strong> ${file.updatedAt ? new Date(file.updatedAt.seconds * 1000).toLocaleString('ja-JP') : '-'}</p>
            <p><strong>所有者:</strong> ${file.userId === currentUser.uid ? '自分' : (file.ownerName || '他のユーザー')}</p>
            <p><strong>共有状態:</strong> ${getVisibilityLabel(file.visibility)}</p>
        </div>
    `;
    
    // ファイルタイプに応じたプレビュー
    if (file.fileType === 'image') {
        // 画像プレビュー
        filePreview.innerHTML = `
            <img src="${file.url}" alt="${file.name}" style="max-width: 100%; max-height: 400px; object-fit: contain;">
        `;
    } else if (file.fileType === 'pdf') {
        // PDFプレビュー（iframeを使用）
        filePreview.innerHTML = `
            <iframe src="${file.url}" style="width: 100%; height: 500px; border: 1px solid var(--border-color); border-radius: var(--radius);"></iframe>
        `;
    } else {
        // その他のファイルはプレビュー不可
        filePreview.innerHTML = `
            <div style="text-align: center; padding: 2rem; background-color: var(--gray-100); border-radius: var(--radius);">
                <i class="fas fa-file" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                <p>このファイルはプレビューできません</p>
            </div>
        `;
    }
    
    // アクションボタン - すべてのユーザーに表示するボタン
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'btn btn-primary';
    downloadBtn.innerHTML = '<i class="fas fa-download"></i> ダウンロード';
    downloadBtn.addEventListener('click', () => downloadFile(file));
    fileActions.appendChild(downloadBtn);
    
    // 画像ファイルの場合は活字化エディタで開くボタンを追加
    if (file.fileType === 'image') {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary ml-2';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> 活字化エディタで開く';
        editBtn.addEventListener('click', () => openInEditor(file));
        fileActions.appendChild(editBtn);
    }
    
    // 編集権限があるユーザーに表示するボタン
    if (canEdit) {
        // 共有ボタン
        const shareBtn = document.createElement('button');
        shareBtn.className = 'btn btn-outline ml-2';
        shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> 共有';
        shareBtn.addEventListener('click', () => showShareModal(file));
        fileActions.appendChild(shareBtn);
        
        // 名前変更ボタン
        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn btn-outline ml-2';
        renameBtn.innerHTML = '<i class="fas fa-edit"></i> 名前変更';
        renameBtn.addEventListener('click', () => showRenameModal(file));
        fileActions.appendChild(renameBtn);
        
        // 削除ボタン
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger ml-2';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 削除';
        deleteBtn.addEventListener('click', () => showDeleteModal(file));
        fileActions.appendChild(deleteBtn);
    }
}

// ファイルプレビュー非表示
function hideFilePreview() {
    document.getElementById('file-list-container').style.display = 'block';
    fileViewContainer.style.display = 'none';
    backNavigation.style.display = 'none';
    currentPreviewFile = null;
}

// ファイルの種類ラベルを取得
function getFileTypeLabel(fileType) {
    switch (fileType) {
        case 'image': return '画像ファイル';
        case 'pdf': return 'PDFファイル';
        case 'document': return 'ドキュメント';
        default: return 'その他のファイル';
    }
}

// 共有状態ラベルを取得
function getVisibilityLabel(visibility) {
    switch (visibility) {
        case 'personal': return '個人用（自分のみ）';
        case 'shared': return '指定共有';
        case 'public': return '全体共有';
        default: return '不明';
    }
}

// 画像プレビューモーダル表示
function showImagePreviewModal(file) {
    if (!file || !file.url) {
        showToast('画像URLが見つかりません', 'error');
        return;
    }
    
    // 画像URLをセット
    previewImage.src = ''; // 一度クリア
    previewImage.src = file.url;
    previewImage.alt = file.name;
    
    // プレビュー中のファイルを保存
    currentPreviewFile = file;
    
    // モーダル表示
    imagePreviewModal.classList.add('show');
}

// 活字化エディタで開く
function openInEditor(file) {
    if (!file || !file.url) {
        showToast('ファイルURLが見つかりません', 'error');
        return;
    }
    
    // ファイルIDをURLパラメータとして渡す
    window.location.href = `katsujieditor.html?file=${file.id}`;
}

// ファイルダウンロード
async function downloadFile(file) {
    try {
        if (!file || !file.url) {
            showToast('ダウンロードURLが見つかりません', 'error');
            return;
        }
        
        // ダウンロード用のリンク作成
        const downloadLink = document.createElement('a');
        downloadLink.href = file.url;
        downloadLink.download = file.name;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        
        // クリックしてダウンロード開始
        downloadLink.click();
        
        // クリーンアップ
        document.body.removeChild(downloadLink);
        
        showToast(`「${file.name}」のダウンロードを開始しました`, 'success');
    } catch (error) {
        console.error("ダウンロードエラー:", error);
        showToast('ダウンロードできませんでした', 'error');
    }
}

// コンテキストメニュー表示
function showContextMenu(x, y, file) {
    // メニュー内容のカスタマイズ
    contextMenu.innerHTML = '';
    
    // ユーザーが操作可能かチェック
    const canEdit = canUserEdit(file);
    const canDelete = canUserPermanentDelete(file);
    
    if (currentView === 'trashed') {
        // ゴミ箱内のファイル用メニュー
        // ゴミ箱内のアイテムは所有者のみが操作可能
        if (canDelete) {
            contextMenu.innerHTML = `
                <div class="action-menu-item" data-action="restore">
                    <i class="fas fa-trash-restore"></i> 復元する
                </div>
                <div class="action-menu-item" data-action="delete-permanent">
                    <i class="fas fa-trash-alt"></i> 完全に削除
                </div>
            `;
        }
    } else {
        // 通常のファイル用メニュー - すべてのユーザーに表示
        if (file.isFolder) {
            contextMenu.innerHTML += `
                <div class="action-menu-item" data-action="open">
                    <i class="fas fa-folder-open"></i> 開く
                </div>
            `;
        } else {
            contextMenu.innerHTML += `
                <div class="action-menu-item" data-action="open">
                    <i class="fas fa-external-link-alt"></i> 開く
                </div>
                <div class="action-menu-item" data-action="download">
                    <i class="fas fa-download"></i> ダウンロード
                </div>
            `;
            
            // 画像ファイルの場合は活字化エディタで開くオプションを追加
            if (file.fileType === 'image') {
                contextMenu.innerHTML += `
                    <div class="action-menu-item" data-action="open-editor">
                        <i class="fas fa-edit"></i> 活字化エディタで開く
                    </div>
                `;
            }
        }
        
        // 編集権限がある場合のみ表示するメニュー項目
        if (canEdit) {
            contextMenu.innerHTML += `
                <div class="action-menu-item" data-action="rename">
                    <i class="fas fa-edit"></i> 名前変更
                </div>
                <div class="action-menu-item" data-action="share">
                    <i class="fas fa-share-alt"></i> 共有設定
                </div>
                <div class="action-menu-item" data-action="move">
                    <i class="fas fa-folder-minus"></i> 移動
                </div>
                <div class="action-menu-item" data-action="delete">
                    <i class="fas fa-trash"></i> 削除
                </div>
            `;
        }
    }
    
    // イベントリスナー設定
    const actionItems = contextMenu.querySelectorAll('.action-menu-item');
    actionItems.forEach(item => {
        item.addEventListener('click', handleContextMenuAction);
    });
    
    // メニュー位置調整
    const menuWidth = 180;
    const menuHeight = contextMenu.scrollHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // 画面右端を超える場合
    if (x + menuWidth > windowWidth) {
        x = windowWidth - menuWidth - 10;
    }
    
    // 画面下端を超える場合
    if (y + menuHeight > windowHeight) {
        y = windowHeight - menuHeight - 10;
    }
    
    // メニュー表示
    contextMenu.style.top = `${y}px`;
    contextMenu.style.left = `${x}px`;
    contextMenu.classList.add('show');
    
    // ドキュメントのクリックイベントで非表示に
    document.addEventListener('click', hideContextMenu);
}

// コンテキストメニュー非表示
function hideContextMenu() {
    contextMenu.classList.remove('show');
    document.removeEventListener('click', hideContextMenu);
}

// コンテキストメニューアクションハンドラ
function handleContextMenuAction(e) {
    const action = e.currentTarget.getAttribute('data-action');
    
    if (!activeFile) return;
    
    switch (action) {
        case 'open':
            if (activeFile.isFolder) {
                changeFolder(activeFile.id);
            } else {
                openFile(activeFile);
            }
            break;
        case 'download':
            downloadFile(activeFile);
            break;
        case 'open-editor':
            openInEditor(activeFile);
            break;
        case 'rename':
            showRenameModal(activeFile);
            break;
        case 'share':
            showShareModal(activeFile);
            break;
        case 'move':
            showMoveModal(activeFile);
            break;
        case 'delete':
            showDeleteModal(activeFile);
            break;
        case 'restore':
            restoreFromTrash(activeFile);
            break;
        case 'delete-permanent':
            showPermanentDeleteModal(activeFile);
            break;
    }
    
    hideContextMenu();
}

// 選択状態の更新
function updateSelectionState() {
    const count = selectedItems.length;
    
    // 選択数に応じて選択バーの表示/非表示を切り替え
    if (count > 0) {
        selectionBar.classList.add('show');
        selectionCount.textContent = `${count} 項目を選択中`;
    } else {
        selectionBar.classList.remove('show');
    }
    
    // 全選択チェックボックスの状態を更新
    const totalItems = document.querySelectorAll('.file-card, .file-list-item:not(.file-list-header)').length;
    const isAllSelected = count > 0 && count === totalItems;
    
    updateCheckboxState(selectAllCheckbox, isAllSelected);
    updateCheckboxState(listSelectAllCheckbox, isAllSelected);
}

// チェックボックス状態の更新
function updateCheckboxState(checkbox, checked) {
    const checkIcon = checkbox.querySelector('i');
    
    if (checked) {
        checkbox.classList.add('checked');
        checkIcon.style.display = 'block';
    } else {
        checkbox.classList.remove('checked');
        checkIcon.style.display = 'none';
    }
}

// アイテムの選択状態を切り替え
function toggleItemSelection(item, selected = null) {
    const id = item.getAttribute('data-id');
    const checkbox = item.querySelector('.file-checkbox');
    
    if (selected === null) {
        // トグル動作
        selected = !selectedItems.includes(id);
    }
    
    if (selected) {
        // 選択する
        if (!selectedItems.includes(id)) {
            selectedItems.push(id);
        }
        item.classList.add('selected');
        if (checkbox) {
            updateCheckboxState(checkbox, true);
        }
    } else {
        // 選択解除
        selectedItems = selectedItems.filter(itemId => itemId !== id);
        item.classList.remove('selected');
        if (checkbox) {
            updateCheckboxState(checkbox, false);
        }
    }
    
    updateSelectionState();
}

// すべての選択を解除
function clearSelection() {
    selectedItems = [];
    
    // すべてのアイテムの選択状態をリセット
    document.querySelectorAll('.file-card, .file-list-item:not(.file-list-header)').forEach(item => {
        item.classList.remove('selected');
        const checkbox = item.querySelector('.file-checkbox');
        if (checkbox) {
            updateCheckboxState(checkbox, false);
        }
    });
    
    // 全選択チェックボックスもリセット
    updateCheckboxState(selectAllCheckbox, false);
    updateCheckboxState(listSelectAllCheckbox, false);
    
    updateSelectionState();
}

// 全選択・解除の処理
function toggleSelectAll(selectAll = null) {
    // すべてのアイテムを取得
    const allItems = document.querySelectorAll('.file-card, .file-list-item:not(.file-list-header)');
    
    if (selectAll === null) {
        // トグル動作（何か選択されていなければすべて選択、すべて選択されていれば解除）
        selectAll = !(selectedItems.length > 0 && selectedItems.length === allItems.length);
    }
    
    // すべてのアイテムを選択/解除
    allItems.forEach(item => {
        toggleItemSelection(item, selectAll);
    });
    
    // チェックボックス状態更新
    updateCheckboxState(selectAllCheckbox, selectAll);
    updateCheckboxState(listSelectAllCheckbox, selectAll);
}

// バッチオペレーション前の権限チェック（一括操作用）
function checkBatchOperationPermissions() {
    // 選択されたアイテムの権限チェック
    const nonEditableItems = [];
    
    for (const itemId of selectedItems) {
        // 選択されたアイテムのDOM要素を取得
        const item = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
        if (!item) continue;
        
        // アイテムのデータ属性
        const itemData = {
            id: itemId,
            type: item.getAttribute('data-type'),
            name: item.querySelector('.file-card-name, [title]')?.textContent || 'ファイル'
        };
        
        // 編集権限の簡易チェック
        // 権限確認の改善 - ファイルの詳細データを取得して権限チェック
        try {
            const collection = itemData.type === 'folder' ? 'folders' : 'files';
            const docRef = db.collection(collection).doc(itemId);
            
            // Firestore から直接ドキュメントを取得
            docRef.get().then(doc => {
                if (doc.exists) {
                    const fileData = doc.data();
                    const canEdit = canUserEdit({...fileData, id: doc.id});
                    
                    if (!canEdit) {
                        nonEditableItems.push(itemData);
                    }
                }
            });
        } catch (error) {
            console.warn(`権限チェックエラー (${itemId}):`, error);
            nonEditableItems.push(itemData);
        }
    }
    
    return nonEditableItems;
}

// 名前変更モーダル表示
function showRenameModal(file) {
    // 編集権限チェック
    if (!canUserEdit(file)) {
        showToast('このファイルの名前を変更する権限がありません', 'error');
        return;
    }
    
    newName.value = file.name;
    renameFileId.value = file.id;
    renameFileType.value = file.isFolder ? 'folder' : 'file';
    
    // モーダル表示
    renameModal.classList.add('show');
}

// 共有設定モーダル表示
function showShareModal(file) {
    // 編集権限チェック
    if (!canUserEdit(file)) {
        showToast('このファイルの共有設定を変更する権限がありません', 'error');
        return;
    }
    
    shareFileId.value = file.id;
    shareFileType.value = file.isFolder ? 'folder' : 'file';
    
    // 現在の共有設定を反映
    shareVisibility.value = file.visibility || 'personal';
    
    // 共有設定に応じてUI表示
    updateShareModalUI();
    
    // 選択リセット
    selectedUserIds.clear();
    
    // 共有ユーザーが設定されていたら、それを選択状態に
    if (file.visibility === 'shared' && file.sharedWith && file.sharedWith.length > 0) {
        setSelectedUsers(file.sharedWith);
    }
    
    // 共有ユーザーリストを更新
    updateUserList(shareSettingsUserList, 'share');
    
    // 公開リンク生成（公開ファイルの場合）
    if (file.visibility === 'public') {
        const baseUrl = window.location.origin;
        shareLink.value = `${baseUrl}/view.html?id=${file.id}&type=${file.isFolder ? 'folder' : 'file'}`;
    }
    
    // モーダル表示
    shareModal.classList.add('show');
}

// 共有設定モーダルUI更新
function updateShareModalUI() {
    const visibility = shareVisibility.value;
    
    // 共有ユーザー選択部分の表示/非表示
    if (visibility === 'shared') {
        shareSettingsUsers.style.display = 'block';
        shareLinkContainer.style.display = 'none';
    } else if (visibility === 'public') {
        shareSettingsUsers.style.display = 'none';
        shareLinkContainer.style.display = 'block';
    } else {
        shareSettingsUsers.style.display = 'none';
        shareLinkContainer.style.display = 'none';
    }
}

// 移動モーダル表示
function showMoveModal(file) {
    // 編集権限チェック
    if (!canUserEdit(file)) {
        showToast('このファイルを移動する権限がありません', 'error');
        return;
    }
    
    moveFileId.value = file.id;
    moveFileType.value = file.isFolder ? 'folder' : 'file';
    
    // 現在のフォルダを選択
    moveDestination.value = file.parentFolder || 'root';
    
    // 自分自身（フォルダの場合）と子フォルダは移動先から除外
    if (file.isFolder) {
        Array.from(moveDestination.options).forEach(option => {
            if (option.value === file.id) {
                option.disabled = true;
            } else {
                option.disabled = false;
            }
        });
    }
    
    // モーダル表示
    moveModal.classList.add('show');
}

// 削除確認モーダル表示
function showDeleteModal(file) {
    // 編集権限チェック
    if (!canUserEdit(file)) {
        showToast('このファイルを削除する権限がありません', 'error');
        return;
    }
    
    deleteFileId.value = file.id;
    deleteFileType.value = file.isFolder ? 'folder' : 'file';
    
    // メッセージ更新
    deleteMessage.textContent = file.isFolder
        ? `フォルダ「${file.name}」とその中のすべてのファイルをゴミ箱に移動しますか？`
        : `ファイル「${file.name}」をゴミ箱に移動しますか？`;
    
    // モーダル表示
    deleteModal.classList.add('show');
}

// 完全削除確認モーダル表示
function showPermanentDeleteModal(file) {
    // 完全削除の権限チェック
    if (!canUserPermanentDelete(file)) {
        showToast('このファイルを完全に削除する権限がありません', 'error');
        return;
    }
    
    permanentDeleteFileId.value = file.id;
    permanentDeleteFileType.value = file.isFolder ? 'folder' : 'file';
    
    // メッセージ更新
    permanentDeleteMessage.textContent = file.isFolder
        ? `フォルダ「${file.name}」とその中のすべてのファイルを完全に削除しますか？この操作は取り消せません。`
        : `ファイル「${file.name}」を完全に削除しますか？この操作は取り消せません。`;
    
    // モーダル表示
    permanentDeleteModal.classList.add('show');
}

// 一括共有設定ダイアログ表示
function showBatchShareModal() {
    if (selectedItems.length === 0) {
        showToast('選択されたアイテムがありません', 'warning');
        return;
    }
    
    // 編集権限のないアイテムをチェック
    const nonEditableItems = checkBatchOperationPermissions();
    
    if (nonEditableItems.length > 0) {
        // 権限のないアイテムがある場合は警告
        if (nonEditableItems.length === selectedItems.length) {
            showToast('選択したアイテムの共有設定を変更する権限がありません', 'warning');
            return;
        } else {
            showToast(`${nonEditableItems.length}個のアイテムは共有設定を変更できません（権限なし）`, 'warning');
            // 権限のあるアイテムだけを対象に実行
            selectedItems = selectedItems.filter(id => !nonEditableItems.some(item => item.id === id));
        }
    }
    
    // 件数表示
    batchShareInfo.textContent = `${selectedItems.length}個の項目を一括で共有設定します。`;
    
    // 初期設定をリセット
    batchShareVisibility.value = 'personal';
    batchShareUsers.style.display = 'none';
    
    // 選択リセット
    selectedUserIds.clear();
    document.getElementById('batch-selected-users').innerHTML = '';
    
    // ユーザーリスト更新
    updateUserList(batchSharedUserList, 'batch');
    
    // モーダル表示
    batchShareModal.classList.add('show');
}

// 一括移動ダイアログ表示
function showBatchMoveModal() {
    if (selectedItems.length === 0) {
        showToast('選択されたアイテムがありません', 'warning');
        return;
    }
    
    // 編集権限のないアイテムをチェック
    const nonEditableItems = checkBatchOperationPermissions();
    
    if (nonEditableItems.length > 0) {
        // 権限のないアイテムがある場合は警告
        if (nonEditableItems.length === selectedItems.length) {
            showToast('選択したアイテムを移動する権限がありません', 'warning');
            return;
        } else {
            showToast(`${nonEditableItems.length}個のアイテムは移動できません（権限なし）`, 'warning');
            // 権限のあるアイテムだけを対象に実行
            selectedItems = selectedItems.filter(id => !nonEditableItems.some(item => item.id === id));
        }
    }
    
    // 件数表示
    batchMoveInfo.textContent = `${selectedItems.length}個の項目を一括で移動します。`;
    
    // フォルダを移動対象から除外
    const folderIds = [];
    selectedItems.forEach(itemId => {
        const item = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
        if (item && item.getAttribute('data-type') === 'folder') {
            folderIds.push(itemId);
        }
    });
    
    // 選択したフォルダは移動先から除外
    Array.from(batchMoveDestination.options).forEach(option => {
        option.disabled = folderIds.includes(option.value);
    });
    
    // モーダル表示
    batchMoveModal.classList.add('show');
}

// 一括削除確認ダイアログ表示
function showBatchDeleteModal() {
    if (selectedItems.length === 0) {
        showToast('選択されたアイテムがありません', 'warning');
        return;
    }
    
    // 編集権限のないアイテムをチェック
    const nonEditableItems = checkBatchOperationPermissions();
    
    if (nonEditableItems.length > 0) {
        // 権限のないアイテムがある場合は警告
        if (nonEditableItems.length === selectedItems.length) {
            showToast('選択したアイテムを削除する権限がありません', 'warning');
            return;
        } else {
            showToast(`${nonEditableItems.length}個のアイテムは削除できません（権限なし）`, 'warning');
            // 権限のあるアイテムだけを対象に実行
            selectedItems = selectedItems.filter(id => !nonEditableItems.some(item => item.id === id));
        }
    }
    
    // 件数表示
    const countStr = `${selectedItems.length}個の項目`;
    
    if (currentView === 'trashed') {
        // ゴミ箱からの完全削除
        batchPermanentDeleteMessage.textContent = `${countStr}を完全に削除しますか？この操作は取り消せません。`;
        batchPermanentDeleteModal.classList.add('show');
    } else {
        // ゴミ箱への移動
        batchDeleteMessage.textContent = `${countStr}をゴミ箱に移動しますか？`;
        batchDeleteModal.classList.add('show');
    }
}

// ファイル名変更処理
async function renameFile() {
    const fileId = renameFileId.value;
    const fileType = renameFileType.value;
    const name = newName.value.trim();
    
    if (!name) {
        showToast('名前を入力してください', 'error');
        return;
    }
    
    try {
        const collection = fileType === 'folder' ? 'folders' : 'files';
        const docRef = db.collection(collection).doc(fileId);
        
        // ファイル情報を取得（権限チェックのため）
        const docSnapshot = await docRef.get();
        if (!docSnapshot.exists) {
            showToast('ファイルが見つかりません', 'error');
            return;
        }
        
        const fileData = { id: docSnapshot.id, ...docSnapshot.data() };
        if (!canUserEdit(fileData)) {
            showToast('このファイルの名前を変更する権限がありません', 'error');
            return;
        }
        
        await docRef.update({
            name: name,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('名前を変更しました', 'success');
        
        // モーダルを閉じる
        closeModal(renameModal);
        
        // 現在プレビュー中のファイルの場合はプレビューを更新
        if (currentPreviewFile && currentPreviewFile.id === fileId) {
            currentPreviewFile.name = name;
            showFilePreview(currentPreviewFile);
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // フォルダの場合はフォルダ一覧も更新
        if (fileType === 'folder') {
            folderNameMap[fileId] = name;
            loadFolders();
        }
    } catch (error) {
        console.error("名前変更エラー:", error);
        showToast('名前を変更できませんでした', 'error');
    }
}

// 共有設定変更処理
async function updateShareSettings() {
    const fileId = shareFileId.value;
    const fileType = shareFileType.value;
    const visibility = shareVisibility.value;
    
    try {
        const collection = fileType === 'folder' ? 'folders' : 'files';
        const docRef = db.collection(collection).doc(fileId);
        
        // ファイル情報を取得（権限チェックのため）
        const docSnapshot = await docRef.get();
        if (!docSnapshot.exists) {
            showToast('ファイルが見つかりません', 'error');
            return;
        }
        
        const fileData = { id: docSnapshot.id, ...docSnapshot.data() };
        if (!canUserEdit(fileData)) {
            showToast('このファイルの共有設定を変更する権限がありません', 'error');
            return;
        }
        
        const updateData = {
            visibility: visibility,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // 選択されたユーザーIDを取得
        // 共有設定変更処理（続き）
        // 選択されたユーザーIDを取得
        if (visibility === 'shared') {
            const sharedWith = Array.from(selectedUserIds);
            updateData.sharedWith = sharedWith;
        } else {
            // 個人用または公開の場合は共有ユーザーリストをクリア
            updateData.sharedWith = [];
        }
        
        await docRef.update(updateData);
        
        showToast('共有設定を更新しました', 'success');
        
        // モーダルを閉じる
        closeModal(shareModal);
        
        // 現在プレビュー中のファイルの場合はプレビューを更新
        if (currentPreviewFile && currentPreviewFile.id === fileId) {
            currentPreviewFile.visibility = visibility;
            currentPreviewFile.sharedWith = updateData.sharedWith;
            showFilePreview(currentPreviewFile);
        }
        
        // ファイル/フォルダ一覧再読み込み
        loadFiles();
        if (fileType === 'folder') {
            loadFolders();
        }
    } catch (error) {
        console.error("共有設定変更エラー:", error);
        showToast('共有設定を更新できませんでした', 'error');
    }
}

// ファイル移動処理
async function moveFile() {
    const fileId = moveFileId.value;
    const fileType = moveFileType.value;
    const destination = moveDestination.value;
    
    try {
        const collection = fileType === 'folder' ? 'folders' : 'files';
        const docRef = db.collection(collection).doc(fileId);
        
        // ファイル情報を取得（権限チェックのため）
        const docSnapshot = await docRef.get();
        if (!docSnapshot.exists) {
            showToast('ファイルが見つかりません', 'error');
            return;
        }
        
        const fileData = { id: docSnapshot.id, ...docSnapshot.data() };
        if (!canUserEdit(fileData)) {
            showToast('このファイルを移動する権限がありません', 'error');
            return;
        }
        
        // 移動先フォルダの共有設定を取得
        let destVisibility = 'personal'; // デフォルト
        let destSharedWith = [];
        
        if (destination !== 'root') {
            const destFolderDoc = await db.collection('folders').doc(destination).get();
            
            if (destFolderDoc.exists) {
                const destFolderData = destFolderDoc.data();
                destVisibility = destFolderData.visibility || 'personal';
                destSharedWith = destFolderData.sharedWith || [];
            }
        }
        
        // 移動先フォルダの共有設定を適用
        await docRef.update({
            parentFolder: destination,
            visibility: destVisibility,
            sharedWith: destSharedWith,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('ファイルを移動しました', 'success');
        
        // モーダルを閉じる
        closeModal(moveModal);
        
        // 現在プレビュー中のファイルの場合はプレビューを非表示にして一覧に戻る
        if (currentPreviewFile && currentPreviewFile.id === fileId) {
            hideFilePreview();
        }
        
        // ファイル一覧再読み込み
        loadFiles();
    } catch (error) {
        console.error("ファイル移動エラー:", error);
        showToast('ファイルを移動できませんでした', 'error');
    }
}

// 一括移動処理
async function batchMove() {
    const destinationFolder = batchMoveDestination.value;
    
    try {
        if (selectedItems.length === 0) {
            showToast('選択されたアイテムがありません', 'warning');
            return;
        }
        
        // 移動先フォルダの共有設定を取得
        let destVisibility = 'personal'; // デフォルト
        let destSharedWith = [];
        
        if (destinationFolder !== 'root') {
            const destFolderDoc = await db.collection('folders').doc(destinationFolder).get();
            
            if (destFolderDoc.exists) {
                const destFolderData = destFolderDoc.data();
                destVisibility = destFolderData.visibility || 'personal';
                destSharedWith = destFolderData.sharedWith || [];
            }
        }

        
        
        // すべての選択アイテムを移動
        const movePromises = [];
        let processedCount = 0;
        
        for (const itemId of selectedItems) {
            // 選択されたアイテムが何かを判断
            const itemElement = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
            if (!itemElement) continue;
            
            const itemType = itemElement.getAttribute('data-type');
            const collection = itemType === 'folder' ? 'folders' : 'files';
            
            // 自分自身を自分の中に移動できないように
            if (itemType === 'folder' && itemId === destinationFolder) {
                continue;
            }
            
            try {
                // アイテムデータを取得して権限チェック
                const docRef = db.collection(collection).doc(itemId);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) continue;
                
                const itemData = { id: docSnapshot.id, ...docSnapshot.data() };
                
                // 編集権限をチェック
                if (!canUserEdit(itemData)) {
                    continue;
                }
                
                // 移動処理 - 共有設定も更新
                movePromises.push(docRef.update({
                    parentFolder: destinationFolder,
                    visibility: destVisibility,
                    sharedWith: destSharedWith,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }));
                
                processedCount++;
            } catch (error) {
                console.warn(`アイテム移動エラー (${itemId}):`, error);
            }
        }
        
        // すべての移動処理を実行
        await Promise.all(movePromises);
        
        showToast(`${processedCount}個のアイテムを移動しました`, 'success');
        
        // 選択をクリア
        clearSelection();
        
        // 現在プレビュー中のファイルの場合はプレビューを非表示にして一覧に戻る
        if (currentPreviewFile && selectedItems.includes(currentPreviewFile.id)) {
            hideFilePreview();
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // モーダルを閉じる
        closeModal(batchMoveModal);
    } catch (error) {
        console.error("一括移動エラー:", error);
        showToast('一部のアイテムを移動できませんでした', 'error');
    }
}

// 一括共有設定処理
async function batchShare() {
    const visibility = batchShareVisibility.value;
    
    try {
        if (selectedItems.length === 0) {
            showToast('選択されたアイテムがありません', 'warning');
            return;
        }
        
        // 共有ユーザーリスト取得
        let sharedWith = [];
        if (visibility === 'shared') {
            sharedWith = Array.from(selectedUserIds);
        }
        
        // すべての選択アイテムを共有設定変更
        const sharePromises = [];
        let processedCount = 0;
        
        for (const itemId of selectedItems) {
            // 選択されたアイテムが何かを判断
            const itemElement = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
            if (!itemElement) continue;
            
            const itemType = itemElement.getAttribute('data-type');
            const collection = itemType === 'folder' ? 'folders' : 'files';
            
            try {
                // アイテムデータを取得して権限チェック
                const docRef = db.collection(collection).doc(itemId);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) continue;
                
                const itemData = { id: docSnapshot.id, ...docSnapshot.data() };
                
                // 編集権限をチェック
                if (!canUserEdit(itemData)) {
                    continue;
                }
                
                // 共有設定更新
                sharePromises.push(docRef.update({
                    visibility: visibility,
                    sharedWith: visibility === 'shared' ? sharedWith : [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }));
                
                processedCount++;
            } catch (error) {
                console.warn(`共有設定変更エラー (${itemId}):`, error);
            }
        }
        
        // すべての共有設定処理を実行
        await Promise.all(sharePromises);
        
        showToast(`${processedCount}個のアイテムの共有設定を更新しました`, 'success');
        
        // 選択をクリア
        clearSelection();
        
        // 現在プレビュー中のファイルの場合はプレビューを更新
        if (currentPreviewFile && selectedItems.includes(currentPreviewFile.id)) {
            currentPreviewFile.visibility = visibility;
            currentPreviewFile.sharedWith = visibility === 'shared' ? sharedWith : [];
            showFilePreview(currentPreviewFile);
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // モーダルを閉じる
        closeModal(batchShareModal);
        
        // フォルダが含まれていたら、フォルダ一覧も更新
        const containsFolder = selectedItems.some(itemId => {
            const item = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
            return item && item.getAttribute('data-type') === 'folder';
        });
        
        if (containsFolder) {
            loadFolders();
        }
    } catch (error) {
        console.error("一括共有設定エラー:", error);
        showToast('一部のアイテムの共有設定を更新できませんでした', 'error');
    }
}

// ゴミ箱へ移動（論理削除）
async function moveToTrash() {
    const fileId = deleteFileId.value;
    const fileType = deleteFileType.value;
    
    try {
        const collection = fileType === 'folder' ? 'folders' : 'files';
        const docRef = db.collection(collection).doc(fileId);
        
        // ファイル情報を取得（権限チェックのため）
        const docSnapshot = await docRef.get();
        if (!docSnapshot.exists) {
            showToast('ファイルが見つかりません', 'error');
            return;
        }
        
        const fileData = { id: docSnapshot.id, ...docSnapshot.data() };
        if (!canUserEdit(fileData)) {
            showToast('このファイルを削除する権限がありません', 'error');
            return;
        }
        
        await docRef.update({
            trashed: true,
            trashedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('ゴミ箱に移動しました', 'success');
        
        // モーダルを閉じる
        closeModal(deleteModal);
        
        // 現在プレビュー中のファイルの場合はプレビューを非表示にして一覧に戻る
        if (currentPreviewFile && currentPreviewFile.id === fileId) {
            hideFilePreview();
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // フォルダの場合はフォルダ一覧も更新
        if (fileType === 'folder') {
            loadFolders();
        }
    } catch (error) {
        console.error("ゴミ箱移動エラー:", error);
        showToast('ゴミ箱に移動できませんでした', 'error');
    }
}

// 一括削除処理
async function batchDelete() {
    try {
        if (selectedItems.length === 0) {
            showToast('選択されたアイテムがありません', 'warning');
            return;
        }
        
        // ゴミ箱への移動か完全削除かを判断
        const isPermanentDelete = currentView === 'trashed';
        
        // すべての選択アイテムを処理
        const deletePromises = [];
        let processedCount = 0;
        let containsFolder = false;
        
        for (const itemId of selectedItems) {
            // 選択されたアイテムが何かを判断
            const itemElement = document.querySelector(`.file-card[data-id="${itemId}"], .file-list-item[data-id="${itemId}"]`);
            if (!itemElement) continue;
            
            const itemType = itemElement.getAttribute('data-type');
            const collection = itemType === 'folder' ? 'folders' : 'files';
            
            if (itemType === 'folder') {
                containsFolder = true;
            }
            
            try {
                // アイテムデータを取得して権限チェック
                const docRef = db.collection(collection).doc(itemId);
                const docSnapshot = await docRef.get();
                
                if (!docSnapshot.exists) continue;
                
                const itemData = { id: docSnapshot.id, ...docSnapshot.data() };
                
                if (isPermanentDelete) {
                    // 完全削除の場合は所有者のみ可能
                    if (!canUserPermanentDelete(itemData)) {
                        continue;
                    }
                    
                    // ファイルの場合はストレージからも削除
                    if (itemType === 'file' && itemData.storagePath) {
                        try {
                            await storage.ref(itemData.storagePath).delete();
                        } catch (storageError) {
                            console.warn("ストレージ削除エラー:", storageError);
                        }
                    }
                    
                    // Firestoreからドキュメント削除
                    deletePromises.push(docRef.delete());
                } else {
                    // ゴミ箱への移動は編集権限が必要
                    if (!canUserEdit(itemData)) {
                        continue;
                    }
                    
                    // ゴミ箱に移動
                    deletePromises.push(docRef.update({
                        trashed: true,
                        trashedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }));
                }
                
                processedCount++;
            } catch (error) {
                console.warn(`削除処理エラー (${itemId}):`, error);
            }
        }
        
        // すべての削除処理を実行
        await Promise.all(deletePromises);
        
        const actionText = isPermanentDelete ? '完全に削除' : 'ゴミ箱に移動';
        showToast(`${processedCount}個のアイテムを${actionText}しました`, 'success');
        
        // 選択をクリア
        clearSelection();
        
        // 現在プレビュー中のファイルの場合はプレビューを非表示にして一覧に戻る
        if (currentPreviewFile && selectedItems.includes(currentPreviewFile.id)) {
            hideFilePreview();
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // フォルダが含まれていたら、フォルダ一覧も更新
        if (containsFolder) {
            loadFolders();
        }
        
        // モーダルを閉じる
        if (isPermanentDelete) {
            closeModal(batchPermanentDeleteModal);
        } else {
            closeModal(batchDeleteModal);
        }
        
        // 完全削除の場合はストレージ使用量更新
        if (isPermanentDelete) {
            fetchStorageUsage();
        }
    } catch (error) {
        console.error("一括削除エラー:", error);
        showToast('一部のアイテムを処理できませんでした', 'error');
    }
}

// 完全削除処理
async function permanentDelete() {
    const fileId = permanentDeleteFileId.value;
    const fileType = permanentDeleteFileType.value;
    
    try {
        const collection = fileType === 'folder' ? 'folders' : 'files';
        const docRef = db.collection(collection).doc(fileId);
        
        // ファイル情報を取得
        const docSnapshot = await docRef.get();
        if (!docSnapshot.exists) {
            showToast('ファイルが見つかりません', 'error');
            return;
        }
        
        const fileData = { id: docSnapshot.id, ...docSnapshot.data() };
        
        // 完全削除の権限チェック（所有者のみ）
        if (!canUserPermanentDelete(fileData)) {
            showToast('このファイルを完全に削除する権限がありません', 'error');
            return;
        }
        
        // ファイルの場合はストレージからも削除
        if (fileType === 'file' && fileData.storagePath) {
            try {
                await storage.ref(fileData.storagePath).delete();
            } catch (storageError) {
                console.error("ストレージ削除エラー:", storageError);
                // ストレージ削除に失敗してもFirestoreからの削除は継続
            }
        }
        
        // Firestoreからドキュメント削除
        await docRef.delete();
        
        showToast('完全に削除しました', 'success');
        
        // モーダルを閉じる
        closeModal(permanentDeleteModal);
        
        // 現在プレビュー中のファイルの場合はプレビューを非表示にして一覧に戻る
        if (currentPreviewFile && currentPreviewFile.id === fileId) {
            hideFilePreview();
        }
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // フォルダの場合はフォルダ一覧も更新
        if (fileType === 'folder') {
            loadFolders();
        }
        
        // ストレージ使用量更新
        fetchStorageUsage();
    } catch (error) {
        console.error("完全削除エラー:", error);
        showToast('削除できませんでした', 'error');
    }
}

// ゴミ箱から復元
async function restoreFromTrash(file) {
    try {
        // 所有者だけがゴミ箱から復元可能
        if (file.userId !== currentUser.uid) {
            showToast('このファイルを復元する権限がありません', 'warning');
            return;
        }
        
        const docRef = file.isFolder
            ? db.collection('folders').doc(file.id)
            : db.collection('files').doc(file.id);
        
        await docRef.update({
            trashed: false,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast(`「${file.name}」を復元しました`, 'success');
        
        // ファイル一覧再読み込み
        loadFiles();
        
        // フォルダの場合はフォルダ一覧も更新
        if (file.isFolder) {
            loadFolders();
        }
    } catch (error) {
        console.error("復元エラー:", error);
        showToast('復元できませんでした', 'error');
    }
}

// 新規フォルダ作成処理
async function createFolder() {
    const name = folderName.value.trim();
    const parent = parentFolder.value;
    const visibility = folderVisibility.value;
    
    if (!name) {
        showToast('フォルダ名を入力してください', 'error');
        return;
    }
    
    try {
        // 選択されたユーザーIDを取得（共有設定の場合）
        let sharedWith = [];
        if (visibility === 'shared') {
            sharedWith = Array.from(selectedUserIds);
        }
        
        // フォルダ作成
        const folderData = {
            name: name,
            parentFolder: parent,
            userId: currentUser.uid,
            ownerName: currentUser.displayName || '',
            visibility: visibility,
            sharedWith: sharedWith,
            trashed: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const docRef = await db.collection('folders').add(folderData);
        
        // フォルダ名をマッピングに追加
        folderNameMap[docRef.id] = name;
        
        showToast(`フォルダ「${name}」を作成しました`, 'success');
        
        // モーダルを閉じる
        closeModal(folderModal);
        folderName.value = '';
        
        // フォルダとファイル一覧再読み込み
        loadFolders();
        
        // 現在のフォルダが作成先の親フォルダと同じ場合は一覧を更新
        if (currentFolder === parent) {
            loadFiles();
        }
    } catch (error) {
        console.error("フォルダ作成エラー:", error);
        showToast('フォルダを作成できませんでした', 'error');
    }
}

// ファイルアップロード処理
async function uploadFiles(files) {
    if (!files || files.length === 0) {
        showToast('ファイルが選択されていません', 'error');
        return;
    }
    
    // アップロード先フォルダと共有設定
    const folder = uploadFolder.value;
    const visibility = uploadVisibility.value;
    
    // 選択されたユーザーIDを取得（共有設定の場合）
    let sharedWith = [];
    if (visibility === 'shared') {
        sharedWith = Array.from(selectedUserIds);
    }
    
    // プログレスコンテナ表示
    uploadProgressContainer.style.display = 'block';
    
    try {
        let successCount = 0;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ファイルサイズチェック
            const maxFileSize = 100 * 1024 * 1024; // 100MB
            if (file.size > maxFileSize) {
                showToast(`ファイル「${file.name}」は最大サイズ（100MB）を超えています`, 'warning');
                continue; // このファイルはスキップ
            }
            
            // アップロード中のファイル名とインデックスを表示
            uploadProgressText.textContent = `アップロード中: ${file.name} (${i + 1}/${files.length})`;
            
            // ファイルタイプの判定
            let fileType = 'other';
            if (file.type.startsWith('image/')) {
                fileType = 'image';
            } else if (file.type === 'application/pdf') {
                fileType = 'pdf';
            } else if (file.type.includes('document') || file.type.includes('text')) {
                fileType = 'document';
            }
            
            try {
                // Storageへアップロード
                const timestamp = new Date().getTime();
                const storagePath = `files/${currentUser.uid}/${timestamp}_${file.name}`;
                const storageRef = storage.ref(storagePath);
                const uploadTask = storageRef.put(file);
                
                // アップロードの進捗監視
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // 進捗状況
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgressBar.style.width = `${progress}%`;
                        
                        // 転送サイズ表示
                        const transferred = formatFileSize(snapshot.bytesTransferred);
                        const total = formatFileSize(snapshot.totalBytes);
                        uploadProgressSize.textContent = `${transferred} / ${total}`;
                    },
                    (error) => {
                        // エラー処理
                        console.error("アップロードエラー:", error);
                        showToast(`「${file.name}」のアップロードに失敗しました`, 'error');
                    }
                );
                
                // アップロード完了を待機
                await uploadTask;
                
                // ダウンロードURLを取得
                const downloadURL = await storageRef.getDownloadURL();
                
                // サムネイル作成（画像の場合）
                let thumbnail = null;
                if (fileType === 'image') {
                    thumbnail = downloadURL;
                }
                
                // Firestoreにファイル情報を保存
                const fileData = {
                    name: file.name,
                    originalName: file.name,
                    storagePath: storagePath,
                    url: downloadURL,
                    thumbnail: thumbnail,
                    fileType: fileType,
                    mimeType: file.type,
                    size: file.size,
                    parentFolder: folder,
                    userId: currentUser.uid,
                    ownerName: currentUser.displayName || '',
                    visibility: visibility,
                    sharedWith: sharedWith,
                    trashed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('files').add(fileData);
                successCount++;
            } catch (error) {
                console.error(`ファイル「${file.name}」の処理エラー:`, error);
                showToast(`ファイル「${file.name}」の処理に失敗しました`, 'error');
            }
        }
        
        // すべてのファイルのアップロード処理が完了
        if (successCount > 0) {
            showToast(`${successCount}個のファイルをアップロードしました`, 'success');
            
            // 現在のフォルダが作成先と同じ場合は一覧を更新
            if (currentFolder === folder) {
                loadFiles();
            }
            
            fetchStorageUsage();
        }
        
        // モーダルを閉じる
        closeModal(uploadModal);
        resetUploadForm();
    } catch (error) {
        console.error("アップロード処理エラー:", error);
        showToast('アップロード処理に失敗しました', 'error');
    }
}

// アップロードフォームのリセット
function resetUploadForm() {
    fileInput.value = '';
    uploadProgressContainer.style.display = 'none';
    uploadProgressBar.style.width = '0%';
    uploadProgressText.textContent = 'アップロード中 (0%)';
    uploadProgressSize.textContent = '0 KB / 0 KB';
    document.querySelector('.dropzone-text').textContent = 'ファイルをドラッグ＆ドロップするか、クリックして選択';
    
    // 共有ユーザーリストの選択をクリア
    selectedUserIds.clear();
    document.getElementById('upload-selected-users').innerHTML = '';
    document.getElementById('folder-selected-users').innerHTML = '';
}

// ローディング表示
function showLoading() {
    loadingState.style.display = 'flex';
    emptyState.style.display = 'none';
    fileGridContainer.style.display = 'none';
    fileListContainer.style.display = 'none';
}

// ローディング非表示
function hideLoading() {
    loadingState.style.display = 'none';
    
    if (currentViewMode === 'grid') {
        fileGridContainer.style.display = 'grid';
        fileListContainer.style.display = 'none';
    } else {
        fileGridContainer.style.display = 'none';
        fileListContainer.style.display = 'block';
    }
}

// 空の状態表示
function showEmptyState() {
    emptyState.style.display = 'flex';
    loadingState.style.display = 'none';
    fileGridContainer.style.display = 'none';
    fileListContainer.style.display = 'none';
}

// 空の状態非表示
function hideEmptyState() {
    emptyState.style.display = 'none';
}

// モーダル閉じる
function closeModal(modal) {
    modal.classList.remove('show');
}

// トースト通知表示
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let icon = '';
    switch (type) {
        case 'success':
            icon = '<i class="fas fa-check-circle toast-icon"></i>';
            break;
        case 'error':
            icon = '<i class="fas fa-exclamation-circle toast-icon"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>';
            break;
        default:
            icon = '<i class="fas fa-info-circle toast-icon"></i>';
    }
    
    toast.innerHTML = `${icon}<div>${message}</div>`;
    toastContainer.appendChild(toast);
    
    // 5秒後に自動的に削除
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// ファイルサイズのフォーマット
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ログアウト処理
async function logout() {
    try {
        await auth.signOut();
        window.location.href = 'login.html';
    } catch (error) {
        console.error("ログアウトエラー:", error);
        showToast('ログアウトに失敗しました', 'error');
    }
}

// テーマ切替
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    
    // アイコンとテキストを切り替え
    if (themeToggle) {
        if (savedTheme === 'dark') {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
        } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
        }
    }
}

function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // アイコンとテキストを切り替え
    if (themeToggle) {
        if (newTheme === 'dark') {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
        } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
        }
    }
}

// サイドバー切替（モバイル用）
function toggleSidebar() {
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
}

// ファイルリスト表示切替
function toggleViewMode(mode) {
    currentViewMode = mode;
    
    if (mode === 'grid') {
        fileGridContainer.style.display = 'grid';
        fileListContainer.style.display = 'none';
        viewGridBtn.classList.add('active');
        viewListBtn.classList.remove('active');
    } else {
        fileGridContainer.style.display = 'none';
        fileListContainer.style.display = 'block';
        viewGridBtn.classList.remove('active');
        viewListBtn.classList.add('active');
    }
    
    localStorage.setItem('fileViewMode', mode);
}

// コピーリンクのクリップボードへのコピー
function copyShareLink() {
    shareLink.select();
    document.execCommand('copy');
    showToast('リンクをコピーしました', 'success');
}

// 検索機能
function searchFiles() {
    loadFiles();
}

// ドラッグ&ドロップイベント処理
function setupDragAndDrop() {
    // ファイルドロップイベント
    uploadDropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadDropzone.classList.add('dropping');
    });
    
    uploadDropzone.addEventListener('dragleave', () => {
        uploadDropzone.classList.remove('dropping');
    });
    
    uploadDropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadDropzone.classList.remove('dropping');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.querySelector('.dropzone-text').textContent = 
                files.length === 1 ? 
                files[0].name :
                `${files.length}個のファイルが選択されました`;
            
            // ファイル入力にドロップされたファイルをセット
            fileInput.files = files;
        }
    });
    
    // クリック時にファイル選択ダイアログを開く
    uploadDropzone.addEventListener('click', () => {
        fileInput.click();
    });
}

// DOM要素の参照取得
const sidebarUserName = document.getElementById('sidebar-user-name');
const userInitial = document.getElementById('user-initial');
const userAvatar = document.getElementById('user-avatar');
const logoutBtn = document.getElementById('logout-btn');
const themeToggle = document.getElementById('theme-toggle');
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');

// ファイル管理
const fileTabs = document.querySelectorAll('.file-tab');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const fileGridContainer = document.getElementById('file-grid');
const fileListContainer = document.getElementById('file-list');
const folderListContainer = document.getElementById('folder-list');
const viewGridBtn = document.getElementById('view-grid-btn');
const viewListBtn = document.getElementById('view-list-btn');
const sortSelect = document.getElementById('sort-select');
const fileSearchInput = document.getElementById('file-search-input');
const emptyState = document.getElementById('empty-state');
const loadingState = document.getElementById('loading-state');
const emptyUploadBtn = document.getElementById('empty-upload-btn');

// 選択関連
const selectionBar = document.getElementById('selection-bar');
const selectionCount = document.getElementById('selection-count');
const selectAllCheckbox = document.getElementById('select-all-checkbox');
const listSelectAllCheckbox = document.getElementById('list-select-all-checkbox');
const deselectAllBtn = document.getElementById('deselect-all-btn');
const moveSelectedBtn = document.getElementById('move-selected-btn');
const shareSelectedBtn = document.getElementById('share-selected-btn');
const deleteSelectedBtn = document.getElementById('delete-selected-btn');

// ファイルプレビュー
const fileViewContainer = document.getElementById('file-view-container');
const filePreview = document.getElementById('file-preview');
const fileInfo = document.getElementById('file-info');
const fileActions = document.getElementById('file-actions');
const backNavigation = document.getElementById('back-navigation');

// モーダル要素
const uploadModal = document.getElementById('upload-modal');
const folderModal = document.getElementById('folder-modal');
const renameModal = document.getElementById('rename-modal');
const shareModal = document.getElementById('share-modal');
const moveModal = document.getElementById('move-modal');
const deleteModal = document.getElementById('delete-modal');
const batchMoveModal = document.getElementById('batch-move-modal');
const batchShareModal = document.getElementById('batch-share-modal');
const batchDeleteModal = document.getElementById('batch-delete-modal');
const permanentDeleteModal = document.getElementById('permanent-delete-modal');
const batchPermanentDeleteModal = document.getElementById('batch-permanent-delete-modal');
const imagePreviewModal = document.getElementById('image-preview-modal');

// フォーム要素
const uploadFolder = document.getElementById('upload-folder');
const uploadVisibility = document.getElementById('upload-visibility');
const uploadSubmit = document.getElementById('upload-submit');
const fileInput = document.getElementById('file-input');
const uploadDropzone = document.getElementById('upload-dropzone');
const shareUsersContainer = document.getElementById('share-users-container');
const sharedUserList = document.getElementById('shared-user-list');

const folderName = document.getElementById('folder-name');
const parentFolder = document.getElementById('parent-folder');
const folderVisibility = document.getElementById('folder-visibility');
const folderShareUsers = document.getElementById('folder-share-users');
const folderSharedUserList = document.getElementById('folder-shared-user-list');
const folderSubmit = document.getElementById('folder-submit');

const newName = document.getElementById('new-name');
const renameFileId = document.getElementById('rename-file-id');
const renameFileType = document.getElementById('rename-file-type');
const renameSubmit = document.getElementById('rename-submit');

const shareVisibility = document.getElementById('share-visibility');
const shareFileId = document.getElementById('share-file-id');
const shareFileType = document.getElementById('share-file-type');
const shareSettingsUsers = document.getElementById('share-settings-users');
const shareSettingsUserList = document.getElementById('share-settings-user-list');
const shareLinkContainer = document.getElementById('share-link-container');
const shareLink = document.getElementById('share-link');
const copyLinkBtn = document.getElementById('copy-link-btn');
const shareSubmit = document.getElementById('share-submit');

const moveDestination = document.getElementById('move-destination');
const moveFileId = document.getElementById('move-file-id');
const moveFileType = document.getElementById('move-file-type');
const moveSubmit = document.getElementById('move-submit');

const batchMoveDestination = document.getElementById('batch-move-destination');
const batchMoveSubmit = document.getElementById('batch-move-submit');

const deleteMessage = document.getElementById('delete-message');
const deleteFileId = document.getElementById('delete-file-id');
const deleteFileType = document.getElementById('delete-file-type');
const deleteSubmit = document.getElementById('delete-submit');

const batchDeleteMessage = document.getElementById('batch-delete-message');
const batchDeleteSubmit = document.getElementById('batch-delete-submit');

const permanentDeleteMessage = document.getElementById('permanent-delete-message');
const permanentDeleteFileId = document.getElementById('permanent-delete-file-id');
const permanentDeleteFileType = document.getElementById('permanent-delete-file-type');
const permanentDeleteSubmit = document.getElementById('permanent-delete-submit');

const batchPermanentDeleteMessage = document.getElementById('batch-permanent-delete-message');
const batchPermanentDeleteSubmit = document.getElementById('batch-permanent-delete-submit');

const batchShareInfo = document.getElementById('batch-share-info');
const batchShareVisibility = document.getElementById('batch-share-visibility');
const batchShareUsers = document.getElementById('batch-share-users');
const batchSharedUserList = document.getElementById('batch-shared-user-list');
const batchShareSubmit = document.getElementById('batch-share-submit');

const previewImage = document.getElementById('preview-image');
const openEditorBtn = document.getElementById('open-editor-btn');
const downloadPreviewBtn = document.getElementById('download-preview-btn');
const closePreviewBtn = document.querySelector('.close-preview');

const contextMenu = document.getElementById('context-menu');
const breadcrumbContainer = document.getElementById('breadcrumb-container');
const toastContainer = document.getElementById('toast-container');

const uploadProgressContainer = document.getElementById('upload-progress-container');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const uploadProgressText = document.getElementById('upload-progress-text');
const uploadProgressSize = document.getElementById('upload-progress-size');

const storageBadge = document.getElementById('storage-badge');
const storageProgress = document.getElementById('storage-progress');
const storageUsed = document.getElementById('storage-used');
const storageTotal = document.getElementById('storage-total');

const uploadBtn = document.getElementById('upload-btn');
const newFolderBtn = document.getElementById('new-folder-btn');

// 共有/ユーザー検索関連
const sharedUserSearch = document.getElementById('shared-user-search');
const folderSharedUserSearch = document.getElementById('folder-shared-user-search');
const shareSettingsUserSearch = document.getElementById('share-settings-user-search');
const batchSharedUserSearch = document.getElementById('batch-shared-user-search');

// イベントリスナー登録
document.addEventListener('DOMContentLoaded', () => {
    // テーマ初期化
    initTheme();
    
    // 保存されているビューモード復元
    const savedViewMode = localStorage.getItem('fileViewMode') || 'grid';
    toggleViewMode(savedViewMode);
    
    // 戻るボタン
    if (backNavigation) {
        backNavigation.addEventListener('click', () => {
            hideFilePreview();
        });
    }
    
    // 画像プレビューモーダルの閉じるボタン
    if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', () => {
            imagePreviewModal.classList.remove('show');
        });
    }
    
    // 画像プレビューモーダル背景クリックで閉じる
    if (imagePreviewModal) {
        imagePreviewModal.addEventListener('click', (e) => {
            if (e.target === imagePreviewModal) {
                imagePreviewModal.classList.remove('show');
            }
        });
    }
    
    // 活字化エディタで開くボタン
    if (openEditorBtn) {
        openEditorBtn.addEventListener('click', () => {
            if (currentPreviewFile && currentPreviewFile.fileType === 'image') {
                openInEditor(currentPreviewFile);
            }
        });
    }
    
    // ダウンロードボタン
    if (downloadPreviewBtn) {
        downloadPreviewBtn.addEventListener('click', () => {
            if (currentPreviewFile) {
                downloadFile(currentPreviewFile);
            }
        });
    }
    
    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (imagePreviewModal && imagePreviewModal.classList.contains('show')) {
                imagePreviewModal.classList.remove('show');
            }
            
            document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                closeModal(modal);
            });
        }
    });
    
    // ファイルタブクリック
    fileTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // アクティブタブの切り替え
            fileTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // 表示モード切替
            currentView = tab.getAttribute('data-view');
            
            // タブ切替時はルートフォルダに戻る
            currentFolder = 'root';
            folderHistory = [];
            
            // ファイルプレビューを非表示
            hideFilePreview();
            
            loadFiles();
        });
    });
    
    // サイドバーアイテムクリック（ファイルタイプ）
    sidebarItems.forEach(item => {
        if (item.hasAttribute('data-type')) {
            item.addEventListener('click', () => {
                // アクティブアイテムの切り替え
                sidebarItems.forEach(i => {
                    if (i.hasAttribute('data-type')) {
                        i.classList.remove('active');
                    }
                });
                item.classList.add('active');
                
                // ファイルタイプ切替
                currentFileType = item.getAttribute('data-type');
                loadFiles();
            });
        }
    });
    
    // 選択関連のイベントリスナー
    // 全選択チェックボックス
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('click', () => toggleSelectAll());
    }
    
    if (listSelectAllCheckbox) {
        listSelectAllCheckbox.addEventListener('click', () => toggleSelectAll());
    }
    
    // 選択解除ボタン
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', clearSelection);
    }
    
    // 一括移動ボタン
    if (moveSelectedBtn) {
        moveSelectedBtn.addEventListener('click', showBatchMoveModal);
    }
    
    // 一括共有ボタン
    if (shareSelectedBtn) {
        shareSelectedBtn.addEventListener('click', showBatchShareModal);
    }
    
    // 一括削除ボタン
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', showBatchDeleteModal);
    }
    
    // ビュー切替ボタン
    if (viewGridBtn) {
        viewGridBtn.addEventListener('click', () => toggleViewMode('grid'));
    }
    
    if (viewListBtn) {
        viewListBtn.addEventListener('click', () => toggleViewMode('list'));
    }
    
    // ソート変更
    if (sortSelect) {
        sortSelect.addEventListener('change', () => loadFiles());
    }
    
    // 検索入力
    if (fileSearchInput) {
        fileSearchInput.addEventListener('input', () => {
            // 入力中は少し遅延させる
            clearTimeout(fileSearchInput.searchTimeout);
            fileSearchInput.searchTimeout = setTimeout(searchFiles, 300);
        });
    }
    
    // 空の状態からのアップロードボタン
    if (emptyUploadBtn) {
        emptyUploadBtn.addEventListener('click', () => {
            if (uploadModal) uploadModal.classList.add('show');
        });
    }
    
    // アップロードボタン
    if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
            if (uploadModal) uploadModal.classList.add('show');
        });
    }
    
    // 新規フォルダボタン
    if (newFolderBtn) {
        newFolderBtn.addEventListener('click', () => {
            if (folderModal) folderModal.classList.add('show');
        });
    }
    
    // 共有設定変更時のUI更新
    if (uploadVisibility) {
        uploadVisibility.addEventListener('change', () => {
            if (uploadVisibility.value === 'shared' && shareUsersContainer) {
                shareUsersContainer.style.display = 'block';
            } else if (shareUsersContainer) {
                shareUsersContainer.style.display = 'none';
            }
        });
    }
    
    if (folderVisibility) {
        folderVisibility.addEventListener('change', () => {
            if (folderVisibility.value === 'shared' && folderShareUsers) {
                folderShareUsers.style.display = 'block';
            } else if (folderShareUsers) {
                folderShareUsers.style.display = 'none';
            }
        });
    }
    
    if (shareVisibility) {
        shareVisibility.addEventListener('change', updateShareModalUI);
    }
    
    if (batchShareVisibility) {
        batchShareVisibility.addEventListener('change', () => {
            if (batchShareVisibility.value === 'shared' && batchShareUsers) {
                batchShareUsers.style.display = 'block';
            } else if (batchShareUsers) {
                batchShareUsers.style.display = 'none';
            }
        });
    }
    
    // ユーザー検索
    if (sharedUserSearch) {
        sharedUserSearch.addEventListener('input', () => {
            updateUserList(sharedUserList, 'upload', sharedUserSearch.value);
        });
    }
    
    if (folderSharedUserSearch) {
        folderSharedUserSearch.addEventListener('input', () => {
            updateUserList(folderSharedUserList, 'folder', folderSharedUserSearch.value);
        });
    }
    
    if (shareSettingsUserSearch) {
        shareSettingsUserSearch.addEventListener('input', () => {
            updateUserList(shareSettingsUserList, 'share', shareSettingsUserSearch.value);
        });
    }
    
    if (batchSharedUserSearch) {
        batchSharedUserSearch.addEventListener('input', () => {
            updateUserList(batchSharedUserList, 'batch', batchSharedUserSearch.value);
        });
    }
    
    // コピーリンクボタン
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', copyShareLink);
    }
    
    // ファイル選択イベント
    if (fileInput) {
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileCount = fileInput.files.length;
                const fileLabel = fileCount === 1 
                    ? fileInput.files[0].name
                    : `${fileCount}個のファイルが選択されました`;
                    
                const dropzoneText = document.querySelector('.dropzone-text');
                if (dropzoneText) {
                    dropzoneText.textContent = fileLabel;
                }
            }
        });
    }
    
    // アップロード実行
    if (uploadSubmit) {
        uploadSubmit.addEventListener('click', () => {
            if (fileInput && fileInput.files.length > 0) {
                uploadFiles(fileInput.files);
            } else {
                showToast('ファイルを選択してください', 'warning');
            }
        });
    }
    
    // フォルダ作成実行
    if (folderSubmit) {
        folderSubmit.addEventListener('click', createFolder);
    }
    
    // 名前変更実行
    if (renameSubmit) {
        renameSubmit.addEventListener('click', renameFile);
    }
    
    // 共有設定更新実行
    if (shareSubmit) {
        shareSubmit.addEventListener('click', updateShareSettings);
    }
    
    // 一括共有設定実行
    if (batchShareSubmit) {
        batchShareSubmit.addEventListener('click', batchShare);
    }
    
    // ファイル移動実行
    if (moveSubmit) {
        moveSubmit.addEventListener('click', moveFile);
    }
    
    // 一括移動実行
    if (batchMoveSubmit) {
        batchMoveSubmit.addEventListener('click', batchMove);
    }
    
    // 削除実行
    if (deleteSubmit) {
        deleteSubmit.addEventListener('click', moveToTrash);
    }
    
    // 一括削除実行
    if (batchDeleteSubmit) {
        batchDeleteSubmit.addEventListener('click', batchDelete);
    }
    
    // 完全削除実行
    if (permanentDeleteSubmit) {
        permanentDeleteSubmit.addEventListener('click', permanentDelete);
    }
    
    // 一括完全削除実行
    if (batchPermanentDeleteSubmit) {
        batchPermanentDeleteSubmit.addEventListener('click', batchDelete);
    }
    
    // モーダルを閉じるボタン
    document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal-overlay');
            closeModal(modal);
        });
    });
    
    // モーダル外クリックで閉じる
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });
    
    // ドラッグ&ドロップ設定
    setupDragAndDrop();
    
    // ログアウトボタン
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }
    
    // テーマ切替ボタン
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
    
    // サイドバー切替ボタン
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // 画面クリックでサイドバーを閉じる（モバイル用）
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && 
            sidebar && 
            sidebar.classList.contains('active') && 
            !sidebar.contains(e.target) && 
            e.target !== sidebarToggle) {
            sidebar.classList.remove('active');
        }
    });
});

// 認証状態の監視
auth.onAuthStateChanged(async user => {
    try {
        if (user) {
            // ユーザーがログインしている場合
            console.log("ログイン中:", user.uid);
            currentUser = user;
            
            // 初期設定を実行
            await setupInitialUser(user);
            
            // ユーザー情報を取得して表示
            await fetchUserData(user.uid);
            
            // 各種データ読み込み
            Promise.all([
                loadFolders().catch(err => {
                    console.error("フォルダ読み込みエラー:", err);
                    showToast('フォルダの読み込みに失敗しました', 'warning');
                }),
                
                loadUsers().catch(err => {
                    console.error("ユーザー読み込みエラー:", err);
                    showToast('ユーザー一覧の読み込みに失敗しました', 'warning');
                }),
                
                fetchStorageUsage().catch(err => {
                    console.error("使用量取得エラー:", err);
                })
            ]).then(() => {
                // すべての初期データ読み込み後にファイル一覧を表示
                loadFiles().catch(err => {
                    console.error("ファイル読み込みエラー:", err);
                    showToast('ファイルの読み込みに失敗しました', 'error');
                    hideLoading();
                    showEmptyState();
                });
            });
        } else {
            // ログインしていない場合はログインページにリダイレクト
            window.location.href = 'login.html';
        }
    } catch (error) {
        console.error("認証処理エラー:", error);
        showToast('認証処理に失敗しました。ページを再読み込みしてください。', 'error');
    }
});
// フォルダ一覧の取得（サイドバー用）
async function loadFolders() {
    try {
        // フォルダリストの初期化
        const folderListOptions = {
            root: 'ルート'
        };
        
        // モーダル内のフォルダリストをクリア
        if (uploadFolder) uploadFolder.innerHTML = '<option value="root">ルート</option>';
        if (parentFolder) parentFolder.innerHTML = '<option value="root">ルート</option>';
        if (moveDestination) moveDestination.innerHTML = '<option value="root">ルート</option>';
        if (batchMoveDestination) batchMoveDestination.innerHTML = '<option value="root">ルート</option>';
        
        // サイドバーが存在すれば初期化
        if (folderListContainer) {
            // ルートフォルダは常に表示
            const rootItem = document.createElement('li');
            rootItem.className = currentFolder === 'root' ? 'sidebar-item active' : 'sidebar-item';
            rootItem.setAttribute('data-folder', 'root');
            rootItem.innerHTML = '<i class="fas fa-folder"></i> ルート';
            rootItem.addEventListener('click', () => changeFolder('root'));
            
            // フォルダリストをクリア
            folderListContainer.innerHTML = '';
            folderListContainer.appendChild(rootItem);
        }
        
        try {
            // ユーザーのフォルダを取得（ゴミ箱以外）
            const myFoldersQuery = db.collection('folders')
                .where('userId', '==', currentUser.uid)
                .where('trashed', '==', false);
            
            const myFoldersSnapshot = await myFoldersQuery.get();
            myFoldersSnapshot.forEach(doc => {
                const folder = { id: doc.id, ...doc.data() };
                // フォルダ名をマッピングに追加
                folderNameMap[folder.id] = folder.name;
                folderListOptions[folder.id] = folder.name;
                
                // サイドバーが存在すればそこにも追加
                if (folderListContainer) {
                    addFolderToSidebar(doc);
                }
                
                // 常にドロップダウンに追加
                addFolderToDropdowns(folder);
            });
            
            // 共有フォルダの取得（自分に共有されているフォルダ）
            const sharedFoldersQuery = db.collection('folders')
                .where('visibility', '==', 'shared')
                .where('sharedWith', 'array-contains', currentUser.uid)
                .where('trashed', '==', false);
            
            const sharedFoldersSnapshot = await sharedFoldersQuery.get();
            sharedFoldersSnapshot.forEach(doc => {
                const folder = { id: doc.id, ...doc.data() };
                // フォルダ名をマッピングに追加
                folderNameMap[folder.id] = folder.name;
                folderListOptions[folder.id] = `${folder.name} (共有)`;
                
                // サイドバーが存在すればそこにも追加
                if (folderListContainer) {
                    addFolderToSidebar(doc, '共有');
                }
                
                // 常にドロップダウンに追加
                addFolderToDropdowns(folder, '共有');
            });
            
            // 公開フォルダの取得
            const publicFoldersQuery = db.collection('folders')
                .where('visibility', '==', 'public')
                .where('trashed', '==', false);
            
            const publicFoldersSnapshot = await publicFoldersQuery.get();
            publicFoldersSnapshot.forEach(doc => {
                const folder = { id: doc.id, ...doc.data() };
                // 自分のフォルダは除外（すでに表示済み）
                if (folder.userId !== currentUser.uid) {
                    // フォルダ名をマッピングに追加
                    folderNameMap[folder.id] = folder.name;
                    folderListOptions[folder.id] = `${folder.name} (公開)`;
                    
                    // サイドバーが存在すればそこにも追加
                    if (folderListContainer) {
                        addFolderToSidebar(doc, '公開');
                    }
                    
                    // 常にドロップダウンに追加
                    addFolderToDropdowns(folder, '公開');
                }
            });
        } catch (error) {
            console.error("フォルダ一覧取得エラー:", error);
            showToast('フォルダ一覧の取得に失敗しました', 'warning');
        }
    } catch (error) {
        console.error("フォルダ一覧取得エラー:", error);
    }
}

// ドロップダウンにフォルダを追加する関数
function addFolderToDropdowns(folder, shareType = '') {
    const folderLabel = shareType ? `${folder.name} (${shareType})` : folder.name;
    
    // アップロードモーダル用
    if (uploadFolder) {
        const uploadOption = document.createElement('option');
        uploadOption.value = folder.id;
        uploadOption.textContent = folderLabel;
        uploadFolder.appendChild(uploadOption);
    }
    
    // 新規フォルダモーダル用
    if (parentFolder) {
        const parentOption = document.createElement('option');
        parentOption.value = folder.id;
        parentOption.textContent = folderLabel;
        parentFolder.appendChild(parentOption);
    }
    
    // 移動モーダル用
    if (moveDestination) {
        const moveOption = document.createElement('option');
        moveOption.value = folder.id;
        moveOption.textContent = folderLabel;
        moveDestination.appendChild(moveOption);
    }
    
    // 一括移動モーダル用
    if (batchMoveDestination) {
        const batchMoveOption = document.createElement('option');
        batchMoveOption.value = folder.id;
        batchMoveOption.textContent = folderLabel;
        batchMoveDestination.appendChild(batchMoveOption);
    }
}
// アップロードモーダルを表示する関数を修正
if (uploadBtn) {
    uploadBtn.addEventListener('click', () => {
        if (uploadModal) {
            // 現在のフォルダを自動選択
            if (uploadFolder) {
                uploadFolder.value = currentFolder;
            }
            
            // 前回の共有設定を復元（localStorage から取得）
            const lastVisibility = localStorage.getItem('lastVisibility') || 'personal';
            if (uploadVisibility) {
                uploadVisibility.value = lastVisibility;
                
                // 共有設定に応じてユーザー選択部分の表示/非表示を切り替え
                if (lastVisibility === 'shared' && shareUsersContainer) {
                    shareUsersContainer.style.display = 'block';
                    
                    // 前回選択したユーザーIDを復元
                    const lastSelectedUsers = JSON.parse(localStorage.getItem('lastSelectedUsers') || '[]');
                    if (lastSelectedUsers.length > 0) {
                        // 選択済みユーザーを設定
                        selectedUserIds.clear();
                        setSelectedUsers(lastSelectedUsers);
                    }
                } else if (shareUsersContainer) {
                    shareUsersContainer.style.display = 'none';
                }
            }
            
            uploadModal.classList.add('show');
        }
    });
}

// アップロード処理の後に共有設定を保存する処理を追加
async function uploadFiles(files) {
    // 既存のコード...
    
    // アップロード先フォルダと共有設定
    const folder = uploadFolder.value;
    const visibility = uploadVisibility.value;
    
    // 現在の設定を保存
    localStorage.setItem('lastVisibility', visibility);
    
    // 選択されたユーザーIDを取得（共有設定の場合）
    let sharedWith = [];
    if (visibility === 'shared') {
        sharedWith = Array.from(selectedUserIds);
        // 選択済みユーザーを保存
        localStorage.setItem('lastSelectedUsers', JSON.stringify(sharedWith));
    }
    
    // 以下、既存のコード...
}

// 空の状態からのアップロードボタンも同様に修正
if (emptyUploadBtn) {
    emptyUploadBtn.addEventListener('click', () => {
        if (uploadModal) {
            // 現在のフォルダを自動選択
            if (uploadFolder) {
                uploadFolder.value = currentFolder;
            }
            
            // 前回の共有設定を復元
            const lastVisibility = localStorage.getItem('lastVisibility') || 'personal';
            if (uploadVisibility) {
                uploadVisibility.value = lastVisibility;
                
                // 共有設定に応じてユーザー選択部分の表示/非表示を切り替え
                if (lastVisibility === 'shared' && shareUsersContainer) {
                    shareUsersContainer.style.display = 'block';
                    
                    // 前回選択したユーザーIDを復元
                    const lastSelectedUsers = JSON.parse(localStorage.getItem('lastSelectedUsers') || '[]');
                    if (lastSelectedUsers.length > 0) {
                        // 選択済みユーザーを設定
                        selectedUserIds.clear();
                        setSelectedUsers(lastSelectedUsers);
                    }
                } else if (shareUsersContainer) {
                    shareUsersContainer.style.display = 'none';
                }
            }
            
            uploadModal.classList.add('show');
        }
    });
}

//修正版
// ファイルアップロード処理
async function uploadFiles(files) {
    if (!files || files.length === 0) {
        showToast('ファイルが選択されていません', 'error');
        return;
    }
    
    // アップロード先フォルダと共有設定
    const folder = uploadFolder.value;
    const visibility = uploadVisibility.value;
    
    // 現在の設定を保存
    localStorage.setItem('lastVisibility', visibility);
    
    // 選択されたユーザーIDを取得（共有設定の場合）
    let sharedWith = [];
    if (visibility === 'shared') {
        sharedWith = Array.from(selectedUserIds);
        // 選択済みユーザーを保存
        localStorage.setItem('lastSelectedUsers', JSON.stringify(sharedWith));
    }
    
    // プログレスコンテナ表示
    uploadProgressContainer.style.display = 'block';
    
    try {
        let successCount = 0;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ファイルサイズチェック
            const maxFileSize = 100 * 1024 * 1024; // 100MB
            if (file.size > maxFileSize) {
                showToast(`ファイル「${file.name}」は最大サイズ（100MB）を超えています`, 'warning');
                continue; // このファイルはスキップ
            }
            
            // アップロード中のファイル名とインデックスを表示
            uploadProgressText.textContent = `アップロード中: ${file.name} (${i + 1}/${files.length})`;
            
            // ファイルタイプの判定
            let fileType = 'other';
            if (file.type.startsWith('image/')) {
                fileType = 'image';
            } else if (file.type === 'application/pdf') {
                fileType = 'pdf';
            } else if (file.type.includes('document') || file.type.includes('text')) {
                fileType = 'document';
            }
            
            try {
                // Storageへアップロード
                const timestamp = new Date().getTime();
                const storagePath = `files/${currentUser.uid}/${timestamp}_${file.name}`;
                const storageRef = storage.ref(storagePath);
                const uploadTask = storageRef.put(file);
                
                // アップロードの進捗監視
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // 進捗状況
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgressBar.style.width = `${progress}%`;
                        
                        // 転送サイズ表示
                        const transferred = formatFileSize(snapshot.bytesTransferred);
                        const total = formatFileSize(snapshot.totalBytes);
                        uploadProgressSize.textContent = `${transferred} / ${total}`;
                    },
                    (error) => {
                        // エラー処理
                        console.error("アップロードエラー:", error);
                        showToast(`「${file.name}」のアップロードに失敗しました`, 'error');
                    }
                );
                
                // アップロード完了を待機
                await uploadTask;
                
                // ダウンロードURLを取得
                const downloadURL = await storageRef.getDownloadURL();
                
                // サムネイル作成（画像の場合）
                let thumbnail = null;
                if (fileType === 'image') {
                    thumbnail = downloadURL;
                }
                
                // Firestoreにファイル情報を保存
                const fileData = {
                    name: file.name,
                    originalName: file.name,
                    storagePath: storagePath,
                    url: downloadURL,
                    thumbnail: thumbnail,
                    fileType: fileType,
                    mimeType: file.type,
                    size: file.size,
                    parentFolder: folder,
                    userId: currentUser.uid,
                    ownerName: currentUser.displayName || '',
                    visibility: visibility,
                    sharedWith: sharedWith,
                    trashed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('files').add(fileData);
                successCount++;
            } catch (error) {
                console.error(`ファイル「${file.name}」の処理エラー:`, error);
                showToast(`ファイル「${file.name}」の処理に失敗しました`, 'error');
            }
        }
        
        // すべてのファイルのアップロード処理が完了
        if (successCount > 0) {
            showToast(`${successCount}個のファイルをアップロードしました`, 'success');
            
            // 現在のフォルダが作成先と同じ場合は一覧を更新
            if (currentFolder === folder) {
                loadFiles();
            }
            
            fetchStorageUsage();
        }
        
        // モーダルを閉じる
        closeModal(uploadModal);
        resetUploadForm();
    } catch (error) {
        console.error("アップロード処理エラー:", error);
        showToast('アップロード処理に失敗しました', 'error');
    }
}

//追加修正
// ファイルアップロード処理の修正バージョン
async function uploadFiles(files) {
    if (!files || files.length === 0) {
        showToast('ファイルが選択されていません', 'error');
        return;
    }
    
    // アップロード先フォルダと共有設定
    const folder = uploadFolder.value;
    const visibility = uploadVisibility.value;
    
    // 現在の設定を保存
    localStorage.setItem('lastVisibility', visibility);
    
    // 選択されたユーザーIDを取得（共有設定の場合）
    let sharedWith = [];
    if (visibility === 'shared') {
        sharedWith = Array.from(selectedUserIds);
        // 選択済みユーザーを保存
        localStorage.setItem('lastSelectedUsers', JSON.stringify(sharedWith));
    }
    
    // プログレスコンテナ表示
    uploadProgressContainer.style.display = 'block';
    
    try {
        let successCount = 0;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // ファイルサイズチェック
            const maxFileSize = 100 * 1024 * 1024; // 100MB
            if (file.size > maxFileSize) {
                showToast(`ファイル「${file.name}」は最大サイズ（100MB）を超えています`, 'warning');
                continue; // このファイルはスキップ
            }
            
            // アップロード中のファイル名とインデックスを表示
            uploadProgressText.textContent = `アップロード中: ${file.name} (${i + 1}/${files.length})`;
            
            // ファイルタイプの判定
            let fileType = 'other';
            if (file.type.startsWith('image/')) {
                fileType = 'image';
            } else if (file.type === 'application/pdf') {
                fileType = 'pdf';
            } else if (file.type.includes('document') || file.type.includes('text')) {
                fileType = 'document';
            }
            
            try {
                // Storageへアップロード
                const timestamp = new Date().getTime();
                const storagePath = `files/${currentUser.uid}/${timestamp}_${file.name}`;
                const storageRef = storage.ref(storagePath);
                const uploadTask = storageRef.put(file);
                
                // アップロードの進捗監視
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // 進捗状況
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgressBar.style.width = `${progress}%`;
                        
                        // 転送サイズ表示
                        const transferred = formatFileSize(snapshot.bytesTransferred);
                        const total = formatFileSize(snapshot.totalBytes);
                        uploadProgressSize.textContent = `${transferred} / ${total}`;
                    },
                    (error) => {
                        // エラー処理
                        console.error("アップロードエラー:", error);
                        showToast(`「${file.name}」のアップロードに失敗しました`, 'error');
                    }
                );
                
                // アップロード完了を待機
                await uploadTask;
                
                // ダウンロードURLを取得 - 重要な修正点: Promise完了を確実に待つ
                let downloadURL;
                try {
                    downloadURL = await storageRef.getDownloadURL();
                    console.log("取得したダウンロードURL:", downloadURL); // デバッグ用
                } catch (urlError) {
                    console.error("ダウンロードURL取得エラー:", urlError);
                    showToast(`「${file.name}」のURL取得に失敗しました`, 'error');
                    continue; // このファイルの処理をスキップ
                }
                
                // サムネイル作成（画像の場合）
                let thumbnail = null;
                if (fileType === 'image') {
                    thumbnail = downloadURL; // 直接ダウンロードURLを使用
                }
                
                // Firestoreにファイル情報を保存
                const fileData = {
                    name: file.name,
                    originalName: file.name,
                    storagePath: storagePath,
                    url: downloadURL,
                    thumbnail: thumbnail,
                    fileType: fileType,
                    mimeType: file.type,
                    size: file.size,
                    parentFolder: folder,
                    userId: currentUser.uid,
                    ownerName: currentUser.displayName || '',
                    visibility: visibility,
                    sharedWith: sharedWith,
                    trashed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('files').add(fileData);
                successCount++;
            } catch (error) {
                console.error(`ファイル「${file.name}」の処理エラー:`, error);
                showToast(`ファイル「${file.name}」の処理に失敗しました`, 'error');
            }
        }
        
        // すべてのファイルのアップロード処理が完了
        if (successCount > 0) {
            showToast(`${successCount}個のファイルをアップロードしました`, 'success');
            
            // 現在のフォルダが作成先と同じ場合は一覧を更新
            if (currentFolder === folder) {
                loadFiles();
            }
            
            fetchStorageUsage();
        }
        
        // モーダルを閉じる
        closeModal(uploadModal);
        resetUploadForm();
    } catch (error) {
        console.error("アップロード処理エラー:", error);
        showToast('アップロード処理に失敗しました', 'error');
    }
}

// ファイルプレビュー表示関数の修正バージョン
function showFilePreview(file) {
    // 現在のファイルを保存
    currentPreviewFile = file;
    
    // ユーザーが操作可能かチェック
    const canEdit = canUserEdit(file);
    
    // プレビューコンテナの表示
    document.getElementById('file-list-container').style.display = 'none';
    fileViewContainer.style.display = 'flex';
    backNavigation.style.display = 'flex';
    
    // プレビュー内容をクリア
    filePreview.innerHTML = '';
    fileInfo.innerHTML = '';
    fileActions.innerHTML = '';
    
    // 権限情報表示
    const filePermissionsInfo = document.getElementById('file-permissions-info');
    if (file.userId === currentUser.uid) {
        // 自分のファイル
        filePermissionsInfo.style.display = 'none';
    } else {
        // 他人のファイル
        filePermissionsInfo.style.display = 'block';
        const permissionsText = document.getElementById('file-permissions-text');
        
        if (file.visibility === 'public') {
            permissionsText.innerHTML = 'このファイルは全体共有されています。<br>元のファイルの所有者は <strong>' + (file.ownerName || '他のユーザー') + '</strong> です。';
            filePermissionsInfo.className = 'file-permissions-info';
            filePermissionsInfo.style.backgroundColor = 'var(--success-light)';
            filePermissionsInfo.style.color = 'var(--success)';
        } else if (file.visibility === 'shared') {
            permissionsText.innerHTML = 'このファイルはあなたと共有されています。<br>元のファイルの所有者は <strong>' + (file.ownerName || '他のユーザー') + '</strong> です。';
            filePermissionsInfo.className = 'file-permissions-info';
            filePermissionsInfo.style.backgroundColor = 'var(--info-light)';
            filePermissionsInfo.style.color = 'var(--info)';
        }
    }
    
    // ファイル情報の表示
    fileInfo.innerHTML = `
        <h2>${file.name}</h2>
        <div class="mt-2">
            <p><strong>タイプ:</strong> ${getFileTypeLabel(file.fileType)}</p>
            <p><strong>サイズ:</strong> ${formatFileSize(file.size || 0)}</p>
            <p><strong>アップロード日:</strong> ${file.createdAt ? new Date(file.createdAt.seconds * 1000).toLocaleString('ja-JP') : '-'}</p>
            <p><strong>最終更新日:</strong> ${file.updatedAt ? new Date(file.updatedAt.seconds * 1000).toLocaleString('ja-JP') : '-'}</p>
            <p><strong>所有者:</strong> ${file.userId === currentUser.uid ? '自分' : (file.ownerName || '他のユーザー')}</p>
            <p><strong>共有状態:</strong> ${getVisibilityLabel(file.visibility)}</p>
        </div>
    `;
    
    // ファイルタイプに応じたプレビュー
    if (file.fileType === 'image') {
        // 画像プレビュー - URLにキャッシュバスターを追加
        const imageUrl = file.url + (file.url.includes('?') ? '&' : '?') + 'cache=' + new Date().getTime();
        console.log("プレビュー表示用URL:", imageUrl); // デバッグ用
        
        filePreview.innerHTML = `
            <img src="${imageUrl}" alt="${file.name}" style="max-width: 100%; max-height: 400px; object-fit: contain;"
                 onerror="console.error('画像読み込みエラー:', this.src); this.onerror=null; 
                          this.src=''; this.alt='画像を読み込めませんでした'; 
                          this.style.padding='2rem'; this.style.backgroundColor='var(--gray-100)'; 
                          this.parentNode.innerHTML += '<p style=\\'text-align:center; margin-top:1rem;\\'>画像の読み込みに失敗しました</p>';">
        `;
    } else if (file.fileType === 'pdf') {
        // PDFプレビュー（iframeを使用）
        filePreview.innerHTML = `
            <iframe src="${file.url}" style="width: 100%; height: 500px; border: 1px solid var(--border-color); border-radius: var(--radius);"></iframe>
        `;
    } else {
        // その他のファイルはプレビュー不可
        filePreview.innerHTML = `
            <div style="text-align: center; padding: 2rem; background-color: var(--gray-100); border-radius: var(--radius);">
                <i class="fas fa-file" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                <p>このファイルはプレビューできません</p>
            </div>
        `;
    }
    
    // アクションボタン - すべてのユーザーに表示するボタン
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'btn btn-primary';
    downloadBtn.innerHTML = '<i class="fas fa-download"></i> ダウンロード';
    downloadBtn.addEventListener('click', () => downloadFile(file));
    fileActions.appendChild(downloadBtn);
    
    // 画像ファイルの場合は活字化エディタで開くボタンを追加
    if (file.fileType === 'image') {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-secondary ml-2';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> 活字化エディタで開く';
        editBtn.addEventListener('click', () => openInEditor(file));
        fileActions.appendChild(editBtn);
    }
    
    // 編集権限があるユーザーに表示するボタン
    if (canEdit) {
        // 共有ボタン
        const shareBtn = document.createElement('button');
        shareBtn.className = 'btn btn-outline ml-2';
        shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> 共有';
        shareBtn.addEventListener('click', () => showShareModal(file));
        fileActions.appendChild(shareBtn);
        
        // 名前変更ボタン
        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn btn-outline ml-2';
        renameBtn.innerHTML = '<i class="fas fa-edit"></i> 名前変更';
        renameBtn.addEventListener('click', () => showRenameModal(file));
        fileActions.appendChild(renameBtn);
        
        // 削除ボタン
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger ml-2';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 削除';
        deleteBtn.addEventListener('click', () => showDeleteModal(file));
        fileActions.appendChild(deleteBtn);
    }
}

// ファイルカードの作成関数の修正バージョン
function createFileCard(file) {
    const card = document.createElement('div');
    card.className = 'file-card';
    card.setAttribute('data-id', file.id);
    card.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
    
    // 選択チェックボックス
    const checkbox = document.createElement('div');
    checkbox.className = 'file-checkbox';
    checkbox.innerHTML = '<i class="fas fa-check" style="display: none;"></i>';
    
    // チェックボックスクリックイベント
    checkbox.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleItemSelection(card);
    });
    
    // アイコンまたはサムネイル
    let iconHtml = '';
    if (file.isFolder) {
        iconHtml = `<div class="file-icon folder-icon"><i class="fas fa-folder"></i></div>`;
    } else if (file.fileType === 'image' && file.thumbnail) {
        // サムネイルにキャッシュバスターを追加
        const thumbnailUrl = file.thumbnail + (file.thumbnail.includes('?') ? '&' : '?') + 'cache=' + new Date().getTime();
        iconHtml = `
            <div class="file-image">
                <img src="${thumbnailUrl}" alt="${file.name}" loading="lazy" 
                     onerror="console.error('サムネイル読み込みエラー:', this.src); this.onerror=null; 
                              this.src=''; this.alt='画像を読み込めませんでした'; 
                              this.parentNode.innerHTML = '<div class=\\'file-icon image-icon\\'><i class=\\'fas fa-file-image\\'></i></div>';">
            </div>`;
    } else {
        // ファイルタイプ別のアイコン
        let iconClass = 'file-icon';
        let faIcon = 'fa-file';
        
        switch (file.fileType) {
            case 'pdf':
                iconClass += ' pdf-icon';
                faIcon = 'fa-file-pdf';
                break;
            case 'document':
                iconClass += ' doc-icon';
                faIcon = 'fa-file-alt';
                break;
            case 'image':
                iconClass += ' image-icon';
                faIcon = 'fa-file-image';
                break;
            default:
                iconClass += '';
                faIcon = 'fa-file';
        }
        
        iconHtml = `<div class="${iconClass}"><i class="fas ${faIcon}"></i></div>`;
    }
    
    // 更新日
    const updatedAt = file.updatedAt ? new Date(file.updatedAt.seconds * 1000) : new Date();
    const formattedDate = updatedAt.toLocaleDateString('ja-JP');
    
    // 共有インジケーター
    let shareIndicator = '';
    if (file.visibility === 'shared') {
        shareIndicator = `
            <div class="share-indicator">
                <i class="fas fa-share-alt share-indicator-icon" style="color: var(--info);"></i>
                <span class="share-indicator-text">指定共有</span>
            </div>
        `;
    } else if (file.visibility === 'public') {
        shareIndicator = `
            <div class="share-indicator">
                <i class="fas fa-globe share-indicator-icon" style="color: var(--success);"></i>
                <span class="share-indicator-text">全体共有</span>
            </div>
        `;
    }
    
    // 所有者表示
    let ownerIndicator = '';
    if (file.userId !== currentUser.uid) {
        const ownerName = file.ownerName || '他のユーザー';
        ownerIndicator = `
            <div class="mt-1" style="font-size: 0.7rem; color: var(--text-muted);">
                <i class="fas fa-user mr-1"></i> ${ownerName}
            </div>
        `;
    }
    
    // HTML作成
    card.innerHTML = `
        ${iconHtml}
        <div>
            <div class="file-card-name" title="${file.name}">${file.name}${shareIndicator}</div>
            <div class="file-card-date">${formattedDate}</div>
            ${ownerIndicator}
        </div>
        <div class="file-card-actions">
            <span class="file-card-action" data-action="more"><i class="fas fa-ellipsis-v"></i></span>
        </div>
    `;
    
    // チェックボックスを追加
    card.appendChild(checkbox);
    
    // 選択状態かチェック
    if (selectedItems.includes(file.id)) {
        card.classList.add('selected');
        updateCheckboxState(checkbox, true);
    }
    
    // イベントリスナー
    card.addEventListener('click', (e) => {
        if (!e.target.closest('.file-checkbox') && !e.target.closest('.file-card-action')) {
            // フォルダの場合は開く
            if (file.isFolder) {
                changeFolder(file.id);
            } else {
                // ファイルの場合はプレビューまたはダウンロード
                openFile(file);
            }
        }
    });
    
    // 右クリックメニュー
    card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        activeFile = file;
        showContextMenu(e.clientX, e.clientY, file);
    });
    
    // 「...」ボタンクリック
    const moreBtn = card.querySelector('[data-action="more"]');
    if (moreBtn) {
        moreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            activeFile = file;
            const rect = moreBtn.getBoundingClientRect();
            showContextMenu(rect.right, rect.bottom, file);
        });
    }
    
    return card;
}

// 画像プレビューモーダル表示の修正
function showImagePreviewModal(file) {
    if (!file || !file.url) {
        showToast('画像URLが見つかりません', 'error');
        return;
    }
    
    // 画像URLをセット - キャッシュバスターを追加
    const imageUrl = file.url + (file.url.includes('?') ? '&' : '?') + 'cache=' + new Date().getTime();
    console.log("モーダル表示用URL:", imageUrl); // デバッグ用
    
    previewImage.src = ''; // 一度クリア
    previewImage.src = imageUrl;
    previewImage.alt = file.name;
    
    // エラーハンドリングを追加
    previewImage.onerror = function() {
        console.error('プレビュー画像読み込みエラー:', this.src);
        this.onerror = null;
        this.src = '';
        this.alt = '画像を読み込めませんでした';
        showToast('画像の読み込みに失敗しました', 'error');
    };
    
    // プレビュー中のファイルを保存
    currentPreviewFile = file;
    
    // モーダル表示
    imagePreviewModal.classList.add('show');
}

// Firebase Storageのセキュリティルール確認用のメッセージを表示
function checkStorageRules() {
    console.log("Firebase Storageのセキュリティルール確認が必要です。以下の点を確認してください：");
    console.log("1. Firebase Consoleで、プロジェクトのStorageのルールが以下のように設定されているか確認：");
    console.log(`
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        match /files/{userId}/{fileName} {
          allow read: if request.auth != null && (
            // 所有者は常に読み取り可能
            request.auth.uid == userId ||
            // 公開ファイルは誰でも読み取り可能
            exists(/databases/$(database)/documents/files/$(resource.name)) && 
            get(/databases/$(database)/documents/files/$(resource.name)).data.visibility == 'public' ||
            // 共有されたファイルは対象ユーザーが読み取り可能
            exists(/databases/$(database)/documents/files/$(resource.name)) && 
            get(/databases/$(database)/documents/files/$(resource.name)).data.visibility == 'shared' &&
            request.auth.uid in get(/databases/$(database)/documents/files/$(resource.name)).data.sharedWith
          );
          allow write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }
    `);
}

// 初期化時にデバッグ情報を表示
document.addEventListener('DOMContentLoaded', () => {
    // 既存の初期化コード...
    
    // デバッグ情報を表示
    console.log("画像読み込みのデバッグを有効化しました");
    checkStorageRules();
});
</script>
</body>
</html>