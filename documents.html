<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>資料管理 | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4338ca;
            --primary-hover: #3730a3;
            --primary-light: #e0e7ff;
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --secondary-light: #e0f2fe;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --accent-light: #fff7ed;
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;
            --info: #3b82f6;
            --info-hover: #2563eb;
            --info-light: #eff6ff;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --bg-color: var(--gray-50);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            
            --header-height: 4rem;
            --sidebar-width: 280px;
            --transition-normal: 0.3s ease;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.25rem;
            --radius: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #2d2a63;
            
            --bg-color: #0f172a;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #1f2937;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* サイドバー */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            color: white;
            z-index: 50;
            transition: transform var(--transition-normal), width var(--transition-normal);
            box-shadow: var(--shadow);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo img {
            width: 2rem;
            height: 2rem;
        }
        
        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        .menu-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.75rem 1.5rem 0.5rem;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: background-color var(--transition-normal);
            position: relative;
            margin: 0.125rem 0.75rem;
            border-radius: var(--radius);
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.25rem;
            height: 1.5rem;
            background-color: white;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        
        .menu-item i {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: var(--primary);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            z-index: 100;
            box-shadow: var(--shadow-md);
            border: none;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-hover);
        }
        
        /* メインコンテンツ */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            transition: margin var(--transition-normal);
        }
        
        .page-header {
            margin-bottom: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.8125rem;
        }
        
        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb i {
            font-size: 0.625rem;
        }
        
        /* ファイル管理スタイル */
        .file-manager-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 12rem);
            overflow: hidden;
        }
        
        .file-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .file-manager-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-tab {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color var(--transition-normal);
        }
        
        .file-tab:hover {
            color: var(--text-color);
        }
        
        .file-tab.active {
            color: var(--primary);
        }
        
        .file-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }
        
        .file-manager-header .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-search {
            position: relative;
            width: 240px;
        }
        
        .file-search input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
        }
        
        .file-search i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .file-manager-body {
            display: flex;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
        }
        
        .file-sidebar {
            width: 220px;
            border-right: 1px solid var(--border-color);
            padding-right: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }
        
        .sidebar-list {
            list-style: none;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            color: var(--text-color);
            text-decoration: none;
            border-radius: var(--radius);
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .sidebar-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
        }
        
        [data-theme="dark"] .sidebar-item.active {
            background-color: rgba(99, 102, 241, 0.2);
        }
        
        .sidebar-item i {
            margin-right: 0.75rem;
        }
        
        .storage-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--gray-100);
            border-radius: var(--radius);
        }
        
        [data-theme="dark"] .storage-info {
            background-color: #1e293b;
        }
        
        .storage-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--gray-200);
            border-radius: var(--radius-full);
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        [data-theme="dark"] .storage-bar {
            background-color: #2d3748;
        }
        
        .storage-progress {
            height: 100%;
            background-color: var(--primary);
            border-radius: var(--radius-full);
        }
        
        .storage-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .file-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .file-list-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            padding: 0.5rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
        }
        
        .file-list-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            transition: background-color var(--transition-normal);
        }
        
        .file-list-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        [data-theme="dark"] .file-list-item:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
        .file-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
            cursor: pointer;
            overflow: hidden;
            max-width: 200px;
            width: 100%;
            margin: 0 auto;
            height: auto;
        }
        
        .file-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .file-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            border-radius: var(--radius);
            background-color: var(--primary-light);
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .file-image {
            width: 100%;
            height: 140px !important;
            max-height: 140px !important;
            margin-bottom: 0.5rem;
            border-radius: var(--radius);
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            overflow: hidden;
            position: relative;
        }
        
        .file-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        
        .folder-icon {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .pdf-icon {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        .doc-icon {
            background-color: var(--info-light);
            color: var(--info);
        }
        
        .image-icon {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .file-card-name {
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        .file-card-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
        }
        
        .file-card:hover .file-card-actions {
            display: flex;
        }
        
        .file-card-action {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: 0.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            color: var(--text-color);
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        [data-theme="dark"] .file-card-action {
            background-color: var(--gray-700);
        }
        
        .file-card-action:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .action-menu {
            position: absolute;
            top: 0;
            right: 0;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            z-index: 10;
            min-width: 150px;
            display: none;
        }
        
        [data-theme="dark"] .action-menu {
            background-color: var(--gray-700);
        }
        
        .action-menu.show {
            display: block;
        }
        
        .action-menu-item {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .action-menu-item:hover {
            background-color: var(--gray-100);
        }
        
        [data-theme="dark"] .action-menu-item:hover {
            background-color: var(--gray-600);
        }
        
        .action-menu-item i {
            margin-right: 0.75rem;
            width: 1rem;
            text-align: center;
        }
        
        /* モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal);
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }
        
        [data-theme="dark"] .modal {
            background-color: var(--gray-800);
        }
        
        .modal-overlay.show .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.25rem;
            transition: color var(--transition-normal);
        }
        
        .modal-close:hover {
            color: var(--text-color);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* 画像プレビューモーダル */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .image-preview-modal.show {
            display: flex;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius);
        }

        .close-preview {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* フォーム */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color var(--transition-normal);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-control:disabled {
            background-color: var(--gray-100);
            cursor: not-allowed;
        }
        
        [data-theme="dark"] .form-control:disabled {
            background-color: var(--gray-700);
        }
        
        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color var(--transition-normal);
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5rem;
        }
        
        /* ドラッグ＆ドロップ関連 */
        .dropzone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 2rem 1rem;
            text-align: center;
            transition: border-color var(--transition-normal);
            cursor: pointer;
        }
        
        .dropzone:hover {
            border-color: var(--primary);
        }
        
        .dropzone i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .dropzone-text {
            margin-bottom: 0.5rem;
        }
        
        .dropzone-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .dropping {
            border-color: var(--primary);
            background-color: var(--primary-light);
        }
        
        /* トースト通知 */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            background-color: white;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            animation: slideIn 0.3s forwards, slideOut 0.3s forwards 3s;
        }
        
        [data-theme="dark"] .toast {
            background-color: var(--gray-800);
        }
        
        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            to {
                transform: translateX(120%);
            }
        }
        
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-error .toast-icon {
            color: var(--danger);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        
        .toast-info .toast-icon {
            color: var(--info);
        }
        
        /* ボタンスタイル */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            border: none;
            line-height: 1.5;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--success-hover);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            border-radius: 50%;
        }
        
        .btn-icon i {
            margin-right: 0;
        }
        
        /* バッジ */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        /* ユーティリティクラス */
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        
        .bg-primary { background-color: var(--primary); color: white; }
        .bg-secondary { background-color: var(--secondary); color: white; }
        .bg-success { background-color: var(--success); color: white; }
        .bg-warning { background-color: var(--warning); color: white; }
        .bg-danger { background-color: var(--danger); color: white; }
        .bg-info { background-color: var(--info); color: white; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mt-5 { margin-top: 3rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-5 { margin-bottom: 3rem; }
        
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-3 { margin-left: 1rem; }
        .ml-4 { margin-left: 1.5rem; }
        .ml-5 { margin-left: 3rem; }
        
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 1rem; }
        .mr-4 { margin-right: 1.5rem; }
        .mr-5 { margin-right: 3rem; }
        
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 1rem; }
        .p-4 { padding: 1.5rem; }
        .p-5 { padding: 3rem; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        .d-flex { display: flex; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .flex-1 { flex: 1; }
        
        /* レスポンシブデザイン */
        @media (max-width: 1024px) {
            .file-manager-body {
                flex-direction: column;
            }
            
            .file-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 1rem;
                overflow-y: visible;
            }
            
            .sidebar-section {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .file-manager-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .file-search {
                width: 100%;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .file-list-header, .file-list-item {
                grid-template-columns: 2fr 1fr auto;
            }
            
            .file-list-header .date-col, .file-list-item .date-col,
            .file-list-header .size-col, .file-list-item .size-col {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .file-tab {
                padding: 0.75rem 1rem;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- サイドバー -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="" class="logo">
                <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
                <span>KatsujiRingX</span>
            </a>
        </div>
        
        <div class="sidebar-menu">
            <p class="menu-label">メインメニュー</p>
            <a href="index.html" class="menu-item">
                <i class="fas fa-home"></i> ダッシュボード
            </a>
            <a href="katsujieditor.html" class="menu-item">
                <i class="fas fa-edit"></i> 活字化エディタ
            </a>
            <a href="documents.html" class="menu-item active">
                <i class="fas fa-file-alt"></i> 資料管理
            </a>
            <a href="booklink.html" class="menu-item">
                <i class="fas fa-book"></i> 完成本を見る
            </a>
            
            <p class="menu-label">学習・コミュニティ</p>
            <a href="games.html" class="menu-item">
                <i class="fas fa-gamepad"></i> 学習ゲーム
            </a>
            <a href="community.html" class="menu-item">
                <i class="fas fa-users"></i> コミュニティ広場
            </a>
            <a href="blog.html" class="menu-item">
                <i class="fas fa-pen"></i> ブログ
            </a>
            
            <p class="menu-label">ユーザー</p>
            <a href="profile.html" class="menu-item">
                <i class="fas fa-user"></i> プロフィール
            </a>

            <p class="menu-label">サポート</p>
            <a href="helpcenter.html" class="menu-item">
                <i class="fas fa-question-circle"></i>ヘルプデスク
            </a>
            <a href="feedback.html" class="menu-item">
                <i class="fas fa-comment-dots"></i>フィードバック
            </a>
        </div>
        
        <div class="sidebar-footer">
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i> ダークモード
            </button>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">
                    <span id="user-initial">U</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-user-name">ユーザー名</div>
                    <div class="user-status">オンライン</div>
                </div>
            </div>
            
            <a href="#" id="logout-btn" class="btn btn-outline w-100 mt-3" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </a>
        </div>
    </aside>
    
    <!-- モバイル用サイドバー切替ボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="page-header">
            <div class="breadcrumb">
                <a href="index.html">ホーム</a>
                <i class="fas fa-chevron-right"></i>
                <span>資料管理</span>
            </div>
            <h1 class="page-title">資料管理</h1>
        </div>
        
        <!-- ファイル管理エリア -->
        <div class="file-manager-container">
            <div class="file-manager-header">
                <div class="d-flex align-center">
                    <button id="upload-btn" class="btn btn-primary">
                        <i class="fas fa-upload"></i> アップロード
                    </button>
                    <button id="new-folder-btn" class="btn btn-outline ml-2">
                        <i class="fas fa-folder-plus"></i> 新規フォルダ
                    </button>
                </div>
                
                <div class="file-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="file-search-input" placeholder="ファイルを検索...">
                </div>
            </div>
            
            <div class="file-manager-tabs">
                <div class="file-tab active" data-view="personal">個人用</div>
                <div class="file-tab" data-view="shared">指定共有</div>
                <div class="file-tab" data-view="public">全体共有</div>
                <div class="file-tab" data-view="trashed">ゴミ箱</div>
            </div>
            
            <div class="file-manager-body">
                <div class="file-sidebar">
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">ストレージ</h3>
                        <ul class="sidebar-list">
                            <li class="sidebar-item active" data-type="all">
                                <i class="fas fa-th-large"></i> すべてのファイル
                            </li>
                            <li class="sidebar-item" data-type="documents">
                                <i class="fas fa-file-alt"></i> ドキュメント
                            </li>
                            <li class="sidebar-item" data-type="images">
                                <i class="fas fa-image"></i> 画像
                            </li>
                            <li class="sidebar-item" data-type="pdfs">
                                <i class="fas fa-file-pdf"></i> PDF
                            </li>
                            <li class="sidebar-item" data-type="others">
                                <i class="fas fa-file"></i> その他
                            </li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3 class="sidebar-title">フォルダ</h3>
                        <ul class="sidebar-list" id="folder-list">
                            <!-- フォルダリストは動的に追加されます -->
                            <li class="sidebar-item" data-folder="root">
                                <i class="fas fa-folder"></i> ルート
                            </li>
                        </ul>
                    </div>
                    
                    <div class="storage-info">
                        <div class="d-flex justify-between">
                            <span>ストレージ使用量</span>
                            <span id="storage-badge" class="badge badge-primary">無料</span>
                        </div>
                        <div class="storage-bar">
                            <div id="storage-progress" class="storage-progress" style="width: 0%;"></div>
                        </div>
                        <div class="storage-text">
                            <span id="storage-used">0 KB</span>
                            <span id="storage-total">10 GB</span>
                        </div>
                    </div>
                </div>
                
                <div class="file-content">
                    <div class="d-flex justify-between mb-3">
                        <div class="d-flex align-center">
                            <button id="view-grid-btn" class="btn btn-sm btn-outline active">
                                <i class="fas fa-th"></i>
                            </button>
                            <button id="view-list-btn" class="btn btn-sm btn-outline ml-1">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                        
                        <div class="d-flex align-center">
                            <select id="sort-select" class="form-select" style="width: auto; padding-right: 2rem;">
                                <option value="name-asc">名前（昇順）</option>
                                <option value="name-desc">名前（降順）</option>
                                <option value="date-desc" selected>日付（新しい順）</option>
                                <option value="date-asc">日付（古い順）</option>
                                <option value="size-desc">サイズ（大きい順）</option>
                                <option value="size-asc">サイズ（小さい順）</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ファイル一覧（グリッドビュー） -->
                    <div id="file-grid" class="file-grid">
                        <!-- ファイルはここに動的に追加されます -->
                    </div>
                    
                    <!-- ファイル一覧（リストビュー） -->
                    <div id="file-list" class="file-list" style="display: none;">
                        <div class="file-list-header">
                            <div>名前</div>
                            <div class="owner-col">所有者</div>
                            <div class="date-col">更新日</div>
                            <div class="size-col">サイズ</div>
                            <div></div>
                        </div>
                        <!-- ファイルはここに動的に追加されます -->
                    </div>
                    
                    <!-- 空の状態表示 -->
                    <div id="empty-state" class="d-flex flex-column align-center justify-center" style="height: 300px; display: none;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                        <h3>フォルダが空です</h3>
                        <p class="text-muted mt-2">ファイルやフォルダをアップロードして始めましょう</p>
                        <button id="empty-upload-btn" class="btn btn-primary mt-3">
                            <i class="fas fa-upload"></i> アップロード
                        </button>
                    </div>
                    
                    <!-- ローディング表示 -->
                    <div id="loading-state" class="d-flex flex-column align-center justify-center" style="height: 300px;">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-3">ファイルを読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右クリックメニュー -->
        <div id="context-menu" class="action-menu">
            <div class="action-menu-item" data-action="open">
                <i class="fas fa-folder-open"></i> 開く
            </div>
            <div class="action-menu-item" data-action="download">
                <i class="fas fa-download"></i> ダウンロード
            </div>
            <div class="action-menu-item" data-action="rename">
                <i class="fas fa-edit"></i> 名前変更
            </div>
            <div class="action-menu-item" data-action="share">
                <i class="fas fa-share-alt"></i> 共有
            </div>
            <div class="action-menu-item" data-action="move">
                <i class="fas fa-folder-minus"></i> 移動
            </div>
            <div class="action-menu-item" data-action="delete">
                <i class="fas fa-trash"></i> 削除
            </div>
        </div>
        
        <!-- アップロードモーダル -->
        <div id="upload-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ファイルアップロード</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="dropzone" id="upload-dropzone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p class="dropzone-text">ファイルをドラッグ＆ドロップするか、クリックして選択</p>
                        <p class="dropzone-hint">最大ファイルサイズ: 100MB</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>
                    
                    <div class="form-group mt-3">
                        <label class="form-label">アップロード先フォルダ</label>
                        <select id="upload-folder" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="upload-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                    </div>
                    
                    <div id="share-users-container" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <select id="share-users" class="form-select" multiple>
                            <!-- ユーザーは動的に追加されます -->
                        </select>
                        <p class="mt-1" style="font-size: 0.75rem; color: var(--text-muted);">Ctrlキーを押しながらクリックで複数選択</p>
                    </div>
                    
                    <div id="upload-progress-container" style="display: none;">
                        <div class="mt-3 mb-2 d-flex justify-between">
                            <span id="upload-progress-text">アップロード中 (0%)</span>
                            <span id="upload-progress-size">0 KB / 0 KB</span>
                        </div>
                        <div class="storage-bar">
                            <div id="upload-progress-bar" class="storage-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="upload-submit" class="btn btn-primary">アップロード</button>
                </div>
            </div>
        </div>
        
        <!-- 新規フォルダモーダル -->
        <div id="folder-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">新規フォルダ作成</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">フォルダ名</label>
                        <input type="text" id="folder-name" class="form-control" placeholder="フォルダ名を入力">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">親フォルダ</label>
                        <select id="parent-folder" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="folder-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                    </div>
                    
                    <div id="folder-share-users" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <select id="folder-users" class="form-select" multiple>
                            <!-- ユーザーは動的に追加されます -->
                        </select>
                        <p class="mt-1" style="font-size: 0.75rem; color: var(--text-muted);">Ctrlキーを押しながらクリックで複数選択</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="folder-submit" class="btn btn-primary">作成</button>
                </div>
            </div>
        </div>
        
        <!-- 名前変更モーダル -->
        <div id="rename-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">名前変更</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">新しい名前</label>
                        <input type="text" id="new-name" class="form-control" placeholder="新しい名前を入力">
                        <input type="hidden" id="rename-file-id">
                        <input type="hidden" id="rename-file-type">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="rename-submit" class="btn btn-primary">変更</button>
                </div>
            </div>
        </div>
        
        <!-- 共有設定モーダル -->
        <div id="share-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">共有設定</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">共有設定</label>
                        <select id="share-visibility" class="form-select">
                            <option value="personal">個人用（自分のみ）</option>
                            <option value="shared">指定共有（選択したユーザーと共有）</option>
                            <option value="public">全体共有（全ユーザーに公開）</option>
                        </select>
                        <input type="hidden" id="share-file-id">
                        <input type="hidden" id="share-file-type">
                    </div>
                    
                    <div id="share-settings-users" class="form-group" style="display: none;">
                        <label class="form-label">共有するユーザー</label>
                        <select id="share-settings-users-select" class="form-select" multiple>
                            <!-- ユーザーは動的に追加されます -->
                        </select>
                        <p class="mt-1" style="font-size: 0.75rem; color: var(--text-muted);">Ctrlキーを押しながらクリックで複数選択</p>
                    </div>
                    
                    <div id="share-link-container" class="form-group" style="display: none;">
                        <label class="form-label">共有リンク</label>
                        <div class="d-flex">
                            <input type="text" id="share-link" class="form-control" readonly>
                            <button id="copy-link-btn" class="btn btn-outline ml-2">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="share-submit" class="btn btn-primary">適用</button>
                </div>
            </div>
        </div>
        
        <!-- 移動モーダル -->
        <div id="move-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ファイル移動</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">移動先フォルダ</label>
                        <select id="move-destination" class="form-select">
                            <option value="root">ルート</option>
                            <!-- 他のフォルダは動的に追加されます -->
                        </select>
                        <input type="hidden" id="move-file-id">
                        <input type="hidden" id="move-file-type">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="move-submit" class="btn btn-primary">移動</button>
                </div>
            </div>
        </div>
        
        <!-- 削除確認モーダル -->
        <div id="delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="delete-message">このファイルをゴミ箱に移動しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--text-muted);">ゴミ箱から復元することができます。</p>
                    <input type="hidden" id="delete-file-id">
                    <input type="hidden" id="delete-file-type">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="delete-submit" class="btn btn-danger">削除</button>
                </div>
            </div>
        </div>
        
        <!-- 完全削除確認モーダル (ゴミ箱から) -->
        <div id="permanent-delete-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">完全削除の確認</h3>
                    <button class="modal-close" data-dismiss="modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="permanent-delete-message">このファイルを完全に削除しますか？</p>
                    <p class="mt-2" style="font-size: 0.875rem; color: var(--danger);">この操作は取り消せません。</p>
                    <input type="hidden" id="permanent-delete-file-id">
                    <input type="hidden" id="permanent-delete-file-type">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" data-dismiss="modal">キャンセル</button>
                    <button id="permanent-delete-submit" class="btn btn-danger">完全に削除</button>
                </div>
            </div>
        </div>
        
        <!-- 画像プレビューモーダル -->
        <div id="image-preview-modal" class="image-preview-modal">
            <div class="image-preview-content">
                <button class="close-preview"><i class="fas fa-times"></i></button>
                <img id="preview-image" src="" alt="">
            </div>
        </div>
        
        <!-- トースト通知コンテナ -->
        <div class="toast-container" id="toast-container">
            <!-- トースト通知はここに動的に追加されます -->
        </div>
    </div>

    <!-- JavaScripts -->
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
            authDomain: "katsujiringx.firebaseapp.com",
            projectId: "katsujiringx",
            storageBucket: "katsujiringx.firebasestorage.app",
            messagingSenderId: "831784731743",
            appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
            measurementId: "G-LPCRE3WYZR"
        };

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Firebaseサービスへの参照
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 日本語ロケールの設定
        auth.languageCode = 'ja';

        // 現在のユーザー
        let currentUser = null;
        
        // 現在の表示
        let currentView = 'personal'; // personal, shared, public, trashed
        let currentFileType = 'all'; // all, documents, images, pdfs, others
        let currentFolder = 'root'; // root または folder ID
        let currentViewMode = 'grid'; // grid または list
        
        // アクティブなファイル/フォルダ（右クリックメニューなどで使用）
        let activeFile = null;
        
        // DOM要素の参照
        // サイドバー
        const sidebarUserName = document.getElementById('sidebar-user-name');
        const userInitial = document.getElementById('user-initial');
        const userAvatar = document.getElementById('user-avatar');
        const logoutBtn = document.getElementById('logout-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        
        // ファイル管理
        const fileTabs = document.querySelectorAll('.file-tab');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const fileGridContainer = document.getElementById('file-grid');
        const fileListContainer = document.getElementById('file-list');
        const folderListContainer = document.getElementById('folder-list');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const viewListBtn = document.getElementById('view-list-btn');
        const sortSelect = document.getElementById('sort-select');
        const fileSearchInput = document.getElementById('file-search-input');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');
        const emptyUploadBtn = document.getElementById('empty-upload-btn');
        
        // 画像プレビュー
        const imagePreviewModal = document.getElementById('image-preview-modal');
        const previewImage = document.getElementById('preview-image');
        const closePreviewBtn = document.querySelector('.close-preview');
        
        // ストレージ情報
        const storageBadge = document.getElementById('storage-badge');
        const storageProgress = document.getElementById('storage-progress');
        const storageUsed = document.getElementById('storage-used');
        const storageTotal = document.getElementById('storage-total');
        
        // 右クリックメニュー
        const contextMenu = document.getElementById('context-menu');
        
        // アップロードモーダル
        const uploadBtn = document.getElementById('upload-btn');
        const uploadModal = document.getElementById('upload-modal');
        const uploadDropzone = document.getElementById('upload-dropzone');
        const fileInput = document.getElementById('file-input');
        const uploadFolder = document.getElementById('upload-folder');
        const uploadVisibility = document.getElementById('upload-visibility');
        const shareUsersContainer = document.getElementById('share-users-container');
        const shareUsers = document.getElementById('share-users');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadProgressText = document.getElementById('upload-progress-text');
        const uploadProgressSize = document.getElementById('upload-progress-size');
        const uploadSubmit = document.getElementById('upload-submit');
        
        // 新規フォルダモーダル
        const newFolderBtn = document.getElementById('new-folder-btn');
        const folderModal = document.getElementById('folder-modal');
        const folderName = document.getElementById('folder-name');
        const parentFolder = document.getElementById('parent-folder');
        const folderVisibility = document.getElementById('folder-visibility');
        const folderShareUsers = document.getElementById('folder-share-users');
        const folderUsers = document.getElementById('folder-users');
        const folderSubmit = document.getElementById('folder-submit');
        
        // 名前変更モーダル
        const renameModal = document.getElementById('rename-modal');
        const newName = document.getElementById('new-name');
        const renameFileId = document.getElementById('rename-file-id');
        const renameFileType = document.getElementById('rename-file-type');
        const renameSubmit = document.getElementById('rename-submit');
        
        // 共有モーダル
        const shareModal = document.getElementById('share-modal');
        const shareVisibility = document.getElementById('share-visibility');
        const shareSettingsUsers = document.getElementById('share-settings-users');
        const shareSettingsUsersSelect = document.getElementById('share-settings-users-select');
        const shareLinkContainer = document.getElementById('share-link-container');
        const shareLink = document.getElementById('share-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const shareFileId = document.getElementById('share-file-id');
        const shareFileType = document.getElementById('share-file-type');
        const shareSubmit = document.getElementById('share-submit');
        
        // 移動モーダル
        const moveModal = document.getElementById('move-modal');
        const moveDestination = document.getElementById('move-destination');
        const moveFileId = document.getElementById('move-file-id');
        const moveFileType = document.getElementById('move-file-type');
        const moveSubmit = document.getElementById('move-submit');
        
        // 削除モーダル
        const deleteModal = document.getElementById('delete-modal');
        const deleteMessage = document.getElementById('delete-message');
        const deleteFileId = document.getElementById('delete-file-id');
        const deleteFileType = document.getElementById('delete-file-type');
        const deleteSubmit = document.getElementById('delete-submit');
        
        // 完全削除モーダル
        const permanentDeleteModal = document.getElementById('permanent-delete-modal');
        const permanentDeleteMessage = document.getElementById('permanent-delete-message');
        const permanentDeleteFileId = document.getElementById('permanent-delete-file-id');
        const permanentDeleteFileType = document.getElementById('permanent-delete-file-type');
        const permanentDeleteSubmit = document.getElementById('permanent-delete-submit');
        
        // トースト通知
        const toastContainer = document.getElementById('toast-container');

        // 初期設定データの作成
        async function setupInitialUser(user) {
            try {
                // まずユーザードキュメントがあるか確認
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // ユーザードキュメントがなければ作成
                    const userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || (user.email ? user.email.split('@')[0] : '新規ユーザー'),
                        profileImageUrl: user.photoURL || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                    console.log("ユーザープロファイル作成完了");
                }
            } catch (error) {
                console.error("初期設定エラー:", error);
            }
        }

        // 認証状態の監視
        auth.onAuthStateChanged(user => {
            if (user) {
                // ユーザーがログインしている場合
                console.log("ログイン中:", user.uid);
                currentUser = user;
                
                // 初期設定を実行
                setupInitialUser(user);
                
                // 初期表示名の反映
                const initialDisplayName = user.displayName || (user.email ? user.email.split('@')[0] : 'ユーザー');
                if (sidebarUserName) {
                    sidebarUserName.textContent = initialDisplayName;
                }
                
                // ユーザーの初期アバター表示
                if (userInitial) {
                    const initial = (user.displayName || 'U').charAt(0).toUpperCase();
                    userInitial.textContent = initial;
                    
                    if (user.photoURL) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = user.photoURL;
                        avatarImg.alt = user.displayName || 'ユーザー';
                        userAvatar.innerHTML = '';
                        userAvatar.appendChild(avatarImg);
                    }
                }
                
                // 各種データ読み込み - エラーを個別に処理
                loadFiles().catch(err => {
                    console.error("ファイル読み込みエラー:", err);
                    showToast('ファイルの読み込みに失敗しました', 'error');
                    hideLoading();
                    showEmptyState();
                });
                
                loadFolders().catch(err => {
                    console.error("フォルダ読み込みエラー:", err);
                });
                
                loadUsers().catch(err => {
                    console.error("ユーザー読み込みエラー:", err);
                });
                
                fetchStorageUsage().catch(err => {
                    console.error("使用量取得エラー:", err);
                });
            } else {
                // ログインしていない場合はログインページにリダイレクト
                window.location.href = 'login.html';
            }
        });

        // ユーザーデータの取得
        async function fetchUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // ユーザー名を表示
                    if (sidebarUserName) {
                        sidebarUserName.textContent = userData.displayName || 'ゲスト';
                    }
                    
                    // ユーザーアバター設定
                    if (userInitial) {
                        const initial = (userData.displayName || 'U').charAt(0).toUpperCase();
                        userInitial.textContent = initial;
                        
                        if (userData.profileImageUrl) {
                            const avatarImg = document.createElement('img');
                            avatarImg.src = userData.profileImageUrl;
                            avatarImg.alt = userData.displayName || 'ユーザー';
                            userAvatar.innerHTML = '';
                            userAvatar.appendChild(avatarImg);
                        }
                    }
                } else {
                    console.log("ユーザーデータが見つかりません");
                }
            } catch (error) {
                console.error("ユーザーデータ取得エラー:", error);
            }
        }

        // ファイル一覧の読み込み
        async function loadFiles() {
            try {
                // ローディング表示を確実に表示
                showLoading();
                
                // 既存のファイル表示をクリア
                fileGridContainer.innerHTML = '';
                fileListContainer.innerHTML = '';
                fileListContainer.appendChild(createListHeader());
                
                // 検索クエリ取得
                const searchQuery = fileSearchInput.value.toLowerCase();
                
                // 基本的なクエリで、現在のフォルダのファイルを取得
                let filesArray = [];
                let foldersArray = [];
                
                try {
                    // 個人用ファイル取得
                    const userFilesRef = db.collection('files').where('userId', '==', currentUser.uid);
                    
                    // ゴミ箱かどうかでフィルタリング
                    const trashedFilesRef = userFilesRef.where('trashed', '==', currentView === 'trashed');
                    
                    // 親フォルダでフィルタリング
                    const filesSnapshot = await trashedFilesRef.get();
                    
                    // クライアント側でフィルタリング
                    filesSnapshot.forEach(doc => {
                        const fileData = { id: doc.id, ...doc.data() };
                        
                        // 親フォルダと表示モードで絞り込み
                        if ((fileData.parentFolder === currentFolder || 
                            (currentFolder === 'root' && fileData.parentFolder === 'root')) &&
                           (currentView === 'trashed' || // ゴミ箱表示の場合はすべて表示
                            currentView === 'personal' && fileData.visibility === 'personal' ||
                            currentView === 'shared' && fileData.visibility === 'shared' ||
                            currentView === 'public' && fileData.visibility === 'public')) {
                            
                            // ファイルタイプでフィルタリング
                            if (currentFileType === 'all' || currentFileType === fileData.fileType) {
                                // 検索クエリでフィルタリング
                                if (!searchQuery || fileData.name.toLowerCase().includes(searchQuery)) {
                                    filesArray.push(fileData);
                                }
                            }
                        }
                    });
                    
                    // フォルダも同様に取得
                    const userFoldersRef = db.collection('folders').where('userId', '==', currentUser.uid);
                    const trashedFoldersRef = userFoldersRef.where('trashed', '==', currentView === 'trashed');
                    const foldersSnapshot = await trashedFoldersRef.get();
                    
                    foldersSnapshot.forEach(doc => {
                        const folderData = { id: doc.id, ...doc.data(), isFolder: true };
                        
                        // 親フォルダと表示モードで絞り込み
                        if ((folderData.parentFolder === currentFolder || 
                            (currentFolder === 'root' && folderData.parentFolder === 'root')) &&
                           (currentView === 'trashed' || // ゴミ箱表示の場合はすべて表示
                            currentView === 'personal' && folderData.visibility === 'personal' ||
                            currentView === 'shared' && folderData.visibility === 'shared' ||
                            currentView === 'public' && folderData.visibility === 'public')) {
                            
                            // 検索クエリでフィルタリング
                            if (!searchQuery || folderData.name.toLowerCase().includes(searchQuery)) {
                                foldersArray.push(folderData);
                            }
                        }
                    });
                    
                    // 共有/公開ファイルの取得（自分の所有でないもの）
                    if (currentView === 'shared' || currentView === 'public') {
                        const visibility = currentView; // 'shared' または 'public'
                        
                        const sharedFilesRef = db.collection('files')
                            .where('visibility', '==', visibility)
                            .where('trashed', '==', false);
                        
                        const sharedFilesSnapshot = await sharedFilesRef.get();
                        
                        sharedFilesSnapshot.forEach(doc => {
                            const fileData = { id: doc.id, ...doc.data() };
                            
                            // 自分のファイルは既に取得済みなのでスキップ
                            if (fileData.userId === currentUser.uid) return;
                            
                            // 共有設定のチェック
                            if (visibility === 'shared' && 
                                (!fileData.sharedWith || !fileData.sharedWith.includes(currentUser.uid))) {
                                return; // 共有対象でなければスキップ
                            }
                            
                            // 親フォルダでフィルタリング
                            if (fileData.parentFolder === currentFolder ||
                                (currentFolder === 'root' && fileData.parentFolder === 'root')) {
                                
                                // ファイルタイプでフィルタリング
                                if (currentFileType === 'all' || currentFileType === fileData.fileType) {
                                    // 検索クエリでフィルタリング
                                    if (!searchQuery || fileData.name.toLowerCase().includes(searchQuery)) {
                                        filesArray.push(fileData);
                                    }
                                }
                            }
                        });
                        
                        // 共有/公開フォルダも同様に取得
                        const sharedFoldersRef = db.collection('folders')
                            .where('visibility', '==', visibility)
                            .where('trashed', '==', false);
                        
                        const sharedFoldersSnapshot = await sharedFoldersRef.get();
                        
                        sharedFoldersSnapshot.forEach(doc => {
                            const folderData = { id: doc.id, ...doc.data(), isFolder: true };
                            
                            // 自分のフォルダはスキップ
                            if (folderData.userId === currentUser.uid) return;
                            
                            // 共有設定のチェック
                            if (visibility === 'shared' && 
                                (!folderData.sharedWith || !folderData.sharedWith.includes(currentUser.uid))) {
                                return; // 共有対象でなければスキップ
                            }
                            
                            // 親フォルダでフィルタリング
                            if (folderData.parentFolder === currentFolder ||
                                (currentFolder === 'root' && folderData.parentFolder === 'root')) {
                                
                                // 検索クエリでフィルタリング
                                if (!searchQuery || folderData.name.toLowerCase().includes(searchQuery)) {
                                    foldersArray.push(folderData);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error("クエリエラー:", error);
                    showToast('データの取得中にエラーが発生しました', 'error');
                }
                
                // 結合とソート
                const allItems = [...foldersArray, ...filesArray];
                
                // ソート
                const sortOption = sortSelect.value;
                allItems.sort((a, b) => {
                    // フォルダを先に表示
                    if (a.isFolder && !b.isFolder) return -1;
                    if (!a.isFolder && b.isFolder) return 1;
                    
                    // 同じタイプならソート条件で比較
                    switch (sortOption) {
                        case 'name-asc':
                            return a.name.localeCompare(b.name);
                        case 'name-desc':
                            return b.name.localeCompare(a.name);
                        case 'date-desc':
                            return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
                        case 'date-asc':
                            return new Date(a.updatedAt || 0) - new Date(b.updatedAt || 0);
                        case 'size-desc':
                            return (b.size || 0) - (a.size || 0);
                        case 'size-asc':
                            return (a.size || 0) - (b.size || 0);
                        default:
                            return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
                    }
                });
                
                // 結果をレンダリング
                if (allItems.length === 0) {
                    showEmptyState();
                } else {
                    hideEmptyState();
                    hideLoading();
                    
                    // ファイルをレンダリング
                    allItems.forEach(item => {
                        // グリッドビュー用のカード作成
                        fileGridContainer.appendChild(createFileCard(item));
                        
                        // リストビュー用の行作成
                        fileListContainer.appendChild(createFileListItem(item));
                    });
                }
            } catch (error) {
                console.error("ファイル一覧取得エラー:", error);
                showToast('ファイル一覧の取得中にエラーが発生しました', 'error');
                hideLoading();
                showEmptyState();
            }
        }

        // フォルダ一覧の取得（サイドバー用）
        async function loadFolders() {
            try {
                // 既存のフォルダ一覧を取得（ルートは常に表示）
                const rootItem = document.createElement('li');
                rootItem.className = currentFolder === 'root' ? 'sidebar-item active' : 'sidebar-item';
                rootItem.setAttribute('data-folder', 'root');
                rootItem.innerHTML = '<i class="fas fa-folder"></i> ルート';
                rootItem.addEventListener('click', () => changeFolder('root'));
                
                // フォルダリストをクリア
                folderListContainer.innerHTML = '';
                folderListContainer.appendChild(rootItem);
                
                // モーダル内のフォルダリストもクリア
                uploadFolder.innerHTML = '<option value="root">ルート</option>';
                parentFolder.innerHTML = '<option value="root">ルート</option>';
                moveDestination.innerHTML = '<option value="root">ルート</option>';
                
                try {
                    // ユーザーのフォルダを取得
                    const foldersQuery = db.collection('folders')
                        .where('userId', '==', currentUser.uid)
                        .where('trashed', '==', false);
                    
                    const foldersSnapshot = await foldersQuery.get();
                    
                    // フォルダ一覧作成
                    foldersSnapshot.forEach(doc => {
                        const folder = { id: doc.id, ...doc.data() };
                        
                        // サイドバー用
                        const folderItem = document.createElement('li');
                        folderItem.className = currentFolder === folder.id ? 'sidebar-item active' : 'sidebar-item';
                        folderItem.setAttribute('data-folder', folder.id);
                        folderItem.innerHTML = `<i class="fas fa-folder"></i> ${folder.name}`;
                        folderItem.addEventListener('click', () => changeFolder(folder.id));
                        folderListContainer.appendChild(folderItem);
                        
                        // アップロードモーダル用
                        const uploadOption = document.createElement('option');
                        uploadOption.value = folder.id;
                        uploadOption.textContent = folder.name;
                        uploadFolder.appendChild(uploadOption);
                        
                        // 新規フォルダモーダル用
                        const parentOption = document.createElement('option');
                        parentOption.value = folder.id;
                        parentOption.textContent = folder.name;
                        parentFolder.appendChild(parentOption);
                        
                        // 移動モーダル用
                        const moveOption = document.createElement('option');
                        moveOption.value = folder.id;
                        moveOption.textContent = folder.name;
                        moveDestination.appendChild(moveOption);
                    });
                } catch (error) {
                    console.error("フォルダデータ取得エラー:", error);
                    showToast('フォルダの読み込みに失敗しました', 'warning');
                }
            } catch (error) {
                console.error("フォルダ一覧取得エラー:", error);
                showToast('フォルダ一覧を取得できませんでした', 'warning');
            }
        }

        // ユーザー一覧の取得（共有設定用）
        async function loadUsers() {
            try {
                // 共有ユーザー選択リストをクリア
                shareUsers.innerHTML = '';
                folderUsers.innerHTML = '';
                shareSettingsUsersSelect.innerHTML = '';
                
                try {
                    // ユーザー一覧を取得（インデックスの問題を回避するため、単純なクエリに変更）
                    const usersSnapshot = await db.collection('users').get();
                    
                    usersSnapshot.forEach(doc => {
                        const user = doc.data();
                        
                        // 自分以外のユーザーをリストに追加
                        if (user.uid === currentUser.uid) return;
                        
                        // アップロード時の共有設定用
                        const uploadOption = document.createElement('option');
                        uploadOption.value = user.uid;
                        uploadOption.textContent = user.displayName || user.email || 'ユーザー';
                        shareUsers.appendChild(uploadOption);
                        
                        // フォルダ共有設定用
                        const folderOption = document.createElement('option');
                        folderOption.value = user.uid;
                        folderOption.textContent = user.displayName || user.email || 'ユーザー';
                        folderUsers.appendChild(folderOption);
                        
                        // 共有設定変更用
                        const shareOption = document.createElement('option');
                        shareOption.value = user.uid;
                        shareOption.textContent = user.displayName || user.email || 'ユーザー';
                        shareSettingsUsersSelect.appendChild(shareOption);
                    });
                } catch (error) {
                    console.error("ユーザーデータ取得エラー:", error);
                    showToast('ユーザー一覧を取得できませんでした', 'warning');
                }
            } catch (error) {
                console.error("ユーザー一覧取得エラー:", error);
                showToast('ユーザー一覧を取得できませんでした', 'warning');
            }
        }

        // ストレージ使用量の取得
        async function fetchStorageUsage() {
            try {
                let totalUsage = 0;
                
                try {
                    // ユーザーのファイル一覧を取得して合計サイズを計算
                    const filesQuery = db.collection('files')
                        .where('userId', '==', currentUser.uid)
                        .where('trashed', '==', false);
                    
                    const filesSnapshot = await filesQuery.get();
                    
                    filesSnapshot.forEach(doc => {
                        const file = doc.data();
                        totalUsage += file.size || 0;
                    });
                } catch (error) {
                    console.error("ファイルサイズ計算エラー:", error);
                }
                
                // 無料プランの上限（10GB）
                const freeLimit = 10 * 1024 * 1024 * 1024; // 10GB in bytes
                
                // 表示更新
                const usagePercent = Math.min(100, (totalUsage / freeLimit) * 100);
                storageProgress.style.width = `${usagePercent}%`;
                
                // 使用量表示
                storageUsed.textContent = formatFileSize(totalUsage);
                storageTotal.textContent = formatFileSize(freeLimit);
                
                // 使用量が多い場合は警告表示
                if (usagePercent > 90) {
                    storageBadge.textContent = "危険";
                    storageBadge.className = "badge badge-danger";
                } else if (usagePercent > 70) {
                    storageBadge.textContent = "警告";
                    storageBadge.className = "badge badge-warning";
                }
            } catch (error) {
                console.error("ストレージ使用量取得エラー:", error);
                // エラーがあっても表示は更新
                storageUsed.textContent = "計算できませんでした";
                storageProgress.style.width = "0%";
            }
        }

        // ファイルカードの作成（グリッドビュー用）
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'file-card';
            card.setAttribute('data-id', file.id);
            card.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
            
            // アイコンまたはサムネイル
            let iconHtml = '';
            if (file.isFolder) {
                iconHtml = `<div class="file-icon folder-icon"><i class="fas fa-folder"></i></div>`;
            } else if (file.fileType === 'image' && file.thumbnail) {
                // 画像ファイルの場合はサムネイル表示を適切に制御
                iconHtml = `<div class="file-image"><img src="${file.thumbnail}" alt="${file.name}" loading="lazy"></div>`;
            } else {
                // ファイルタイプ別のアイコン
                let iconClass = 'file-icon';
                let faIcon = 'fa-file';
                
                switch (file.fileType) {
                    case 'pdf':
                        iconClass += ' pdf-icon';
                        faIcon = 'fa-file-pdf';
                        break;
                    case 'document':
                        iconClass += ' doc-icon';
                        faIcon = 'fa-file-alt';
                        break;
                    case 'image':
                        iconClass += ' image-icon';
                        faIcon = 'fa-file-image';
                        break;
                    default:
                        iconClass += '';
                        faIcon = 'fa-file';
                }
                
                iconHtml = `<div class="${iconClass}"><i class="fas ${faIcon}"></i></div>`;
            }
            
            // 更新日
            const updatedAt = file.updatedAt ? new Date(file.updatedAt.seconds * 1000) : new Date();
            const formattedDate = updatedAt.toLocaleDateString('ja-JP');
            
            // 共有アイコン
            let shareIcon = '';
            if (file.visibility === 'shared') {
                shareIcon = '<i class="fas fa-share-alt ml-1" style="color: var(--info);"></i>';
            } else if (file.visibility === 'public') {
                shareIcon = '<i class="fas fa-globe ml-1" style="color: var(--success);"></i>';
            }
            
            // HTML作成
            card.innerHTML = `
                ${iconHtml}
                <div class="file-card-name" title="${file.name}">${file.name}${shareIcon}</div>
                <div class="file-card-date">${formattedDate}</div>
                <div class="file-card-actions">
                    <span class="file-card-action" data-action="more"><i class="fas fa-ellipsis-v"></i></span>
                </div>
            `;
            
            // イベントリスナー
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.file-card-action')) {
                    // フォルダの場合は開く
                    if (file.isFolder) {
                        changeFolder(file.id);
                    } else {
                        // ファイルの場合はプレビューまたはダウンロード
                        openFile(file);
                    }
                }
            });
            
            // 右クリックメニュー
            card.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                activeFile = file;
                showContextMenu(e.clientX, e.clientY, file);
            });
            
            // 「...」ボタンクリック
            const moreBtn = card.querySelector('[data-action="more"]');
            if (moreBtn) {
                moreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    activeFile = file;
                    const rect = moreBtn.getBoundingClientRect();
                    showContextMenu(rect.right, rect.bottom, file);
                });
            }
            
            return card;
        }

        // ファイルリスト行の作成（リストビュー用）
        function createFileListItem(file) {
            const item = document.createElement('div');
            item.className = 'file-list-item';
            item.setAttribute('data-id', file.id);
            item.setAttribute('data-type', file.isFolder ? 'folder' : 'file');
            
            // アイコン選択
            let iconClass = 'fa-file';
            if (file.isFolder) {
                iconClass = 'fa-folder';
            } else {
                switch (file.fileType) {
                    case 'pdf':
                        iconClass = 'fa-file-pdf';
                        break;
                    case 'document':
                        iconClass = 'fa-file-alt';
                        break;
                    case 'image':
                        iconClass = 'fa-file-image';
                        break;
                }
            }
            
            // 更新日
            const updatedAt = file.updatedAt ? new Date(file.updatedAt.seconds * 1000) : new Date();
            const formattedDate = updatedAt.toLocaleDateString('ja-JP');
            
            // 共有アイコン
            let shareIcon = '';
            if (file.visibility === 'shared') {
                shareIcon = '<i class="fas fa-share-alt ml-1" style="color: var(--info);"></i>';
            } else if (file.visibility === 'public') {
                shareIcon = '<i class="fas fa-globe ml-1" style="color: var(--success);"></i>';
            }
            
            // HTML作成
            item.innerHTML = `
                <div><i class="fas ${iconClass} mr-2"></i> ${file.name} ${shareIcon}</div>
                <div class="owner-col">${file.ownerName || '自分'}</div>
                <div class="date-col">${formattedDate}</div>
                <div class="size-col">${file.isFolder ? '-' : formatFileSize(file.size || 0)}</div>
                <div>
                    <span class="btn btn-sm btn-icon btn-outline" data-action="more">
                        <i class="fas fa-ellipsis-v"></i>
                    </span>
                </div>
            `;
            
            // イベントリスナー
            item.addEventListener('click', (e) => {
                if (!e.target.closest('[data-action]')) {
                    // フォルダの場合は開く
                    if (file.isFolder) {
                        changeFolder(file.id);
                    } else {
                        // ファイルの場合はプレビューまたはダウンロード
                        openFile(file);
                    }
                }
            });
            
            // 右クリックメニュー
            item.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                activeFile = file;
                showContextMenu(e.clientX, e.clientY, file);
            });
            
            // 「...」ボタンクリック
            const moreBtn = item.querySelector('[data-action="more"]');
            if (moreBtn) {
                moreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    activeFile = file;
                    const rect = moreBtn.getBoundingClientRect();
                    showContextMenu(rect.right, rect.bottom, file);
                });
            }
            
            return item;
        }

        // リストビューのヘッダー行作成
        function createListHeader() {
            const header = document.createElement('div');
            header.className = 'file-list-header';
            header.innerHTML = `
                <div>名前</div>
                <div class="owner-col">所有者</div>
                <div class="date-col">更新日</div>
                <div class="size-col">サイズ</div>
                <div></div>
            `;
            return header;
        }

        // コンテキストメニュー（右クリックメニュー）表示
        function showContextMenu(x, y, file) {
            // メニュー内容のカスタマイズ
            contextMenu.innerHTML = '';
            
            if (currentView === 'trashed') {
                // ゴミ箱内のファイル用メニュー
                contextMenu.innerHTML = `
                    <div class="action-menu-item" data-action="restore">
                        <i class="fas fa-trash-restore"></i> 復元する
                    </div>
                    <div class="action-menu-item" data-action="delete-permanent">
                        <i class="fas fa-trash-alt"></i> 完全に削除
                    </div>
                `;
            } else {
                // 通常のファイル用メニュー
                if (file.isFolder) {
                    contextMenu.innerHTML += `
                        <div class="action-menu-item" data-action="open">
                            <i class="fas fa-folder-open"></i> 開く
                        </div>
                    `;
                } else {
                    contextMenu.innerHTML += `
                        <div class="action-menu-item" data-action="open">
                            <i class="fas fa-external-link-alt"></i> 開く
                        </div>
                        <div class="action-menu-item" data-action="download">
                            <i class="fas fa-download"></i> ダウンロード
                        </div>
                    `;
                }
                
                // 共通メニュー項目（所有者のみ編集可能）
                if (file.userId === currentUser.uid) {
                    contextMenu.innerHTML += `
                        <div class="action-menu-item" data-action="rename">
                            <i class="fas fa-edit"></i> 名前変更
                        </div>
                        <div class="action-menu-item" data-action="share">
                            <i class="fas fa-share-alt"></i> 共有設定
                        </div>
                        <div class="action-menu-item" data-action="move">
                            <i class="fas fa-folder-minus"></i> 移動
                        </div>
                        <div class="action-menu-item" data-action="delete">
                            <i class="fas fa-trash"></i> 削除
                        </div>
                    `;
                }
            }
            
            // イベントリスナー設定
            const actionItems = contextMenu.querySelectorAll('.action-menu-item');
            actionItems.forEach(item => {
                item.addEventListener('click', handleContextMenuAction);
            });
            
            // メニュー位置調整
            const menuWidth = 180;
            const menuHeight = contextMenu.scrollHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // 画面右端を超える場合
            if (x + menuWidth > windowWidth) {
                x = windowWidth - menuWidth - 10;
            }
            
            // 画面下端を超える場合
            if (y + menuHeight > windowHeight) {
                y = windowHeight - menuHeight - 10;
            }
            
            // メニュー表示
            contextMenu.style.top = `${y}px`;
            contextMenu.style.left = `${x}px`;
            contextMenu.classList.add('show');
            
            // ドキュメントのクリックイベントで非表示に
            document.addEventListener('click', hideContextMenu);
        }

        // コンテキストメニュー非表示
        function hideContextMenu() {
            contextMenu.classList.remove('show');
            document.removeEventListener('click', hideContextMenu);
        }

        // コンテキストメニューアクションハンドラ
        function handleContextMenuAction(e) {
            const action = e.currentTarget.getAttribute('data-action');
            
            if (!activeFile) return;
            
            switch (action) {
                case 'open':
                    if (activeFile.isFolder) {
                        changeFolder(activeFile.id);
                    } else {
                        openFile(activeFile);
                    }
                    break;
                case 'download':
                    downloadFile(activeFile);
                    break;
                case 'rename':
                    showRenameModal(activeFile);
                    break;
                case 'share':
                    showShareModal(activeFile);
                    break;
                case 'move':
                    showMoveModal(activeFile);
                    break;
                case 'delete':
                    showDeleteModal(activeFile);
                    break;
                case 'restore':
                    restoreFromTrash(activeFile);
                    break;
                case 'delete-permanent':
                    showPermanentDeleteModal(activeFile);
                    break;
            }
            
            hideContextMenu();
        }

        // フォルダ変更
        async function changeFolder(folderId) {
            try {
                // 前のフォルダに戻るように履歴に追加する処理も可能
                currentFolder = folderId;
                
                // サイドバーのアクティブ項目更新
                document.querySelectorAll('#folder-list .sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeItem = document.querySelector(`#folder-list [data-folder="${folderId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
                // ファイル一覧再読み込み
                await loadFiles();
            } catch (error) {
                console.error("フォルダ変更エラー:", error);
                showToast('フォルダを開けませんでした', 'error');
            }
        }

        // ファイルを開く
        function openFile(file) {
            try {
                if (file.fileType === 'image') {
                    // 画像プレビュー表示
                    showImagePreview(file);
                } else if (file.fileType === 'pdf') {
                    // PDF表示は新しいタブで開く
                    window.open(file.url, '_blank');
                } else {
                    // その他のファイルはダウンロード
                    downloadFile(file);
                }
            } catch (error) {
                console.error("ファイルを開くエラー:", error);
                showToast('ファイルを開けませんでした', 'error');
            }
        }

        // 画像プレビュー表示
        function showImagePreview(file) {
            if (!file || !file.url) {
                showToast('画像URLが見つかりません', 'error');
                return;
            }
            
            // 画像URLをセット
            previewImage.src = ''; // 一度クリア
            previewImage.src = file.url;
            previewImage.alt = file.name;
            
            // モーダル表示
            imagePreviewModal.classList.add('show');
        }

        // ファイルダウンロード
        async function downloadFile(file) {
            try {
                if (!file || !file.url) {
                    showToast('ダウンロードURLが見つかりません', 'error');
                    return;
                }
                
                // ダウンロード用のリンク作成
                const downloadLink = document.createElement('a');
                downloadLink.href = file.url;
                downloadLink.download = file.name;
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                
                // クリックしてダウンロード開始
                downloadLink.click();
                
                // クリーンアップ
                document.body.removeChild(downloadLink);
                
                showToast(`「${file.name}」のダウンロードを開始しました`, 'success');
            } catch (error) {
                console.error("ダウンロードエラー:", error);
                showToast('ダウンロードできませんでした', 'error');
            }
        }

        // 名前変更モーダル表示
        function showRenameModal(file) {
            newName.value = file.name;
            renameFileId.value = file.id;
            renameFileType.value = file.isFolder ? 'folder' : 'file';
            
            // モーダル表示
            renameModal.classList.add('show');
        }

        // 共有設定モーダル表示
        function showShareModal(file) {
            shareFileId.value = file.id;
            shareFileType.value = file.isFolder ? 'folder' : 'file';
            
            // 現在の共有設定を反映
            shareVisibility.value = file.visibility || 'personal';
            
            // 共有設定に応じてUI表示
            updateShareModalUI();
            
            // 共有ユーザー選択肢を生成（現在の共有ユーザーをプリセット）
            if (file.visibility === 'shared' && file.sharedWith && file.sharedWith.length > 0) {
                // 共有ユーザーを選択状態に
                Array.from(shareSettingsUsersSelect.options).forEach(option => {
                    option.selected = file.sharedWith.includes(option.value);
                });
            } else {
                // 選択解除
                Array.from(shareSettingsUsersSelect.options).forEach(option => {
                    option.selected = false;
                });
            }
            
            // 公開リンク生成（公開ファイルの場合）
            if (file.visibility === 'public') {
                const baseUrl = window.location.origin;
                shareLink.value = `${baseUrl}/view.html?id=${file.id}&type=${file.isFolder ? 'folder' : 'file'}`;
            }
            
            // モーダル表示
            shareModal.classList.add('show');
        }

        // 共有設定モーダルUI更新
        function updateShareModalUI() {
            const visibility = shareVisibility.value;
            
            // 共有ユーザー選択部分の表示/非表示
            if (visibility === 'shared') {
                shareSettingsUsers.style.display = 'block';
                shareLinkContainer.style.display = 'none';
            } else if (visibility === 'public') {
                shareSettingsUsers.style.display = 'none';
                shareLinkContainer.style.display = 'block';
            } else {
                shareSettingsUsers.style.display = 'none';
                shareLinkContainer.style.display = 'none';
            }
        }

        // 移動モーダル表示
        function showMoveModal(file) {
            moveFileId.value = file.id;
            moveFileType.value = file.isFolder ? 'folder' : 'file';
            
            // 現在のフォルダを選択
            moveDestination.value = file.parentFolder || 'root';
            
            // 自分自身（フォルダの場合）と子フォルダは移動先から除外
            if (file.isFolder) {
                Array.from(moveDestination.options).forEach(option => {
                    if (option.value === file.id) {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                });
            }
            
            // モーダル表示
            moveModal.classList.add('show');
        }

        // 削除確認モーダル表示
        function showDeleteModal(file) {
            deleteFileId.value = file.id;
            deleteFileType.value = file.isFolder ? 'folder' : 'file';
            
            // メッセージ更新
            deleteMessage.textContent = file.isFolder
                ? `フォルダ「${file.name}」とその中のすべてのファイルをゴミ箱に移動しますか？`
                : `ファイル「${file.name}」をゴミ箱に移動しますか？`;
            
            // モーダル表示
            deleteModal.classList.add('show');
        }

        // 完全削除確認モーダル表示
        function showPermanentDeleteModal(file) {
            permanentDeleteFileId.value = file.id;
            permanentDeleteFileType.value = file.isFolder ? 'folder' : 'file';
            
            // メッセージ更新
            permanentDeleteMessage.textContent = file.isFolder
                ? `フォルダ「${file.name}」とその中のすべてのファイルを完全に削除しますか？この操作は取り消せません。`
                : `ファイル「${file.name}」を完全に削除しますか？この操作は取り消せません。`;
            
            // モーダル表示
            permanentDeleteModal.classList.add('show');
        }

        // ゴミ箱から復元
        async function restoreFromTrash(file) {
            try {
                const docRef = file.isFolder
                    ? db.collection('folders').doc(file.id)
                    : db.collection('files').doc(file.id);
                
                await docRef.update({
                    trashed: false,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`「${file.name}」を復元しました`, 'success');
                loadFiles();
            } catch (error) {
                console.error("復元エラー:", error);
                showToast('復元できませんでした', 'error');
            }
        }

        // ファイル名変更処理
        async function renameFile() {
            const fileId = renameFileId.value;
            const fileType = renameFileType.value;
            const name = newName.value.trim();
            
            if (!name) {
                showToast('名前を入力してください', 'error');
                return;
            }
            
            try {
                const collection = fileType === 'folder' ? 'folders' : 'files';
                const docRef = db.collection(collection).doc(fileId);
                
                await docRef.update({
                    name: name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('名前を変更しました', 'success');
                
                // モーダルを閉じる
                closeModal(renameModal);
                
                // ファイル一覧再読み込み
                loadFiles();
            } catch (error) {
                console.error("名前変更エラー:", error);
                showToast('名前を変更できませんでした', 'error');
            }
        }

        // 共有設定変更処理
        async function updateShareSettings() {
            const fileId = shareFileId.value;
            const fileType = shareFileType.value;
            const visibility = shareVisibility.value;
            
            try {
                const collection = fileType === 'folder' ? 'folders' : 'files';
                const docRef = db.collection(collection).doc(fileId);
                
                const updateData = {
                    visibility: visibility,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 選択されたユーザーIDを取得
                if (visibility === 'shared') {
                    const selectedUsers = Array.from(shareSettingsUsersSelect.selectedOptions).map(option => option.value);
                    updateData.sharedWith = selectedUsers;
                } else {
                    // 個人用または公開の場合は共有ユーザーリストをクリア
                    updateData.sharedWith = [];
                }
                
                await docRef.update(updateData);
                
                showToast('共有設定を更新しました', 'success');
                
                // モーダルを閉じる
                closeModal(shareModal);
                
                // ファイル一覧再読み込み
                loadFiles();
            } catch (error) {
                console.error("共有設定変更エラー:", error);
                showToast('共有設定を更新できませんでした', 'error');
            }
        }
        // ファイル移動処理
        async function moveFile() {
            const fileId = moveFileId.value;
            const fileType = moveFileType.value;
            const destination = moveDestination.value;
            
            try {
                const collection = fileType === 'folder' ? 'folders' : 'files';
                const docRef = db.collection(collection).doc(fileId);
                
                await docRef.update({
                    parentFolder: destination,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('ファイルを移動しました', 'success');
                
                // モーダルを閉じる
                closeModal(moveModal);
                
                // ファイル一覧再読み込み
                loadFiles();
            } catch (error) {
                console.error("ファイル移動エラー:", error);
                showToast('ファイルを移動できませんでした', 'error');
            }
        }

        // ゴミ箱へ移動（論理削除）
        async function moveToTrash() {
            const fileId = deleteFileId.value;
            const fileType = deleteFileType.value;
            
            try {
                const collection = fileType === 'folder' ? 'folders' : 'files';
                const docRef = db.collection(collection).doc(fileId);
                
                await docRef.update({
                    trashed: true,
                    trashedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('ゴミ箱に移動しました', 'success');
                
                // モーダルを閉じる
                closeModal(deleteModal);
                
                // ファイル一覧再読み込み
                loadFiles();
            } catch (error) {
                console.error("ゴミ箱移動エラー:", error);
                showToast('ゴミ箱に移動できませんでした', 'error');
            }
        }

        // 完全削除（物理削除）
        async function permanentDelete() {
            const fileId = permanentDeleteFileId.value;
            const fileType = permanentDeleteFileType.value;
            
            try {
                const collection = fileType === 'folder' ? 'folders' : 'files';
                const docRef = db.collection(collection).doc(fileId);
                
                // ファイルの場合はストレージからも削除
                if (fileType === 'file') {
                    const fileDoc = await docRef.get();
                    const file = fileDoc.data();
                    
                    if (file && file.storagePath) {
                        try {
                            await storage.ref(file.storagePath).delete();
                        } catch (storageError) {
                            console.error("ストレージ削除エラー:", storageError);
                            // ストレージ削除失敗でもFirestore削除は続行
                        }
                    }
                }
                
                // Firestoreから削除
                await docRef.delete();
                
                showToast('完全に削除しました', 'success');
                
                // モーダルを閉じる
                closeModal(permanentDeleteModal);
                
                // ファイル一覧再読み込み
                loadFiles();
                
                // ストレージ使用量更新
                fetchStorageUsage();
            } catch (error) {
                console.error("完全削除エラー:", error);
                showToast('削除できませんでした', 'error');
            }
        }

        // 新規フォルダ作成処理
        async function createFolder() {
            const name = folderName.value.trim();
            const parent = parentFolder.value;
            const visibility = folderVisibility.value;
            
            if (!name) {
                showToast('フォルダ名を入力してください', 'error');
                return;
            }
            
            try {
                // 選択されたユーザーIDを取得（共有設定の場合）
                let sharedWith = [];
                if (visibility === 'shared') {
                    sharedWith = Array.from(folderUsers.selectedOptions).map(option => option.value);
                }
                
                // フォルダ作成
                const folderData = {
                    name: name,
                    parentFolder: parent,
                    userId: currentUser.uid,
                    ownerName: currentUser.displayName || '',
                    visibility: visibility,
                    sharedWith: sharedWith,
                    trashed: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('folders').add(folderData);
                
                showToast(`フォルダ「${name}」を作成しました`, 'success');
                
                // モーダルを閉じる
                closeModal(folderModal);
                
                // フォルダとファイル一覧再読み込み
                loadFolders();
                loadFiles();
            } catch (error) {
                console.error("フォルダ作成エラー:", error);
                showToast('フォルダを作成できませんでした', 'error');
            }
        }

        // ファイルアップロード処理
        async function uploadFiles(files) {
            if (!files || files.length === 0) {
                showToast('ファイルが選択されていません', 'error');
                return;
            }
            
            // アップロード先フォルダと共有設定
            const folder = uploadFolder.value;
            const visibility = uploadVisibility.value;
            
            // 選択されたユーザーIDを取得（共有設定の場合）
            let sharedWith = [];
            if (visibility === 'shared') {
                sharedWith = Array.from(shareUsers.selectedOptions).map(option => option.value);
            }
            
            // プログレスコンテナ表示
            uploadProgressContainer.style.display = 'block';
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // ファイルサイズチェック
                    const maxFileSize = 100 * 1024 * 1024; // 100MB
                    if (file.size > maxFileSize) {
                        showToast(`ファイル「${file.name}」は最大サイズ（100MB）を超えています`, 'warning');
                        continue; // このファイルはスキップ
                    }
                    
                    // アップロード中のファイル名とインデックスを表示
                    uploadProgressText.textContent = `アップロード中: ${file.name} (${i + 1}/${files.length})`;
                    
                    // ファイルタイプの判定
                    let fileType = 'other';
                    if (file.type.startsWith('image/')) {
                        fileType = 'image';
                    } else if (file.type === 'application/pdf') {
                        fileType = 'pdf';
                    } else if (file.type.includes('document') || file.type.includes('text')) {
                        fileType = 'document';
                    }
                    
                    // Storageへアップロード
                    const timestamp = new Date().getTime();
                    const storagePath = `files/${currentUser.uid}/${timestamp}_${file.name}`;
                    const uploadTask = storage.ref(storagePath).put(file);
                    
                    // アップロードの進捗監視
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // 進捗状況
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgressBar.style.width = `${progress}%`;
                            
                            // 転送サイズ表示
                            const transferred = formatFileSize(snapshot.bytesTransferred);
                            const total = formatFileSize(snapshot.totalBytes);
                            uploadProgressSize.textContent = `${transferred} / ${total}`;
                        },
                        (error) => {
                            // エラー処理
                            console.error("アップロードエラー:", error);
                            showToast(`「${file.name}」のアップロードに失敗しました`, 'error');
                        },
                        async () => {
                            // 完了時の処理
                            try {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // サムネイル作成（画像の場合）
                                let thumbnail = null;
                                if (fileType === 'image') {
                                    thumbnail = downloadURL;
                                }
                                
                                // Firestoreにファイル情報を保存
                                const fileData = {
                                    name: file.name,
                                    originalName: file.name,
                                    storagePath: storagePath,
                                    url: downloadURL,
                                    thumbnail: thumbnail,
                                    fileType: fileType,
                                    mimeType: file.type,
                                    size: file.size,
                                    parentFolder: folder,
                                    userId: currentUser.uid,
                                    ownerName: currentUser.displayName || '',
                                    visibility: visibility,
                                    sharedWith: sharedWith,
                                    trashed: false,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                await db.collection('files').add(fileData);
                                
                                // 最後のファイルが完了したら処理
                                if (i === files.length - 1) {
                                    showToast(`${files.length}個のファイルをアップロードしました`, 'success');
                                    closeModal(uploadModal);
                                    resetUploadForm();
                                    loadFiles();
                                    fetchStorageUsage();
                                }
                            } catch (error) {
                                console.error("ファイル情報保存エラー:", error);
                                showToast(`「${file.name}」の保存に失敗しました`, 'error');
                            }
                        }
                    );
                }
            } catch (error) {
                console.error("アップロード処理エラー:", error);
                showToast('アップロード処理に失敗しました', 'error');
            }
        }

        // アップロードフォームのリセット
        function resetUploadForm() {
            fileInput.value = '';
            uploadProgressContainer.style.display = 'none';
            uploadProgressBar.style.width = '0%';
            uploadProgressText.textContent = 'アップロード中 (0%)';
            uploadProgressSize.textContent = '0 KB / 0 KB';
            document.querySelector('.dropzone-text').textContent = 'ファイルをドラッグ＆ドロップするか、クリックして選択';
        }

        // ローディング表示
        function showLoading() {
            loadingState.style.display = 'flex';
            emptyState.style.display = 'none';
            fileGridContainer.style.display = 'none';
            fileListContainer.style.display = 'none';
        }

        // ローディング非表示
        function hideLoading() {
            loadingState.style.display = 'none';
            
            if (currentViewMode === 'grid') {
                fileGridContainer.style.display = 'grid';
                fileListContainer.style.display = 'none';
            } else {
                fileGridContainer.style.display = 'none';
                fileListContainer.style.display = 'block';
            }
        }

        // 空の状態表示
        function showEmptyState() {
            emptyState.style.display = 'flex';
            loadingState.style.display = 'none';
            fileGridContainer.style.display = 'none';
            fileListContainer.style.display = 'none';
        }

        // 空の状態非表示
        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // モーダル閉じる
        function closeModal(modal) {
            modal.classList.remove('show');
        }

        // トースト通知表示
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle toast-icon"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle toast-icon"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle toast-icon"></i>';
            }
            
            toast.innerHTML = `${icon}<div>${message}</div>`;
            toastContainer.appendChild(toast);
            
            // 5秒後に自動的に削除
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // ファイルサイズのフォーマット
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ログアウト処理
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error("ログアウトエラー:", error);
                showToast('ログアウトに失敗しました', 'error');
            }
        }

        // テーマ切替
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // アイコンとテキストを切り替え
            if (themeToggle) {
                if (savedTheme === 'dark') {
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
                } else {
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
                }
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // アイコンとテキストを切り替え
            if (themeToggle) {
                if (newTheme === 'dark') {
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
                } else {
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
                }
            }
        }

        // サイドバー切替（モバイル用）
        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('active');
            }
        }

        // ファイルリスト表示切替
        function toggleViewMode(mode) {
            currentViewMode = mode;
            
            if (mode === 'grid') {
                fileGridContainer.style.display = 'grid';
                fileListContainer.style.display = 'none';
                viewGridBtn.classList.add('active');
                viewListBtn.classList.remove('active');
            } else {
                fileGridContainer.style.display = 'none';
                fileListContainer.style.display = 'block';
                viewGridBtn.classList.remove('active');
                viewListBtn.classList.add('active');
            }
            
            localStorage.setItem('fileViewMode', mode);
        }

        // コピーリンクのクリップボードへのコピー
        function copyShareLink() {
            shareLink.select();
            document.execCommand('copy');
            showToast('リンクをコピーしました', 'success');
        }

        // 検索機能
        function searchFiles() {
            loadFiles();
        }

        // ドラッグ&ドロップイベント処理
        function setupDragAndDrop() {
            // ファイルドロップイベント
            uploadDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDropzone.classList.add('dropping');
            });
            
            uploadDropzone.addEventListener('dragleave', () => {
                uploadDropzone.classList.remove('dropping');
            });
            
            uploadDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDropzone.classList.remove('dropping');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.querySelector('.dropzone-text').textContent = 
                        files.length === 1 ? 
                        files[0].name :
                        `${files.length}個のファイルが選択されました`;
                }
            });
            
            // クリック時にファイル選択ダイアログを開く
            uploadDropzone.addEventListener('click', () => {
                fileInput.click();
            });
        }

        // イベントリスナー登録
        document.addEventListener('DOMContentLoaded', () => {
            // テーマ初期化
            initTheme();
            
            // 保存されているビューモード復元
            const savedViewMode = localStorage.getItem('fileViewMode') || 'grid';
            toggleViewMode(savedViewMode);
            
            // 画像プレビューモーダルの閉じるボタン
            closePreviewBtn.addEventListener('click', () => {
                imagePreviewModal.classList.remove('show');
            });
            
            // 画像プレビューモーダル背景クリックで閉じる
            imagePreviewModal.addEventListener('click', (e) => {
                if (e.target === imagePreviewModal) {
                    imagePreviewModal.classList.remove('show');
                }
            });
            
            // ESCキーでモーダルを閉じる
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (imagePreviewModal.classList.contains('show')) {
                        imagePreviewModal.classList.remove('show');
                    }
                    
                    document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                        closeModal(modal);
                    });
                }
            });
            
            // ファイルタブクリック
            fileTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // アクティブタブの切り替え
                    fileTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 表示モード切替
                    currentView = tab.getAttribute('data-view');
                    loadFiles();
                });
            });
            
            // サイドバーアイテムクリック（ファイルタイプ）
            sidebarItems.forEach(item => {
                if (item.hasAttribute('data-type')) {
                    item.addEventListener('click', () => {
                        // アクティブアイテムの切り替え
                        sidebarItems.forEach(i => {
                            if (i.hasAttribute('data-type')) {
                                i.classList.remove('active');
                            }
                        });
                        item.classList.add('active');
                        
                        // ファイルタイプ切替
                        currentFileType = item.getAttribute('data-type');
                        loadFiles();
                    });
                }
            });
            
            // ビュー切替ボタン
            viewGridBtn.addEventListener('click', () => toggleViewMode('grid'));
            viewListBtn.addEventListener('click', () => toggleViewMode('list'));
            
            // ソート変更
            sortSelect.addEventListener('change', () => loadFiles());
            
            // 検索入力
            fileSearchInput.addEventListener('input', () => {
                // 入力中は少し遅延させる
                clearTimeout(fileSearchInput.searchTimeout);
                fileSearchInput.searchTimeout = setTimeout(searchFiles, 300);
            });
            
            // 空の状態からのアップロードボタン
            emptyUploadBtn.addEventListener('click', () => {
                uploadModal.classList.add('show');
            });
            
            // アップロードボタン
            uploadBtn.addEventListener('click', () => {
                uploadModal.classList.add('show');
            });
            
            // 新規フォルダボタン
            newFolderBtn.addEventListener('click', () => {
                folderModal.classList.add('show');
            });
            
            // 共有設定変更時のUI更新
            uploadVisibility.addEventListener('change', () => {
                if (uploadVisibility.value === 'shared') {
                    shareUsersContainer.style.display = 'block';
                } else {
                    shareUsersContainer.style.display = 'none';
                }
            });
            
            folderVisibility.addEventListener('change', () => {
                if (folderVisibility.value === 'shared') {
                    folderShareUsers.style.display = 'block';
                } else {
                    folderShareUsers.style.display = 'none';
                }
            });
            
            shareVisibility.addEventListener('change', updateShareModalUI);
            
            // コピーリンクボタン
            copyLinkBtn.addEventListener('click', copyShareLink);
            
            // ファイル選択イベント
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const fileCount = fileInput.files.length;
                    const fileLabel = fileCount === 1 
                        ? fileInput.files[0].name
                        : `${fileCount}個のファイルが選択されました`;
                        
                    document.querySelector('.dropzone-text').textContent = fileLabel;
                }
            });
            
            // アップロード実行
            uploadSubmit.addEventListener('click', () => {
                if (fileInput.files.length > 0) {
                    uploadFiles(fileInput.files);
                } else {
                    showToast('ファイルを選択してください', 'warning');
                }
            });
            
            // フォルダ作成実行
            folderSubmit.addEventListener('click', createFolder);
            
            // 名前変更実行
            renameSubmit.addEventListener('click', renameFile);
            
            // 共有設定更新実行
            shareSubmit.addEventListener('click', updateShareSettings);
            
            // ファイル移動実行
            moveSubmit.addEventListener('click', moveFile);
            
            // 削除実行
            deleteSubmit.addEventListener('click', moveToTrash);
            
            // 完全削除実行
            permanentDeleteSubmit.addEventListener('click', permanentDelete);
            
            // モーダルを閉じるボタン
            document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal-overlay');
                    closeModal(modal);
                });
            });
            
            // モーダル外クリックで閉じる
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal);
                    }
                });
            });
            
            // ドラッグ&ドロップ設定
            setupDragAndDrop();
            
            // ログアウトボタン
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
            
            // テーマ切替ボタン
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // サイドバー切替ボタン
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // 画面クリックでサイドバーを閉じる（モバイル用）
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    sidebar && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    e.target !== sidebarToggle) {
                    sidebar.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>