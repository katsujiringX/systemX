<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>資料管理 | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .file-categories li i {
    margin-right: 0.75rem;
    width: 1.25rem;
    text-align: center;
}

.storage-info {
    margin-top: auto;
    padding: 1.25rem;
    border-top: 1px solid var(--border-color);
}

.storage-info p {
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    font-size: 0.8125rem;
}

.storage-info .storage-text {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    text-align: right;
}

.storage-bar {
    height: 4px;
    background-color: var(--gray-200);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.storage-used {
    height: 100%;
    background-color: var(--primary);
    transition: width var(--transition-normal);
}

.file-content {
    flex: 1;
    padding: 1.25rem;
    overflow-y: auto;
}

.breadcrumbs {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.breadcrumb-item {
    cursor: pointer;
    color: var(--primary);
    transition: color var(--transition-normal);
}

.breadcrumb-item:hover {
    color: var(--primary-hover);
    text-decoration: underline;
}

/* ファイルコンテナ */
.files-container {
    display: flex;
    flex-wrap: wrap;
}

.files-container.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.25rem;
}

.files-container.list-view {
    display: table;
    width: 100%;
    border-collapse: collapse;
}

.files-container.list-view .file-item-header {
    display: table-row;
    font-weight: 500;
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
}

.files-container.list-view .file-item-header span {
    display: table-cell;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

/* ファイルアイテム - グリッドビュー */
.file-item {
    background-color: var(--bg-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    position: relative;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    border: 1px solid var(--border-color);
}

.file-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.file-icon {
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
}

.file-icon i {
    font-size: 2rem;
}

.file-icon.folder i {
    color: var(--warning);
}

.file-icon.image i {
    color: var(--success);
}

.file-icon.document i {
    color: var(--primary);
}

.file-icon.spreadsheet i {
    color: var(--success);
}

.file-icon.presentation i {
    color: var(--accent);
}

.file-icon.pdf i {
    color: var(--danger);
}

.file-icon.audio i {
    color: var(--info);
}

.file-icon.video i {
    color: var(--secondary);
}

.file-icon.archive i {
    color: var(--gray-600);
}

.file-icon.code i {
    color: var(--info);
}

.file-name {
    text-align: center;
    font-size: 0.875rem;
    word-break: break-word;
    margin-bottom: 0.25rem;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.2;
    min-height: 2.4em;
}

.file-info {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.file-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.25rem;
}

.file-action-btn {
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.8);
    border: none;
    cursor: pointer;
    color: var(--gray-700);
    transition: background-color var(--transition-normal), color var(--transition-normal);
}

[data-theme="dark"] .file-action-btn {
    background-color: rgba(15, 23, 42, 0.8);
    color: var(--gray-300);
}

.file-action-btn:hover {
    background-color: var(--gray-200);
    color: var(--gray-900);
}

[data-theme="dark"] .file-action-btn:hover {
    background-color: var(--gray-700);
    color: white;
}

.public-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background-color: var(--primary);
    color: white;
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-full);
}

/* ファイルアイテム - リストビュー */
.files-container.list-view .file-item {
    display: table-row;
    border-radius: 0;
    padding: 0;
    transform: none;
    border: none;
    box-shadow: none;
}

.files-container.list-view .file-item:hover {
    background-color: var(--gray-100);
}

[data-theme="dark"] .files-container.list-view .file-item:hover {
    background-color: var(--gray-700);
}

.files-container.list-view .file-cell {
    display: table-cell;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
}

.files-container.list-view .file-name-cell {
    display: flex;
    align-items: center;
}

.files-container.list-view .file-icon {
    width: 2rem;
    height: 2rem;
    margin-right: 0.75rem;
    margin-bottom: 0;
}

.files-container.list-view .file-icon i {
    font-size: 1.25rem;
}

.files-container.list-view .file-name {
    text-align: left;
    margin-bottom: 0;
    -webkit-line-clamp: 1;
    min-height: auto;
}

.files-container.list-view .file-actions {
    position: static;
}

.files-container.list-view .public-badge {
    position: static;
    margin-left: 0.5rem;
}

/* 空フォルダ表示 */
.empty-folder {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
}

.empty-folder i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.empty-folder p {
    margin-bottom: 1.5rem;
}

/* モーダル */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 2rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    width: 90%;
    max-width: 500px;
    position: relative;
    animation: modal-fade-in 0.3s ease;
}

@keyframes modal-fade-in {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

[data-theme="dark"] .modal-content {
    background-color: #1e293b;
}

.preview-content {
    max-width: 80%;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.close {
    position: absolute;
    right: 1.5rem;
    top: 1.5rem;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.close:hover {
    color: var(--text-color);
}

.modal h3 {
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    color: var(--text-color);
}

.modal form input[type="text"],
.modal form input[type="email"] {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background-color: var(--bg-color);
    color: var(--text-color);
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

/* ファイル操作モーダル */
.modal .file-info {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    font-size: inherit;
    color: var(--text-color);
}

.modal .file-icon {
    margin-right: 1rem;
    margin-bottom: 0;
}

.actions-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.action-btn {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-color);
    font-size: 0.875rem;
    cursor: pointer;
    transition: background-color var(--transition-normal), border-color var(--transition-normal);
}

.action-btn:hover {
    background-color: var(--gray-100);
    border-color: var(--gray-400);
}

[data-theme="dark"] .action-btn:hover {
    background-color: var(--gray-700);
    border-color: var(--gray-500);
}

.action-btn i {
    margin-right: 0.75rem;
    width: 1rem;
    text-align: center;
}

.delete-btn {
    color: var(--danger);
}

.delete-btn:hover {
    background-color: var(--danger-light);
    border-color: var(--danger);
}

/* 共有モーダル */
.share-options {
    margin-bottom: 1.5rem;
}

.share-option {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
}

.share-option input[type="radio"] {
    margin-right: 0.5rem;
}

.share-email-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.share-email-input input {
    flex: 1;
    margin-bottom: 0;
}

.shared-users-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-bottom: 1rem;
}

.shared-user-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.shared-user-item:last-child {
    border-bottom: none;
}

.shared-user-info {
    display: flex;
    align-items: center;
}

.shared-user-avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background-color: var(--primary-light);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    margin-right: 0.75rem;
}

.remove-user-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color var(--transition-normal);
}

.remove-user-btn:hover {
    color: var(--danger);
}

/* アップロードモーダル */
.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    transition: border-color var(--transition-normal), background-color var(--transition-normal);
}

.upload-area.dragover {
    border-color: var(--primary);
    background-color: var(--primary-light);
}

.upload-area i {
    font-size: 2.5rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
}

.upload-area p {
    margin-bottom: 1.25rem;
    color: var(--text-muted);
}

.upload-files {
    margin-top: 1.5rem;
}

.upload-file-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background-color: var(--bg-color);
    border-radius: var(--radius);
    margin-bottom: 0.75rem;
}

.upload-file-icon {
    margin-right: 0.75rem;
    color: var(--text-muted);
    width: 1.5rem;
    text-align: center;
}

.upload-file-info {
    flex: 1;
    min-width: 0;
}

.upload-file-name {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.upload-file-size {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.upload-progress-bar {
    height: 4px;
    background-color: var(--gray-200);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-top: 0.5rem;
}

.upload-progress-fill {
    height: 100%;
    background-color: var(--primary);
    width: 0%;
    transition: width 0.3s linear;
}

.upload-file-actions {
    display: flex;
    align-items: center;
}

.cancel-upload-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color var(--transition-normal);
}

.cancel-upload-btn:hover {
    color: var(--danger);
}

.upload-file-item.upload-complete .upload-file-icon {
    color: var(--success);
}

.upload-file-item.upload-error .upload-file-icon {
    color: var(--danger);
}

.error-message {
    color: var(--danger);
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

/* フォルダツリー */
.folder-tree {
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.folder-tree-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background-color var(--transition-normal);
}

.folder-tree-item:hover {
    background-color: var(--gray-100);
}

[data-theme="dark"] .folder-tree-item:hover {
    background-color: var(--gray-700);
}

.folder-tree-item.selected {
    background-color: var(--primary-light);
    color: var(--primary);
}

.folder-tree-toggle {
    width: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.folder-tree-icon {
    margin-right: 0.5rem;
}

.folder-tree-children {
    padding-left: 1.5rem;
}

/* プレビューモーダル */
.preview-container {
    flex: 1;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    margin: 1rem 0;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background-color: var(--bg-color);
    overflow: auto;
}

.preview-container img {
    max-width: 100%;
    max-height: 60vh;
    object-fit: contain;
}

.preview-container audio,
.preview-container video {
    width: 100%;
}

.preview-container iframe {
    width: 100%;
    height: 60vh;
    border: none;
}

.preview-container .document-preview {
    width: 100%;
    max-height: 60vh;
    overflow: auto;
    padding: 1rem;
    background-color: white;
    border-radius: var(--radius);
}

[data-theme="dark"] .preview-container .document-preview {
    background-color: var(--gray-800);
}

.preview-container pre {
    font-family: monospace;
    white-space: pre-wrap;
    word-break: break-all;
}

.no-preview {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

.no-preview i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

/* ローディングスピナー */
.loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 3px solid var(--gray-200);
    border-radius: 50%;
    border-top: 3px solid var(--primary);
    animation: spin 1s linear infinite;
    margin: 2rem auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 通知 */
.notification-container {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 350px;
}

.notification {
    background-color: white;
    border-left: 4px solid var(--primary);
    box-shadow: var(--shadow-md);
    border-radius: var(--radius);
    padding: 1rem;
    transform: translateX(120%);
    animation: notification-slide 0.3s forwards;
    font-size: 0.875rem;
    display: flex;
    align-items: flex-start;
}

[data-theme="dark"] .notification {
    background-color: #1e293b;
}

@keyframes notification-slide {
    to { transform: translateX(0); }
}

.notification.hide {
    animation: notification-slide-out 0.3s forwards;
}

@keyframes notification-slide-out {
    to { transform: translateX(120%); }
}

.notification-icon {
    margin-right: 0.75rem;
    font-size: 1.25rem;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.notification-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: color var(--transition-normal);
    font-size: 1rem;
    margin-left: 0.5rem;
    line-height: 1;
}

.notification-close:hover {
    color: var(--text-color);
}

.notification.success {
    border-left-color: var(--success);
}

.notification.success .notification-icon {
    color: var(--success);
}

.notification.error {
    border-left-color: var(--danger);
}

.notification.error .notification-icon {
    color: var(--danger);
}

.notification.warning {
    border-left-color: var(--warning);
}

.notification.warning .notification-icon {
    color: var(--warning);
}

.notification.info {
    border-left-color: var(--info);
}

.notification.info .notification-icon {
    color: var(--info);
}

/* ボタン */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal);
    border: none;
    line-height: 1.5;
}

.btn i {
    margin-right: 0.5rem;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-hover);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.btn-outline:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* テーマ切替ボタン */
.theme-toggle {
    cursor: pointer;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.125rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    width: 100%;
    padding: 0.5rem;
    border-radius: var(--radius);
    transition: background-color var(--transition-normal);
}

.theme-toggle:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.theme-toggle i {
    margin-right: 0.75rem;
}

/* ユーザープロフィール */
.user-profile {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    color: white;
    text-decoration: none;
}

.user-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 0.75rem;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 500;
    margin-bottom: 0.125rem;
}

.user-status {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
}

/* ユーティリティクラス */
.w-100 { width: 100%; }
.h-100 { height: 100%; }

.mt-1 { margin-top: 0.25rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-3 { margin-top: 1rem; }
.mt-4 { margin-top: 1.5rem; }
.mt-5 { margin-top: 3rem; }

.mb-1 { margin-bottom: 0.25rem; }
.mb-2 { margin-bottom: 0.5rem; }
.mb-3 { margin-bottom: 1rem; }
.mb-4 { margin-bottom: 1.5rem; }
.mb-5 { margin-bottom: 3rem; }

/* レスポンシブデザイン */
@media (max-width: 1200px) {
    .file-manager-container {
        height: calc(100vh - 160px);
    }
    
    .files-container.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
}

@media (max-width: 992px) {
    .file-sidebar {
        width: 180px;
    }
    
    .search-bar {
        width: 240px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .sidebar-toggle {
        display: flex;
    }
    
    .file-manager-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-bar {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .file-manager-body {
        flex-direction: column;
    }
    
    .file-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 0;
    }
    
    .file-categories {
        display: flex;
        overflow-x: auto;
        padding: 0.5rem;
        margin-bottom: 0;
    }
    
    .file-categories li {
        padding: 0.5rem 0.75rem;
        white-space: nowrap;
    }
    
    .file-categories li.active::before {
        display: none;
    }
    
    .storage-info {
        padding: 0.75rem;
        border-top: none;
    }
    
    .files-container.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
    }
    
    .preview-content {
        max-width: 95%;
    }
}

@media (max-width: 576px) {
    .file-actions {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .btn {
        font-size: 0.75rem;
    }
    
    .files-container.grid-view {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    
    .actions-list {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        padding: 1.5rem;
        margin: 5% auto;
    }
}:root {
    --primary: #4338ca;
    --primary-hover: #3730a3;
    --primary-light: #e0e7ff;
    --secondary: #0ea5e9;
    --secondary-hover: #0284c7;
    --secondary-light: #e0f2fe;
    --accent: #f97316;
    --accent-hover: #ea580c;
    --accent-light: #fff7ed;
    --success: #10b981;
    --success-hover: #059669;
    --success-light: #ecfdf5;
    --warning: #f59e0b;
    --warning-hover: #d97706;
    --warning-light: #fffbeb;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --danger-light: #fef2f2;
    --info: #3b82f6;
    --info-hover: #2563eb;
    --info-light: #eff6ff;
    
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    
    --bg-color: var(--gray-50);
    --text-color: var(--gray-800);
    --text-muted: var(--gray-500);
    --border-color: var(--gray-200);
    
    --header-height: 4rem;
    --sidebar-width: 280px;
    --transition-normal: 0.3s ease;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    
    --radius-sm: 0.25rem;
    --radius: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-full: 9999px;
}

[data-theme="dark"] {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --primary-light: #2d2a63;
    
    --bg-color: #0f172a;
    --text-color: #f3f4f6;
    --text-muted: #9ca3af;
    --border-color: #1f2937;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans JP', sans-serif;
    background-color: var(--primary);
    height: 1.5rem;
}

/* サイドバー */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--primary);
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    display: flex;
    flex-direction: column;
    color: white;
    z-index: 50;
    transition: transform var(--transition-normal), width var(--transition-normal);
    box-shadow: var(--shadow);
}

.sidebar-header {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.logo {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.logo img {
    width: 2rem;
    height: 2rem;
}

.sidebar-menu {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
}

.menu-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.6);
    padding: 0.75rem 1.5rem 0.5rem;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: background-color var(--transition-normal);
    position: relative;
    margin: 0.125rem 0.75rem;
    border-radius: var(--radius);
}

.menu-item:hover, .menu-item.active {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
}

.menu-item.active {
    background-color: rgba(255, 255, 255, 0.15);
}

.menu-item.active::before {
    content: '';
    position: absolute;
    left: -0.75rem;
    top: 50%;
    transform: translateY(-50%);
    width: 0.25rem;
    height: 1.5rem;
    background-color: white;
    border-radius: 0 var(--radius) var(--radius) 0;
}

.menu-item i {
    margin-right: 0.75rem;
    width: 1.25rem;
    text-align: center;
}

.sidebar-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar-toggle {
    display: none;
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background-color: var(--primary);
    color: white;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    justify-content: center;
    align-items: center;
    z-index: 100;
    box-shadow: var(--shadow-md);
    border: none;
    cursor: pointer;
    transition: background-color var(--transition-normal);
}

.sidebar-toggle:hover {
    background-color: var(--primary-hover);
}

/* メインコンテンツ */
.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 1.5rem;
    transition: margin var(--transition-normal);
}

.page-header {
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-description {
    color: var(--text-muted);
    margin-bottom: 1.25rem;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    font-size: 0.8125rem;
}

.breadcrumb a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb i {
    font-size: 0.625rem;
}

/* ファイル管理コンテナ */
.file-manager-container {
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 180px);
}

[data-theme="dark"] .file-manager-container {
    background-color: #1e293b;
}

.file-manager-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.search-bar {
    display: flex;
    align-items: center;
    background-color: var(--bg-color);
    border-radius: var(--radius-full);
    padding: 0.5rem 1rem;
    width: 300px;
}

.search-bar i {
    color: var(--text-muted);
    margin-right: 0.5rem;
}

.search-bar input {
    border: none;
    background: transparent;
    outline: none;
    width: 100%;
    color: var(--text-color);
}

.file-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.view-controls {
    display: flex;
    gap: 0.25rem;
    margin-left: 0.5rem;
}

.view-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    width: 2rem;
    height: 2rem;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color var(--transition-normal), color var(--transition-normal);
}

.view-btn:hover {
    background-color: var(--gray-100);
    color: var(--text-color);
}

.view-btn.active {
    background-color: var(--primary-light);
    color: var(--primary);
}

[data-theme="dark"] .view-btn:hover {
    background-color: var(--gray-700);
}

[data-theme="dark"] .view-btn.active {
    background-color: var(--primary-light);
    color: var(--primary);
}

.file-manager-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.file-sidebar {
    width: 220px;
    border-right: 1px solid var(--border-color);
    padding: 1.25rem 0;
    display: flex;
    flex-direction: column;
}

.file-categories {
    list-style: none;
    margin-bottom: 1.5rem;
}

.file-categories li {
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    color: var(--text-color);
    cursor: pointer;
    transition: background-color var(--transition-normal);
    position: relative;
}

.file-categories li:hover {
    background-color: var(--gray-100);
}

[data-theme="dark"] .file-categories li:hover {
    background-color: var(--gray-700);
}

.file-categories li.active {
    background-color: var(--primary-light);
    color: var(--primary);
}

[data-theme="dark"] .file-categories li.active {
    background-color: var(--primary-light);
    color: var(--primary);
}

.file-categories li.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 1.5rem;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 0.875rem;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    transition: background-color var(--transition-normal), color var(--transition-normal);
}
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- サイドバー -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="mainpage.html" class="logo">
                <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
                <span>KatsujiRingX</span>
            </a>
        </div>
        
        <div class="sidebar-menu">
            <p class="menu-label">メインメニュー</p>
            <a href="dashboard.html" class="menu-item">
                <i class="fas fa-home"></i> ダッシュボード
            </a>
            <a href="katsujieditor.html" class="menu-item">
                <i class="fas fa-edit"></i> 活字化エディタ
            </a>
            <a href="documents.html" class="menu-item active">
                <i class="fas fa-file-alt"></i> 資料管理
            </a>
            <a href="booklink.html" class="menu-item">
                <i class="fas fa-book"></i> 完成本を見る
            </a>
            
            <p class="menu-label">学習・コミュニティ</p>
            <a href="games.html" class="menu-item">
                <i class="fas fa-gamepad"></i> 学習ゲーム
            </a>
            <a href="community.html" class="menu-item">
                <i class="fas fa-users"></i> コミュニティ広場
            </a>
            <a href="blog.html" class="menu-item">
                <i class="fas fa-pen"></i> ブログ
            </a>
            
            <p class="menu-label">ユーザー</p>
            <a href="profile.html" class="menu-item">
                <i class="fas fa-user"></i> プロフィール
            </a>

            <p class="menu-label">サポート</p>
            <a href="helpcenter.html" class="menu-item">
                <i class="fas fa-question-circle"></i>ヘルプデスク
            </a>
            <a href="feedback.html" class="menu-item">
                <i class="fas fa-comment-dots"></i>フィードバック
            </a>
        </div>
        
        <div class="sidebar-footer">
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i> ダークモード
            </button>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">
                    <span id="user-initial">U</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-user-name">ユーザー名</div>
                    <div class="user-status">オンライン</div>
                </div>
            </div>
            
            <a href="#" id="logout-btn" class="btn btn-outline w-100 mt-3" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </a>
        </div>
    </aside>
    
    <!-- モバイル用サイドバー切替ボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="page-header">
            <div class="breadcrumb">
                <a href="mainpage.html">ホーム</a>
                <i class="fas fa-chevron-right"></i>
                <span>資料管理</span>
            </div>
            <h1 class="page-title">資料管理</h1>
            <p class="page-description">活字化プロジェクトの資料を整理・共有できます</p>
        </div>
        
        <div class="file-manager-container">
            <div class="file-manager-header">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="ファイルを検索" id="search-input">
                </div>
                <div class="file-actions">
                    <button id="upload-btn" class="btn btn-primary">
                        <i class="fas fa-upload"></i> アップロード
                    </button>
                    <button id="new-folder-btn" class="btn btn-outline">
                        <i class="fas fa-folder-plus"></i> 新規フォルダ
                    </button>
                    <div class="view-controls">
                        <button class="view-btn active" data-view="grid"><i class="fas fa-th"></i></button>
                        <button class="view-btn" data-view="list"><i class="fas fa-list"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="file-manager-body">
                <div class="file-sidebar">
                    <ul class="file-categories">
                        <li class="active" data-category="my-files">
                            <i class="fas fa-folder"></i> マイファイル
                        </li>
                        <li data-category="shared-all">
                            <i class="fas fa-users"></i> 全体共有
                        </li>
                        <li data-category="shared-with-me">
                            <i class="fas fa-share-alt"></i> 共有済み
                        </li>
                        <li data-category="starred">
                            <i class="fas fa-star"></i> スター付き
                        </li>
                        <li data-category="trash">
                            <i class="fas fa-trash"></i> ゴミ箱
                        </li>
                    </ul>
                </div>
                
                <div class="file-content">
                    <div class="breadcrumbs" id="breadcrumbs">
                        <span class="breadcrumb-item">マイファイル</span>
                        <span id="current-folder-path"></span>
                    </div>
                    
                    <div class="files-container grid-view" id="files-container">
                        <!-- ファイルとフォルダはJavaScriptで動的に追加されます -->
                        <div class="loading-spinner" id="files-loading"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ファイル操作モーダル -->
        <div class="modal" id="file-actions-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>ファイル操作</h3>
                <div class="file-info">
                    <div class="file-icon" id="modal-file-icon">
                        <i class="far fa-file"></i>
                    </div>
                    <p id="file-name">ファイル名</p>
                </div>
                <div class="actions-list">
                    <button class="action-btn" id="rename-btn"><i class="fas fa-edit"></i> 名前変更</button>
                    <button class="action-btn" id="move-btn"><i class="fas fa-exchange-alt"></i> 移動</button>
                    <button class="action-btn" id="share-btn"><i class="fas fa-share-alt"></i> 共有</button>
                    <button class="action-btn" id="star-btn"><i class="fas fa-star"></i> スターを付ける</button>
                    <button class="action-btn" id="download-btn"><i class="fas fa-download"></i> ダウンロード</button>
                    <button class="action-btn delete-btn" id="delete-btn"><i class="fas fa-trash"></i> 削除</button>
                </div>
            </div>
        </div>

        <!-- 名前変更モーダル -->
        <div class="modal" id="rename-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>名前変更</h3>
                <form id="rename-form">
                    <input type="text" id="new-name" placeholder="新しい名前">
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" class="btn btn-outline modal-cancel">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- フォルダ作成モーダル -->
        <div class="modal" id="new-folder-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>新規フォルダ</h3>
                <form id="new-folder-form">
                    <input type="text" id="folder-name" placeholder="フォルダ名">
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">作成</button>
                        <button type="button" class="btn btn-outline modal-cancel">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 移動モーダル -->
        <div class="modal" id="move-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>移動先を選択</h3>
                <div class="folder-tree" id="folder-tree">
                    <!-- フォルダツリーはJavaScriptで動的に追加されます -->
                    <div class="loading-spinner" id="folder-tree-loading"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="move-confirm-btn">移動</button>
                    <button class="btn btn-outline modal-cancel">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- 共有モーダル -->
        <div class="modal" id="share-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>共有設定</h3>
                <div class="share-options">
                    <div class="share-option">
                        <input type="radio" id="share-public" name="share-type" value="public">
                        <label for="share-public">全体共有（全ユーザーに共有）</label>
                    </div>
                    <div class="share-option">
                        <input type="radio" id="share-specific" name="share-type" value="specific" checked>
                        <label for="share-specific">特定ユーザーと共有</label>
                    </div>
                </div>
                <div id="specific-users-section">
                    <div class="share-email-input">
                        <input type="email" id="share-email" placeholder="メールアドレスを入力">
                        <button id="add-user-btn" class="btn btn-sm btn-outline">追加</button>
                    </div>
                    <div class="shared-users-list" id="shared-users-list">
                        <!-- 共有ユーザーリストはJavaScriptで動的に追加されます -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="share-confirm-btn">共有</button>
                    <button class="btn btn-outline modal-cancel">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- アップロードモーダル -->
        <div class="modal" id="upload-modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>ファイルをアップロード</h3>
                <form id="upload-form">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>ここにファイルをドラッグ＆ドロップまたは</p>
                        <label for="file-input" class="btn btn-primary">ファイルを選択</label>
                        <input type="file" id="file-input" multiple hidden>
                    </div>
                    <div class="upload-progress" id="upload-progress-container">
                        <div class="upload-files" id="upload-files-list">
                            <!-- アップロードファイルリストはJavaScriptで動的に追加されます -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="upload-start-btn">アップロード</button>
                        <button type="button" class="btn btn-outline modal-cancel">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ファイルプレビューモーダル -->
        <div class="modal" id="preview-modal">
            <div class="modal-content preview-content">
                <span class="close">&times;</span>
                <h3 id="preview-file-name">ファイル名</h3>
                <div class="preview-container" id="preview-container">
                    <!-- プレビューコンテンツはJavaScriptで動的に追加されます -->
                    <div class="loading-spinner"></div>
                </div>
                <div class="modal-footer">
                    <button id="preview-download-btn" class="btn btn-outline">
                        <i class="fas fa-download"></i> ダウンロード
                    </button>
                    <button class="btn btn-outline modal-cancel">閉じる</button>
                </div>
            </div>
        </div>
        
        <!-- 通知コンポーネント -->
        <div class="notification-container" id="notification-container"></div>
    </div>

    <script>
// Firebase初期化
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const firebaseConfig = {
    apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
    authDomain: "katsujiringx.firebaseapp.com",
    projectId: "katsujiringx",
    storageBucket: "katsujiringx.firebasestorage.app",
    messagingSenderId: "831784731743",
    appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
    measurementId: "G-LPCRE3WYZR"
};
// Firebaseサービスへの参照
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// DOM要素の参照
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebar-toggle');
const themeToggle = document.getElementById('theme-toggle');
const userInitial = document.getElementById('user-initial');
const sidebarUserName = document.getElementById('sidebar-user-name');
const userAvatar = document.getElementById('user-avatar');
const filesContainer = document.getElementById('files-container');
const filesLoading = document.getElementById('files-loading');
const breadcrumbsElement = document.getElementById('breadcrumbs');
const currentFolderPath = document.getElementById('current-folder-path');
const storageUsedElement = document.getElementById('storage-used');
const totalStorageElement = document.getElementById('total-storage');
const storageBarElement = document.getElementById('used-storage');
const logoutBtn = document.getElementById('logout-btn');
const searchInput = document.getElementById('search-input');
const uploadBtn = document.getElementById('upload-btn');
const newFolderBtn = document.getElementById('new-folder-btn');
const viewButtons = document.querySelectorAll('.view-btn');
const fileCategories = document.querySelectorAll('.file-categories li');

// モーダル要素
const fileActionsModal = document.getElementById('file-actions-modal');
const renameModal = document.getElementById('rename-modal');
const newFolderModal = document.getElementById('new-folder-modal');
const moveModal = document.getElementById('move-modal');
const shareModal = document.getElementById('share-modal');
const uploadModal = document.getElementById('upload-modal');
const previewModal = document.getElementById('preview-modal');
const notificationContainer = document.getElementById('notification-container');

// グローバル変数
let currentUser = null;
let currentFolder = 'root';
let folderPath = [];
let selectedFile = null;
let selectedFolderForMove = null;
let currentCategory = 'my-files';
let viewMode = 'grid';
let searchQuery = '';
let draggedFile = null;

// アプリケーション初期化
document.addEventListener('DOMContentLoaded', () => {
    // テーマの初期化
    initTheme();
    
    // イベントリスナーを設定
    setupEventListeners();
});

// 認証状態の監視
auth.onAuthStateChanged(async (user) => {
    try {
        if (user) {
            // ユーザーがログインしている場合
            currentUser = user;
            
            // ユーザー情報を表示
            await loadUserInfo();
            
            // ファイル一覧を読み込み
            loadFiles();
        } else {
            // ログインしていない場合はログインページにリダイレクト
            window.location.href = 'login.html';
        }
    } catch (error) {
        console.error('認証状態の監視エラー:', error);
        showNotification('認証エラーが発生しました', 'error');
    }
});

// ユーザー情報の読み込み
async function loadUserInfo() {
    try {
        // ユーザードキュメントの取得
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        let userData = null;
        
        if (userDoc.exists) {
            userData = userDoc.data();
        } else {
            // ユーザードキュメントが存在しない場合は作成
            userData = {
                uid: currentUser.uid,
                displayName: currentUser.displayName || currentUser.email.split('@')[0],
                email: currentUser.email,
                profileImageUrl: currentUser.photoURL || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(currentUser.uid).set(userData);
        }
        
        // ユーザー名を表示
        if (sidebarUserName) {
            sidebarUserName.textContent = userData.displayName || currentUser.displayName || '匿名ユーザー';
        }
        
        // アバターの表示
        if (userAvatar) {
            if (currentUser.photoURL) {
                const img = document.createElement('img');
                img.src = currentUser.photoURL;
                img.alt = 'ユーザーアバター';
                userAvatar.innerHTML = '';
                userAvatar.appendChild(img);
            } else if (userInitial) {
                const name = userData.displayName || currentUser.displayName || 'ユーザー';
                userInitial.textContent = name.charAt(0).toUpperCase();
            }
        }
        
        // ストレージ使用量を計算して表示
        await updateStorageUsage();
        
    } catch (error) {
        console.error('ユーザー情報の読み込みエラー:', error);
        showNotification('ユーザー情報の読み込みに失敗しました', 'error');
    }
}

// ストレージ使用量の更新
async function updateStorageUsage() {
    try {
        // ユーザーのファイルを取得
        const userFilesSnapshot = await db.collection('files')
            .where('userId', '==', currentUser.uid)
            .where('type', '!=', 'folder')
            .get();
        
        // 合計サイズを計算
        let totalSize = 0;
        userFilesSnapshot.forEach(doc => {
            const fileData = doc.data();
            totalSize += fileData.size || 0;
        });
        
        // ギガバイトに変換（1 GB = 1024^3 bytes）
        const usedGB = (totalSize / Math.pow(1024, 3)).toFixed(2);
        const totalGB = 15; // ユーザーに割り当てられた容量（例として15GB）
        const usagePercentage = (usedGB / totalGB) * 100;
        
        // 表示を更新
        if (storageUsedElement) {
            storageUsedElement.style.width = `${Math.min(usagePercentage, 100)}%`;
        }
        
        if (totalStorageElement) {
            totalStorageElement.textContent = totalGB;
        }
        
        if (storageBarElement) {
            storageBarElement.textContent = usedGB;
        }
    } catch (error) {
        console.error('ストレージ使用量の更新エラー:', error);
    }
}

// ファイル一覧の読み込み
async function loadFiles(folderId = null, category = null) {
    try {
        // ローディング表示
        if (filesLoading) {
            filesLoading.style.display = 'block';
        }
        
        // 一覧をクリア
        filesContainer.innerHTML = '';
        
        // フォルダIDを更新
        if (folderId !== null) {
            currentFolder = folderId;
        }
        
        // カテゴリを更新
        if (category !== null) {
            currentCategory = category;
            
            // カテゴリのアクティブ状態を更新
            fileCategories.forEach(item => {
                item.classList.toggle('active', item.dataset.category === category);
            });
            
            // ルートに戻る
            if (category !== 'my-files') {
                currentFolder = 'root';
                folderPath = [];
            }
        }
        
        // クエリの構築
        let query = db.collection('files');
        
        // カテゴリに応じたフィルタリング
        switch (currentCategory) {
            case 'my-files':
                query = query.where('userId', '==', currentUser.uid)
                           .where('parentFolder', '==', currentFolder)
                           .where('deleted', '==', false);
                break;
            case 'shared-all':
                query = query.where('isPublic', '==', true)
                           .where('deleted', '==', false);
                break;
            case 'shared-with-me':
                // 共有されているファイルIDを取得
                const sharedFilesIds = await getSharedFilesIds();
                
                if (sharedFilesIds.length === 0) {
                    // 共有されているファイルがない場合
                    showEmptyMessage('共有されているファイルがありません');
                    if (filesLoading) {
                        filesLoading.style.display = 'none';
                    }
                    return;
                }
                
                query = query.where(firebase.firestore.FieldPath.documentId(), 'in', sharedFilesIds)
                           .where('deleted', '==', false);
                break;
            case 'starred':
                query = query.where('userId', '==', currentUser.uid)
                           .where('starred', '==', true)
                           .where('deleted', '==', false);
                break;
            case 'trash':
                query = query.where('userId', '==', currentUser.uid)
                           .where('deleted', '==', true);
                break;
        }
        
        // 検索クエリがある場合
        if (searchQuery) {
            // Firestoreは完全一致しかサポートしていないため、
            // クライアント側でフィルタリングする必要がある
            query = query.get().then(snapshot => {
                const results = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name.toLowerCase().includes(searchQuery.toLowerCase())) {
                        results.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                return results;
            });
        } else {
            // 検索クエリがない場合は普通にデータを取得
            query = query.get().then(snapshot => {
                const results = [];
                snapshot.forEach(doc => {
                    results.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return results;
            });
        }
        
        // データの取得
        const files = await query;
        
        // ローディング表示を非表示
        if (filesLoading) {
            filesLoading.style.display = 'none';
        }
        
        // パンくずリストを更新
        updateBreadcrumbs();
        
        // 空の場合のメッセージを表示
        if (files.length === 0) {
            showEmptyMessage();
            return;
        }
        
        // ファイルをソート
        const sortedFiles = sortFiles(files);
        
        // リストビューのヘッダーを追加
        if (viewMode === 'list') {
            const headerRow = document.createElement('div');
            headerRow.className = 'file-item-header';
            headerRow.innerHTML = `
                <span style="width: 50%;">名前</span>
                <span style="width: 20%;">更新日</span>
                <span style="width: 15%;">サイズ</span>
                <span style="width: 15%;">操作</span>
            `;
            filesContainer.appendChild(headerRow);
        }
        
        // ファイルを表示
        sortedFiles.forEach(file => {
            renderFileItem(file);
        });
        
    } catch (error) {
        console.error('ファイル一覧の読み込みエラー:', error);
        showNotification('ファイル一覧の読み込みに失敗しました', 'error');
        
        // ローディング表示を非表示
        if (filesLoading) {
            filesLoading.style.display = 'none';
        }
        
        // エラーメッセージを表示
        filesContainer.innerHTML = `
            <div class="empty-folder">
                <i class="fas fa-exclamation-circle"></i>
                <p>ファイルの読み込み中にエラーが発生しました</p>
                <button class="btn btn-primary mt-3" onclick="loadFiles()">再読み込み</button>
            </div>
        `;
    }
}

// 共有されているファイルIDの取得
async function getSharedFilesIds() {
    try {
        const sharedFilesSnapshot = await db.collection('shares')
            .where('sharedWith', '==', currentUser.email)
            .get();
        
        return sharedFilesSnapshot.docs.map(doc => doc.data().fileId);
    } catch (error) {
        console.error('共有ファイルID取得エラー:', error);
        return [];
    }
}

// ファイルのソート
function sortFiles(files) {
    // フォルダを先に表示
    return files.sort((a, b) => {
        // フォルダを先に
        if (a.type === 'folder' && b.type !== 'folder') return -1;
        if (a.type !== 'folder' && b.type === 'folder') return 1;
        
        // 同じタイプの場合は名前でソート
        return a.name.localeCompare(b.name);
    });
}

// 空メッセージの表示
function showEmptyMessage(message = null) {
    let displayMessage = '';
    let icon = 'fa-folder-open';
    let actionButton = '';
    
    switch (currentCategory) {
        case 'my-files':
            displayMessage = currentFolder === 'root' ? 
                'マイファイルはまだありません' : 
                'このフォルダは空です';
            actionButton = `
                <button class="btn btn-primary mt-3" id="empty-upload-btn">
                    <i class="fas fa-upload"></i> ファイルをアップロード
                </button>
            `;
            break;
        case 'shared-all':
            displayMessage = '全体共有されているファイルはありません';
            icon = 'fa-share-alt';
            break;
        case 'shared-with-me':
            displayMessage = '共有されているファイルはありません';
            icon = 'fa-share-alt';
            break;
        case 'starred':
            displayMessage = 'スター付きファイルはありません';
            icon = 'fa-star';
            break;
        case 'trash':
            displayMessage = 'ゴミ箱は空です';
            icon = 'fa-trash';
            break;
        default:
            displayMessage = 'ファイルはありません';
    }
    
    // メッセージが指定されている場合は上書き
    if (message) {
        displayMessage = message;
    }
    
    filesContainer.innerHTML = `
        <div class="empty-folder">
            <i class="fas ${icon}"></i>
            <p>${displayMessage}</p>
            ${actionButton}
        </div>
    `;
    
    // アップロードボタンのイベントリスナーを追加
    const emptyUploadBtn = document.getElementById('empty-upload-btn');
    if (emptyUploadBtn) {
        emptyUploadBtn.addEventListener('click', () => {
            openUploadModal();
        });
    }
}

// ファイルアイテムのレンダリング
function renderFileItem(file) {
    const isFolder = file.type === 'folder';
    const fileExtension = !isFolder ? getFileExtension(file.name) : null;
    const fileIconClass = getFileIconClass(file.type, fileExtension);
    const formattedDate = formatDate(file.updatedAt);
    const formattedSize = isFolder ? '-' : formatFileSize(file.size || 0);
    
    if (viewMode === 'grid') {
        // グリッドビューでのレンダリング
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.id = file.id;
        fileItem.dataset.type = file.type;
        
        fileItem.innerHTML = `
            ${file.isPublic ? '<span class="public-badge">全体共有</span>' : ''}
            <div class="file-icon ${file.type}">
                <i class="${fileIconClass}"></i>
            </div>
            <div class="file-name">${file.name}</div>
            <div class="file-info">${formattedDate}</div>
            <div class="file-actions">
                <button class="file-action-btn" data-action="more">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        `;
        
        // イベントリスナーを追加
        fileItem.addEventListener('click', (e) => {
            if (!e.target.closest('[data-action]')) {
                // 操作ボタン以外をクリックした場合
                handleFileClick(file);
            }
        });
        
        // 操作ボタンのイベントリスナー
        const actionBtn = fileItem.querySelector('[data-action="more"]');
        actionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openFileActionsModal(file);
        });
        
        // ドラッグ&ドロップのイベントリスナー
        if (file.userId === currentUser.uid) {
            fileItem.setAttribute('draggable', 'true');
            fileItem.addEventListener('dragstart', (e) => handleDragStart(e, file));
            fileItem.addEventListener('dragend', handleDragEnd);
            
            if (isFolder) {
                fileItem.addEventListener('dragover', handleDragOver);
                fileItem.addEventListener('dragleave', handleDragLeave);
                fileItem.addEventListener('drop', (e) => handleDrop(e, file));
            }
        }
        
        filesContainer.appendChild(fileItem);
    } else {
        // リストビューでのレンダリング
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.id = file.id;
        fileItem.dataset.type = file.type;
        
        fileItem.innerHTML = `
            <div class="file-cell file-name-cell" style="width: 50%;">
                <div class="file-icon ${file.type}">
                    <i class="${fileIconClass}"></i>
                </div>
                <div class="file-name">${file.name}</div>
                ${file.isPublic ? '<span class="public-badge">全体共有</span>' : ''}
            </div>
            <div class="file-cell" style="width: 20%;">${formattedDate}</div>
            <div class="file-cell" style="width: 15%;">${formattedSize}</div>
            <div class="file-cell" style="width: 15%;">
                <div class="file-actions">
                    <button class="file-action-btn" data-action="more">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        `;
        
        // イベントリスナーを追加
        fileItem.addEventListener('click', (e) => {
            if (!e.target.closest('[data-action]')) {
                // 操作ボタン以外をクリックした場合
                handleFileClick(file);
            }
        });
        
        // 操作ボタンのイベントリスナー
        const actionBtn = fileItem.querySelector('[data-action="more"]');
        actionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openFileActionsModal(file);
        });
        
        // ドラッグ&ドロップのイベントリスナー
        if (file.userId === currentUser.uid) {
            fileItem.setAttribute('draggable', 'true');
            fileItem.addEventListener('dragstart', (e) => handleDragStart(e, file));
            fileItem.addEventListener('dragend', handleDragEnd);
            
            if (isFolder) {
                fileItem.addEventListener('dragover', handleDragOver);
                fileItem.addEventListener('dragleave', handleDragLeave);
                fileItem.addEventListener('drop', (e) => handleDrop(e, file));
            }
        }
        
        filesContainer.appendChild(fileItem);
    }
}

// ファイルクリック処理
async function handleFileClick(file) {
    try {
        if (file.type === 'folder') {
            // フォルダの場合は中を表示
            if (currentCategory === 'my-files' || currentCategory === 'shared-all') {
                // フォルダパスを更新
                folderPath.push({
                    id: file.id,
                    name: file.name
                });
                
                // フォルダ内のファイルを表示
                loadFiles(file.id);
            }
        } else {
            // ファイルの場合はプレビュー
            await openPreviewModal(file);
        }
    } catch (error) {
        console.error('ファイルクリックエラー:', error);
        showNotification('ファイルを開けませんでした', 'error');
    }
}

// パンくずリストの更新
function updateBreadcrumbs() {
    if (!breadcrumbsElement || !currentFolderPath) return;
    
    // カテゴリーに応じたルートラベル
    let rootLabel = 'マイファイル';
    switch (currentCategory) {
        case 'shared-all': rootLabel = '全体共有'; break;
        case 'shared-with-me': rootLabel = '共有済み'; break;
        case 'starred': rootLabel = 'スター付き'; break;
        case 'trash': rootLabel = 'ゴミ箱'; break;
    }
    
    // ルートパンくず
    breadcrumbsElement.innerHTML = `
        <span class="breadcrumb-item" data-id="root">${rootLabel}</span>
    `;
    
    // ルートへのイベントリスナー
    const rootBreadcrumb = breadcrumbsElement.querySelector('[data-id="root"]');
    rootBreadcrumb.addEventListener('click', () => {
        folderPath = [];
        loadFiles('root');
    });
    
    // 現在のパスを表示
    let pathHTML = '';
    if (folderPath.length > 0) {
        folderPath.forEach((folder, index) => {
            if (index === folderPath.length - 1) {
                // 現在のフォルダ（クリックできない）
                pathHTML += ` / <span>${folder.name}</span>`;
            } else {
                // 親フォルダ（クリックで移動可能）
                pathHTML += ` / <span class="breadcrumb-item" data-id="${folder.id}">${folder.name}</span>`;
            }
        });
    }
    
    currentFolderPath.innerHTML = pathHTML;
    
    // パンくずアイテムのイベントリスナー
    const breadcrumbItems = currentFolderPath.querySelectorAll('.breadcrumb-item');
    breadcrumbItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            // このフォルダまでのパスを取得
            folderPath = folderPath.slice(0, index + 1);
            
            // このフォルダの内容を表示
            loadFiles(item.dataset.id);
        });
    });
}

// ファイル操作モーダル
function openFileActionsModal(file) {
    selectedFile = file;
    
    // ファイル情報を設定
    document.getElementById('file-name').textContent = file.name;
    const modalFileIcon = document.getElementById('modal-file-icon');
    const fileExtension = file.type !== 'folder' ? getFileExtension(file.name) : null;
    const fileIconClass = getFileIconClass(file.type, fileExtension);
    modalFileIcon.innerHTML = `<i class="${fileIconClass}"></i>`;
    modalFileIcon.className = `file-icon ${file.type}`;
    
    // スターボタンのテキストを更新
    const starBtn = document.getElementById('star-btn');
    if (starBtn) {
        starBtn.innerHTML = file.starred ? 
            '<i class="fas fa-star"></i> スターを外す' : 
            '<i class="far fa-star"></i> スターを付ける';
    }
    
    // ゴミ箱内のファイルの場合は、削除ボタンを「完全に削除」に変更
    const deleteBtn = document.getElementById('delete-btn');
    if (deleteBtn) {
        if (currentCategory === 'trash') {
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> 完全に削除';
        } else {
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 削除';
        }
    }
    
    // モーダルを表示
    fileActionsModal.style.display = 'block';
}

// 名前変更モーダル
function openRenameModal() {
    if (!selectedFile) return;
    
    // 現在の名前を設定
    document.getElementById('new-name').value = selectedFile.name;
    
    // モーダルを表示
    renameModal.style.display = 'block';
    
    // 入力フィールドにフォーカス
    setTimeout(() => {
        document.getElementById('new-name').focus();
    }, 100);
}

// 新規フォルダモーダル
function openNewFolderModal() {
    // 入力をクリア
    document.getElementById('folder-name').value = '';
    
    // モーダルを表示
    newFolderModal.style.display = 'block';
    
    // 入力フィールドにフォーカス
    setTimeout(() => {
        document.getElementById('folder-name').focus();
    }, 100);
}

// 移動モーダル
async function openMoveModal() {
    if (!selectedFile) return;
    
    // ローディング表示
    document.getElementById('folder-tree-loading').style.display = 'block';
    document.getElementById('folder-tree').innerHTML = '';
    
    // モーダルを表示
    moveModal.style.display = 'block';
    
    // フォルダツリーを読み込み
    await loadFolderTree();
    
    // ローディング非表示
    document.getElementById('folder-tree-loading').style.display = 'none';
}

// フォルダツリーの読み込み
async function loadFolderTree() {
    try {
        const folderTreeElement = document.getElementById('folder-tree');
        folderTreeElement.innerHTML = '';
        
        // 選択されたフォルダをリセット
        selectedFolderForMove = null;
        
        // ルートフォルダアイテム
        const rootItem = document.createElement('div');
        rootItem.className = 'folder-tree-item';
        rootItem.dataset.id = 'root';
        rootItem.innerHTML = `
            <span class="folder-tree-icon"><i class="fas fa-home"></i></span>
            <span>マイファイル</span>
        `;
        
        // ルートフォルダのクリックイベント
        rootItem.addEventListener('click', () => {
            document.querySelectorAll('.folder-tree-item').forEach(item => {
                item.classList.remove('selected');
            });
            rootItem.classList.add('selected');
            selectedFolderForMove = 'root';
        });
        
        folderTreeElement.appendChild(rootItem);
        
        // 自分のフォルダを取得
        const foldersSnapshot = await db.collection('files')
            .where('userId', '==', currentUser.uid)
            .where('type', '==', 'folder')
            .where('deleted', '==', false)
            .get();
        
        // フォルダデータを整理
        const folders = {};
        foldersSnapshot.forEach(doc => {
            const folderData = doc.data();
            
            // 自分自身は除外
            if (selectedFile && doc.id === selectedFile.id) return;
            
            folders[doc.id] = {
                id: doc.id,
                name: folderData.name,
                parentFolder: folderData.parentFolder,
                children: []
            };
        });
        
        // 親子関係を構築
        Object.values(folders).forEach(folder => {
            if (folder.parentFolder !== 'root' && folders[folder.parentFolder]) {
                folders[folder.parentFolder].children.push(folder);
            }
        });
        
        // ルート直下のフォルダを追加
        Object.values(folders)
            .filter(folder => folder.parentFolder === 'root')
            .sort((a, b) => a.name.localeCompare(b.name))// Firebase設定
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(folder => {
                renderFolderTreeItem(folder, folders, folderTreeElement);
            });
            
        // ルートを選択状態にする
        rootItem.click();
        
    } catch (error) {
        console.error('フォルダツリー読み込みエラー:', error);
        
        const folderTreeElement = document.getElementById('folder-tree');
        folderTreeElement.innerHTML = `
            <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
                <i class="fas fa-exclamation-circle"></i>
                <p>フォルダの読み込みに失敗しました</p>
            </div>
        `;
    }
}

// フォルダツリーアイテムのレンダリング
function renderFolderTreeItem(folder, allFolders, parentElement) {
    const hasChildren = folder.children && folder.children.length > 0;
    
    const folderItem = document.createElement('div');
    folderItem.className = 'folder-tree-item';
    folderItem.dataset.id = folder.id;
    
    folderItem.innerHTML = `
        <span class="folder-tree-toggle">
            ${hasChildren ? '<i class="fas fa-caret-right"></i>' : ''}
        </span>
        <span class="folder-tree-icon"><i class="fas fa-folder"></i></span>
        <span>${folder.name}</span>
    `;
    
    // フォルダクリックのイベントリスナー
    folderItem.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // 選択状態を更新
        document.querySelectorAll('.folder-tree-item').forEach(item => {
            item.classList.remove('selected');
        });
        folderItem.classList.add('selected');
        selectedFolderForMove = folder.id;
    });
    
    parentElement.appendChild(folderItem);
    
    // 子フォルダがある場合
    if (hasChildren) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'folder-tree-children';
        childrenContainer.style.display = 'none';
        
        // 子フォルダを表示
        folder.children
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(child => {
                renderFolderTreeItem(child, allFolders, childrenContainer);
            });
        
        parentElement.appendChild(childrenContainer);
        
        // トグルボタンのクリックイベント
        const toggleBtn = folderItem.querySelector('.folder-tree-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const caret = toggleBtn.querySelector('i');
                const isExpanded = childrenContainer.style.display !== 'none';
                
                childrenContainer.style.display = isExpanded ? 'none' : 'block';
                caret.className = isExpanded ? 'fas fa-caret-right' : 'fas fa-caret-down';
            });
        }
    }
}

// 共有モーダル
async function openShareModal() {
    if (!selectedFile) return;
    
    // モーダルを表示
    shareModal.style.display = 'block';
    
    // 共有タイプの設定
    document.getElementById('share-public').checked = selectedFile.isPublic || false;
    document.getElementById('share-specific').checked = !selectedFile.isPublic;
    
    // 特定ユーザーセクションの表示/非表示
    document.getElementById('specific-users-section').style.display = 
        selectedFile.isPublic ? 'none' : 'block';
    
    // 共有ユーザーリストをクリア
    document.getElementById('shared-users-list').innerHTML = '';
    
    // メールフィールドをクリア
    document.getElementById('share-email').value = '';
    
    // 既存の共有設定を読み込み
    if (!selectedFile.isPublic) {
        try {
            const sharesSnapshot = await db.collection('shares')
                .where('fileId', '==', selectedFile.id)
                .get();
            
            sharesSnapshot.forEach(doc => {
                const shareData = doc.data();
                addSharedUserToList(shareData.sharedWith);
            });
        } catch (error) {
            console.error('共有設定読み込みエラー:', error);
        }
    }
}

// 共有ユーザーをリストに追加
function addSharedUserToList(email) {
    // 既に追加済みかチェック
    const existingItem = document.querySelector(`.shared-user-item[data-email="${email}"]`);
    if (existingItem) return;
    
    const sharedUsersList = document.getElementById('shared-users-list');
    
    const userItem = document.createElement('div');
    userItem.className = 'shared-user-item';
    userItem.dataset.email = email;
    
    // 頭文字を取得
    const initial = email.charAt(0).toUpperCase();
    
    userItem.innerHTML = `
        <div class="shared-user-info">
            <div class="shared-user-avatar">${initial}</div>
            <div>${email}</div>
        </div>
        <button type="button" class="remove-user-btn">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // 削除ボタンのイベントリスナー
    const removeBtn = userItem.querySelector('.remove-user-btn');
    removeBtn.addEventListener('click', () => {
        userItem.remove();
    });
    
    sharedUsersList.appendChild(userItem);
}

// アップロードモーダル
function openUploadModal() {
    // モーダルを表示
    uploadModal.style.display = 'block';
    
    // ファイルリストをクリア
    document.getElementById('upload-files-list').innerHTML = '';
    document.getElementById('file-input').value = '';
    
    // アップロードエリアのドラッグオーバー状態をリセット
    document.getElementById('upload-area').classList.remove('dragover');
}

// プレビューモーダル
async function openPreviewModal(file) {
    try {
        // ファイル名を設定
        document.getElementById('preview-file-name').textContent = file.name;
        
        // プレビューコンテナをリセット
        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = '<div class="loading-spinner"></div>';
        
        // モーダルを表示
        previewModal.style.display = 'block';
        
        // ファイルURLを取得
        let fileURL;
        try {
            fileURL = await storage.ref(file.storagePath).getDownloadURL();
        } catch (error) {
            console.error('ファイルURL取得エラー:', error);
            previewContainer.innerHTML = `
                <div class="no-preview">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>ファイルの読み込みに失敗しました</p>
                </div>
            `;
            return;
        }
        
        // ダウンロードボタンにURLを設定
        const downloadBtn = document.getElementById('preview-download-btn');
        if (downloadBtn) {
            downloadBtn.onclick = () => downloadFile(file);
        }
        
        // ファイル種類に応じたプレビュー表示
        const fileExtension = getFileExtension(file.name);
        
        if (file.type === 'image') {
            // 画像の場合
            previewContainer.innerHTML = `<img src="${fileURL}" alt="${file.name}">`;
        } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
            // 動画の場合
            previewContainer.innerHTML = `
                <video controls>
                    <source src="${fileURL}" type="video/${fileExtension}">
                    お使いのブラウザは動画の再生に対応していません。
                </video>
            `;
        } else if (['mp3', 'wav'].includes(fileExtension)) {
            // 音声の場合
            previewContainer.innerHTML = `
                <audio controls>
                    <source src="${fileURL}" type="audio/${fileExtension}">
                    お使いのブラウザは音声の再生に対応していません。
                </audio>
            `;
        } else if (fileExtension === 'pdf') {
            // PDFの場合
            previewContainer.innerHTML = `
                <iframe src="${fileURL}#toolbar=0" frameborder="0"></iframe>
            `;
        } else if (['txt', 'json', 'csv', 'md', 'html', 'css', 'js'].includes(fileExtension)) {
            // テキストファイルの場合
            try {
                const response = await fetch(fileURL);
                const text = await response.text();
                previewContainer.innerHTML = `
                    <div class="document-preview">
                        <pre>${escapeHTML(text)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('テキスト読み込みエラー:', error);
                previewContainer.innerHTML = `
                    <div class="no-preview">
                        <i class="fas fa-file-alt"></i>
                        <p>テキストの読み込みに失敗しました</p>
                    </div>
                `;
            }
        } else if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(fileExtension)) {
            // Office文書の場合（Google Docs Viewerを使用）
            previewContainer.innerHTML = `
                <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(fileURL)}&embedded=true" frameborder="0"></iframe>
            `;
        } else {
            // 未対応のファイルタイプ
            previewContainer.innerHTML = `
                <div class="no-preview">
                    <i class="${getFileIconClass(file.type, fileExtension)}"></i>
                    <p>このファイル形式はプレビューに対応していません</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('プレビューモーダルエラー:', error);
        showNotification('ファイルのプレビューに失敗しました', 'error');
    }
}

// ファイル操作関数
// ----------------------------------------------

// ファイルをダウンロード
async function downloadFile(file) {
    try {
        // URLを取得
        const url = await storage.ref(file.storagePath).getDownloadURL();
        
        // ダウンロードリンクを作成
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showNotification(`「${file.name}」のダウンロードを開始しました`, 'success');
    } catch (error) {
        console.error('ファイルダウンロードエラー:', error);
        showNotification('ダウンロードに失敗しました', 'error');
    }
}

// ファイル名を変更
async function renameFile() {
    try {
        if (!selectedFile) return;
        
        const newName = document.getElementById('new-name').value.trim();
        if (!newName) {
            showNotification('ファイル名を入力してください', 'warning');
            return;
        }
        
        if (newName === selectedFile.name) {
            // 名前が変わっていない場合は何もしない
            closeModal(renameModal);
            return;
        }
        
        // 同じ名前のファイルがないかチェック
        const existingFilesSnapshot = await db.collection('files')
            .where('parentFolder', '==', selectedFile.parentFolder)
            .where('name', '==', newName)
            .where('userId', '==', currentUser.uid)
            .where('deleted', '==', false)
            .get();
        
        if (!existingFilesSnapshot.empty) {
            showNotification('同じ名前のファイルが既に存在します', 'warning');
            return;
        }
        
        // 拡張子を保持するために元のファイル名から拡張子を取得
        let newFileName = newName;
        if (selectedFile.type !== 'folder') {
            const oldExt = getFileExtension(selectedFile.name);
            const newExt = getFileExtension(newName);
            
            // 新しい名前に拡張子がない場合、または異なる拡張子の場合は元の拡張子を追加
            if ((!newExt && oldExt) || (newExt !== oldExt)) {
                newFileName = `${newName}.${oldExt}`;
            }
        }
        
        // データベースを更新
        await db.collection('files').doc(selectedFile.id).update({
            name: newFileName,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('ファイル名を変更しました', 'success');
        closeModal(renameModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('ファイル名変更エラー:', error);
        showNotification('ファイル名の変更に失敗しました', 'error');
    }
}

// 新規フォルダを作成
async function createFolder() {
    try {
        const folderName = document.getElementById('folder-name').value.trim();
        if (!folderName) {
            showNotification('フォルダ名を入力してください', 'warning');
            return;
        }
        
        // 同じ名前のフォルダがないかチェック
        const existingFoldersSnapshot = await db.collection('files')
            .where('parentFolder', '==', currentFolder)
            .where('name', '==', folderName)
            .where('userId', '==', currentUser.uid)
            .where('type', '==', 'folder')
            .where('deleted', '==', false)
            .get();
        
        if (!existingFoldersSnapshot.empty) {
            showNotification('同じ名前のフォルダが既に存在します', 'warning');
            return;
        }
        
        // フォルダを作成
        await db.collection('files').add({
            name: folderName,
            type: 'folder',
            parentFolder: currentFolder,
            userId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            starred: false,
            isPublic: false,
            deleted: false
        });
        
        showNotification(`フォルダ「${folderName}」を作成しました`, 'success');
        closeModal(newFolderModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('フォルダ作成エラー:', error);
        showNotification('フォルダの作成に失敗しました', 'error');
    }
}

// ファイルを移動
async function moveFile() {
    try {
        if (!selectedFile || !selectedFolderForMove) {
            showNotification('移動先フォルダを選択してください', 'warning');
            return;
        }
        
        // 同じフォルダに移動しようとしている場合
        if (selectedFile.parentFolder === selectedFolderForMove) {
            showNotification('既に選択したフォルダに存在しています', 'info');
            closeModal(moveModal);
            return;
        }
        
        // フォルダを自分自身のサブフォルダに移動しようとしていないかチェック
        if (selectedFile.type === 'folder') {
            if (await isFolderDescendant(selectedFolderForMove, selectedFile.id)) {
                showNotification('フォルダを自分自身のサブフォルダに移動することはできません', 'warning');
                return;
            }
        }
        
        // 同じ名前のファイルがないかチェック
        const existingFilesSnapshot = await db.collection('files')
            .where('parentFolder', '==', selectedFolderForMove)
            .where('name', '==', selectedFile.name)
            .where('userId', '==', currentUser.uid)
            .where('deleted', '==', false)
            .get();
        
        if (!existingFilesSnapshot.empty) {
            showNotification('移動先に同じ名前のファイルが既に存在します', 'warning');
            return;
        }
        
        // ファイルを移動
        await db.collection('files').doc(selectedFile.id).update({
            parentFolder: selectedFolderForMove,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification(`「${selectedFile.name}」を移動しました`, 'success');
        closeModal(moveModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('ファイル移動エラー:', error);
        showNotification('ファイルの移動に失敗しました', 'error');
    }
}

// フォルダAがフォルダBの子孫かどうかをチェック
async function isFolderDescendant(folderA, folderB) {
    // 同じフォルダの場合はtrue
    if (folderA === folderB) return true;
    
    // ルートの場合はfalse
    if (folderA === 'root') return false;
    
    try {
        // フォルダAの親を取得
        const folderDoc = await db.collection('files').doc(folderA).get();
        if (!folderDoc.exists) return false;
        
        const parentFolder = folderDoc.data().parentFolder;
        
        // 再帰的にチェック
        return await isFolderDescendant(parentFolder, folderB);
    } catch (error) {
        console.error('フォルダ関係チェックエラー:', error);
        return false;
    }
}

// 共有設定を更新
async function updateShareSettings() {
    try {
        if (!selectedFile) return;
        
        const shareType = document.querySelector('input[name="share-type"]:checked').value;
        const isPublic = shareType === 'public';
        
        // ファイルの共有設定を更新
        await db.collection('files').doc(selectedFile.id).update({
            isPublic: isPublic,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 特定ユーザーとの共有の場合
        if (!isPublic) {
            // 既存の共有設定を削除
            const existingSharesSnapshot = await db.collection('shares')
                .where('fileId', '==', selectedFile.id)
                .get();
            
            const batch = db.batch();
            existingSharesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // 新しい共有ユーザーを取得
            const sharedUserItems = document.querySelectorAll('.shared-user-item');
            const sharedEmails = Array.from(sharedUserItems).map(item => item.dataset.email);
            
            // 新しい共有設定を追加
            sharedEmails.forEach(email => {
                const shareRef = db.collection('shares').doc();
                batch.set(shareRef, {
                    fileId: selectedFile.id,
                    sharedWith: email,
                    sharedBy: currentUser.uid,
                    sharedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            await batch.commit();
        } else {
            // 全体共有の場合は既存の特定ユーザー共有を削除
            const existingSharesSnapshot = await db.collection('shares')
                .where('fileId', '==', selectedFile.id)
                .get();
            
            const batch = db.batch();
            existingSharesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
        }
        
        showNotification('共有設定を更新しました', 'success');
        closeModal(shareModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('共有設定更新エラー:', error);
        showNotification('共有設定の更新に失敗しました', 'error');
    }
}

// ファイルを削除
async function deleteFile() {
    try {
        if (!selectedFile) return;
        
        if (currentCategory === 'trash') {
            // ゴミ箱から完全に削除
            if (!confirm(`「${selectedFile.name}」を完全に削除しますか？この操作は元に戻せません。`)) {
                return;
            }
            
            if (selectedFile.type === 'folder') {
                // フォルダの場合は再帰的に削除
                await deleteFilesInFolder(selectedFile.id, true);
            }
            
            // ストレージからファイルを削除
            if (selectedFile.type !== 'folder' && selectedFile.storagePath) {
                await storage.ref(selectedFile.storagePath).delete().catch(err => {
                    console.warn('ストレージファイル削除エラー:', err);
                });
            }
            
            // データベースからファイルを削除
            await db.collection('files').doc(selectedFile.id).delete();
            
            // 共有設定を削除
            const sharesSnapshot = await db.collection('shares')
                .where('fileId', '==', selectedFile.id)
                .get();
            
            const batch = db.batch();
            sharesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            
            showNotification(`「${selectedFile.name}」を完全に削除しました`, 'success');
        } else {
            // ゴミ箱に移動
            if (!confirm(`「${selectedFile.name}」をゴミ箱に移動しますか？`)) {
                return;
            }
            
            if (selectedFile.type === 'folder') {
                // フォルダの場合は再帰的にゴミ箱に移動
                await deleteFilesInFolder(selectedFile.id, false);
            }
            
            // ファイルをゴミ箱に移動
            await db.collection('files').doc(selectedFile.id).update({
                deleted: true,
                deletedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification(`「${selectedFile.name}」をゴミ箱に移動しました`, 'success');
        }
        
        closeModal(fileActionsModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('ファイル削除エラー:', error);
        showNotification('ファイルの削除に失敗しました', 'error');
    }
}

// フォルダ内のファイルを再帰的に削除/ゴミ箱に移動
async function deleteFilesInFolder(folderId, permanent = false) {
    try {
        // フォルダ内のファイルとサブフォルダを取得
        const filesSnapshot = await db.collection('files')
            .where('parentFolder', '==', folderId)
            .get();
        
        for (const doc of filesSnapshot.docs) {
            const fileData = doc.data();
            
            if (fileData.type === 'folder') {
                // サブフォルダの場合は再帰的に処理
                await deleteFilesInFolder(doc.id, permanent);
            }
            
            if (permanent) {
                // 完全に削除
                if (fileData.type !== 'folder' && fileData.storagePath) {
                    // ストレージからファイルを削除
                    await storage.ref(fileData.storagePath).delete().catch(err => {
                        console.warn('ストレージファイル削除エラー:', err);
                    });
                }
                
                // データベースからドキュメントを削除
                await doc.ref.delete();
                
                // 共有設定を削除
                const sharesSnapshot = await db.collection('shares')
                    .where('fileId', '==', doc.id)
                    .get();
                
                const batch = db.batch();
                sharesSnapshot.forEach(shareDoc => {
                    batch.delete(shareDoc.ref);
                });
                await batch.commit();
            } else {
                // ゴミ箱に移動
                await doc.ref.update({
                    deleted: true,
                    deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
    } catch (error) {
        console.error('フォルダ内ファイル削除エラー:', error);
        throw error;
    }
}

// スター付け/解除
async function toggleStar() {
    try {
        if (!selectedFile) return;
        
        const newStarred = !selectedFile.starred;
        
        // データベースを更新
        await db.collection('files').doc(selectedFile.id).update({
            starred: newStarred,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification(
            newStarred ? 
                `「${selectedFile.name}」にスターを付けました` : 
                `「${selectedFile.name}」のスターを外しました`, 
            'success'
        );
        
        closeModal(fileActionsModal);
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('スター切替エラー:', error);
        showNotification('スターの切り替えに失敗しました', 'error');
    }
}

// ファイルをアップロード
async function uploadFiles(files) {
    try {
        if (!files || files.length === 0) return;
        
        // アップロードボタンを無効化
        const uploadStartBtn = document.getElementById('upload-start-btn');
        if (uploadStartBtn) {
            uploadStartBtn.disabled = true;
        }
        
        // ファイルリストを表示
        const uploadFilesList = document.getElementById('upload-files-list');
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileId = generateUniqueId();
            
            // ファイルアイテムを作成
            const fileItem = document.createElement('div');
            fileItem.className = 'upload-file-item';
            fileItem.dataset.id = fileId;
            
            const fileType = getFileType(file.type);
            const fileExtension = getFileExtension(file.name);
            const fileIconClass = getFileIconClass(fileType, fileExtension);
            
            fileItem.innerHTML = `
                <div class="upload-file-icon">
                    <i class="${fileIconClass}"></i>
                </div>
                <div class="upload-file-info">
                    <div class="upload-file-name">${file.name}</div>
                    <div class="upload-file-size">${formatFileSize(file.size)}</div>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="upload-file-actions">
                    <button class="cancel-upload-btn" data-id="${fileId}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            uploadFilesList.appendChild(fileItem);
            
            // 同名ファイルの存在チェック
            const existingFilesSnapshot = await db.collection('files')
                .where('parentFolder', '==', currentFolder)
                .where('name', '==', file.name)
                .where('userId', '==', currentUser.uid)
                .where('deleted', '==', false)
                .get();
            
            if (!existingFilesSnapshot.empty) {
                fileItem.classList.add('upload-error');
                fileItem.querySelector('.upload-file-info').innerHTML += `
                    <div class="error-message">同名のファイルが既に存在します</div>
                `;
                continue;
            }
            
            // アップロードパスを設定
            const storagePath = `users/${currentUser.uid}/files/${fileId}_${file.name}`;
            const uploadTask = storage.ref(storagePath).put(file);
            
            // キャンセルボタンのイベントリスナー
            const cancelBtn = fileItem.querySelector('.cancel-upload-btn');
            cancelBtn.addEventListener('click', () => {
                uploadTask.cancel();
                fileItem.remove();
            });
            
            // アップロード進捗の監視
            uploadTask.on('state_changed', 
                // 進捗
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    const progressBar = fileItem.querySelector('.upload-progress-fill');
                    progressBar.style.width = `${progress}%`;
                },
                // エラー
                (error) => {
                    console.error('ファイルアップロードエラー:', error);
                    console.error('ファイルアップロードエラー:', error);
                    fileItem.classList.add('upload-error');
                    fileItem.querySelector('.upload-file-info').innerHTML += `
                        <div class="error-message">アップロードに失敗しました: ${error.message}</div>
                    `;
                },
                // 完了
                async () => {
                    try {
                        // ファイル情報をFirestoreに保存
                        await db.collection('files').add({
                            name: file.name,
                            type: fileType,
                            size: file.size,
                            storagePath: storagePath,
                            parentFolder: currentFolder,
                            userId: currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            starred: false,
                            isPublic: false,
                            deleted: false
                        });
                        
                        // 完了表示
                        fileItem.classList.add('upload-complete');
                        const actionsDiv = fileItem.querySelector('.upload-file-actions');
                        actionsDiv.innerHTML = '<i class="fas fa-check" style="color: var(--success);"></i>';
                        
                        // ストレージ使用量を更新
                        await updateStorageUsage();
                    } catch (error) {
                        console.error('ファイル情報保存エラー:', error);
                        fileItem.classList.add('upload-error');
                        fileItem.querySelector('.upload-file-info').innerHTML += `
                            <div class="error-message">ファイル情報の保存に失敗しました</div>
                        `;
                    }
                }
            );
        }
        
        // アップロードボタンを有効化
        if (uploadStartBtn) {
            uploadStartBtn.disabled = false;
        }
        
        // ファイル一覧を更新（遅延実行）
        setTimeout(() => {
            loadFiles();
        }, 1000);
        
        showNotification('ファイルのアップロードを開始しました', 'info');
    } catch (error) {
        console.error('アップロード処理エラー:', error);
        showNotification('ファイルのアップロードに失敗しました', 'error');
        
        // アップロードボタンを有効化
        const uploadStartBtn = document.getElementById('upload-start-btn');
        if (uploadStartBtn) {
            uploadStartBtn.disabled = false;
        }
    }
}

// ユーティリティ関数
// ----------------------------------------------

// ファイルサイズのフォーマット
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 日付フォーマット
function formatDate(timestamp) {
    if (!timestamp) return '-';
    
    let date;
    if (timestamp.toDate) {
        // Firestore Timestamp
        date = timestamp.toDate();
    } else if (timestamp.seconds) {
        // Firestore Timestamp in different format
        date = new Date(timestamp.seconds * 1000);
    } else {
        // JS Date or timestamp number
        date = new Date(timestamp);
    }
    
    return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ファイルの拡張子を取得
function getFileExtension(filename) {
    return filename.split('.').pop().toLowerCase();
}

// MIMEタイプからファイルタイプを判別
function getFileType(mimeType) {
    if (!mimeType) return 'unknown';
    
    const type = mimeType.split('/')[0];
    const subtype = mimeType.split('/')[1];
    
    if (type === 'image') return 'image';
    if (type === 'video') return 'video';
    if (type === 'audio') return 'audio';
    
    if (subtype === 'pdf') return 'pdf';
    if (subtype.includes('msword') || subtype.includes('document')) return 'document';
    if (subtype.includes('sheet') || subtype.includes('excel')) return 'spreadsheet';
    if (subtype.includes('presentation') || subtype.includes('powerpoint')) return 'presentation';
    
    return 'file';
}

// ファイルタイプと拡張子からアイコンクラスを取得
function getFileIconClass(type, ext) {
    switch (type) {
        case 'folder':
            return 'fas fa-folder';
        case 'image':
            return 'far fa-file-image';
        case 'video':
            return 'far fa-file-video';
        case 'audio':
            return 'far fa-file-audio';
        case 'pdf':
            return 'far fa-file-pdf';
        case 'document':
            return 'far fa-file-word';
        case 'spreadsheet':
            return 'far fa-file-excel';
        case 'presentation':
            return 'far fa-file-powerpoint';
    }
    
    // 拡張子による判別
    if (!ext) return 'far fa-file';
    
    switch (ext) {
        case 'pdf':
            return 'far fa-file-pdf';
        case 'doc':
        case 'docx':
            return 'far fa-file-word';
        case 'xls':
        case 'xlsx':
        case 'csv':
            return 'far fa-file-excel';
        case 'ppt':
        case 'pptx':
            return 'far fa-file-powerpoint';
        case 'zip':
        case 'rar':
        case '7z':
        case 'tar':
        case 'gz':
            return 'far fa-file-archive';
        case 'txt':
        case 'md':
            return 'far fa-file-alt';
        case 'html':
        case 'css':
        case 'js':
        case 'json':
        case 'xml':
        case 'php':
        case 'py':
        case 'java':
        case 'c':
        case 'cpp':
            return 'far fa-file-code';
        default:
            return 'far fa-file';
    }
}

// ユニークIDの生成
function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 10);
}

// HTMLエスケープ
function escapeHTML(str) {
    return str.replace(/[&<>'"]/g, 
        tag => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            "'": '&#39;',
            '"': '&quot;'
        }[tag]));
}

// メールアドレスの検証
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

// モーダルを閉じる
function closeModal(modal) {
    if (modal) modal.style.display = 'none';
}

// 通知を表示
function showNotification(message, type = 'info') {
    const id = generateUniqueId();
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.dataset.id = id;
    
    let icon = 'info-circle';
    switch (type) {
        case 'success': icon = 'check-circle'; break;
        case 'error': icon = 'exclamation-circle'; break;
        case 'warning': icon = 'exclamation-triangle'; break;
    }
    
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="fas fa-${icon}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" data-id="${id}">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // 閉じるボタンのイベントリスナー
    notification.querySelector('.notification-close').addEventListener('click', () => {
        closeNotification(id);
    });
    
    // 通知を追加
    notificationContainer.appendChild(notification);
    
    // 自動で閉じる
    setTimeout(() => {
        closeNotification(id);
    }, 5000);
}

// 通知を閉じる
function closeNotification(id) {
    const notification = document.querySelector(`.notification[data-id="${id}"]`);
    if (notification) {
        notification.classList.add('hide');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
}

// テーマの初期化
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    
    // テーマトグルボタンの表示を更新
    updateThemeToggle(savedTheme);
}

// テーマトグルの表示を更新
function updateThemeToggle(theme) {
    if (themeToggle) {
        if (theme === 'dark') {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
        } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
        }
    }
}

// テーマの切り替え
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    updateThemeToggle(newTheme);
}

// サイドバーの表示切替（モバイル用）
function toggleSidebar() {
    sidebar.classList.toggle('active');
}

// ドラッグアンドドロップ関連の関数
function handleDragStart(e, file) {
    draggedFile = file;
    e.dataTransfer.setData('text/plain', file.id);
    e.currentTarget.classList.add('dragging');
}

function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    if (e.currentTarget.dataset.type === 'folder') {
        e.currentTarget.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

async function handleDrop(e, targetFile) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    // ドラッグされたファイルがない場合は何もしない
    if (!draggedFile) return;
    
    // 同じフォルダには移動しない
    if (draggedFile.parentFolder === targetFile.id) {
        showNotification('既に選択したフォルダに存在しています', 'info');
        return;
    }
    
    // フォルダを自分自身のサブフォルダに移動しようとしていないかチェック
    if (draggedFile.type === 'folder') {
        if (await isFolderDescendant(targetFile.id, draggedFile.id)) {
            showNotification('フォルダを自分自身のサブフォルダに移動することはできません', 'warning');
            return;
        }
    }
    
    // 同名ファイルのチェック
    const existingFilesSnapshot = await db.collection('files')
        .where('parentFolder', '==', targetFile.id)
        .where('name', '==', draggedFile.name)
        .where('userId', '==', currentUser.uid)
        .where('deleted', '==', false)
        .get();
    
    if (!existingFilesSnapshot.empty) {
        showNotification('移動先に同じ名前のファイルが既に存在します', 'warning');
        return;
    }
    
    try {
        // ファイルを移動
        await db.collection('files').doc(draggedFile.id).update({
            parentFolder: targetFile.id,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification(`「${draggedFile.name}」を「${targetFile.name}」に移動しました`, 'success');
        
        // ファイル一覧を更新
        loadFiles();
    } catch (error) {
        console.error('ドラッグ＆ドロップ移動エラー:', error);
        showNotification('ファイルの移動に失敗しました', 'error');
    }
}

// イベントリスナーの設定
function setupEventListeners() {
    // ログアウトボタン
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ログアウトエラー:', error);
                showNotification('ログアウトに失敗しました', 'error');
            }
        });
    }
    
    // テーマ切替ボタン
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
    
    // サイドバー切替ボタン（モバイル用）
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // ファイルカテゴリ切替
    fileCategories.forEach(category => {
        category.addEventListener('click', () => {
            const categoryId = category.dataset.category;
            loadFiles(null, categoryId);
        });
    });
    
    // 表示モード切替ボタン
    viewButtons.forEach(button => {
        button.addEventListener('click', () => {
            viewMode = button.dataset.view;
            
            // ボタンのアクティブ状態を更新
            viewButtons.forEach(btn => {
                btn.classList.toggle('active', btn === button);
            });
            
            // ファイルコンテナのクラスを更新
            filesContainer.className = `files-container ${viewMode}-view`;
            
            // ファイル一覧を再読み込み
            loadFiles();
        });
    });
    
    // 検索機能
    if (searchInput) {
        let searchTimeout;
        
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                searchQuery = searchInput.value.trim();
                loadFiles();
            }, 500);
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchQuery = searchInput.value.trim();
                loadFiles();
            }
        });
    }
    
    // アップロードボタン
    if (uploadBtn) {
        uploadBtn.addEventListener('click', openUploadModal);
    }
    
    // 新規フォルダボタン
    if (newFolderBtn) {
        newFolderBtn.addEventListener('click', openNewFolderModal);
    }
    
    // ファイル操作モーダルのボタン
    document.getElementById('rename-btn').addEventListener('click', () => {
        closeModal(fileActionsModal);
        openRenameModal();
    });
    
    document.getElementById('move-btn').addEventListener('click', async () => {
        closeModal(fileActionsModal);
        await openMoveModal();
    });
    
    document.getElementById('share-btn').addEventListener('click', () => {
        closeModal(fileActionsModal);
        openShareModal();
    });
    
    document.getElementById('star-btn').addEventListener('click', () => {
        toggleStar();
    });
    
    document.getElementById('download-btn').addEventListener('click', () => {
        downloadFile(selectedFile);
        closeModal(fileActionsModal);
    });
    
    document.getElementById('delete-btn').addEventListener('click', () => {
        deleteFile();
    });
    
    // 名前変更フォーム
    document.getElementById('rename-form').addEventListener('submit', (e) => {
        e.preventDefault();
        renameFile();
    });
    
    // 新規フォルダフォーム
    document.getElementById('new-folder-form').addEventListener('submit', (e) => {
        e.preventDefault();
        createFolder();
    });
    
    // 移動確認ボタン
    document.getElementById('move-confirm-btn').addEventListener('click', () => {
        moveFile();
    });
    
    // 共有設定
    const shareTypeRadios = document.getElementsByName('share-type');
    shareTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            const specificUsersSection = document.getElementById('specific-users-section');
            specificUsersSection.style.display = radio.value === 'specific' ? 'block' : 'none';
        });
    });
    
    // ユーザー追加ボタン
    document.getElementById('add-user-btn').addEventListener('click', () => {
        const email = document.getElementById('share-email').value.trim();
        
        if (email && validateEmail(email)) {
            addSharedUserToList(email);
            document.getElementById('share-email').value = '';
        } else {
            showNotification('有効なメールアドレスを入力してください', 'warning');
        }
    });
    
    // 共有設定確認ボタン
    document.getElementById('share-confirm-btn').addEventListener('click', () => {
        updateShareSettings();
    });
    
    // アップロードフォーム
    document.getElementById('upload-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('file-input');
        if (fileInput.files.length > 0) {
            uploadFiles(fileInput.files);
        } else {
            showNotification('アップロードするファイルを選択してください', 'warning');
        }
    });
    
    // アップロードエリアのドラッグ&ドロップ
    const uploadArea = document.getElementById('upload-area');
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
            uploadFiles(e.dataTransfer.files);
        }
    });
    
    // ファイル選択入力のイベント
    document.getElementById('file-input').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const filesList = document.getElementById('upload-files-list');
            filesList.innerHTML = '';
            
            for (let i = 0; i < e.target.files.length; i++) {
                const file = e.target.files[i];
                const fileType = getFileType(file.type);
                const fileExtension = getFileExtension(file.name);
                const fileIconClass = getFileIconClass(fileType, fileExtension);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'upload-file-item';
                fileItem.innerHTML = `
                    <div class="upload-file-icon">
                        <i class="${fileIconClass}"></i>
                    </div>
                    <div class="upload-file-info">
                        <div class="upload-file-name">${file.name}</div>
                        <div class="upload-file-size">${formatFileSize(file.size)}</div>
                    </div>
                `;
                
                filesList.appendChild(fileItem);
            }
        }
    });
    
    // モーダルの閉じるボタン
    document.querySelectorAll('.close, .modal-cancel').forEach(element => {
        element.addEventListener('click', () => {
            const modal = element.closest('.modal');
            closeModal(modal);
        });
    });
    
    // モーダル外クリックで閉じる
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });
    
    // Escキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.style.display === 'block') {
                    closeModal(modal);
                }
            });
        }
    });
}
    </script>
</body>
</html>