<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KatsujiRingX - 日本語古文書のデジタル化・活字化プラットフォーム">
    <title>マイページ | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <style>
        /* ベースとなる変数 */
:root {
  /* カラーパレット */
  --primary: #4A6FDC;
  --primary-dark: #3D5CB8;
  --primary-light: #7291E5;
  --primary-rgb: 74, 111, 220;
  
  --secondary: #FF8A3D;
  --secondary-dark: #E56F24;
  --secondary-light: #FFA166;
  --secondary-rgb: 255, 138, 61;
  
  --accent: #3ECA72;
  --accent-dark: #33A85E;
  --accent-light: #62E790;
  --accent-rgb: 62, 202, 114;
  
  /* テキストカラー (ライトモード) */
  --text-primary: #333333;
  --text-secondary: #666666;
  --text-muted: #909090;
  
  /* 背景カラー (ライトモード) */
  --bg-primary: #FFFFFF;
  --bg-secondary: #F5F7FA;
  --bg-tertiary: #E9EDF2;
  --bg-primary-rgb: 255, 255, 255;
  
  /* ボーダーとシャドウ */
  --border-color: #D1D9E6;
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
  
  /* スペーシング */
  --spacing-xs: 0.25rem;
  --spacing-sm: 0.5rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  
  /* トランジション */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.3s ease;
}

/* ダークモード変数 */
[data-theme="dark"] {
  --text-primary: #F5F7FA;
  --text-secondary: #C4C9D4;
  --text-muted: #9098A6;
  
  --bg-primary: #1A202C;
  --bg-secondary: #2D3748;
  --bg-tertiary: #3E4B61;
  --bg-primary-rgb: 26, 32, 44;
  
  --border-color: #4A5568;
}

/* リセットとベーススタイル */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
}

body {
  font-family: 'Noto Sans JP', sans-serif;
  color: var(--text-primary);
  background-color: var(--bg-primary);
  line-height: 1.6;
  transition: background-color var(--transition-normal), color var(--transition-normal);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

body.preload * {
  transition: none !important;
}

.hidden {
  display: none !important;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--spacing-lg);
}

/* タイポグラフィ */
h1, h2, h3, h4, h5, h6 {
  font-weight: 700;
  line-height: 1.3;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

h1 {
  font-size: 1.875rem;
}

h2 {
  font-size: 1.5rem;
}

h3 {
  font-size: 1.25rem;
}

h4 {
  font-size: 1.125rem;
}

p {
  margin-bottom: 1rem;
}

a {
  color: var(--primary);
  text-decoration: none;
  transition: color var(--transition-fast);
}

a:hover {
  color: var(--primary-dark);
}

img {
  max-width: 100%;
  height: auto;
}

/* ヘッダースタイル */
#header {
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
  transition: background-color var(--transition-normal);
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 4rem;
  padding: 0 var(--spacing-lg);
}

.logo {
  display: flex;
  align-items: center;
  text-decoration: none;
  color: var(--text-primary);
}

.logo img {
  margin-right: var(--spacing-sm);
}

.logo-text {
  font-weight: 700;
  font-size: 1.25rem;
}

.menu-toggle {
  display: none;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 1.25rem;
  cursor: pointer;
}

.nav-menu {
  display: flex;
  list-style: none;
}

.nav-menu li {
  margin: 0 var(--spacing-md);
}

.nav-menu a {
  color: var(--text-primary);
  text-decoration: none;
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: 4px;
  transition: background-color var(--transition-fast);
}

.nav-menu a:hover {
  background-color: var(--bg-tertiary);
}

.nav-menu a.active {
  color: var(--primary);
  font-weight: 500;
}

/* フッター */
footer {
  background-color: var(--bg-secondary);
  border-top: 1px solid var(--border-color);
  padding-top: var(--spacing-xl);
  margin-top: auto;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--spacing-lg);
}

.footer-top {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-xl);
  padding-bottom: var(--spacing-xl);
}

.footer-section h3 {
  font-size: 1rem;
  margin-bottom: var(--spacing-md);
}

.footer-logo {
  display: inline-block;
  margin-bottom: var(--spacing-md);
  text-decoration: none;
  color: var(--text-primary);
  font-weight: 700;
  font-size: 1.25rem;
}

.footer-section p {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-md);
}

.footer-links {
  list-style: none;
}

.footer-links li {
  margin-bottom: var(--spacing-sm);
}

.footer-links a {
  color: var(--text-secondary);
  text-decoration: none;
  transition: color var(--transition-fast);
}

.footer-links a:hover {
  color: var(--primary);
}

.footer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-lg) 0;
  border-top: 1px solid var(--border-color);
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.footer-nav {
  display: flex;
  gap: var(--spacing-lg);
}

.footer-nav a {
  color: var(--text-secondary);
  text-decoration: none;
}

.footer-nav a:hover {
  color: var(--primary);
}

/* ローディングオーバーレイ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  color: white;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #ffffff;
  animation: spin 1s linear infinite;
  margin-bottom: var(--spacing-md);
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* 通知コンテナ */
.notification-container {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.notification {
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: 6px;
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: flex-start;
  max-width: 350px;
  animation: slideIn 0.3s ease;
}

.notification-success {
  background-color: #D1FAE5;
  border-left: 4px solid #34D399;
  color: #065F46;
}

.notification-error {
  background-color: #FEE2E2;
  border-left: 4px solid #F87171;
  color: #991B1B;
}

.notification-info {
  background-color: #DBEAFE;
  border-left: 4px solid #60A5FA;
  color: #1E40AF;
}

.notification-icon {
  margin-right: var(--spacing-md);
  font-size: 1.25rem;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
}

.notification-close {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  padding: 0;
  color: inherit;
  opacity: 0.7;
  margin-left: var(--spacing-md);
}

.notification-close:hover {
  opacity: 1;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .menu-toggle {
    display: block;
  }
  
  .nav-menu {
    position: fixed;
    top: 4rem;
    left: 0;
    width: 100%;
    background-color: var(--bg-primary);
    box-shadow: var(--shadow-md);
    flex-direction: column;
    padding: var(--spacing-md) 0;
    transform: translateY(-100%);
    transition: transform var(--transition-normal);
    z-index: 99;
  }
  
  .nav-menu.active {
    transform: translateY(0);
  }
  
  .nav-menu li {
    margin: 0;
  }
  
  .nav-menu a {
    display: block;
    padding: var(--spacing-md) var(--spacing-lg);
  }
  
  .footer-top {
    grid-template-columns: 1fr;
  }
  
  .footer-bottom {
    flex-direction: column;
    gap: var(--spacing-md);
  }
}
/* ボタンスタイル */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
  border: none;
  font-size: 1rem;
}

.btn-primary {
  background-color: var(--primary);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-dark);
}

.btn-secondary {
  background-color: var(--secondary);
  color: white;
}

.btn-secondary:hover {
  background-color: var(--secondary-dark);
}

.btn-outline {
  background-color: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
}

.btn-outline:hover {
  background-color: var(--bg-tertiary);
}

.btn-small {
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.9rem;
}

.btn-block {
  display: block;
  width: 100%;
}

.btn-link {
  background: none;
  border: none;
  color: var(--primary);
  padding: 0;
  font-weight: 500;
  text-decoration: none;
}

.btn-link:hover {
  text-decoration: underline;
}

.btn i {
  margin-right: var(--spacing-sm);
}

.btn-icon {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 1.1rem;
  padding: var(--spacing-sm);
  cursor: pointer;
  border-radius: 50%;
  margin-right: var(--spacing-md);
  transition: background-color var(--transition-fast);
}

.btn-icon:hover {
  background-color: var(--bg-tertiary);
}

/* ユーザーメニュー */
.header-actions {
  display: flex;
  align-items: center;
}

.user-menu {
  position: relative;
}

.user-menu-button {
  display: flex;
  align-items: center;
  background: none;
  border: none;
  cursor: pointer;
  padding: var(--spacing-sm);
  border-radius: 4px;
  transition: background-color var(--transition-fast);
}

.user-menu-button:hover {
  background-color: var(--bg-tertiary);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-color: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: var(--spacing-sm);
}

.user-name {
  margin-right: var(--spacing-sm);
  color: var(--text-primary);
}

.dropdown-arrow {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.user-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: 8px;
  width: 200px;
  padding: var(--spacing-sm) 0;
  margin-top: var(--spacing-sm);
  z-index: 101;
  border: 1px solid var(--border-color);
}

.user-dropdown a,
.dropdown-item {
  display: flex;
  align-items: center;
  padding: var(--spacing-md) var(--spacing-lg);
  color: var(--text-primary);
  text-decoration: none;
  transition: background-color var(--transition-fast);
  width: 100%;
  text-align: left;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 0.95rem;
}

.user-dropdown a:hover,
.dropdown-item:hover {
  background-color: var(--bg-secondary);
}

.user-dropdown i {
  margin-right: var(--spacing-md);
  color: var(--text-secondary);
  width: 1.2rem;
  text-align: center;
}

.user-dropdown hr {
  border: none;
  border-top: 1px solid var(--border-color);
  margin: var(--spacing-sm) 0;
}

/* プログレスバー */
.progress-bar {
  height: 6px;
  background-color: var(--bg-tertiary);
  border-radius: 3px;
  overflow: hidden;
}

.progress {
  height: 100%;
  background-color: var(--primary);
}

/* 円形プログレス */
.circular-progress {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: conic-gradient(var(--primary) 0%, var(--bg-tertiary) 0%);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  margin-bottom: var(--spacing-sm);
}

.circular-progress::before {
  content: "";
  width: 90px;
  height: 90px;
  background-color: var(--bg-primary);
  border-radius: 50%;
  position: absolute;
}

.progress-value {
  position: relative;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

/* コンテナヘッダー */
.container-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-lg);
}

.container-header h2 {
  font-size: 1.25rem;
  margin-bottom: 0;
}

/* 空の状態表示 */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl);
  text-align: center;
}

.empty-icon {
  font-size: 2rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
}

.empty-state h3 {
  margin-bottom: var(--spacing-sm);
}

.empty-state p {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-lg);
  max-width: 400px;
}

.empty-actions {
  display: flex;
  gap: var(--spacing-md);
}

/* ローディング状態 */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl);
  color: var(--text-secondary);
}

/* 認証フォーム */
.auth-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 4rem);
  padding: var(--spacing-xl);
  background-color: var(--bg-secondary);
}

.auth-box {
  background-color: var(--bg-primary);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  padding: var(--spacing-xl);
  width: 100%;
  max-width: 450px;
}

.auth-box h1 {
  font-size: 1.75rem;
  margin-bottom: var(--spacing-sm);
  text-align: center;
}

.auth-box p {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-xl);
  text-align: center;
}

.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-sm);
  font-weight: 500;
}

.form-group input {
  width: 100%;
  padding: var(--spacing-md);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  transition: border-color var(--transition-fast);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary);
}

.password-input {
  position: relative;
}

.toggle-password {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
}

.password-strength-meter {
  height: 4px;
  background-color: var(--bg-tertiary);
  margin-top: var(--spacing-sm);
  border-radius: 2px;
  overflow: hidden;
}

.meter-bar {
  height: 100%;
  width: 0;
  background-color: var(--accent);
  transition: width var(--transition-normal), background-color var(--transition-normal);
}

.password-feedback {
  font-size: 0.85rem;
  margin-top: var(--spacing-xs);
  color: var(--text-secondary);
}

.auth-divider {
  display: flex;
  align-items: center;
  margin: var(--spacing-lg) 0;
}

.auth-divider::before,
.auth-divider::after {
  content: "";
  flex: 1;
  height: 1px;
  background-color: var(--border-color);
}

.auth-divider span {
  padding: 0 var(--spacing-md);
  color: var(--text-secondary);
  font-size: 0.85rem;
}

.auth-links {
  margin-top: var(--spacing-lg);
  text-align: center;
  font-size: 0.9rem;
}

.auth-links a {
  color: var(--primary);
  text-decoration: none;
}

.auth-links a:hover {
  text-decoration: underline;
}
/* ダッシュボードスタイル */
.dashboard {
  padding-bottom: var(--spacing-xl);
}

.welcome-section {
  background-color: var(--primary);
  color: white;
  padding: var(--spacing-xl) 0;
  margin-bottom: var(--spacing-xl);
}

.welcome-content h1 {
  font-size: 1.75rem;
  margin-bottom: var(--spacing-sm);
}

/* 統計カード */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.stats-card {
  background-color: var(--bg-primary);
  border-radius: 8px;
  padding: var(--spacing-lg);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  display: flex;
  align-items: center;
}

.stats-icon {
  font-size: 1.5rem;
  color: var(--primary);
  background-color: rgba(74, 111, 220, 0.1);
  width: 48px;
  height: 48px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: var(--spacing-md);
}

.stats-info h3 {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-xs);
}

.stats-number {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
}

/* 最近の活動 */
.recent-activities,
.dashboard-column,
.dashboard-activity,
.dashboard-community {
  margin-bottom: var(--spacing-xl);
}

.activity-list {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

.activity-item {
  display: flex;
  align-items: flex-start;
  padding: var(--spacing-lg);
  border-bottom: 1px solid var(--border-color);
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-icon {
  color: var(--primary);
  background-color: rgba(74, 111, 220, 0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: var(--spacing-md);
  flex-shrink: 0;
}

.activity-content {
  flex: 1;
}

.activity-header {
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
}

.activity-description {
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.activity-time {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-left: var(--spacing-md);
}

/* ダッシュボードカラム */
.dashboard-columns {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--spacing-xl);
  margin-bottom: var(--spacing-xl);
}

/* プロジェクトリスト */
.project-list {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

.project-item {
  padding: var(--spacing-lg);
  border-bottom: 1px solid var(--border-color);
}

.project-item:last-child {
  border-bottom: none;
}

.project-title {
  font-weight: 500;
  margin-bottom: var(--spacing-sm);
  display: flex;
  justify-content: space-between;
}

.project-progress {
  margin-bottom: var(--spacing-sm);
}

.project-meta {
  display: flex;
  justify-content: space-between;
  color: var(--text-secondary);
  font-size: 0.85rem;
}

/* 学習統計 */
.learning-stats {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
}

.learning-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: var(--spacing-lg);
}

.skill-progress {
  margin-top: var(--spacing-md);
  width: 100%;
}

.skill-item {
  margin-bottom: var(--spacing-md);
}

.skill-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--spacing-xs);
  font-size: 0.95rem;
}

/* デイリーチャレンジ */
.daily-challenge {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  padding: var(--spacing-lg);
}

.daily-challenge h3 {
  margin-bottom: var(--spacing-md);
  font-size: 1.1rem;
}

.challenge-content {
  display: flex;
  align-items: center;
  margin-bottom: var(--spacing-lg);
}

.challenge-icon {
  color: var(--secondary);
  background-color: rgba(255, 138, 61, 0.1);
  width: 48px;
  height: 48px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: var(--spacing-md);
  font-size: 1.25rem;
}

.challenge-info h4 {
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
}

.challenge-info p {
  color: var(--text-secondary);
  font-size: 0.95rem;
}

/* チャート */
.chart-period {
  display: flex;
}

.chart-period button {
  margin-left: var(--spacing-sm);
}

.chart-period button.active {
  background-color: var(--primary);
  color: white;
  border-color: var(--primary);
}

.chart-container {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  padding: var(--spacing-lg);
  position: relative;
  min-height: 300px;
}

.chart-loading,
.chart-no-data {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background-color: rgba(var(--bg-primary-rgb), 0.8);
}

/* コミュニティセクション */
.community-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
}

.community-stat {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  padding: var(--spacing-lg);
  text-align: center;
}

.stat-icon {
  color: var(--primary);
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.community-feed {
  background-color: var(--bg-primary);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  padding: var(--spacing-lg);
}

.community-feed h3 {
  margin-bottom: var(--spacing-lg);
  font-size: 1.1rem;
}

.community-projects {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: var(--spacing-lg);
}

.community-project {
  border-radius: 6px;
  overflow: hidden;
  transition: transform var(--transition-fast);
}

.community-project:hover {
  transform: translateY(-4px);
}

.project-preview {
  height: 140px;
  background-color: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
}

.project-info {
  padding: var(--spacing-md);
  background-color: var(--bg-secondary);
}

.project-author {
  font-size: 0.85rem;
  color: var(--text-secondary);
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  .dashboard-columns {
    grid-template-columns: 1fr;
  }
  
  .community-stats {
    grid-template-columns: 1fr;
  }
}
    </style>
</head>
<body class="preload">
    <div id="app">
        <!-- ヘッダー部分 -->
        <header id="header">
            <div class="header-content">
                <a href="index.html" class="logo" aria-label="KatsujiRingX ホームページ">
                    <img src="img/katsujiRingX.png" alt="KatsujiRingX ロゴ" width="40" height="40">
                    <span class="logo-text">KatsujiRingX</span>
                </a>
                
                <button id="menu-toggle" class="menu-toggle" aria-expanded="false" aria-controls="nav-menu">
                    <span class="sr-only">メニュー</span>
                    <i class="fas fa-bars"></i>
                </button>
                
                <nav>
                    <ul id="nav-menu" class="nav-menu">
                        <li><a href="index.html">ホーム</a></li>
                        <li><a href="main.html" class="active">マイページ</a></li>
                        <li><a href="editor.html">活字化エディター</a></li>
                        <li><a href="documents.html">資料管理</a></li>
                        <li><a href="games.html">学習ゲーム</a></li>
                    </ul>
                </nav>
                
                <div class="header-actions">
                    <button id="theme-toggle" class="btn-icon" aria-label="テーマの切り替え">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="user-menu">
                        <button id="user-menu-button" class="user-menu-button" aria-haspopup="true" aria-expanded="false">
                            <div class="user-avatar">
                                <span id="user-initial">U</span>
                            </div>
                            <span class="user-name" id="header-user-name">ユーザー</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                        </button>
                        
                        <div id="user-dropdown" class="user-dropdown hidden">
                            <a href="profile.html">
                                <i class="fas fa-user"></i>プロフィール
                            </a>
                            <a href="settings.html">
                                <i class="fas fa-cog"></i>設定
                            </a>
                            <a href="help.html">
                                <i class="fas fa-question-circle"></i>ヘルプ
                            </a>
                            <hr>
                            <button id="logout-btn" class="dropdown-item">
                                <i class="fas fa-sign-out-alt"></i>ログアウト
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-content">
            <!-- ダッシュボード (ログイン成功後に表示) -->
            <div id="dashboard-container" class="dashboard">
                <!-- Welcome Section -->
                <section class="welcome-section">
                    <div class="container">
                        <div class="welcome-content">
                            <h1>ようこそ <span id="welcome-user-name">ユーザー</span> さん</h1>
                            <p>KatsujiRingXへログインしました。あなたの活字化作業をサポートします。</p>
                        </div>
                    </div>
                </section>

                <!-- Stats Section -->
                <section class="dashboard-stats">
                    <div class="container">
                        <h2 class="sr-only">活動統計</h2>
                        <div class="stats-grid">
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="stats-info">
                                    <h3>活字化プロジェクト</h3>
                                    <p class="stats-number" id="projects-count">0</p>
                                </div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stats-info">
                                    <h3>活字化時間</h3>
                                    <p class="stats-number" id="total-hours">0時間</p>
                                </div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="stats-info">
                                    <h3>達成度</h3>
                                    <p class="stats-number" id="completion-rate">0%</p>
                                </div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="stats-info">
                                    <h3>獲得ポイント</h3>
                                    <p class="stats-number" id="earned-points">0pt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Recent Activities -->
                <section class="recent-activities">
                    <div class="container">
                        <div class="container-header">
                            <h2>最近の活動</h2>
                            <a href="activities.html" class="btn btn-link">すべて見る <i class="fas fa-arrow-right"></i></a>
                        </div>
                        <div class="activity-list" id="recent-activities-list">
                            <!-- アクティビティはJavaScriptで動的に生成 -->
                            <div id="activities-loading" class="loading-state">
                                <div class="spinner"></div>
                                <p>活動データを読み込み中...</p>
                            </div>
                            <div id="activities-empty-state" class="empty-state hidden">
                                <div class="empty-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h3>アクティビティがありません</h3>
                                <p>活字化エディターやゲームを利用して活動を始めましょう</p>
                                <div class="empty-actions">
                                    <a href="editor.html" class="btn btn-primary">エディターを開く</a>
                                    <a href="games.html" class="btn btn-outline">ゲームをプレイ</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Dashboard Columns -->
                <div class="dashboard-columns">
                    <!-- Projects Column -->
                    <section class="dashboard-column">
                        <div class="container">
                            <div class="container-header">
                                <h2>進行中のプロジェクト</h2>
                                <a href="projects.html" class="btn btn-link">すべて見る <i class="fas fa-arrow-right"></i></a>
                            </div>
                            <div class="project-list" id="current-projects-list">
                                <!-- プロジェクトはJavaScriptで動的に生成 -->
                                <div id="projects-loading" class="loading-state">
                                    <div class="spinner"></div>
                                    <p>プロジェクトを読み込み中...</p>
                                </div>
                            </div>
                            <div id="empty-projects" class="empty-state hidden">
                                <div class="empty-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <h3>プロジェクトがありません</h3>
                                <p>新しい活字化プロジェクトを作成しましょう</p>
                                <div class="empty-actions">
                                    <a href="editor.html" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> 新規プロジェクト
                                    </a>
                                    <a href="documents.html" class="btn btn-outline">資料からインポート</a>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Learning Progress Column -->
                    <section class="dashboard-column">
                        <div class="container">
                            <div class="container-header">
                                <h2>学習の進捗</h2>
                                <a href="learning.html" class="btn btn-link">詳細を見る <i class="fas fa-arrow-right"></i></a>
                            </div>
                            <div id="learning-loading" class="loading-state">
                                <div class="spinner"></div>
                                <p>学習データを読み込み中...</p>
                            </div>
                            <div id="learning-content" class="hidden">
                                <div class="learning-stats">
                                    <div class="learning-progress">
                                        <div class="circular-progress" id="overall-progress">
                                            <div class="progress-value">0%</div>
                                        </div>
                                        <p>総合達成度</p>
                                    </div>
                                    <div class="skill-progress">
                                        <div class="skill-item">
                                            <div class="skill-info">
                                                <span>崩し字</span>
                                                <span id="kuzushiji-level">レベル 0</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress" id="kuzushiji-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="skill-item">
                                            <div class="skill-info">
                                                <span>変体仮名</span>
                                                <span id="hentaigana-level">レベル 0</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress" id="hentaigana-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="skill-item">
                                            <div class="skill-info">
                                                <span>古文書</span>
                                                <span id="komonjo-level">レベル 0</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress" id="komonjo-progress" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="daily-challenge">
                                    <h3>今日のチャレンジ</h3>
                                    <div class="challenge-content">
                                        <div class="challenge-icon">
                                            <i class="fas fa-gamepad"></i>
                                        </div>
                                        <div class="challenge-info">
                                            <h4 id="challenge-title">崩し字クイズ</h4>
                                            <p id="challenge-description">10問の崩し字問題に挑戦しましょう</p>
                                        </div>
                                    </div>
                                    <a href="games.html" class="btn btn-secondary btn-block">
                                        挑戦する <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Activity Chart -->
                <section class="dashboard-activity">
                    <div class="container">
                        <div class="container-header">
                            <h2>活字化活動の分析</h2>
                            <div class="chart-period">
                                <button class="btn btn-small btn-outline active" data-period="week">週間</button>
                                <button class="btn btn-small btn-outline" data-period="month">月間</button>
                                <button class="btn btn-small btn-outline" data-period="year">年間</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="activity-chart"></canvas>
                            <div id="chart-loading" class="chart-loading">
                                <div class="spinner"></div>
                                <p>データを読み込み中...</p>
                            </div>
                            <div id="chart-no-data" class="chart-no-data hidden">
                                <div class="empty-icon">
                                    <i class="fas fa-chart-area"></i>
                                </div>
                                <p>この期間のデータがありません</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Community Section -->
                <section class="dashboard-community">
                    <div class="container">
                        <div class="container-header">
                            <h2>コミュニティ</h2>
                            <a href="community.html" class="btn btn-link">コミュニティページへ <i class="fas fa-arrow-right"></i></a>
                        </div>
                        <div id="community-loading" class="loading-state">
                            <div class="spinner"></div>
                            <p>コミュニティデータを読み込み中...</p>
                        </div>
                        <div id="community-content" class="hidden">
                            <div class="community-stats">
                                <div class="community-stat">
                                    <div class="stat-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-value" id="community-members">0</div>
                                    <div class="stat-label">メンバー</div>
                                </div>
                                <div class="community-stat">
                                    <div class="stat-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="stat-value" id="community-projects">0</div>
                                    <div class="stat-label">プロジェクト</div>
                                </div>
                                <div class="community-stat">
                                    <div class="stat-icon">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div class="stat-value" id="community-documents">0</div>
                                    <div class="stat-label">共有資料</div>
                                </div>
                            </div>
                            <div class="community-feed">
                                <h3>最新の共有プロジェクト</h3>
                                <div class="community-projects" id="community-feed">
                                    <!-- コミュニティプロジェクトはJavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-top">
                    <div class="footer-section">
                        <a href="index.html" class="footer-logo">
                            <span class="logo-text">KatsujiRingX</span>
                        </a>
                        <p>次世代の活字化プラットフォーム。OCR技術を活用した日本語縦書き文書の活字化をサポートします。</p>
                    </div>
                    <div class="footer-section">
                        <h3>現在の提供サービス</h3>
                        <ul class="footer-links">
                            <li><a href="editor.html">活字化エディター</a></li>
                            <li><a href="documents.html">OCR文字認識</a></li>
                            <li><a href="documents.html">資料管理</a></li>
                            <li><a href="games.html">学習ゲーム</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>サポート</h3>
                        <ul class="footer-links">
                            <li><a href="help.html">ヘルプセンター</a></li>
                            <li><a href="faq.html">よくある質問</a></li>
                            <li><a href="contact.html">お問い合わせ</a></li>
                            <li><a href="feedback.html">フィードバック</a></li>
                        </ul>
                    </div>
                    <div class="footer-section">
                        <h3>リソース</h3>
                        <ul class="footer-links">
                            <li><a href="blog.html">ブログ</a></li>
                            <li><a href="tutorials.html">チュートリアル</a></li>
                            <li><a href="api.html">API</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer-bottom">
                    <div class="copyright">
                        &copy; 2025 KatsujiRingX. All rights reserved.
                    </div>
                    <div class="footer-nav">
                        <a href="privacy.html">プライバシーポリシー</a>
                        <a href="terms.html">利用規約</a>
                        <a href="accessibility.html">アクセシビリティ</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification System -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>読み込み中...</p>
    </div>

    <script>
        // Firebase設定
const firebaseConfig = {
    apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
                authDomain: "katsujiringx.firebaseapp.com",
                projectId: "katsujiringx",
                storageBucket: "katsujiringx.firebasestorage.app",
                messagingSenderId: "831784731743",
                appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
                measurementId: "G-LPCRE3WYZR"
};

// Firebase初期化
firebase.initializeApp(firebaseConfig);

// Firebase共通サービス
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Firestoreのパフォーマンス設定
db.settings({
  cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
});
db.enablePersistence({ synchronizeTabs: true })
  .catch(err => {
    if (err.code === 'failed-precondition') {
      // 複数タブが開かれている場合
      console.warn('Firestore persistence can only be enabled in one tab at a time.');
    } else if (err.code === 'unimplemented') {
      // ブラウザがサポートしていない場合
      console.warn('Your browser does not support Firestore persistence.');
    }
  });

// グローバルで利用するユーティリティ関数
const utilities = {
  // 通知システム
  notifications: {
    container: document.getElementById('notification-container'),
    
    show: function(message, type = 'info', duration = 5000) {
      const id = 'notification-' + Date.now();
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.id = id;
      
      let icon = '';
      switch(type) {
        case 'success':
          icon = '<i class="fas fa-check-circle notification-icon"></i>';
          break;
        case 'error':
          icon = '<i class="fas fa-exclamation-circle notification-icon"></i>';
          break;
        default:
          icon = '<i class="fas fa-info-circle notification-icon"></i>';
      }
      
      notification.innerHTML = `
        ${icon}
        <div class="notification-content">
          <p>${message}</p>
        </div>
        <button class="notification-close" aria-label="閉じる">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      // 閉じるボタンに機能を追加
      notification.querySelector('.notification-close').addEventListener('click', () => {
        this.remove(id);
      });
      
      this.container.appendChild(notification);
      
      // 一定時間後に自動で消す
      if (duration > 0) {
        setTimeout(() => {
          this.remove(id);
        }, duration);
      }
      
      return id;
    },
    
    remove: function(id) {
      const notification = document.getElementById(id);
      if (notification) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }
  },
  
  // ローディングオーバーレイ
  loadingOverlay: {
    element: document.getElementById('loading-overlay'),
    
    show: function() {
      if (this.element) {
        this.element.classList.remove('hidden');
      }
    },
    
    hide: function() {
      if (this.element) {
        this.element.classList.add('hidden');
      }
    }
  },
  
  // テーマ切り替え機能
  themeManager: {
    toggle: document.getElementById('theme-toggle'),
    
    init: function() {
      if (!this.toggle) return;
      
      // 保存されたテーマを読み込む
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateIcon(savedTheme);
      } else {
        // システムの設定に合わせる
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        this.updateIcon(prefersDark ? 'dark' : 'light');
      }
      
      // トグルボタンのイベントリスナー
      this.toggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        this.updateIcon(newTheme);
      });
      
      // システムの設定変更を監視
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          this.updateIcon(newTheme);
        }
      });
    },
    
    updateIcon: function(theme) {
      if (!this.toggle) return;
      
      const icon = this.toggle.querySelector('i');
      if (icon) {
        if (theme === 'dark') {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }
      }
    }
  },
  
  // 相対時間を取得
  getTimeAgo: function(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // 秒単位の差
    
    if (diff < 60) return `${diff}秒前`;
    if (diff < 3600) return `${Math.floor(diff / 60)}分前`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}時間前`;
    if (diff < 604800) return `${Math.floor(diff / 86400)}日前`;
    
    // それ以上は日付表示
    return date.toLocaleDateString('ja-JP');
  }
};

// ドキュメント読み込み完了時の初期化処理
document.addEventListener('DOMContentLoaded', function() {
  // プリロードクラスを削除（アニメーション有効化）
  setTimeout(() => {
    document.body.classList.remove('preload');
  }, 300);
  
  // テーママネージャーを初期化
  utilities.themeManager.init();
  
  // ユーザーメニューのドロップダウン機能
  const userMenuButton = document.getElementById('user-menu-button');
  const userDropdown = document.getElementById('user-dropdown');
  
  if (userMenuButton && userDropdown) {
    userMenuButton.addEventListener('click', function() {
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !expanded);
      userDropdown.classList.toggle('hidden');
    });
    
    // ドキュメントクリックでドロップダウンを閉じる
    document.addEventListener('click', function(event) {
      if (!userMenuButton.contains(event.target) && !userDropdown.contains(event.target)) {
        userMenuButton.setAttribute('aria-expanded', 'false');
        userDropdown.classList.add('hidden');
      }
    });
  }
  
  // モバイルナビゲーションの切り替え
  const menuToggle = document.getElementById('menu-toggle');
  const navMenu = document.getElementById('nav-menu');
  
  if (menuToggle && navMenu) {
    menuToggle.addEventListener('click', function() {
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !expanded);
      navMenu.classList.toggle('active');
    });
  }
});

// 認証関連の要素
const authElements = {
  dashboardContainer: document.getElementById('dashboard-container'),
  logoutBtn: document.getElementById('logout-btn'),
  headerUserName: document.getElementById('header-user-name'),
  userInitial: document.getElementById('user-initial'),
  welcomeUserName: document.getElementById('welcome-user-name')
};

// 認証状態の監視
auth.onAuthStateChanged(user => {
  // 読み込み中表示
  utilities.loadingOverlay.show();
  
  if (user) {
    // ユーザーがログインしている場合
    userLoggedIn(user);
  } else {
    // ユーザーがログアウトしている場合
    userLoggedOut();
  }
  
  // 読み込み完了
  setTimeout(() => {
    utilities.loadingOverlay.hide();
  }, 500);
});

// ユーザーがログイン状態の処理
function userLoggedIn(user) {
  // ユーザー情報を表示
  if (authElements.headerUserName) {
    authElements.headerUserName.textContent = user.displayName || user.email;
  }
  
  if (authElements.userInitial) {
    const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
    authElements.userInitial.textContent = initial;
  }
  
  if (authElements.welcomeUserName) {
    authElements.welcomeUserName.textContent = user.displayName || user.email.split('@')[0];
  }
  
  // ユーザーデータをFirestoreから取得
  loadUserData(user.uid);
}

// ユーザーがログアウト状態の処理
function userLoggedOut() {
  // 別のログインページにリダイレクト
  window.location.href = 'login.html';
}

// ログアウト処理
if (authElements.logoutBtn) {
  authElements.logoutBtn.addEventListener('click', () => {
    utilities.loadingOverlay.show();
    
    auth.signOut()
      .then(() => {
        utilities.notifications.show('ログアウトしました', 'success');
        // ログアウト成功時は onAuthStateChanged で処理される
      })
      .catch(error => {
        utilities.notifications.show('ログアウトに失敗しました: ' + error.message, 'error');
        utilities.loadingOverlay.hide();
      });
  });
}

// Firestoreにユーザーデータを作成
function createUserData(uid, userData) {
  return db.collection('users').doc(uid).set({
    ...userData,
    stats: {
      projects: 0,
      totalHours: 0,
      completionRate: 0,
      points: 0
    },
    skills: {
      kuzushiji: { level: 0, progress: 0 },
      hentaigana: { level: 0, progress: 0 },
      komonjo: { level: 0, progress: 0 }
    }
  });
}

// ユーザーデータをロード
function loadUserData(uid) {
  // 各種データを読み込む
  loadUserStats(uid);
  loadUserActivities(uid);
  loadUserProjects(uid);
  loadUserLearning(uid);
  loadCommunityData();
}

// ユーザー統計をロード
function loadUserStats(uid) {
  db.collection('users').doc(uid).get()
    .then(doc => {
      if (doc.exists && doc.data().stats) {
        const stats = doc.data().stats;
        
        document.getElementById('projects-count').textContent = stats.projects;
        document.getElementById('total-hours').textContent = stats.totalHours + '時間';
        document.getElementById('completion-rate').textContent = stats.completionRate + '%';
        document.getElementById('earned-points').textContent = stats.points + 'pt';
      }
    })
    .catch(error => {
      console.error('ユーザー統計の読み込みに失敗しました:', error);
    });
}

// ユーザーアクティビティをロード
function loadUserActivities(uid) {
  const activitiesList = document.getElementById('recent-activities-list');
  const activitiesLoading = document.getElementById('activities-loading');
  const activitiesEmptyState = document.getElementById('activities-empty-state');
  
  db.collection('users').doc(uid).collection('activities')
    .orderBy('timestamp', 'desc')
    .limit(5)
    .get()
    .then(snapshot => {
      if (activitiesLoading) activitiesLoading.classList.add('hidden');
      
      if (snapshot.empty) {
        if (activitiesEmptyState) activitiesEmptyState.classList.remove('hidden');
        return;
      }
      
      snapshot.forEach(doc => {
        const activity = doc.data();
        const activityItem = createActivityElement(activity);
        activitiesList.appendChild(activityItem);
      });
    })
    .catch(error => {
      console.error('アクティビティの読み込みに失敗しました:', error);
      if (activitiesLoading) activitiesLoading.classList.add('hidden');
    });
}

// アクティビティ要素を作成
function createActivityElement(activity) {
  const item = document.createElement('div');
  item.className = 'activity-item';
  
  let iconClass = 'fa-file-alt';
  
  switch (activity.type) {
    case 'edit':
      iconClass = 'fa-edit';
      break;
    case 'complete':
      iconClass = 'fa-check-circle';
      break;
    case 'game':
      iconClass = 'fa-gamepad';
      break;
  }
  
  const timestamp = activity.timestamp?.toDate 
    ? activity.timestamp.toDate() 
    : new Date(activity.timestamp);
    
  const timeAgo = utilities.getTimeAgo(timestamp);
  
  item.innerHTML = `
    <div class="activity-icon">
      <i class="fas ${iconClass}"></i>
    </div>
    <div class="activity-content">
      <div class="activity-header">${activity.title}</div>
      <div class="activity-description">${activity.description}</div>
    </div>
    <div class="activity-time">${timeAgo}</div>
  `;
  
  return item;
}

// ユーザープロジェクトをロード
function loadUserProjects(uid) {
  const projectsList = document.getElementById('current-projects-list');
  const projectsLoading = document.getElementById('projects-loading');
  const emptyProjects = document.getElementById('empty-projects');
  
  db.collection('users').doc(uid).collection('projects')
    .where('status', '==', 'in-progress')
    .orderBy('lastUpdated', 'desc')
    .limit(5)
    .get()
    .then(snapshot => {
      if (projectsLoading) projectsLoading.classList.add('hidden');
      
      if (snapshot.empty) {
        if (emptyProjects) emptyProjects.classList.remove('hidden');
        return;
      }
      
      snapshot.forEach(doc => {
        const project = doc.data();
        const projectItem = createProjectElement(project, doc.id);
        projectsList.appendChild(projectItem);
      });
    })
    .catch(error => {
      console.error('プロジェクトの読み込みに失敗しました:', error);
      if (projectsLoading) projectsLoading.classList.add('hidden');
    });
}

// プロジェクト要素を作成
function createProjectElement(project, id) {
  const item = document.createElement('div');
  item.className = 'project-item';
  
  const date = project.lastUpdated?.toDate 
    ? project.lastUpdated.toDate() 
    : new Date(project.lastUpdated);
    
  const formattedDate = date.toLocaleDateString('ja-JP');
  
  item.innerHTML = `
    <div class="project-title">
      ${project.title}
      <a href="editor.html?id=${id}" aria-label="${project.title}を編集">
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
    <div class="project-progress">
      <div class="progress-bar">
        <div class="progress" style="width: ${project.progress}%;"></div>
      </div>
    </div>
    <div class="project-meta">
      <span>${project.progress}% 完了</span>
      <span>最終更新: ${formattedDate}</span>
    </div>
  `;
  
  return item;
}

// ユーザーの学習状況をロード
function loadUserLearning(uid) {
  const learningLoading = document.getElementById('learning-loading');
  const learningContent = document.getElementById('learning-content');
  
  db.collection('users').doc(uid).get()
    .then(doc => {
      if (learningLoading) learningLoading.classList.add('hidden');
      if (learningContent) learningContent.classList.remove('hidden');
      
      if (doc.exists && doc.data().skills) {
        const skills = doc.data().skills;
        
        // 円形プログレスを更新
        updateCircularProgress('overall-progress', calculateOverallProgress(skills));
        
        // スキル進捗を更新
        updateSkillProgress('kuzushiji', skills.kuzushiji);
        updateSkillProgress('hentaigana', skills.hentaigana);
        updateSkillProgress('komonjo', skills.komonjo);
      }
    })
    .catch(error => {
      console.error('学習状況の読み込みに失敗しました:', error);
      if (learningLoading) learningLoading.classList.add('hidden');
    });
  
  // 今日のチャレンジをロード
  loadDailyChallenge();
}

// 総合進捗を計算
function calculateOverallProgress(skills) {
  const total = skills.kuzushiji.progress + skills.hentaigana.progress + skills.komonjo.progress;
  return Math.round(total / 3);
}

// 円形プログレスを更新
function updateCircularProgress(id, percentage) {
  const element = document.getElementById(id);
  if (!element) return;
  
  element.style.background = `conic-gradient(var(--primary) ${percentage}%, var(--bg-tertiary) 0%)`;
  element.querySelector('.progress-value').textContent = percentage + '%';
}

// スキル進捗を更新
function updateSkillProgress(skillName, skill) {
  const progressElement = document.getElementById(`${skillName}-progress`);
  const levelElement = document.getElementById(`${skillName}-level`);
  
  if (progressElement) {
    progressElement.style.width = skill.progress + '%';
  }
  
  if (levelElement) {
    levelElement.textContent = 'レベル ' + skill.level;
  }
}

// 今日のチャレンジをロード
function loadDailyChallenge() {
  const challengeTitle = document.getElementById('challenge-title');
  const challengeDescription = document.getElementById('challenge-description');
  
  // チャレンジはサーバーから取得することもできますが、
  // ここでは簡単のためにローカルで生成
  const challenges = [
    { title: '崩し字クイズ', description: '10問の崩し字問題に挑戦しましょう' },
    { title: '変体仮名マスター', description: '変体仮名の読み方を覚えよう' },
    { title: '文書解読', description: '江戸時代の古文書を解読しよう' }
  ];
  
  const todayIndex = new Date().getDate() % challenges.length;
  const todayChallenge = challenges[todayIndex];
  
  if (challengeTitle) challengeTitle.textContent = todayChallenge.title;
  if (challengeDescription) challengeDescription.textContent = todayChallenge.description;
}

// コミュニティデータをロード
function loadCommunityData() {
  const communityLoading = document.getElementById('community-loading');
  const communityContent = document.getElementById('community-content');
  const communityFeed = document.getElementById('community-feed');
  
  // コミュニティ統計をロード
  db.collection('stats').doc('community').get()
    .then(doc => {
      if (communityLoading) communityLoading.classList.add('hidden');
      if (communityContent) communityContent.classList.remove('hidden');
      
      if (doc.exists) {
        const stats = doc.data();
        
        document.getElementById('community-members').textContent = stats.members || 0;
        document.getElementById('community-projects').textContent = stats.projects || 0;
        document.getElementById('community-documents').textContent = stats.documents || 0;
      }
    })
    .catch(error => {
      console.error('コミュニティ統計の読み込みに失敗しました:', error);
      if (communityLoading) communityLoading.classList.add('hidden');
    });
  
  // 共有プロジェクトをロード
  db.collection('shared_projects')
    .orderBy('createdAt', 'desc')
    .limit(6)
    .get()
    .then(snapshot => {
      if (communityFeed) {
        communityFeed.innerHTML = '';
        
        snapshot.forEach(doc => {
          const project = doc.data();
          const projectItem = createCommunityProjectElement(project, doc.id);
          communityFeed.appendChild(projectItem);
        });
      }
    })
    .catch(error => {
      console.error('共有プロジェクトの読み込みに失敗しました:', error);
    });
}

// コミュニティプロジェクト要素を作成
function createCommunityProjectElement(project, id) {
  const item = document.createElement('div');
  item.className = 'community-project';
  
  let thumbnail = `<i class="fas fa-file-alt"></i>`;
  if (project.thumbnailURL) {
    thumbnail = `<img src="${project.thumbnailURL}" alt="${project.title}" loading="lazy">`;
  }
  
  item.innerHTML = `
    <a href="project.html?id=${id}" class="project-preview">
      ${thumbnail}
    </a>
    <div class="project-info">
      <div class="project-title">${project.title}</div>
      <div class="project-author">
        <i class="fas fa-user"></i> ${project.authorName}
      </div>
    </div>
  `;
  
  return item;
}
// ドキュメント読み込み完了時の処理
document.addEventListener('DOMContentLoaded', function() {
  // アクティビティチャートを初期化
  initActivityChart();
});

// アクティビティチャート
function initActivityChart() {
  const chartCanvas = document.getElementById('activity-chart');
  if (!chartCanvas) return;
  
  const chartLoading = document.getElementById('chart-loading');
  const chartNoData = document.getElementById('chart-no-data');
  
  // デフォルトは週間表示
  loadChartData('week');
  
  // 期間切り替えボタンのイベントリスナー
  const periodButtons = document.querySelectorAll('.chart-period button');
  periodButtons.forEach(button => {
    button.addEventListener('click', () => {
      // アクティブ状態を更新
      periodButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      // 選択された期間のデータを読み込む
      const period = button.getAttribute('data-period');
      loadChartData(period);
    });
  });
  
  // チャートデータを読み込む
  function loadChartData(period) {
    if (chartLoading) chartLoading.classList.remove('hidden');
    if (chartNoData) chartNoData.classList.add('hidden');
    
    // 現在のユーザーを取得
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // データの期間を設定
    let startDate, endDate;
    const now = new Date();
    
    switch (period) {
      case 'week':
        startDate = new Date(now);
        startDate.setDate(now.getDate() - 7);
        endDate = now;
        break;
      case 'month':
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - 1);
        endDate = now;
        break;
      case 'year':
        startDate = new Date(now);
        startDate.setFullYear(now.getFullYear() - 1);
        endDate = now;
        break;
    }
    
    // Firestoreからデータを取得
    db.collection('users').doc(user.uid).collection('activity_logs')
      .where('timestamp', '>=', startDate)
      .where('timestamp', '<=', endDate)
      .orderBy('timestamp', 'asc')
      .get()
      .then(snapshot => {
        if (chartLoading) chartLoading.classList.add('hidden');
        
        if (snapshot.empty) {
          if (chartNoData) chartNoData.classList.remove('hidden');
          return;
        }
        
        // 期間ごとのデータ整形
        const chartData = processChartData(snapshot.docs, period);
        
        // チャートを描画
        drawActivityChart(chartData, period);
      })
      .catch(error => {
        console.error('チャートデータの読み込みに失敗しました:', error);
        if (chartLoading) chartLoading.classList.add('hidden');
        if (chartNoData) chartNoData.classList.remove('hidden');
      });
  }
  
  // データを整形する
  function processChartData(docs, period) {
    const data = {};
    const labels = [];
    const activityMinutes = [];
    
    // 期間ごとのグループ化とラベル生成
    switch (period) {
      case 'week':
        // 過去7日間のデータ
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const label = weekdays[date.getDay()] + '曜日';
          labels.push(label);
          data[date.toDateString()] = 0;
        }
        
        // データをグループ化
        docs.forEach(doc => {
          const timestamp = doc.data().timestamp.toDate();
          const dateString = timestamp.toDateString();
          if (data[dateString] !== undefined) {
            data[dateString] += doc.data().minutes || 0;
          }
        });
        
        // 結果の配列を作成
        Object.values(data).forEach(minutes => {
          activityMinutes.push(minutes);
        });
        break;
        
      case 'month':
        // 過去30日間のデータ（週単位でグループ化）
        for (let i = 0; i < 4; i++) {
          const endDay = new Date();
          endDay.setDate(endDay.getDate() - (i * 7));
          const startDay = new Date(endDay);
          startDay.setDate(startDay.getDate() - 6);
          
          const startMonth = startDay.getMonth() + 1;
          const endMonth = endDay.getMonth() + 1;
          const label = `${startMonth}/${startDay.getDate()}-${endMonth}/${endDay.getDate()}`;
          labels.unshift(label);
          
          const weekKey = `week-${i}`;
          data[weekKey] = 0;
        }
        
        // データをグループ化
        docs.forEach(doc => {
          const timestamp = doc.data().timestamp.toDate();
          const now = new Date();
          const dayDiff = Math.floor((now - timestamp) / (1000 * 60 * 60 * 24));
          const weekIndex = Math.floor(dayDiff / 7);
          
          if (weekIndex >= 0 && weekIndex < 4) {
            const weekKey = `week-${weekIndex}`;
            data[weekKey] += doc.data().minutes || 0;
          }
        });
        
        // 結果の配列を作成
        for (let i = 0; i < 4; i++) {
          activityMinutes.push(data[`week-${i}`]);
        }
        break;
        
      case 'year':
        // 過去12ヶ月のデータ
        const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        for (let i = 11; i >= 0; i--) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
          const label = months[date.getMonth()];
          labels.push(label);
          data[monthKey] = 0;
        }
        
        // データをグループ化
        docs.forEach(doc => {
          const timestamp = doc.data().timestamp.toDate();
          const monthKey = `${timestamp.getFullYear()}-${timestamp.getMonth()}`;
          if (data[monthKey] !== undefined) {
            data[monthKey] += doc.data().minutes || 0;
          }
        });
        
        // 結果の配列を作成
        const sortedKeys = Object.keys(data).sort();
        sortedKeys.forEach(key => {
          activityMinutes.push(data[key]);
        });
        break;
    }
    
    return {
      labels: labels,
      activityMinutes: activityMinutes
    };
  }
  
  // チャートを描画する
  function drawActivityChart(data, period) {
    // 既存のチャートを破棄
    if (window.activityChart) {
      window.activityChart.destroy();
    }
    
    // チャートのコンテキスト
    const ctx = chartCanvas.getContext('2d');
    
    // チャートの色を取得
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
    const primaryLight = getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim();
    
    // Y軸のラベル
    let yAxisLabel = '';
    switch (period) {
      case 'week':
        yAxisLabel = '分 / 日';
        break;
      case 'month':
        yAxisLabel = '分 / 週';
        break;
      case 'year':
        yAxisLabel = '分 / 月';
        break;
    }
    
    // チャートを作成
    window.activityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [{
          label: '活動時間',
          data: data.activityMinutes,
          backgroundColor: primaryLight,
          borderColor: primaryColor,
          borderWidth: 1,
          borderRadius: 4,
          hoverBackgroundColor: primaryColor
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const minutes = context.raw;
                if (minutes >= 60) {
                  const hours = Math.floor(minutes / 60);
                  const remainingMinutes = minutes % 60;
                  return `${hours}時間${remainingMinutes}分`;
                } else {
                  return `${minutes}分`;
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: yAxisLabel
            },
            ticks: {
              callback: function(value) {
                if (value >= 60) {
                  const hours = Math.floor(value / 60);
                  return `${hours}h`;
                }
                return `${value}m`;
              }
            }
          }
        }
      }
    });
  }
}
    </script>
</body>
</html>