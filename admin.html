<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>管理者パネル | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root {
            --primary: #4338ca;
            --primary-hover: #3730a3;
            --primary-light: #e0e7ff;
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --info: #3b82f6;
            --info-hover: #2563eb;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --bg-color: var(--gray-50);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --radius-sm: 0.125rem;
            --radius: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #2d2a63;
            --bg-color: #0f172a;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #1f2937;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }
        
        a {
            color: var(--primary);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        .card {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        [data-theme="dark"] .card {
            background-color: #1e293b;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        [data-theme="dark"] .tabs {
            background-color: #1e293b;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            grid-gap: 20px;
            margin-bottom: 20px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            align-items: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        [data-theme="dark"] .stat-card {
            background-color: #1e293b;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .stat-icon.primary {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .stat-icon.info {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }
        
        .stat-icon.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .stat-icon.warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            font-weight: 500;
            color: var(--text-muted);
            background-color: var(--gray-50);
        }
        
        [data-theme="dark"] th {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        tbody tr:hover {
            background-color: var(--gray-50);
        }
        
        [data-theme="dark"] tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            margin-right: 10px;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-inactive {
            background-color: var(--gray-100);
            color: var(--gray-600);
        }
        
        .badge-suspended {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-banned {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-info {
            background-color: var(--info);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .badge-secondary {
            background-color: var(--gray-500);
            color: white;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-hover);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background-color: var(--success-hover);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background-color: var(--warning-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--secondary-hover);
        }
        
        .btn i {
            margin-right: 6px;
        }
        
        .action-btns {
            display: flex;
            gap: 5px;
        }
        
        .theme-toggle {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius);
        }
        
        .theme-toggle:hover {
            background-color: var(--gray-100);
        }
        
        [data-theme="dark"] .theme-toggle:hover {
            background-color: #2d3748;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        [data-theme="dark"] .loading {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-muted {
            color: var(--text-muted);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }
        
        .page-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-item:hover:not(.disabled) {
            background-color: var(--gray-100);
        }
        
        .page-item.active {
            background-color: var(--primary);
            color: white;
        }
        
        .page-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        select.form-control {
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .form-check input[type="checkbox"],
        .form-check input[type="radio"] {
            margin-right: 8px;
        }
        
        .progress {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-end {
            justify-content: flex-end;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mr-2 {
            margin-right: 0.5rem;
        }
        
        .ml-2 {
            margin-left: 0.5rem;
        }
        
        .w-full {
            width: 100%;
        }
        
        
        
        .h-full {
            height: 100%;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-6 {
            padding: 1.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        .overflow-hidden {
            overflow: hidden;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s;
            overflow: hidden;
        }
        
        [data-theme="dark"] .modal-content {
            background-color: #1e293b;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--danger);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
        }
        
        .alert-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
            display: flex;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            color: var(--success);
        }
        
        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            color: var(--danger);
        }
        
        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            color: var(--warning);
        }
        
        .alert-info {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--info);
            color: var(--info);
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }
        
        .toast {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 12px 16px;
            min-width: 250px;
            max-width: 350px;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        [data-theme="dark"] .toast {
            background-color: #1e293b;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-error .toast-icon {
            color: var(--danger);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        
        .toast-info .toast-icon {
            color: var(--info);
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            padding: 2px;
            margin-left: 8px;
            transition: color 0.3s;
        }
        
        .toast-close:hover {
            color: var(--danger);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 8px 16px;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <img src="https://placehold.co/40x40/4338ca/white?text=KR" alt="KatsujiRingX Logo">
            KatsujiRingX 管理パネル
        </div>
        <div class="flex gap-4 items-center">
            <div id="user-display" class="flex items-center">
                <div class="user-avatar mr-2" id="header-user-avatar">
                    <span id="header-user-initial">A</span>
                </div>
                <span id="header-user-name">管理者</span>
            </div>
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <button id="logout-btn" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </button>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="dashboard">
            <i class="fas fa-tachometer-alt"></i> ダッシュボード
        </div>
        <div class="tab" data-tab="users">
            <i class="fas fa-users"></i> ユーザー管理
        </div>
        <div class="tab" data-tab="announcements">
            <i class="fas fa-bullhorn"></i> お知らせ管理
        </div>
        <div class="tab" data-tab="analytics">
            <i class="fas fa-chart-line"></i> データ分析
        </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
        <h2>ダッシュボード</h2>
        
        <div class="grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="total-users">
                        <div class="loading"></div>
                    </div>
                    <div class="stat-label">総ユーザー数</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="active-users">
                        <div class="loading"></div>
                    </div>
                    <div class="stat-label">アクティブユーザー</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="total-documents">
                        <div class="loading"></div>
                    </div>
                    <div class="stat-label">総資料数</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="total-posts">
                        <div class="loading"></div>
                    </div>
                    <div class="stat-label">コミュニティ投稿数</div>
                </div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card mb-6">
                <div class="flex justify-between mb-4">
                    <h3>最近の登録ユーザー</h3>
                    <button id="refresh-users" class="btn btn-sm btn-outline">
                        <i class="fas fa-sync-alt"></i> 更新
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ユーザー</th>
                                <th>登録日</th>
                                <th>状態</th>
                            </tr>
                        </thead>
                        <tbody id="recent-users-table">
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="loading"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card mb-6">
                <div class="flex justify-between mb-4">
                    <h3>システム状況</h3>
                    <span class="badge badge-active" id="system-status">正常稼働中</span>
                </div>
                
                <div class="mb-4">
                    <h4 class="mb-2">ストレージ使用量</h4>
                    <div class="progress mb-1">
                        <div class="progress-bar" id="storage-bar" style="width: 45%;"></div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span id="storage-used">4.5 GB</span>
                        <span id="storage-total">10 GB</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="mb-2">データベース使用量</h4>
                    <div class="progress mb-1">
                        <div class="progress-bar" id="database-bar" style="width: 32%;"></div>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span id="database-used">320 MB</span>
                        <span id="database-total">1000 MB</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="mb-2">システム情報</h4>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">Firebase バージョン</span>
                        <span>9.22.1</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">最終データバックアップ</span>
                        <span id="last-backup">2023/12/15 03:00</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-muted">サーバー稼働時間</span>
                        <span>99.8%</span>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="backup-now" class="btn btn-outline mr-2">
                        <i class="fas fa-download"></i> 今すぐバックアップ
                    </button>
                    <button id="system-check" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> システム診断
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="flex justify-between mb-4">
                <h3>システムアクティビティ</h3>
                <button id="clear-logs" class="btn btn-sm btn-outline">
                    <i class="fas fa-trash-alt"></i> ログをクリア
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>タイプ</th>
                            <th>説明</th>
                            <th>ユーザー</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log">
                        <tr>
                            <td colspan="4" class="text-center">
                                <div class="loading"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <h2>ユーザー管理</h2>
        
        <div class="card mb-6">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div style="flex: 1;">
                    <input type="text" id="user-search" class="form-control" placeholder="ユーザー名、メール、IDで検索...">
                </div>
                <div>
                    <select id="user-status-filter" class="form-control">
                        <option value="">すべての状態</option>
                        <option value="active">アクティブ</option>
                        <option value="inactive">非アクティブ</option>
                        <option value="suspended">一時停止</option>
                        <option value="banned">禁止</option>
                    </select>
                </div>
                <div>
                    <select id="user-role-filter" class="form-control">
                        <option value="">すべての役割</option>
                        <option value="admin">管理者</option>
                        <option value="moderator">モデレーター</option>
                        <option value="user">一般ユーザー</option>
                        <option value="student">学生</option>
                        <option value="teacher">教師</option>
                        <option value="researcher">研究者</option>
                    </select>
                </div>
                <div>
                    <button id="apply-filter" class="btn btn-primary">
                        <i class="fas fa-filter"></i> 適用
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between mb-4">
                <div>
                    <span class="text-muted" id="users-count">0 ユーザーが見つかりました</span>
                </div>
                <div class="flex gap-2">
                    <button id="export-csv" class="btn btn-outline">
                        <i class="fas fa-download"></i> CSVエクスポート
                    </button>
                    <button id="bulk-email" class="btn btn-primary">
                        <i class="fas fa-envelope"></i> 一括メール送信
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="select-all-users">
                            </th>
                            <th>ユーザー</th>
                            <th>メールアドレス</th>
                            <th>登録日</th>
                            <th>最終ログイン</th>
                            <th>状態</th>
                            <th>役割</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="loading"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="users-pagination"></div>
        </div>
    </div>
    
    <!-- Announcements Tab -->
    <div id="announcements-tab" class="tab-content">
        <h2>お知らせ管理</h2>
        
        <div class="flex justify-between mb-4">
            <div>
                <select id="announcement-filter" class="form-control">
                    <option value="all">すべて</option>
                    <option value="active" selected>有効</option>
                    <option value="scheduled">予約済み</option>
                    <option value="expired">期限切れ</option>
                    <option value="draft">下書き</option>
                </select>
            </div>
            <div>
                <button id="create-announcement" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 新規お知らせ
                </button>
            </div>
        </div>
        
        <div class="card mb-6">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>タイトル</th>
                            <th>優先度</th>
                            <th>対象者</th>
                            <th>公開期間</th>
                            <th>状態</th>
                            <th>作成者</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody id="announcements-table">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <h3>最新のお知らせ</h3>
        <div class="grid" id="announcement-previews">
            <div class="card text-center">
                <div class="loading"></div>
                <p class="text-muted">読み込み中...</p>
            </div>
        </div>
    </div>
    
    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
        <h2>データ分析</h2>
        
        <div class="card mb-6">
            <h3>期間を選択</h3>
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div style="flex: 1;">
                    <label for="start-date">開始日</label>
                    <input type="date" id="start-date" class="form-control">
                </div>
                <div style="flex: 1;">
                    <label for="end-date">終了日</label>
                    <input type="date" id="end-date" class="form-control">
                </div>
                <div style="align-self: flex-end;">
                    <button id="apply-date" class="btn btn-primary">
                        <i class="fas fa-check"></i> 適用
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button class="btn btn-outline" data-range="7">直近7日</button>
                <button class="btn btn-outline" data-range="30">直近30日</button>
                <button class="btn btn-outline" data-range="90">直近90日</button>
            </div>
        </div>
        
        <div class="card mb-6">
            <h3>ユーザー統計</h3>
            <div class="flex justify-between mb-4">
                <select id="user-graph-interval" class="form-control" style="width: auto;">
                    <option value="daily">日ごと</option>
                    <option value="weekly">週ごと</option>
                    <option value="monthly" selected>月ごと</option>
                </select>
                <div class="flex gap-2">
                    <span class="badge badge-active">DAU: <span id="dau-count">0</span></span>
                    <span class="badge badge-info">MAU: <span id="mau-count">0</span></span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="user-growth-chart"></canvas>
            </div>
        </div>
        
        <div class="card mb-6">
            <h3>コンテンツ統計</h3>
            <div class="grid-2">
                <div class="chart-container">
                    <canvas id="document-upload-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ユーザーセグメント分析</h3>
            <div class="grid-2">
                <div class="chart-container">
                    <canvas id="user-roles-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="user-status-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- User Detail Modal -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="user-modal-title">ユーザー詳細</h3>
                <button class="modal-close" data-close="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user-id">
                
                <div class="flex items-start gap-4 mb-4">
                    <div class="user-avatar" style="width: 64px; height: 64px; font-size: 1.5rem;" id="detail-user-avatar">
                        <span id="detail-user-initial">U</span>
                    </div>
                    <div class="flex-1">
                        <h2 class="mb-1" id="detail-user-name">ユーザー名</h2>
                        <p class="text-muted mb-2" id="detail-user-email">user@example.com</p>
                        <div class="flex gap-2 mb-2">
                            <span class="badge badge-active" id="detail-user-status">アクティブ</span>
                            <span class="badge badge-primary" id="detail-user-role">一般ユーザー</span>
                        </div>
                        <p class="text-sm text-muted">
                            ユーザーID: <span id="detail-user-uid">UID12345</span>
                        </p>
                    </div>
                </div>
                
                <div class="grid-2 mb-4">
                    <div>
                        <h4 class="mb-2">アカウント情報</h4>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">登録日</span>
                            <span id="detail-user-created">2023/10/15</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">最終ログイン</span>
                            <span id="detail-user-last-login">2023/12/14</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">プロフィール完成度</span>
                            <span id="detail-profile-completion">85%</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">メール確認</span>
                            <span id="detail-email-verified">確認済み</span>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="mb-2">アクティビティ統計</h4>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">資料数</span>
                            <span id="detail-document-count">12</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">投稿数</span>
                            <span id="detail-post-count">5</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">コメント数</span>
                            <span id="detail-comment-count">28</span>
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="text-muted">経験値</span>
                            <span id="detail-points">850</span>
                        </div>
                    </div>
                </div>
                
                <div id="user-edit-section">
                    <h4 class="mb-2">ユーザー設定</h4>
                    <div class="form-group">
                        <label for="detail-user-role-select">役割</label>
                        <select id="detail-user-role-select" class="form-control">
                            <option value="user">一般ユーザー</option>
                            <option value="moderator">モデレーター</option>
                            <option value="admin">管理者</option>
                            <option value="student">学生</option>
                            <option value="teacher">教師</option>
                            <option value="researcher">研究者</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="detail-user-status-select">アカウント状態</label>
                        <select id="detail-user-status-select" class="form-control">
                            <option value="active">アクティブ</option>
                            <option value="inactive">非アクティブ</option>
                            <option value="suspended">一時停止</option>
                            <option value="banned">禁止</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="suspension-reason-group" style="display: none;">
                        <label for="suspension-reason">停止/禁止の理由</label>
                        <textarea id="suspension-reason" class="form-control" placeholder="ユーザーに通知される理由を入力してください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="detail-user-notes">管理者メモ</label>
                        <textarea id="detail-user-notes" class="form-control" placeholder="ユーザーに関する内部メモ"></textarea>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h4 class="mb-2">最近のアクティビティログ</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>日時</th>
                                    <th>アクション</th>
                                    <th>詳細</th>
                                </tr>
                            </thead>
                            <tbody id="user-activity-table">
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="loading"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close="modal">閉じる</button>
                <button class="btn btn-danger" id="reset-password-btn">
                    <i class="fas fa-key"></i> パスワードリセット
                </button>
                <button class="btn btn-primary" id="save-user-btn">
                    <i class="fas fa-save"></i> 変更を保存
                </button>
            </div>
        </div>
    </div>
    
    <!-- Announcement Modal -->
    <div class="modal" id="announcement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="announcement-modal-title">新規お知らせ</h3>
                <button class="modal-close" data-close="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="announcement-id">
                
                <div class="form-group">
                    <label for="announcement-title">タイトル</label>
                    <input type="text" id="announcement-title" class="form-control" placeholder="お知らせのタイトル">
                </div>
                
                <div class="form-group">
                    <label for="announcement-content">内容</label>
                    <textarea id="announcement-content" class="form-control" placeholder="お知らせの本文"></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="announcement-priority">優先度</label>
                        <select id="announcement-priority" class="form-control">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                            <option value="urgent">緊急</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="announcement-type">表示タイプ</label>
                        <select id="announcement-type" class="form-control">
                            <option value="normal" selected>通常</option>
                            <option value="banner">バナー</option>
                            <option value="popup">ポップアップ</option>
                            <option value="toast">トースト</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>対象ユーザー</label>
                    <div class="form-check">
                        <input type="radio" id="target-all" name="target-users" value="all" checked>
                        <label for="target-all">すべてのユーザー</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="target-specific" name="target-users" value="specific">
                        <label for="target-specific">特定のユーザー</label>
                    </div>
                    
                    <div id="specific-targets" style="display: none; margin-top: 1rem; padding-left: 1.5rem;">
                        <div class="form-check">
                            <input type="checkbox" id="target-students" value="students">
                            <label for="target-students">学生</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="target-teachers" value="teachers">
                            <label for="target-teachers">教師</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="target-researchers" value="researchers">
                            <label for="target-researchers">研究者</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" id="target-new-users" value="new-users">
                            <label for="target-new-users">新規ユーザー（過去30日以内）</label>
                        </div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="announcement-start-date">公開開始日時</label>
                        <input type="datetime-local" id="announcement-start-date" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="announcement-end-date">公開終了日時</label>
                        <input type="datetime-local" id="announcement-end-date" class="form-control">
                        <small class="text-muted">空欄の場合、終了日時はありません</small>
                    </div>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" id="announcement-active" checked>
                    <label for="announcement-active">有効にする</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close="modal">キャンセル</button>
                <button class="btn btn-secondary" id="save-draft-btn">
                    <i class="fas fa-save"></i> 下書き保存
                </button>
                <button class="btn btn-primary" id="publish-announcement-btn">
                    <i class="fas fa-paper-plane"></i> 公開
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Email Modal -->
    <div class="modal" id="email-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">一括メール送信</h3>
                <button class="modal-close" data-close="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <div class="alert-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">メール送信について</div>
                        <p>選択したユーザーグループに一括でメールを送信します。テンプレートタグを使用して、各ユーザーに個別化したメールを送信できます。</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email-recipients">送信先</label>
                    <select id="email-recipients" class="form-control">
                        <option value="selected">選択したユーザー（0人）</option>
                        <option value="all">すべてのユーザー</option>
                        <option value="active">アクティブユーザー</option>
                        <option value="inactive">非アクティブユーザー</option>
                        <option value="students">学生ユーザー</option>
                        <option value="teachers">教師ユーザー</option>
                        <option value="researchers">研究者ユーザー</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="email-subject">件名</label>
                    <input type="text" id="email-subject" class="form-control" placeholder="メールの件名">
                </div>
                
                <div class="form-group">
                    <label for="email-content">本文</label>
                    <textarea id="email-content" class="form-control" rows="10" placeholder="メールの本文"></textarea>
                    <small class="text-muted">
                        使用可能なテンプレートタグ: {{ユーザー名}}、{{メールアドレス}}、{{登録日}}
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="email-template">テンプレート</label>
                    <select id="email-template" class="form-control">
                        <option value="">テンプレートを選択...</option>
                        <option value="welcome">ウェルカムメール</option>
                        <option value="newsletter">ニュースレター</option>
                        <option value="update">アップデート通知</option>
                        <option value="event">イベント通知</option>
                    </select>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" id="send-test-email">
                    <label for="send-test-email">送信前にテストメールを送信する</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" data-close="modal">キャンセル</button>
                <button class="btn btn-secondary" id="preview-email-btn">
                    <i class="fas fa-eye"></i> プレビュー
                </button>
                <button class="btn btn-primary" id="send-email-btn">
                    <i class="fas fa-paper-plane"></i> 送信
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
            authDomain: "katsujiringx.firebaseapp.com",
            projectId: "katsujiringx",
            storageBucket: "katsujiringx.appspot.com", 
            messagingSenderId: "831784731743",
            appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
            measurementId: "G-LPCRE3WYZR"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);

        // Firebaseサービスへの参照
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // DOM要素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const themeToggle = document.getElementById('theme-toggle');
        const logoutBtn = document.getElementById('logout-btn');
        
        // モーダル管理
        const modals = document.querySelectorAll('.modal');
        const modalCloseButtons = document.querySelectorAll('[data-close="modal"]');
        
        // グローバル変数
        let currentUser = null;
        let charts = {};
        let selectedUsers = new Set();
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            // テーマ設定を適用
            applyTheme();
            
            // タブ切り替え設定
            initTabs();
            
            // モーダル設定
            initModals();
            
            // テーマ切り替えボタン設定
            themeToggle.addEventListener('click', toggleTheme);
            
            // ログアウトボタン設定
            logoutBtn.addEventListener('click', logout);
            
            // 認証状態を監視
            auth.onAuthStateChanged(handleAuthStateChanged);
        });
        
        // 認証状態変更ハンドラー
        async function handleAuthStateChanged(user) {
            if (user) {
                try {
                    // ユーザーデータを取得
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data() || {};
                    
                    // 管理者権限チェック
                    if (!userData.roles || !userData.roles.includes('admin')) {
                        showToast('エラー', '管理者権限がありません。リダイレクトします。', 'error');
                        setTimeout(() => {
                            auth.signOut();
                        }, 2000);
                        return;
                    }
                    
                    // 現在のユーザーを設定
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: userData.displayName || user.email.split('@')[0],
                        ...userData
                    };
                    
                    // ヘッダーのユーザー情報を更新
                    updateHeaderUser();
                    
                    // 各タブのデータ読み込み
                    initDashboard();
                    
                    // システムログを記録
                    logSystemActivity('login', '管理者ログイン');
                    
                } catch (error) {
                    console.error('ユーザーデータ取得エラー:', error);
                    showToast('エラー', 'ユーザーデータの取得中にエラーが発生しました。', 'error');
                }
            } else {
                // 未ログインの場合はログインページへリダイレクト
                window.location.href = 'login.html';
            }
        }
        
        // ヘッダーのユーザー情報を更新
        function updateHeaderUser() {
            if (!currentUser) return;
            
            const headerUserName = document.getElementById('header-user-name');
            const headerUserInitial = document.getElementById('header-user-initial');
            const headerUserAvatar = document.getElementById('header-user-avatar');
            
            headerUserName.textContent = currentUser.displayName;
            
            if (currentUser.profileImageUrl) {
                headerUserAvatar.innerHTML = `<img src="${currentUser.profileImageUrl}" alt="${currentUser.displayName}">`;
            } else {
                const initial = (currentUser.displayName || currentUser.email || 'A')[0].toUpperCase();
                headerUserInitial.textContent = initial;
            }
        }
        
        // ログアウト処理
        function logout() {
            if (confirm('ログアウトしますか？')) {
                // ログアウト前にシステムログを記録
                logSystemActivity('logout', '管理者ログアウト')
                    .then(() => {
                        auth.signOut().then(() => {
                            window.location.href = 'login.html';
                        }).catch(error => {
                            console.error('ログアウトエラー:', error);
                            showToast('エラー', 'ログアウト中にエラーが発生しました。', 'error');
                        });
                    })
                    .catch(error => {
                        console.error('ログ記録エラー:', error);
                        auth.signOut().then(() => {
                            window.location.href = 'login.html';
                        });
                    });
            }
        }
        
        // システムログを記録
        async function logSystemActivity(type, description, targetUser = null) {
            if (!currentUser) return;
            
            try {
                const logData = {
                    type,
                    description,
                    user: currentUser.uid,
                    userName: currentUser.displayName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (targetUser) {
                    logData.targetUser = targetUser;
                }
                
                await db.collection('systemLogs').add(logData);
                return true;
            } catch (error) {
                console.error('システムログ記録エラー:', error);
                return false;
            }
        }
        
        // テーマ切り替え
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // テーマボタンのアイコン更新
            themeToggle.innerHTML = newTheme === 'dark' 
                ? '<i class="fas fa-sun"></i>' 
                : '<i class="fas fa-moon"></i>';
            
            // チャートの色を更新
            updateChartsTheme();
        }
        
        // 保存されたテーマを適用
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // テーマボタンのアイコン更新
            themeToggle.innerHTML = savedTheme === 'dark' 
                ? '<i class="fas fa-sun"></i>' 
                : '<i class="fas fa-moon"></i>';
        }
        
        // タブ切り替え初期化
        function initTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // アクティブなタブを変更
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // タブコンテンツを切り替え
                    const tabId = tab.getAttribute('data-tab') + '-tab';
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // タブに応じたデータを読み込み
                    switch(tab.getAttribute('data-tab')) {
                        case 'dashboard':
                            initDashboard();
                            break;
                        case 'users':
                            initUsers();
                            break;
                        case 'announcements':
                            initAnnouncements();
                            break;
                        case 'analytics':
                            initAnalytics();
                            break;
                    }
                });
            });
        }
        
        // モーダル初期化
        function initModals() {
            // モーダルを開く関数をグローバルに定義
            window.openModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            };
            
            // モーダルを閉じる関数をグローバルに定義
            window.closeModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            };
            
            // モーダル閉じるボタンの設定
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal');
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                });
            });
            
            // モーダル外クリックで閉じる
            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // ユーザー詳細モーダルの初期化
            initUserModal();
            
            // お知らせモーダルの初期化
            initAnnouncementModal();
            
            // メール送信モーダルの初期化
            initEmailModal();
        }
        
        // トースト通知を表示
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            
            // トーストのHTMLを作成
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // トーストのアイコンを設定
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'times-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="toast-message">
                    <strong>${title}</strong>
                    <div>${message}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // 閉じるボタンのイベント設定
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });
            
            // トーストコンテナに追加
            toastContainer.appendChild(toast);
            
            // アニメーションのためにdelayを設定
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 自動的に消える設定
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }
        
        // 日付をフォーマット
        function formatDate(date, includeTime = false) {
            if (!date) return '';
            
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            if (date instanceof firebase.firestore.Timestamp) {
                date = date.toDate();
            }
            
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            
            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
            }
            
            return new Intl.DateTimeFormat('ja-JP', options).format(date);
        }
        
        // 数値を3桁区切りでフォーマット
        function formatNumber(num) {
            return num.toLocaleString();
        }
        
        // CSVエクスポート
        function exportToCSV(data, filename) {
            if (!data || !data.length) {
                showToast('エラー', 'データがありません。', 'error');
                return;
            }
            
            // ヘッダーを取得
            const headers = Object.keys(data[0]);
            
            // CSVデータを作成
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header];
                    
                    // 数値以外はダブルクォートで囲む
                    if (typeof value !== 'number') {
                        // 特殊文字をエスケープ
                        if (value === null || value === undefined) {
                            value = '';
                        } else {
                            value = String(value).replace(/"/g, '""');
                        }
                        value = `"${value}"`;
                    }
                    
                    return value;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            // BOMを追加してUTF-8として認識させる
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // ダウンロードリンクを作成
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        /* ダッシュボード関連 */
        // ダッシュボード初期化
        async function initDashboard() {
            try {
                // 統計データを読み込み
                loadDashboardStats();
                
                // 最近の登録ユーザーを読み込み
                loadRecentUsers();
                
                // システムアクティビティを読み込み
                loadSystemActivity();
                
                // 更新ボタンのイベント設定
                document.getElementById('refresh-users').addEventListener('click', loadRecentUsers);
                document.getElementById('clear-logs').addEventListener('click', clearSystemLogs);
                document.getElementById('backup-now').addEventListener('click', backupSystem);
                document.getElementById('system-check').addEventListener('click', checkSystem);
            } catch (error) {
                console.error('ダッシュボード初期化エラー:', error);
                showToast('エラー', 'ダッシュボードの初期化中にエラーが発生しました。', 'error');
            }
        }
        
        // 統計データを読み込み
        async function loadDashboardStats() {
            try {
                // 総ユーザー数
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('total-users').textContent = formatNumber(usersSnapshot.size);
                
                // 一ヶ月前の日付
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                
                // アクティブユーザー数
                const activeUsersSnapshot = await db.collection('users')
                    .where('lastLoginAt', '>=', firebase.firestore.Timestamp.fromDate(oneMonthAgo))
                    .get();
                document.getElementById('active-users').textContent = formatNumber(activeUsersSnapshot.size);
                
                // 総資料数
                const documentsSnapshot = await db.collection('documents').get();
                document.getElementById('total-documents').textContent = formatNumber(documentsSnapshot.size);
                
                // コミュニティ投稿数
                const postsSnapshot = await db.collection('posts').get();
                document.getElementById('total-posts').textContent = formatNumber(postsSnapshot.size);
                
                // ストレージ・データベース使用量の更新（実際はAdmin SDKが必要）
                // ここでは固定値を使用
                updateStorageUsage(4.5, 10);
                updateDatabaseUsage(320, 1000);
                
            } catch (error) {
                console.error('統計データ読み込みエラー:', error);
                showToast('エラー', '統計データの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // ストレージ使用量を更新
        function updateStorageUsage(used, total) {
            const storageBar = document.getElementById('storage-bar');
            const storageUsed = document.getElementById('storage-used');
            const storageTotal = document.getElementById('storage-total');
            
            const percentage = (used / total) * 100;
            
            storageBar.style.width = `${percentage}%`;
            storageUsed.textContent = `${used} GB`;
            storageTotal.textContent = `${total} GB`;
            
            // 使用量が多い場合は色を変更
            if (percentage > 90) {
                storageBar.style.backgroundColor = 'var(--danger)';
            } else if (percentage > 70) {
                storageBar.style.backgroundColor = 'var(--warning)';
            } else {
                storageBar.style.backgroundColor = 'var(--primary)';
            }
        }
        
        // データベース使用量を更新
        function updateDatabaseUsage(used, total) {
            const databaseBar = document.getElementById('database-bar');
            const databaseUsed = document.getElementById('database-used');
            const databaseTotal = document.getElementById('database-total');
            
            const percentage = (used / total) * 100;
            
            databaseBar.style.width = `${percentage}%`;
            databaseUsed.textContent = `${used} MB`;
            databaseTotal.textContent = `${total} MB`;
            
            // 使用量が多い場合は色を変更
            if (percentage > 90) {
                databaseBar.style.backgroundColor = 'var(--danger)';
            } else if (percentage > 70) {
                databaseBar.style.backgroundColor = 'var(--warning)';
            } else {
                databaseBar.style.backgroundColor = 'var(--info)';
            }
        }
        
        // 最近の登録ユーザーを読み込み
        async function loadRecentUsers() {
            const recentUsersTable = document.getElementById('recent-users-table');
            
            try {
                recentUsersTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="loading"></div>
                        </td>
                    </tr>
                `;
                
                // 最近登録した10人のユーザーを取得
                const recentUsersSnapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                if (recentUsersSnapshot.empty) {
                    recentUsersTable.innerHTML = '<tr><td colspan="3" class="text-center">ユーザーデータがありません</td></tr>';
                    return;
                }
                
                let html = '';
                recentUsersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    // 登録日のフォーマット
                    const createdAt = user.createdAt ? user.createdAt.toDate() : new Date();
                    const formattedDate = formatDate(createdAt);
                    
                    // ユーザーステータス
                    let statusClass = 'badge-active';
                    let statusText = 'アクティブ';
                    
                    if (user.status === 'inactive') {
                        statusClass = 'badge-inactive';
                        statusText = '非アクティブ';
                    } else if (user.status === 'suspended') {
                        statusClass = 'badge-suspended';
                        statusText = '一時停止';
                    } else if (user.status === 'banned') {
                        statusClass = 'badge-banned';
                        statusText = '禁止';
                    }
                    
                    // ユーザーの初期アバター
                    const initial = (user.displayName || user.email || 'U')[0].toUpperCase();
                    
                    html += `
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${user.profileImageUrl ? `<img src="${user.profileImageUrl}" alt="${user.displayName || 'ユーザー'}">` : initial}
                                    </div>
                                    <div>
                                        <div class="user-name">${user.displayName || 'ユーザー'}</div>
                                        <div class="user-email">${user.email || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${formattedDate}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                recentUsersTable.innerHTML = html;
                
            } catch (error) {
                console.error('最近のユーザー読み込みエラー:', error);
                recentUsersTable.innerHTML = '<tr><td colspan="3" class="text-center">データの読み込み中にエラーが発生しました</td></tr>';
                showToast('エラー', '最近のユーザーデータの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // システムアクティビティを読み込み
        async function loadSystemActivity() {
            const activityLog = document.getElementById('activity-log');
            
            try {
                activityLog.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">
                            <div class="loading"></div>
                        </td>
                    </tr>
                `;
                
                // システムログを取得
                const logsSnapshot = await db.collection('systemLogs')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                if (logsSnapshot.empty) {
                    activityLog.innerHTML = '<tr><td colspan="4" class="text-center">システムアクティビティログはありません</td></tr>';
                    return;
                }
                
                let html = '';
                logsSnapshot.forEach(doc => {
                    const log = doc.data();
                    
                    // 日時のフォーマット
                    const timestamp = log.timestamp ? log.timestamp.toDate() : new Date();
                    const formattedDate = formatDate(timestamp, true);
                    
                    // アクティビティタイプに応じたクラス
                    let typeClass = '';
                    let typeIcon = '';
                    
                    switch(log.type) {
                        case 'login':
                            typeClass = 'text-info';
                            typeIcon = '<i class="fas fa-sign-in-alt"></i>';
                            break;
                        case 'logout':
                            typeClass = 'text-secondary';
                            typeIcon = '<i class="fas fa-sign-out-alt"></i>';
                            break;
                        case 'user_update':
                            typeClass = 'text-primary';
                            typeIcon = '<i class="fas fa-user-edit"></i>';
                            break;
                        case 'announcement':
                            typeClass = 'text-success';
                            typeIcon = '<i class="fas fa-bullhorn"></i>';
                            break;
                        case 'backup':
                            typeClass = 'text-info';
                            typeIcon = '<i class="fas fa-database"></i>';
                            break;
                        case 'error':
                            typeClass = 'text-danger';
                            typeIcon = '<i class="fas fa-exclamation-triangle"></i>';
                            break;
                        default:
                            typeClass = 'text-muted';
                            typeIcon = '<i class="fas fa-history"></i>';
                    }
                    
                    html += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td class="${typeClass}">${typeIcon} ${log.type || 'アクション'}</td>
                            <td>${log.description || '-'}</td>
                            <td>${log.userName || '管理者'}</td>
                        </tr>
                    `;
                });
                
                activityLog.innerHTML = html;
                
            } catch (error) {
                console.error('システムアクティビティ読み込みエラー:', error);
                activityLog.innerHTML = '<tr><td colspan="4" class="text-center">データの読み込み中にエラーが発生しました</td></tr>';
                showToast('エラー', 'システムアクティビティの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // システムログをクリア
        async function clearSystemLogs() {
            if (!confirm('本当にすべてのシステムログをクリアしますか？この操作は元に戻せません。')) {
                return;
            }
            
            try {
                // 本来はAdmin SDKが必要。ここではログ記録だけ行う
                await logSystemActivity('admin_action', 'システムログをクリア');
                
                showToast('成功', 'システムログがクリアされました。', 'success');
                
                // ログを再読み込み
                loadSystemActivity();
                
            } catch (error) {
                console.error('システムログクリアエラー:', error);
                showToast('エラー', 'システムログのクリア中にエラーが発生しました。', 'error');
            }
        }
        
        // システムバックアップを実行
        async function backupSystem() {
            try {
                showToast('情報', 'バックアッププロセスを開始しました...', 'info');
                
                // バックアッププロセスをシミュレート
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // バックアップ完了時刻を更新
                const now = new Date();
                document.getElementById('last-backup').textContent = formatDate(now, true);
                
                // システムログを記録
                await logSystemActivity('backup', 'システムバックアップ実行');
                
                showToast('成功', 'バックアップが正常に完了しました。', 'success');
                
            } catch (error) {
                console.error('バックアップエラー:', error);
                showToast('エラー', 'バックアップ中にエラーが発生しました。', 'error');
            }
        }
        
        // システム診断を実行
        async function checkSystem() {
            try {
                showToast('情報', 'システム診断を実行中...', 'info');
                
                // 診断プロセスをシミュレート
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // システムログを記録
                await logSystemActivity('admin_action', 'システム診断実行');
                
                showToast('成功', 'システム診断が完了しました。すべてのシステムは正常に動作しています。', 'success');
                
            } catch (error) {
                console.error('システム診断エラー:', error);
                showToast('エラー', 'システム診断中にエラーが発生しました。', 'error');
            }
        }
        
        /* ユーザー管理関連 */
        // ユーザー管理初期化
        async function initUsers() {
            try {
                // ユーザーデータを読み込み
                loadUsers();
                
                // 検索フィルターの設定
                setupUserFilters();
                
                // 一括選択の設定
                setupUserSelection();
                
                // CSVエクスポートとメール送信ボタンの設定
                document.getElementById('export-csv').addEventListener('click', exportUserData);
                document.getElementById('bulk-email').addEventListener('click', () => {
                    updateEmailRecipients();
                    openModal('email-modal');
                });
            } catch (error) {
                console.error('ユーザー管理初期化エラー:', error);
                showToast('エラー', 'ユーザー管理の初期化中にエラーが発生しました。', 'error');
            }
        }
        
        // ユーザーフィルターの設定
        function setupUserFilters() {
            const applyFilterBtn = document.getElementById('apply-filter');
            applyFilterBtn.addEventListener('click', () => {
                loadUsers();
            });
        }
        
        // ユーザー選択の設定
        function setupUserSelection() {
            const selectAllCheckbox = document.getElementById('select-all-users');
            selectAllCheckbox.addEventListener('change', () => {
                const checkboxes = document.querySelectorAll('#users-table input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                    const userId = checkbox.getAttribute('data-user-id');
                    if (selectAllCheckbox.checked) {
                        selectedUsers.add(userId);
                    } else {
                        selectedUsers.delete(userId);
                    }
                });
                
                updateEmailRecipients();
            });
        }
        
        // ユーザーデータを読み込み
        async function loadUsers(page = 1) {
            const usersTable = document.getElementById('users-table');
            const usersCount = document.getElementById('users-count');
            const usersPagination = document.getElementById('users-pagination');
            
            // 検索条件を取得
            const search = document.getElementById('user-search').value.trim().toLowerCase();
            const statusFilter = document.getElementById('user-status-filter').value;
            const roleFilter = document.getElementById('user-role-filter').value;
            
            // 1ページあたりの表示数
            const perPage = 10;
            
            try {
                usersTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="loading"></div>
                        </td>
                    </tr>
                `;
                
                // 基本クエリを作成
                let query = db.collection('users')
                    .orderBy('createdAt', 'desc');
                
                // フィルターを適用
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (roleFilter) {
                    query = query.where('roles', 'array-contains', roleFilter);
                }
                
                // クエリを実行
                const snapshot = await query.get();
                
                // 検索条件で絞り込み（Firestoreの制限によりクライアント側でフィルタリング）
                let filteredData = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    user.id = doc.id;
                    
                    if (search) {
                        const displayName = (user.displayName || '').toLowerCase();
                        const email = (user.email || '').toLowerCase();
                        const uid = user.id.toLowerCase();
                        
                        if (!displayName.includes(search) && !email.includes(search) && !uid.includes(search)) {
                            return;
                        }
                    }
                    
                    filteredData.push(user);
                });
                
                // 検索結果数を表示
                usersCount.textContent = `${filteredData.length} ユーザーが見つかりました`;
                
                // ページネーション情報を計算
                const totalPages = Math.ceil(filteredData.length / perPage);
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const pageData = filteredData.slice(start, end);
                
                if (pageData.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="8" class="text-center">ユーザーが見つかりませんでした</td></tr>';
                    usersPagination.innerHTML = '';
                    return;
                }
                
                // ユーザーテーブルを生成
                let html = '';
                pageData.forEach(user => {
                    // 役割テキスト
                    let roleText = '一般ユーザー';
                    let roleClass = 'badge-secondary';
                    
                    if (user.roles) {
                        if (user.roles.includes('admin')) {
                            roleText = '管理者';
                            roleClass = 'badge-danger';
                        } else if (user.roles.includes('moderator')) {
                            roleText = 'モデレーター';
                            roleClass = 'badge-warning';
                        } else if (user.roles.includes('teacher')) {
                            roleText = '教師';
                            roleClass = 'badge-info';
                        } else if (user.roles.includes('student')) {
                            roleText = '学生';
                            roleClass = 'badge-primary';
                        } else if (user.roles.includes('researcher')) {
                            roleText = '研究者';
                            roleClass = 'badge-success';
                        }
                    }
                    
                    // ステータス
                    let statusClass = 'badge-active';
                    let statusText = 'アクティブ';
                    
                    if (user.status === 'inactive') {
                        statusClass = 'badge-inactive';
                        statusText = '非アクティブ';
                    } else if (user.status === 'suspended') {
                        statusClass = 'badge-suspended';
                        statusText = '一時停止';
                    } else if (user.status === 'banned') {
                        statusClass = 'badge-banned';
                        statusText = '禁止';
                    }
                    
                    // 日付フォーマット
                    const createdAt = user.createdAt ? formatDate(user.createdAt.toDate()) : '-';
                    const lastLoginAt = user.lastLoginAt ? formatDate(user.lastLoginAt.toDate()) : '-';
                    
                    // ユーザーの初期アバター
                    const initial = (user.displayName || user.email || 'U')[0].toUpperCase();
                    
                    html += `
                        <tr>
                            <td>
                                <input type="checkbox" data-user-id="${user.id}" class="user-checkbox">
                            </td>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${user.profileImageUrl ? `<img src="${user.profileImageUrl}" alt="${user.displayName || 'ユーザー'}">` : initial}
                                    </div>
                                    <div>
                                        <div class="user-name">${user.displayName || 'ユーザー'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${user.email || '-'}</td>
                            <td>${createdAt}</td>
                            <td>${lastLoginAt}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td><span class="badge ${roleClass}">${roleText}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn btn-sm btn-outline" onclick="openUserDetail('${user.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="sendEmail('${user.id}')">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                usersTable.innerHTML = html;
                
                // チェックボックスの変更イベントを設定
                document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const userId = checkbox.getAttribute('data-user-id');
                        if (checkbox.checked) {
                            selectedUsers.add(userId);
                        } else {
                            selectedUsers.delete(userId);
                        }
                        
                        updateEmailRecipients();
                    });
                });
                
                // ページネーションを生成
                generatePagination(usersPagination, page, totalPages);
                
            } catch (error) {
                console.error('ユーザーデータ読み込みエラー:', error);
                usersTable.innerHTML = '<tr><td colspan="8" class="text-center">データの読み込み中にエラーが発生しました</td></tr>';
                usersPagination.innerHTML = '';
                showToast('エラー', 'ユーザーデータの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // ページネーションを生成
        function generatePagination(container, currentPage, totalPages) {
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 前へボタン
            html += `
                <div class="page-item ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}">
                    <i class="fas fa-chevron-left"></i>
                </div>
            `;
            
            // ページ番号
            const maxPageItems = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageItems / 2));
            let endPage = Math.min(totalPages, startPage + maxPageItems - 1);
            
            if (endPage - startPage + 1 < maxPageItems) {
                startPage = Math.max(1, endPage - maxPageItems + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <div class="page-item ${i === currentPage ? 'active' : ''}" data-page="${i}">
                        ${i}
                    </div>
                `;
            }
            
            // 次へボタン
            html += `
                <div class="page-item ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}">
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
            
            container.innerHTML = html;
            
            // ページ切り替えイベントを設定
            container.querySelectorAll('.page-item:not(.disabled)').forEach(item => {
                item.addEventListener('click', () => {
                    const page = parseInt(item.getAttribute('data-page'));
                    loadUsers(page);
                });
            });
        }
        
        // ユーザーデータをCSVエクスポート
        async function exportUserData() {
            try {
                showToast('情報', 'ユーザーデータをエクスポート中...', 'info');
                
                // 検索条件を取得
                const search = document.getElementById('user-search').value.trim().toLowerCase();
                const statusFilter = document.getElementById('user-status-filter').value;
                const roleFilter = document.getElementById('user-role-filter').value;
                
                // クエリを作成
                let query = db.collection('users');
                
                // フィルターを適用
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                if (roleFilter) {
                    query = query.where('roles', 'array-contains', roleFilter);
                }
                
                // クエリを実行
                const snapshot = await query.get();
                
                // 検索条件で絞り込み
                let filteredData = [];
                snapshot.forEach(doc => {
                    const user = doc.data();
                    user.id = doc.id;
                    
                    if (search) {
                        const displayName = (user.displayName || '').toLowerCase();
                        const email = (user.email || '').toLowerCase();
                        const uid = user.id.toLowerCase();
                        
                        if (!displayName.includes(search) && !email.includes(search) && !uid.includes(search)) {
                            return;
                        }
                    }
                    
                    // CSV用にデータを整形
                    const csvUser = {
                        ID: user.id,
                        名前: user.displayName || '',
                        メールアドレス: user.email || '',
                        役割: user.roles ? user.roles.join(', ') : '一般ユーザー',
                        状態: user.status || 'active',
                        登録日: user.createdAt ? formatDate(user.createdAt.toDate()) : '',
                        最終ログイン: user.lastLoginAt ? formatDate(user.lastLoginAt.toDate()) : '',
                        プロフィール完成度: user.profileCompletion ? `${user.profileCompletion}%` : '0%'
                    };
                    
                    filteredData.push(csvUser);
                });
                
                if (filteredData.length === 0) {
                    showToast('警告', 'エクスポートするデータがありません。', 'warning');
                    return;
                }
                
                // CSVにエクスポート
                exportToCSV(filteredData, 'user_export_' + new Date().toISOString().slice(0, 10) + '.csv');
                
                // システムログを記録
                await logSystemActivity('admin_action', `ユーザーデータをCSVエクスポート（${filteredData.length}件）`);
                
                showToast('成功', `${filteredData.length}件のユーザーデータをエクスポートしました。`, 'success');
                
            } catch (error) {
                console.error('ユーザーデータエクスポートエラー:', error);
                showToast('エラー', 'ユーザーデータのエクスポート中にエラーが発生しました。', 'error');
            }
        }
        
        // ユーザー詳細モーダルを初期化
        function initUserModal() {
            // ユーザー状態が変更されたときの処理
            const statusSelect = document.getElementById('detail-user-status-select');
            const suspensionGroup = document.getElementById('suspension-reason-group');
            
            statusSelect.addEventListener('change', () => {
                const status = statusSelect.value;
                if (status === 'suspended' || status === 'banned') {
                    suspensionGroup.style.display = 'block';
                } else {
                    suspensionGroup.style.display = 'none';
                }
            });
            
            // ユーザー情報を保存
            const saveUserBtn = document.getElementById('save-user-btn');
            saveUserBtn.addEventListener('click', saveUserDetails);
            
            // パスワードリセット
            const resetPasswordBtn = document.getElementById('reset-password-btn');
            resetPasswordBtn.addEventListener('click', resetUserPassword);
        }
        
        // ユーザー詳細を表示
        window.openUserDetail = async function(userId) {
            try {
                // モーダルを開く
                openModal('user-modal');
                
                // ユーザーIDを設定
                document.getElementById('user-id').value = userId;
                
                // ユーザーデータを取得
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    showToast('エラー', 'ユーザーが見つかりませんでした。', 'error');
                    closeModal('user-modal');
                    return;
                }
                
                const user = userDoc.data();
                
                // モーダルタイトル
                document.getElementById('user-modal-title').textContent = `ユーザー詳細: ${user.displayName || user.email || 'ユーザー'}`;
                
                // ユーザー基本情報
                document.getElementById('detail-user-name').textContent = user.displayName || 'ユーザー';
                document.getElementById('detail-user-email').textContent = user.email || '';
                document.getElementById('detail-user-uid').textContent = userId;
                
                // ユーザーアバター
                const userAvatar = document.getElementById('detail-user-avatar');
                const userInitial = document.getElementById('detail-user-initial');
                
                if (user.profileImageUrl) {
                    userAvatar.innerHTML = `<img src="${user.profileImageUrl}" alt="${user.displayName || 'ユーザー'}">`;
                } else {
                    const initial = (user.displayName || user.email || 'U')[0].toUpperCase();
                    userInitial.textContent = initial;
                }
                
                // ユーザー状態
                const statusBadge = document.getElementById('detail-user-status');
                const statusSelect = document.getElementById('detail-user-status-select');
                
                let statusClass = 'badge-active';
                let statusText = 'アクティブ';
                
                if (user.status === 'inactive') {
                    statusClass = 'badge-inactive';
                    statusText = '非アクティブ';
                } else if (user.status === 'suspended') {
                    statusClass = 'badge-suspended';
                    statusText = '一時停止';
                } else if (user.status === 'banned') {
                    statusClass = 'badge-banned';
                    statusText = '禁止';
                }
                
                statusBadge.className = `badge ${statusClass}`;
                statusBadge.textContent = statusText;
                statusSelect.value = user.status || 'active';
                
                // 停止理由の表示/非表示
                const suspensionGroup = document.getElementById('suspension-reason-group');
                if (user.status === 'suspended' || user.status === 'banned') {
                    suspensionGroup.style.display = 'block';
                    document.getElementById('suspension-reason').value = user.suspensionReason || '';
                } else {
                    suspensionGroup.style.display = 'none';
                }
                
                // ユーザー役割
                const roleBadge = document.getElementById('detail-user-role');
                const roleSelect = document.getElementById('detail-user-role-select');
                
                let roleText = '一般ユーザー';
                let roleClass = 'badge-secondary';
                let roleValue = 'user';
                
                if (user.roles) {
                    if (user.roles.includes('admin')) {
                        roleText = '管理者';
                        roleClass = 'badge-danger';
                        roleValue = 'admin';
                    } else if (user.roles.includes('moderator')) {
                        roleText = 'モデレーター';
                        roleClass = 'badge-warning';
                        roleValue = 'moderator';
                    } else if (user.roles.includes('teacher')) {
                        roleText = '教師';
                        roleClass = 'badge-info';
                        roleValue = 'teacher';
                    } else if (user.roles.includes('student')) {
                        roleText = '学生';
                        roleClass = 'badge-primary';
                        roleValue = 'student';
                    } else if (user.roles.includes('researcher')) {
                        roleText = '研究者';
                        roleClass = 'badge-success';
                        roleValue = 'researcher';
                    }
                }
                
                roleBadge.className = `badge ${roleClass}`;
                roleBadge.textContent = roleText;
                roleSelect.value = roleValue;
                
                // アカウント情報
                document.getElementById('detail-user-created').textContent = user.createdAt ? formatDate(user.createdAt.toDate()) : '-';
                document.getElementById('detail-user-last-login').textContent = user.lastLoginAt ? formatDate(user.lastLoginAt.toDate()) : '-';
                document.getElementById('detail-profile-completion').textContent = `${user.profileCompletion || 0}%`;
                document.getElementById('detail-email-verified').textContent = user.emailVerified ? '確認済み' : '未確認';
                
                // アクティビティ統計
                document.getElementById('detail-document-count').textContent = user.documentCount || 0;
                document.getElementById('detail-post-count').textContent = user.postCount || 0;
                document.getElementById('detail-comment-count').textContent = user.commentCount || 0;
                document.getElementById('detail-points').textContent = user.points || 0;
                
                // 管理者メモ
                document.getElementById('detail-user-notes').value = user.adminNotes || '';
                
                // ユーザーアクティビティログを読み込み
                loadUserActivity(userId);
                
            } catch (error) {
                console.error('ユーザー詳細取得エラー:', error);
                showToast('エラー', 'ユーザー詳細の取得中にエラーが発生しました。', 'error');
            }
        };
        
        // ユーザーアクティビティログを読み込み
        async function loadUserActivity(userId) {
            const activityTable = document.getElementById('user-activity-table');
            
            try {
                activityTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="loading"></div>
                        </td>
                    </tr>
                `;
                
                // ユーザーのアクティビティログを取得
                const logsSnapshot = await db.collection('userLogs')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                if (logsSnapshot.empty) {
                    activityTable.innerHTML = '<tr><td colspan="3" class="text-center">アクティビティログはありません</td></tr>';
                    return;
                }
                
                let html = '';
                logsSnapshot.forEach(doc => {
                    const log = doc.data();
                    
                    // 日時のフォーマット
                    const timestamp = log.timestamp ? log.timestamp.toDate() : new Date();
                    const formattedDate = formatDate(timestamp, true);
                    
                    html += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>${log.action || 'アクション'}</td>
                            <td>${log.details || '-'}</td>
                        </tr>
                    `;
                });
                
                activityTable.innerHTML = html;
                
            } catch (error) {
                console.error('ユーザーアクティビティ読み込みエラー:', error);
                activityTable.innerHTML = '<tr><td colspan="3" class="text-center">データの読み込み中にエラーが発生しました</td></tr>';
            }
        }
        
        // ユーザー情報を保存
        async function saveUserDetails() {
            const userId = document.getElementById('user-id').value;
            
            if (!userId) {
                showToast('エラー', 'ユーザーIDが見つかりません。', 'error');
                return;
            }
            
            try {
                // フォームからデータを取得
                const roleValue = document.getElementById('detail-user-role-select').value;
                const statusValue = document.getElementById('detail-user-status-select').value;
                const suspensionReason = document.getElementById('suspension-reason').value;
                const adminNotes = document.getElementById('detail-user-notes').value;
                
                // 保存するデータを準備
                const updateData = {
                    status: statusValue,
                    adminNotes: adminNotes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 役割の設定
                updateData.roles = ['user'];
                if (roleValue !== 'user') {
                    updateData.roles = [roleValue, 'user'];
                }
                
                // 停止理由の設定
                if (statusValue === 'suspended' || statusValue === 'banned') {
                    updateData.suspensionReason = suspensionReason;
                } else {
                    // 停止解除の場合は理由をクリア
                    updateData.suspensionReason = '';
                }
                
                // ユーザーデータを更新
                await db.collection('users').doc(userId).update(updateData);
                
                // システムログを記録
                await logSystemActivity('user_update', `ユーザー情報を更新: ${userId}`, userId);
                
                showToast('成功', 'ユーザー情報を保存しました。', 'success');
                
                // モーダルを閉じて一覧を更新
                closeModal('user-modal');
                loadUsers();
                
            } catch (error) {
                console.error('ユーザー情報保存エラー:', error);
                showToast('エラー', 'ユーザー情報の保存中にエラーが発生しました。', 'error');
            }
        }
        
        // ユーザーパスワードをリセット
        async function resetUserPassword() {
            try {
                const userId = document.getElementById('user-id').value;
                const userEmail = document.getElementById('detail-user-email').textContent;
                
                if (!userId || !userEmail) {
                    showToast('エラー', 'ユーザー情報が不足しています。', 'error');
                    return;
                }
                
                if (!confirm(`${userEmail} 宛にパスワードリセットメールを送信します。よろしいですか？`)) {
                    return;
                }
                
                // パスワードリセットメールを送信
                await auth.sendPasswordResetEmail(userEmail);
                
                // システムログを記録
                await logSystemActivity('admin_action', `パスワードリセット: ${userEmail}`, userId);
                
                showToast('成功', `${userEmail} 宛にパスワードリセットメールを送信しました。`, 'success');
                
            } catch (error) {
                console.error('パスワードリセットエラー:', error);
                showToast('エラー', 'パスワードリセットメールの送信中にエラーが発生しました。', 'error');
            }
        }
        
        // メール対象者を更新
        function updateEmailRecipients() {
            const emailRecipients = document.getElementById('email-recipients');
            const option = emailRecipients.querySelector('option[value="selected"]');
            
            if (option) {
                option.textContent = `選択したユーザー（${selectedUsers.size}人）`;
            }
        }
        
        // 個別ユーザーにメール送信
        window.sendEmail = function(userId) {
            // 選択をリセット
            selectedUsers.clear();
            selectedUsers.add(userId);
            
            // メールモーダルを開く
            updateEmailRecipients();
            
            // 送信先を「選択したユーザー」に設定
            document.getElementById('email-recipients').value = 'selected';
            
            openModal('email-modal');
        };
        
        // メール送信モーダルを初期化
        function initEmailModal() {
            // テンプレート選択時の処理
            const emailTemplate = document.getElementById('email-template');
            emailTemplate.addEventListener('change', () => {
                const template = emailTemplate.value;
                
                if (!template) return;
                
                // テンプレートに応じた内容を設定
                const emailSubject = document.getElementById('email-subject');
                const emailContent = document.getElementById('email-content');
                
                switch (template) {
                    case 'welcome':
                        emailSubject.value = 'KatsujiRingXへようこそ！';
                        emailContent.value = `{{ユーザー名}} 様

KatsujiRingXへのご登録ありがとうございます。
当サービスでは、様々な文書の検索や管理、コミュニティでの意見交換ができます。

まずは以下のステップで始めましょう：
1. プロフィールを完成させる
2. 興味のあるトピックをフォローする
3. 最初の資料をアップロードする

ご不明な点がございましたら、お気軽にサポートまでお問い合わせください。

KatsujiRingX チーム`;
                        break;
                    case 'newsletter':
                        emailSubject.value = 'KatsujiRingX ニュースレター';
                        emailContent.value = `{{ユーザー名}} 様

KatsujiRingXの最新情報をお届けします。

■ 今月のアップデート
・新機能: 文書OCR機能の強化
・UI改善: ダッシュボードのリニューアル
・パフォーマンス向上: 検索速度の50%向上

■ おすすめコンテンツ
・人気の資料: 「デジタルアーカイブの基礎と実践」
・活発なディスカッション: 「古文書のデジタル保存方法」

今後とも KatsujiRingX をよろしくお願いいたします。

KatsujiRingX チーム`;
                        break;
                    case 'update':
                        emailSubject.value = 'KatsujiRingX 重要なアップデートのお知らせ';
                        emailContent.value = `{{ユーザー名}} 様

KatsujiRingXに重要なアップデートが適用されました。

■ アップデート内容
・セキュリティ強化
・新しい文書管理機能の追加
・検索アルゴリズムの改善

詳細はサイト内のお知らせをご確認ください。
このアップデートにより、より快適にサービスをご利用いただけます。

KatsujiRingX チーム`;
                        break;
                    case 'event':
                        emailSubject.value = 'KatsujiRingX オンラインイベントのご案内';
                        emailContent.value = `{{ユーザー名}} 様

KatsujiRingXでは、下記の日程でオンラインイベントを開催いたします。

■ イベント詳細
タイトル: デジタルアーカイブの最新動向
日時: 2023年12月20日 19:00〜20:30
参加方法: Zoomウェビナー（リンクは後日お送りします）

■ 内容
・デジタルアーカイブの最新技術
・効率的な文書管理のコツ
・質疑応答セッション

参加をご希望の方は、マイページからお申し込みください。
皆様のご参加をお待ちしております。

KatsujiRingX チーム`;
                        break;
                }
            });
            
            // メールプレビューボタン
            document.getElementById('preview-email-btn').addEventListener('click', previewEmail);
            
            // メール送信ボタン
            document.getElementById('send-email-btn').addEventListener('click', sendBulkEmail);
        }
        
        // メールプレビュー
        function previewEmail() {
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            
            if (!subject || !content) {
                showToast('警告', '件名と本文を入力してください。', 'warning');
                return;
            }
            
            // プレビュー用にテンプレートタグを置換
            const previewContent = content
                .replace(/{{ユーザー名}}/g, 'テストユーザー')
                .replace(/{{メールアドレス}}/g, 'test@example.com')
                .replace(/{{登録日}}/g, formatDate(new Date()));
            
            // 確認ダイアログでプレビュー表示
            alert(`【件名】\n${subject}\n\n【本文】\n${previewContent}`);
        }
        
        // 一括メール送信
        async function sendBulkEmail() {
            const recipientType = document.getElementById('email-recipients').value;
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            const testEmail = document.getElementById('send-test-email').checked;
            
            if (!subject || !content) {
                showToast('警告', '件名と本文を入力してください。', 'warning');
                return;
            }
            
            try {
                let targetCount = 0;
                let targetDescription = '';
                
                // 送信対象の説明
                switch (recipientType) {
                    case 'selected':
                        targetCount = selectedUsers.size;
                        targetDescription = `選択した${targetCount}人のユーザー`;
                        break;
                    case 'all':
                        targetDescription = 'すべてのユーザー';
                        break;
                    case 'active':
                        targetDescription = 'アクティブユーザー';
                        break;
                    case 'inactive':
                        targetDescription = '非アクティブユーザー';
                        break;
                    case 'students':
                        targetDescription = '学生ユーザー';
                        break;
                    case 'teachers':
                        targetDescription = '教師ユーザー';
                        break;
                    case 'researchers':
                        targetDescription = '研究者ユーザー';
                        break;
                }
                
                // 確認ダイアログ
                if (!confirm(`${targetDescription}にメールを送信します。\n\n件名: ${subject}\n\n${testEmail ? 'テストメールが管理者宛に先に送信されます。' : ''}`)) {
                    return;
                }
                
                showToast('情報', 'メールを送信準備中...', 'info');
                
                // 本来はCloud Functionsなどでバックエンドから送信
                // ここではフロントエンドからの実行をシミュレート
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // システムログを記録
                await logSystemActivity('admin_action', `一括メール送信: ${targetDescription} 宛に「${subject}」`);
                
                showToast('成功', `${targetDescription}へのメール送信を開始しました。完了までに時間がかかる場合があります。`, 'success');
                
                // モーダルを閉じる
                closeModal('email-modal');
                
                // フォームをクリア
                document.getElementById('email-subject').value = '';
                document.getElementById('email-content').value = '';
                document.getElementById('email-template').value = '';
                document.getElementById('send-test-email').checked = false;
                
            } catch (error) {
                console.error('メール送信エラー:', error);
                showToast('エラー', 'メール送信の準備中にエラーが発生しました。', 'error');
            }
        }
        
        /* お知らせ管理関連 */
        // お知らせ管理初期化
        async function initAnnouncements() {
            try {
                // お知らせデータを読み込み
                loadAnnouncements();
                loadAnnouncementPreviews();
                
                // フィルターの設定
                document.getElementById('announcement-filter').addEventListener('change', loadAnnouncements);
                
                // 新規お知らせボタンの設定
                document.getElementById('create-announcement').addEventListener('click', () => {
                    resetAnnouncementForm();
                    openModal('announcement-modal');
                });
            } catch (error) {
                console.error('お知らせ管理初期化エラー:', error);
                showToast('エラー', 'お知らせ管理の初期化中にエラーが発生しました。', 'error');
            }
        }
        
        // お知らせデータを読み込み
        async function loadAnnouncements() {
            const announcementsTable = document.getElementById('announcements-table');
            const filterValue = document.getElementById('announcement-filter').value;
            
            try {
                announcementsTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="loading"></div>
                        </td>
                    </tr>
                `;
                
                // 基本クエリを作成
                let query = db.collection('announcements')
                    .orderBy('createdAt', 'desc');
                
                // 現在の日時
                const now = new Date();
                
                // お知らせ状態でフィルタリング
                if (filterValue !== 'all') {
                    switch (filterValue) {
                        case 'active':
                            // 有効なお知らせ: 現在公開中
                            query = query.where('isActive', '==', true)
                                .where('startDate', '<=', firebase.firestore.Timestamp.fromDate(now));
                            break;
                        case 'scheduled':
                            // 予約済みのお知らせ: まだ公開期間に入っていない
                            query = query.where('isActive', '==', true)
                                .where('startDate', '>', firebase.firestore.Timestamp.fromDate(now));
                            break;
                        case 'expired':
                            // 期限切れのお知らせ: 終了日時を過ぎている
                            query = query.where('endDate', '<', firebase.firestore.Timestamp.fromDate(now));
                            break;
                        case 'draft':
                            // 下書き: 非アクティブのもの
                            query = query.where('isActive', '==', false);
                            break;
                    }
                }
                
                // クエリを実行
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    announcementsTable.innerHTML = '<tr><td colspan="7" class="text-center">お知らせが見つかりませんでした</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const announcement = doc.data();
                    announcement.id = doc.id;
                    
                    // 優先度に応じたクラス
                    let priorityClass = 'badge-secondary';
                    let priorityText = '低';
                    
                    if (announcement.priority === 'medium') {
                        priorityClass = 'badge-primary';
                        priorityText = '中';
                    } else if (announcement.priority === 'high') {
                        priorityClass = 'badge-warning';
                        priorityText = '高';
                    } else if (announcement.priority === 'urgent') {
                        priorityClass = 'badge-danger';
                        priorityText = '緊急';
                    }
                    
                    // 対象者
                    let targetText = 'すべてのユーザー';
                    if (announcement.targetUsers && announcement.targetUsers !== 'all') {
                        const targets = [];
                        if (announcement.specificTargets) {
                            if (announcement.specificTargets.includes('students')) targets.push('学生');
                            if (announcement.specificTargets.includes('teachers')) targets.push('教師');
                            if (announcement.specificTargets.includes('researchers')) targets.push('研究者');
                            if (announcement.specificTargets.includes('new-users')) targets.push('新規ユーザー');
                        }
                        targetText = targets.join(', ') || '特定のユーザー';
                    }
                    
                    // 公開期間
                    const startDate = announcement.startDate ? formatDate(announcement.startDate.toDate()) : '-';
                    const endDate = announcement.endDate ? formatDate(announcement.endDate.toDate()) : '無期限';
                    const dateRange = `${startDate} 〜 ${endDate}`;
                    
                    // 状態
                    let statusClass = 'badge-inactive';
                    let statusText = '下書き';
                    
                    if (announcement.isActive) {
                        const startTimestamp = announcement.startDate ? announcement.startDate.toDate().getTime() : 0;
                        const endTimestamp = announcement.endDate ? announcement.endDate.toDate().getTime() : Infinity;
                        const nowTimestamp = now.getTime();
                        
                        if (nowTimestamp < startTimestamp) {
                            statusClass = 'badge-info';
                            statusText = '予約済み';
                        } else if (nowTimestamp > endTimestamp) {
                            statusClass = 'badge-secondary';
                            statusText = '期限切れ';
                        } else {
                            statusClass = 'badge-active';
                            statusText = '公開中';
                        }
                    }
                    
                    // 作成者
                    const createdBy = announcement.createdBy || '管理者';
                    
                    html += `
                        <tr>
                            <td>${announcement.title || 'タイトルなし'}</td>
                            <td><span class="badge ${priorityClass}">${priorityText}</span></td>
                            <td>${targetText}</td>
                            <td>${dateRange}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>${createdBy}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn btn-sm btn-outline" onclick="editAnnouncement('${announcement.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline btn-danger" onclick="deleteAnnouncement('${announcement.id}')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                announcementsTable.innerHTML = html;
                
            } catch (error) {
                console.error('お知らせデータ読み込みエラー:', error);
                announcementsTable.innerHTML = '<tr><td colspan="7" class="text-center">データの読み込み中にエラーが発生しました</td></tr>';
                showToast('エラー', 'お知らせデータの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // お知らせプレビューを読み込み
        async function loadAnnouncementPreviews() {
            const previewsContainer = document.getElementById('announcement-previews');
            
            try {
                previewsContainer.innerHTML = `
                    <div class="card text-center">
                        <div class="loading"></div>
                        <p class="text-muted">読み込み中...</p>
                    </div>
                `;
                
                // 現在有効なお知らせを取得
                const now = new Date();
                const snapshot = await db.collection('announcements')
                    .where('isActive', '==', true)
                    .where('startDate', '<=', firebase.firestore.Timestamp.fromDate(now))
                    .orderBy('startDate', 'desc')
                    .limit(4)
                    .get();
                
                if (snapshot.empty) {
                    previewsContainer.innerHTML = `
                        <div class="card text-center">
                            <p class="text-muted">現在有効なお知らせはありません</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const announcement = doc.data();
                    
                    // 優先度に応じたクラス
                    let priorityClass = '';
                    if (announcement.priority === 'medium') priorityClass = 'border-primary';
                    if (announcement.priority === 'high') priorityClass = 'border-warning';
                    if (announcement.priority === 'urgent') priorityClass = 'border-danger';
                    
                    // 公開日
                    const startDate = announcement.startDate ? formatDate(announcement.startDate.toDate()) : '-';
                    
                    // 内容（プレビュー用に短く）
                    const content = announcement.content || '';
                    const shortContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
                    
                    html += `
                        <div class="card ${priorityClass}" style="${priorityClass ? 'border-left-width: 4px;' : ''}">
                            <h4>${announcement.title || 'タイトルなし'}</h4>
                            <p class="text-muted mb-2">${startDate}</p>
                            <p>${shortContent}</p>
                            <button class="btn btn-sm btn-outline" onclick="editAnnouncement('${doc.id}')">
                                <i class="fas fa-edit"></i> 編集
                            </button>
                        </div>
                    `;
                });
                
                previewsContainer.innerHTML = html;
                
            } catch (error) {
                console.error('お知らせプレビュー読み込みエラー:', error);
                previewsContainer.innerHTML = `
                    <div class="card text-center">
                        <p class="text-danger">データの読み込み中にエラーが発生しました</p>
                    </div>
                `;
            }
        }
        
        // お知らせモーダルを初期化
        function initAnnouncementModal() {
            // 対象ユーザー選択の切り替え
            const targetAll = document.getElementById('target-all');
            const targetSpecific = document.getElementById('target-specific');
            const specificTargets = document.getElementById('specific-targets');
            
            targetAll.addEventListener('change', () => {
                specificTargets.style.display = 'none';
            });
            
            targetSpecific.addEventListener('change', () => {
                specificTargets.style.display = 'block';
            });
            
            // 現在の日時をデフォルト値に設定
            const now = new Date();
            const startDateInput = document.getElementById('announcement-start-date');
            startDateInput.value = now.toISOString().slice(0, 16);
            
            // 保存ボタンのイベント設定
            document.getElementById('save-draft-btn').addEventListener('click', () => saveAnnouncement(false));
            document.getElementById('publish-announcement-btn').addEventListener('click', () => saveAnnouncement(true));
        }
        
        // お知らせフォームをリセット
        function resetAnnouncementForm() {
            // フォーム要素を取得
            const titleInput = document.getElementById('announcement-title');
            const contentInput = document.getElementById('announcement-content');
            const prioritySelect = document.getElementById('announcement-priority');
            const typeSelect = document.getElementById('announcement-type');
            const targetAll = document.getElementById('target-all');
            const targetSpecific = document.getElementById('target-specific');
            const specificTargets = document.getElementById('specific-targets');
            const startDateInput = document.getElementById('announcement-start-date');
            const endDateInput = document.getElementById('announcement-end-date');
            const activeCheckbox = document.getElementById('announcement-active');
            const announcementIdInput = document.getElementById('announcement-id');
            const modalTitle = document.getElementById('announcement-modal-title');
            
            // フォームをリセット
            titleInput.value = '';
            contentInput.value = '';
            prioritySelect.value = 'medium';
            typeSelect.value = 'normal';
            targetAll.checked = true;
            targetSpecific.checked = false;
            specificTargets.style.display = 'none';
            document.querySelectorAll('#specific-targets input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // 現在の日時を開始日時に設定
            const now = new Date();
            startDateInput.value = now.toISOString().slice(0, 16);
            endDateInput.value = '';
            
            activeCheckbox.checked = true;
            announcementIdInput.value = '';
            modalTitle.textContent = '新規お知らせ';
        }
        
        // お知らせの編集
        window.editAnnouncement = async function(announcementId) {
            try {
                // お知らせデータを取得
                const docRef = await db.collection('announcements').doc(announcementId).get();
                
                if (!docRef.exists) {
                    showToast('エラー', 'お知らせが見つかりませんでした。', 'error');
                    return;
                }
                
                const announcement = docRef.data();
                
                // フォームに値を設定
                document.getElementById('announcement-id').value = announcementId;
                document.getElementById('announcement-title').value = announcement.title || '';
                document.getElementById('announcement-content').value = announcement.content || '';
                document.getElementById('announcement-priority').value = announcement.priority || 'medium';
                document.getElementById('announcement-type').value = announcement.type || 'normal';
                
                // 対象ユーザー
                if (announcement.targetUsers === 'specific') {
                    document.getElementById('target-specific').checked = true;
                    document.getElementById('specific-targets').style.display = 'block';
                    
                    // 特定ターゲットのチェックボックス
                    if (announcement.specificTargets) {
                        document.getElementById('target-students').checked = announcement.specificTargets.includes('students');
                        document.getElementById('target-teachers').checked = announcement.specificTargets.includes('teachers');
                        document.getElementById('target-researchers').checked = announcement.specificTargets.includes('researchers');
                        document.getElementById('target-new-users').checked = announcement.specificTargets.includes('new-users');
                    }
                } else {
                    document.getElementById('target-all').checked = true;
                    document.getElementById('specific-targets').style.display = 'none';
                }
                
                // 日付
                if (announcement.startDate) {
                    const startDate = announcement.startDate.toDate();
                    document.getElementById('announcement-start-date').value = startDate.toISOString().slice(0, 16);
                }
                
                if (announcement.endDate) {
                    const endDate = announcement.endDate.toDate();
                    document.getElementById('announcement-end-date').value = endDate.toISOString().slice(0, 16);
                } else {
                    document.getElementById('announcement-end-date').value = '';
                }
                
                document.getElementById('announcement-active').checked = announcement.isActive || false;
                document.getElementById('announcement-modal-title').textContent = 'お知らせを編集';
                
                // モーダルを開く
                openModal('announcement-modal');
                
            } catch (error) {
                console.error('お知らせ編集エラー:', error);
                showToast('エラー', 'お知らせデータの取得中にエラーが発生しました。', 'error');
            }
        };
        
        // お知らせを保存
        async function saveAnnouncement(publish = true) {
            try {
                // フォームからデータを取得
                const announcementId = document.getElementById('announcement-id').value;
                const title = document.getElementById('announcement-title').value;
                const content = document.getElementById('announcement-content').value;
                const priority = document.getElementById('announcement-priority').value;
                const type = document.getElementById('announcement-type').value;
                const isActive = publish ? true : document.getElementById('announcement-active').checked;
                
                // 必須項目チェック
                if (!title) {
                    showToast('警告', 'タイトルを入力してください。', 'warning');
                    return;
                }
                
                // 対象ユーザー
                const targetUsers = document.getElementById('target-specific').checked ? 'specific' : 'all';
                
                // 特定のターゲット
                let specificTargets = [];
                if (targetUsers === 'specific') {
                    if (document.getElementById('target-students').checked) specificTargets.push('students');
                    if (document.getElementById('target-teachers').checked) specificTargets.push('teachers');
                    if (document.getElementById('target-researchers').checked) specificTargets.push('researchers');
                    if (document.getElementById('target-new-users').checked) specificTargets.push('new-users');
                    
                    if (specificTargets.length === 0) {
                        showToast('警告', '対象ユーザーを選択してください。', 'warning');
                        return;
                    }
                }
                
                // 日付の取得と検証
                const startDateStr = document.getElementById('announcement-start-date').value;
                const endDateStr = document.getElementById('announcement-end-date').value;
                
                if (!startDateStr) {
                    showToast('警告', '開始日時を設定してください。', 'warning');
                    return;
                }
                
                const startDate = firebase.firestore.Timestamp.fromDate(new Date(startDateStr));
                let endDate = null;
                
                if (endDateStr) {
                    endDate = firebase.firestore.Timestamp.fromDate(new Date(endDateStr));
                    
                    // 終了日が開始日より前の場合はエラー
                    if (endDate.toMillis() < startDate.toMillis()) {
                        showToast('警告', '終了日時は開始日時より後に設定してください。', 'warning');
                        return;
                    }
                }
                
                // 保存するデータ
                const announcementData = {
                    title,
                    content,
                    priority,
                    type,
                    targetUsers,
                    specificTargets: targetUsers === 'specific' ? specificTargets : [],
                    startDate,
                    endDate,
                    isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 新規作成の場合は作成日時と作成者も設定
                if (!announcementId) {
                    announcementData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    announcementData.createdBy = currentUser.displayName || currentUser.email;
                    announcementData.createdById = currentUser.uid;
                }
                
                // Firestoreに保存
                if (announcementId) {
                    // 既存のお知らせを更新
                    await db.collection('announcements').doc(announcementId).update(announcementData);
                    
                    // システムログを記録
                    await logSystemActivity('announcement', `お知らせを更新: ${title}`);
                    
                    showToast('成功', `お知らせ「${title}」を${publish ? '公開' : '保存'}しました。`, 'success');
                } else {
                    // 新規お知らせを作成
                    const docRef = await db.collection('announcements').add(announcementData);
                    
                    // システムログを記録
                    await logSystemActivity('announcement', `新規お知らせを作成: ${title}`);
                    
                    showToast('成功', `新規お知らせ「${title}」を${publish ? '公開' : '下書き保存'}しました。`, 'success');
                }
                
                // モーダルを閉じてお知らせ一覧を更新
                closeModal('announcement-modal');
                loadAnnouncements();
                loadAnnouncementPreviews();
                
            } catch (error) {
                console.error('お知らせ保存エラー:', error);
                showToast('エラー', 'お知らせの保存中にエラーが発生しました。', 'error');
            }
        }
        
        // お知らせの削除
        window.deleteAnnouncement = async function(announcementId) {
            try {
                // 削除前に確認
                if (!confirm('このお知らせを削除してもよろしいですか？この操作は元に戻せません。')) {
                    return;
                }
                
                // ドキュメントを取得して情報を記録
                const docRef = await db.collection('announcements').doc(announcementId).get();
                const announcement = docRef.exists ? docRef.data() : { title: 'お知らせ' };
                
                // お知らせを削除
                await db.collection('announcements').doc(announcementId).delete();
                
                // システムログを記録
                await logSystemActivity('admin_action', `お知らせを削除: ${announcement.title || 'タイトルなし'}`);
                
                showToast('成功', `お知らせ「${announcement.title || 'タイトルなし'}」を削除しました。`, 'success');
                
                // お知らせ一覧を更新
                loadAnnouncements();
                loadAnnouncementPreviews();
                
            } catch (error) {
                console.error('お知らせ削除エラー:', error);
                showToast('エラー', 'お知らせの削除中にエラーが発生しました。', 'error');
            }
        };
        
        /* データ分析関連 */
        // データ分析初期化
        async function initAnalytics() {
            try {
                // デフォルトの日付範囲を設定
                setupDefaultDateRange();
                
                // 期間選択ボタンのイベント設定
                setupDateRangeButtons();
                
                // 間隔変更イベントの設定
                document.getElementById('user-graph-interval').addEventListener('change', updateUserChart);
                
                // 日付適用ボタンのイベント設定
                document.getElementById('apply-date').addEventListener('click', updateAllCharts);
                
                // チャートを初期化
                initCharts();
                
                // チャートデータを読み込み
                loadAnalyticsData();
            } catch (error) {
                console.error('データ分析初期化エラー:', error);
                showToast('エラー', 'データ分析の初期化中にエラーが発生しました。', 'error');
            }
        }
        
        // デフォルトの日付範囲を設定
        function setupDefaultDateRange() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            endDateInput.value = today.toISOString().split('T')[0];
        }
        
        // 期間選択ボタンのイベント設定
        function setupDateRangeButtons() {
            const dateRangeButtons = document.querySelectorAll('[data-range]');
            dateRangeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const days = parseInt(button.getAttribute('data-range'));
                    
                    const today = new Date();
                    const startDate = new Date();
                    startDate.setDate(today.getDate() - days);
                    
                    const startDateInput = document.getElementById('start-date');
                    const endDateInput = document.getElementById('end-date');
                    
                    startDateInput.value = startDate.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    
                    // 選択されたボタンのスタイル変更
                    dateRangeButtons.forEach(btn => {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline');
                    });
                    button.classList.remove('btn-outline');
                    button.classList.add('btn-primary');
                    
                    // チャート更新
                    updateAllCharts();
                });
            });
        }
        
        // すべてのチャートを更新
        function updateAllCharts() {
            updateUserChart();
            updateContentChart();
            updateUserSegmentCharts();
        }
        
        // チャートを初期化
        function initCharts() {
            // ユーザー成長チャート
            const userGrowthCtx = document.getElementById('user-growth-chart').getContext('2d');
            charts.userGrowth = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '新規ユーザー',
                            data: [],
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'アクティブユーザー',
                            data: [],
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ユーザー成長推移'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 文書アップロードチャート
            const documentUploadCtx = document.getElementById('document-upload-chart').getContext('2d');
            charts.documentUpload = new Chart(documentUploadCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'アップロード資料数',
                            data: [],
                            backgroundColor: 'rgba(245, 158, 11, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '資料アップロード推移'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // アクティビティチャート
            const activityCtx = document.getElementById('activity-chart').getContext('2d');
            charts.activity = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '投稿数',
                            data: [],
                            borderColor: 'rgba(59, 130, 246, 1)',
                            tension: 0.1
                        },
                        {
                            label: 'コメント数',
                            data: [],
                            borderColor: 'rgba(16, 185, 129, 1)',
                            tension: 0.1
                        },
                        {
                            label: 'いいね数',
                            data: [],
                            borderColor: 'rgba(239, 68, 68, 1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'コミュニティアクティビティ'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // ユーザー役割分布チャート
            const userRolesCtx = document.getElementById('user-roles-chart').getContext('2d');
            charts.userRoles = new Chart(userRolesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['一般ユーザー', '学生', '教師', '研究者', 'モデレーター', '管理者'],
                    datasets: [
                        {
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(107, 114, 128, 0.6)',
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(245, 158, 11, 0.6)',
                                'rgba(249, 115, 22, 0.6)',
                                'rgba(239, 68, 68, 0.6)'
                            ]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ユーザー役割分布'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // ユーザー状態分布チャート
            const userStatusCtx = document.getElementById('user-status-chart').getContext('2d');
            charts.userStatus = new Chart(userStatusCtx, {
                type: 'pie',
                data: {
                    labels: ['アクティブ', '非アクティブ', '一時停止', '禁止'],
                    datasets: [
                        {
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(107, 114, 128, 0.6)',
                                'rgba(245, 158, 11, 0.6)',
                                'rgba(239, 68, 68, 0.6)'
                            ]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ユーザー状態分布'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // チャートのテーマを更新
        function updateChartsTheme() {
            // 各チャートの色を更新
            Object.values(charts).forEach(chart => {
                // テーマに応じた文字色
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                const textColor = isDark ? '#f3f4f6' : '#1f2937';
                
                // タイトルの色を更新
                if (chart.options.plugins.title) {
                    chart.options.plugins.title.color = textColor;
                }
                
                // 凡例の色を更新
                if (chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels = {
                        color: textColor
                    };
                }
                
                // スケールの色を更新
                if (chart.options.scales) {
                    Object.keys(chart.options.scales).forEach(axis => {
                        chart.options.scales[axis].ticks = {
                            color: textColor
                        };
                        chart.options.scales[axis].grid = {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        };
                    });
                }
                
                // チャートを更新
                chart.update();
            });
        }
        
        // 分析データを読み込み
        async function loadAnalyticsData() {
            try {
                // ユーザーチャートを更新
                updateUserChart();
                
                // コンテンツチャートを更新
                updateContentChart();
                
                // ユーザーセグメントチャートを更新
                updateUserSegmentCharts();
                
                // DAU/MAUを更新
                updateActiveUserCounts();
                
            } catch (error) {
                console.error('分析データ読み込みエラー:', error);
                showToast('エラー', '分析データの読み込み中にエラーが発生しました。', 'error');
            }
        }
        
        // ユーザーチャートを更新
        async function updateUserChart() {
            try {
                // 日付範囲を取得
                const { startDate, endDate, intervalType } = getDateRangeAndInterval();
                
                // データを生成（実際はFirebaseから取得）
                const { newUserData, activeUserData, labels } = await generateUserData(startDate, endDate, intervalType);
                
                // チャートを更新
                charts.userGrowth.data.labels = labels;
                charts.userGrowth.data.datasets[0].data = newUserData;
                charts.userGrowth.data.datasets[1].data = activeUserData;
                charts.userGrowth.update();
                
            } catch (error) {
                console.error('ユーザーチャート更新エラー:', error);
                showToast('エラー', 'ユーザーチャートの更新中にエラーが発生しました。', 'error');
            }
        }
        
        // 日付範囲と間隔を取得
        function getDateRangeAndInterval() {
            // 入力から日付を取得
            const startDateStr = document.getElementById('start-date').value;
            const endDateStr = document.getElementById('end-date').value;
            const intervalType = document.getElementById('user-graph-interval').value;
            
            // 日付オブジェクトに変換
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999); // 終了日の終わりに設定
            
            return { startDate, endDate, intervalType };
        }
        
        // ユーザーデータを生成（実際はFirebaseから取得）
        async function generateUserData(startDate, endDate, intervalType) {
            // 日付の差を計算
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let format;
            let step;
            
            switch (intervalType) {
                case 'daily':
                    format = 'MM/DD';
                    step = 1;
                    break;
                case 'weekly':
                    format = 'YYYY/MM/DD';
                    step = 7;
                    break;
                case 'monthly':
                    format = 'YYYY/MM';
                    step = 30;
                    break;
                default:
                    format = 'MM/DD';
                    step = 1;
            }
            
            // データポイント数を計算
            const numPoints = Math.ceil(diffDays / step);
            
            // ラベルとデータを生成
            const labels = [];
            const newUserData = [];
            const activeUserData = [];
            
            // 開始日からステップごとにデータポイントを生成
            for (let i = 0; i < numPoints; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * step);
                
                // 日付を指定したフォーマットに変換
                const label = format === 'YYYY/MM' 
                    ? `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}`
                    : `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                
                labels.push(label);
                
                // ランダムデータを生成（実際はFBから取得）
                const newUserValue = Math.floor(Math.random() * 50) + 10;
                const activeUserValue = Math.floor(Math.random() * 200) + 50;
                
                newUserData.push(newUserValue);
                activeUserData.push(activeUserValue);
            }
            
            return { labels, newUserData, activeUserData };
        }
        
        // コンテンツチャートを更新
        async function updateContentChart() {
            try {
                // 日付範囲を取得
                const { startDate, endDate } = getDateRangeAndInterval();
                
                // ドキュメントデータを生成
                const { documentData, documentLabels } = await generateDocumentData(startDate, endDate);
                
                // アクティビティデータを生成
                const { postData, commentData, likeData, activityLabels } = await generateActivityData(startDate, endDate);
                
                // 文書アップロードチャートを更新
                charts.documentUpload.data.labels = documentLabels;
                charts.documentUpload.data.datasets[0].data = documentData;
                charts.documentUpload.update();
                
                // アクティビティチャートを更新
                charts.activity.data.labels = activityLabels;
                charts.activity.data.datasets[0].data = postData;
                charts.activity.data.datasets[1].data = commentData;
                charts.activity.data.datasets[2].data = likeData;
                charts.activity.update();
                
            } catch (error) {
                console.error('コンテンツチャート更新エラー:', error);
                showToast('エラー', 'コンテンツチャートの更新中にエラーが発生しました。', 'error');
            }
        }
        
        // ドキュメントデータを生成（実際はFirebaseから取得）
        async function generateDocumentData(startDate, endDate) {
            // 日付の差を計算
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // データポイント数を計算（週ごと）
            const step = 7;
            const numPoints = Math.ceil(diffDays / step);
            
            // ラベルとデータを生成
            const documentLabels = [];
            const documentData = [];
            
            // 開始日からステップごとにデータポイントを生成
            for (let i = 0; i < numPoints; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * step);
                
                // 日付をフォーマット
                const label = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                
                documentLabels.push(label);
                
                // ランダムデータを生成（実際はFBから取得）
                const documentValue = Math.floor(Math.random() * 30) + 5;
                
                documentData.push(documentValue);
            }
            
            return { documentLabels, documentData };
        }
        
        // アクティビティデータを生成（実際はFirebaseから取得）
        async function generateActivityData(startDate, endDate) {
            // 日付の差を計算
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // データポイント数を計算（週ごと）
            const step = 7;
            const numPoints = Math.ceil(diffDays / step);
            
            // ラベルとデータを生成
            const activityLabels = [];
            const postData = [];
            const commentData = [];
            const likeData = [];
            
            // 開始日からステップごとにデータポイントを生成
            for (let i = 0; i < numPoints; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i * step);
                
                // 日付をフォーマット
                const label = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                
                activityLabels.push(label);
                
                // ランダムデータを生成（実際はFBから取得）
                const postValue = Math.floor(Math.random() * 20) + 5;
                const commentValue = Math.floor(Math.random() * 60) + 20;
                const likeValue = Math.floor(Math.random() * 100) + 50;
                
                postData.push(postValue);
                commentData.push(commentValue);
                likeData.push(likeValue);
            }
            
            return { activityLabels, postData, commentData, likeData };
        }
        
        // ユーザーセグメントチャートを更新
        async function updateUserSegmentCharts() {
            try {
                // ユーザー役割分布データを生成
                const roleData = await generateUserRoleData();
                
                // ユーザー状態分布データを生成
                const statusData = await generateUserStatusData();
                
                // ユーザー役割チャートを更新
                charts.userRoles.data.datasets[0].data = roleData;
                charts.userRoles.update();
                
                // ユーザー状態チャートを更新
                charts.userStatus.data.datasets[0].data = statusData;
                charts.userStatus.update();
                
            } catch (error) {
                console.error('ユーザーセグメントチャート更新エラー:', error);
                showToast('エラー', 'ユーザーセグメントチャートの更新中にエラーが発生しました。', 'error');
            }
        }
        
        // ユーザー役割分布データを生成（実際はFirebaseから取得）
        async function generateUserRoleData() {
            // ランダムデータを生成（実際はFBから取得）
            const normalUsers = Math.floor(Math.random() * 1000) + 500;
            const students = Math.floor(Math.random() * 300) + 100;
            const teachers = Math.floor(Math.random() * 100) + 50;
            const researchers = Math.floor(Math.random() * 50) + 20;
            const moderators = Math.floor(Math.random() * 20) + 5;
            const admins = Math.floor(Math.random() * 10) + 2;
            
            return [normalUsers, students, teachers, researchers, moderators, admins];
        }
        
        // ユーザー状態分布データを生成（実際はFirebaseから取得）
        async function generateUserStatusData() {
            // ランダムデータを生成（実際はFBから取得）
            const active = Math.floor(Math.random() * 1000) + 500;
            const inactive = Math.floor(Math.random() * 500) + 200;
            const suspended = Math.floor(Math.random() * 50) + 10;
            const banned = Math.floor(Math.random() * 20) + 5;
            
            return [active, inactive, suspended, banned];
        }
        
        // アクティブユーザー数を更新
        async function updateActiveUserCounts() {
            try {
                // DAU/MAUをランダムに生成（実際はFirebaseから取得）
                const dau = Math.floor(Math.random() * 100) + 50;
                const mau = Math.floor(Math.random() * 1000) + 300;
                
                // 表示を更新
                document.getElementById('dau-count').textContent = formatNumber(dau);
                document.getElementById('mau-count').textContent = formatNumber(mau);
                
            } catch (error) {
                console.error('アクティブユーザー数更新エラー:', error);
            }
        }
    </script>
</body>
</html>