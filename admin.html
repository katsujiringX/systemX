<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>管理者ダッシュボード | KatsujiRingX</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root {
            --primary: #4338ca;
            --primary-hover: #3730a3;
            --primary-light: #e0e7ff;
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --secondary-light: #e0f2fe;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --accent-light: #fff7ed;
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;
            --info: #3b82f6;
            --info-hover: #2563eb;
            --info-light: #eff6ff;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --bg-color: var(--gray-50);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            
            --header-height: 4rem;
            --sidebar-width: 280px;
            --transition-normal: 0.3s ease;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.25rem;
            --radius: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
        }
        
        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #2d2a63;
            
            --bg-color: #0f172a;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #1f2937;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* サイドバー */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            color: white;
            z-index: 50;
            transition: transform var(--transition-normal), width var(--transition-normal);
            box-shadow: var(--shadow);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo img {
            width: 2rem;
            height: 2rem;
        }
        
        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        .menu-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.75rem 1.5rem 0.5rem;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: background-color var(--transition-normal);
            position: relative;
            margin: 0.125rem 0.75rem;
            border-radius: var(--radius);
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.25rem;
            height: 1.5rem;
            background-color: white;
            border-radius: 0 var(--radius) var(--radius) 0;
        }
        
        .menu-item i {
            margin-right: 0.75rem;
            width: 1.25rem;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: var(--primary);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            z-index: 100;
            box-shadow: var(--shadow-md);
            border: none;
            cursor: pointer;
            transition: background-color var(--transition-normal);
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-hover);
        }
        
        /* メインコンテンツ */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            transition: margin var(--transition-normal);
        }
        
        .page-header {
            margin-bottom: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.8125rem;
        }
        
        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb i {
            font-size: 0.625rem;
        }
        
        /* 統計カード */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        [data-theme="dark"] .stat-card {
            background-color: #1e293b;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .stat-primary {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .stat-secondary {
            background-color: var(--secondary-light);
            color: var(--secondary);
        }
        
        .stat-success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .stat-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .stat-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        .stat-info {
            background-color: var(--info-light);
            color: var(--info);
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        /* カードセクション */
        .card-section {
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .section-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        [data-theme="dark"] .card {
            background-color: #1e293b;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* グリッドレイアウト */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        /* テーブルスタイル */
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            font-weight: 600;
            color: var(--text-muted);
            background-color: var(--gray-50);
        }
        
        [data-theme="dark"] .data-table th {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .data-table tbody tr:hover {
            background-color: var(--gray-50);
        }
        
        [data-theme="dark"] .data-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .table-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            margin-right: 0.5rem;
        }
        
        .table-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .user-name-cell {
            display: flex;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-email {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* バッジ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: var(--success-light);
            color: var(--success);
        }
        
        .badge-warning {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        .badge-info {
            background-color: var(--info-light);
            color: var(--info);
        }
        
        .badge-secondary {
            background-color: var(--secondary-light);
            color: var(--secondary);
        }
        
        /* セクション・タブ */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .tab-container {
            margin-bottom: 1.5rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            transition: all var(--transition-normal);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* フォーム要素 */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: white;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        [data-theme="dark"] .form-control {
            background-color: #1e293b;
            color: white;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            display: block;
            width: 100%;
            padding: 0.625rem 2rem 0.625rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            appearance: none;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
        }
        
        [data-theme="dark"] .form-select {
            background-color: #1e293b;
            color: white;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .form-check-input {
            margin-right: 0.5rem;
        }
        
        /* モーダル */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }
        
        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform var(--transition-normal);
        }
        
        [data-theme="dark"] .modal {
            background-color: #1e293b;
        }
        
        .modal-backdrop.show .modal {
            transform: scale(1);
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color var(--transition-normal);
        }
        
        .modal-close:hover {
            color: var(--danger);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* ページネーション */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        .page-item {
            list-style: none;
        }
        
        .page-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: var(--radius);
            margin: 0 0.25rem;
            text-decoration: none;
            color: var(--text-color);
            background-color: white;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }
        
        [data-theme="dark"] .page-link {
            background-color: #1e293b;
        }
        
        .page-link:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-300);
        }
        
        [data-theme="dark"] .page-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .page-item.active .page-link {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-item.disabled .page-link {
            color: var(--text-muted);
            pointer-events: none;
        }
        
        /* 検索バー */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: white;
            font-size: 0.875rem;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        [data-theme="dark"] .search-input {
            background-color: #1e293b;
            color: white;
        }
        
        .search-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        /* フィルターパネル */
        .filter-panel {
            background-color: white;
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        [data-theme="dark"] .filter-panel {
            background-color: #1e293b;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .filter-title i {
            margin-right: 0.5rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* アクティビティフィード */
        .activity-feed {
            list-style: none;
        }
        
        .activity-item {
            display: flex;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .activity-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .activity-meta {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .activity-user {
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .activity-time {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .activity-description {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        /* アラート */
        .alert {
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid transparent;
        }
        
        .alert-info {
            background-color: var(--info-light);
            color: var(--info);
            border-left-color: var(--info);
        }
        
        .alert-success {
            background-color: var(--success-light);
            color: var(--success);
            border-left-color: var(--success);
        }
        
        .alert-warning {
            background-color: var(--warning-light);
            color: var(--warning);
            border-left-color: var(--warning);
        }
        
        .alert-danger {
            background-color: var(--danger-light);
            color: var(--danger);
            border-left-color: var(--danger);
        }
        
        /* ローディングスピナー */
        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ユーティリティクラス */
        .text-primary { color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-info { color: var(--info); }
        .text-muted { color: var(--text-muted); }
        
        .bg-primary { background-color: var(--primary); color: white; }
        .bg-secondary { background-color: var(--secondary); color: white; }
        .bg-success { background-color: var(--success); color: white; }
        .bg-warning { background-color: var(--warning); color: white; }
        .bg-danger { background-color: var(--danger); color: white; }
        .bg-info { background-color: var(--info); color: white; }
        
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .flex-column { flex-direction: column; }
        .flex-1 { flex: 1; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mt-5 { margin-top: 3rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-5 { margin-bottom: 3rem; }
        
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-3 { margin-left: 1rem; }
        .ml-4 { margin-left: 1.5rem; }
        .ml-5 { margin-left: 3rem; }
        
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 1rem; }
        .mr-4 { margin-right: 1.5rem; }
        .mr-5 { margin-right: 3rem; }
        
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 1rem; }
        .p-4 { padding: 1.5rem; }
        .p-5 { padding: 3rem; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        /* ボタンスタイル */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            border: none;
            line-height: 1.5;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--success-hover);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: var(--warning-hover);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--danger-hover);
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: var(--info-hover);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon i {
            margin-right: 0;
        }
        
        .btn-link {
            background: none;
            padding: 0;
            color: var(--primary);
            font-weight: 500;
            text-decoration: none;
        }
        
        .btn-link:hover {
            text-decoration: underline;
        }
        
        /* テーマ切替ボタン */
        .theme-toggle {
            cursor: pointer;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: background-color var(--transition-normal);
        }
        
        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .theme-toggle i {
            margin-right: 0.75rem;
        }
        
        /* チャート */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* レポート・分析セクション専用スタイル */
.report-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.report-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

.report-description {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.report-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 1.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.report-tab {
    padding: 0.75rem 1.5rem;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-muted);
    transition: all var(--transition-normal);
    white-space: nowrap;
}

.report-tab:hover {
    color: var(--primary);
}

.report-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* チャート・グラフスタイル */
.chart-wrapper {
    position: relative;
    background-color: var(--bg-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition-normal);
}

.chart-wrapper:hover {
    box-shadow: var(--shadow);
}

.chart-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.chart-legend {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    margin-right: 0.5rem;
}

/* データカードスタイル */
.data-card {
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
}

[data-theme="dark"] .data-card {
    background-color: #1e293b;
}

.data-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.data-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.data-card-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-muted);
}

.data-card-icon {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius);
    background-color: var(--primary-light);
    color: var(--primary);
}

.data-card-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.data-card-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.data-trend {
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    margin-top: 0.5rem;
}

.data-trend-up {
    color: var(--success);
}

.data-trend-down {
    color: var(--danger);
}

.data-trend i {
    margin-right: 0.25rem;
}

/* リテンションテーブルスタイル */
.retention-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.retention-table th, 
.retention-table td {
    padding: 0.75rem;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}

.retention-table th:first-child,
.retention-table td:first-child {
    text-align: left;
}

.retention-table th:nth-child(2),
.retention-table td:nth-child(2) {
    text-align: right;
}

.retention-table th {
    font-weight: 600;
    color: var(--text-muted);
    background-color: var(--bg-color);
}

.retention-cell {
    position: relative;
    font-weight: 500;
}

/* カスタムレポートビルダースタイル */
.builder-section {
    margin-bottom: 2rem;
}

.builder-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-color);
}

.builder-description {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.metrics-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.metric-chip {
    display: inline-flex;
    align-items: center;
    background-color: var(--primary-light);
    color: var(--primary);
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color var(--transition-normal);
}

.metric-chip:hover {
    background-color: rgba(67, 56, 202, 0.2);
}

.metric-chip.selected {
    background-color: var(--primary);
    color: white;
}

.metric-chip i {
    margin-right: 0.5rem;
}

.filter-badge {
    display: inline-flex;
    align-items: center;
    background-color: var(--info-light);
    color: var(--info);
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.filter-badge button {
    background: none;
    border: none;
    color: inherit;
    margin-left: 0.5rem;
    padding: 0;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
}

/* レポート結果スタイル */
.report-result {
    margin-top: 2rem;
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow);
    overflow: hidden;
}

[data-theme="dark"] .report-result {
    background-color: #1e293b;
}

.report-result-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border-color);
}

.report-result-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.report-result-description {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.report-result-body {
    padding: 1.5rem;
}

.report-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
}

/* エクスポートモーダルスタイル */
.export-option {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.export-option:hover {
    border-color: var(--primary);
    background-color: var(--primary-light);
}

.export-option-icon {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius);
    background-color: var(--primary-light);
    color: var(--primary);
    margin-right: 1rem;
}

.export-option-content {
    flex: 1;
}

.export-option-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.export-option-description {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* スケルトンローディングスタイル */
.skeleton-loading {
    background: linear-gradient(90deg, var(--border-color) 25%, var(--bg-color) 50%, var(--border-color) 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: var(--radius);
}

@keyframes skeleton-loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

.skeleton-chart {
    height: 300px;
    width: 100%;
}

.skeleton-row {
    height: 20px;
    margin-bottom: 8px;
}

.skeleton-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

/* ヒートマップスタイル */
.heatmap-table {
    width: 100%;
    border-collapse: collapse;
}

.heatmap-table th, 
.heatmap-table td {
    padding: 0.6rem;
    text-align: center;
    border: 1px solid var(--border-color);
}

.heatmap-table th {
    font-weight: 600;
    color: var(--text-muted);
    background-color: var(--bg-color);
}

.heatmap-cell {
    font-weight: 500;
}

/* 保存済みレポートカードスタイル */
.saved-report-card {
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    display: flex;
    flex-direction: column;
    height: 100%;
}

[data-theme="dark"] .saved-report-card {
    background-color: #1e293b;
}

.saved-report-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.saved-report-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.saved-report-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.saved-report-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
}

.saved-report-body {
    padding: 1rem;
    flex: 1;
}

.saved-report-description {
    font-size: 0.875rem;
    color: var(--text-color);
    margin-bottom: 1rem;
}

.saved-report-footer {
    padding: 0.75rem 1rem;
    background-color: var(--bg-color);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
}

/* レスポンシブ調整 */
@media (max-width: 1024px) {
    .chart-container {
        height: 250px !important;
    }
    
    .grid-3 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .grid-2, .grid-3 {
        grid-template-columns: 1fr;
    }
    
    .report-tabs {
        overflow-x: auto;
    }
    
    .report-tab {
        padding: 0.75rem 1rem;
    }
}

@media (max-width: 480px) {
    .chart-container {
        height: 200px !important;
    }
    
    .filter-panel .d-flex {
        flex-direction: column;
    }
    
    .filter-panel .d-flex > div {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .report-actions {
        flex-direction: column;
    }
}

/* ダークモード調整 */
[data-theme="dark"] .chart-wrapper {
    background-color: #1e293b;
}

[data-theme="dark"] .skeleton-loading {
    background: linear-gradient(90deg, #2d3748 25%, #1e293b 50%, #2d3748 75%);
    background-size: 200% 100%;
}

/* グラデーションバックグラウンド */
.gradient-bg-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
}

.gradient-bg-secondary {
    background: linear-gradient(135deg, var(--secondary), var(--secondary-hover));
    color: white;
}

.gradient-bg-success {
    background: linear-gradient(135deg, var(--success), var(--success-hover));
    color: white;
}

/* カスタムレポートデザイン強化 */
.metrics-container {
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.metrics-container-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
}

.metrics-container-title i {
    margin-right: 0.5rem;
    color: var(--primary);
}

/* レポート詳細ページ専用スタイル */
.report-detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.report-detail-info {
    flex: 1;
}

.report-detail-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.report-detail-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.report-detail-meta-item {
    display: flex;
    align-items: center;
}

.report-detail-meta-item i {
    margin-right: 0.5rem;
    font-size: 0.875rem;
}

.report-detail-actions {
    display: flex;
    gap: 0.75rem;
}

/* タブ内のフォームレイアウト */
.tab-form-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .tab-form-layout {
        grid-template-columns: 1fr;
    }
}

/* グラフとデータカードの組み合わせ */
.graph-with-cards {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 1024px) {
    .graph-with-cards {
        grid-template-columns: 1fr;
    }
}

/* アニメーション効果 */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* カスタム選択ドロップダウン強化 */
.custom-select-wrapper {
    position: relative;
}

.custom-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.625rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    cursor: pointer;
    transition: border-color var(--transition-normal);
    background-color: white;
}

[data-theme="dark"] .custom-select-trigger {
    background-color: #1e293b;
}

.custom-select-trigger:hover {
    border-color: var(--primary);
}

.custom-select-trigger i {
    transition: transform var(--transition-normal);
}

.custom-select-trigger.active i {
    transform: rotate(180deg);
}

.custom-select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: white;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-top: 0.25rem;
    max-height: 250px;
    overflow-y: auto;
    z-index: 50;
    box-shadow: var(--shadow);
    display: none;
}

[data-theme="dark"] .custom-select-options {
    background-color: #1e293b;
}

.custom-select-option {
    padding: 0.625rem 0.75rem;
    cursor: pointer;
    transition: background-color var(--transition-normal);
}

.custom-select-option:hover {
    background-color: var(--primary-light);
}

.custom-select-option.selected {
    background-color: var(--primary-light);
    color: var(--primary);
    font-weight: 500;
}

/* フィルターバッジ強化スタイル */
.filter-chip {
    display: inline-flex;
    align-items: center;
    background-color: var(--primary-light);
    color: var(--primary);
    border-radius: var(--radius-full);
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.filter-chip-remove {
    margin-left: 0.5rem;
    cursor: pointer;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: rgba(67, 56, 202, 0.2);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    transition: background-color var(--transition-normal);
}

.filter-chip-remove:hover {
    background-color: rgba(67, 56, 202, 0.4);
}

/* リテンションヒートマップのカラースケール */
.retention-scale {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
    justify-content: flex-end;
}

.retention-scale-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin: 0 0.5rem;
}

.retention-scale-bar {
    width: 150px;
    height: 10px;
    background: linear-gradient(to right, rgba(79, 70, 229, 0.1), rgba(79, 70, 229, 1));
    border-radius: var(--radius-full);
}

/* デザイン向上のための追加スタイル */
.chart-card {
    background-color: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    transition: transform var(--transition-normal), box-shadow var(--transition-normal);
    height: 100%;
    display: flex;
    flex-direction: column;
}

[data-theme="dark"] .chart-card {
    background-color: #1e293b;
}

.chart-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.chart-card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chart-card-title {
    font-weight: 600;
    font-size: 0.875rem;
}

.chart-card-body {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chart-card-footer {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid var(--border-color);
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
}
        /* レスポンシブデザイン */
        @media (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 240px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- サイドバー -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">
                <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
                <span>管理者パネル</span>
            </a>
        </div>
        
        <div class="sidebar-menu">
            <p class="menu-label">管理</p>
            <a href="#" class="menu-item active" data-section="dashboard">
                <i class="fas fa-th-large"></i> ダッシュボード
            </a>
            <a href="#" class="menu-item" data-section="users">
                <i class="fas fa-users"></i> ユーザー管理
            </a>
            <a href="#" class="menu-item" data-section="activity">
                <i class="fas fa-chart-line"></i> 活動モニタリング
            </a>
            <a href="#" class="menu-item" data-section="content">
                <i class="fas fa-file-alt"></i> コンテンツ管理
            </a>
            <a href="#" class="menu-item" data-section="announcements">
                <i class="fas fa-bullhorn"></i> お知らせ管理
            </a>
            <a href="#" class="menu-item" data-section="reports">
                <i class="fas fa-chart-bar"></i> レポート・分析
            </a>
            
            <p class="menu-label">システム</p>
            <a href="#" class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i> システム設定
            </a>
            <a href="#" class="menu-item" data-section="roles">
                <i class="fas fa-user-shield"></i> 権限・ロール管理
            </a>
            <a href="#" class="menu-item" data-section="logs">
                <i class="fas fa-list"></i> システムログ
            </a>
            
            <p class="menu-label">リンク</p>
            <a href="mainpage.html" class="menu-item">
                <i class="fas fa-external-link-alt"></i> メインサイト
            </a>
        </div>
        
        <div class="sidebar-footer">
            <button id="theme-toggle" class="theme-toggle">
                <i class="fas fa-moon"></i> ダークモード
            </button>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">
                    <span id="user-initial">A</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-user-name">管理者</div>
                    <div class="user-status">管理者ステータス</div>
                </div>
            </div>
            
            <a href="#" id="logout-btn" class="btn btn-outline w-100 mt-3" style="background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2);">
                <i class="fas fa-sign-out-alt"></i> ログアウト
            </a>
        </div>
    </aside>
    
    <!-- モバイル用サイドバー切替ボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- メインコンテンツ -->
    <div class="main-content">
        <!-- システム通知 -->
        <div id="system-notification-container" class="mb-4" style="display: none;">
            <!-- 通知メッセージが動的に追加されます -->
        </div>
        
        <!-- ダッシュボードセクション -->
        <div id="dashboard-section" class="content-section active">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="#">管理者パネル</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>ダッシュボード</span>
                </div>
                <h1 class="page-title">管理者ダッシュボード</h1>
            </div>
            
            <!-- 統計カード -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">登録ユーザー</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-info">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-documents">0</div>
                        <div class="stat-label">ドキュメント総数</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-success">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="active-users">0</div>
                        <div class="stat-label">アクティブユーザー</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon stat-warning">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-posts">0</div>
                        <div class="stat-label">コミュニティ投稿</div>
                    </div>
                </div>
            </div>
            
            <!-- アクティビティチャート -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>ユーザー活動グラフ</h3>
                    <div class="d-flex gap-2">
                        <select id="activity-chart-period" class="form-select" style="width: auto;">
                            <option value="7">過去7日間</option>
                            <option value="30" selected>過去30日間</option>
                            <option value="90">過去3ヶ月</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="activity-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 最近の活動 -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3>最近のユーザー登録</h3>
                        <a href="#" class="btn btn-sm btn-outline" data-section="users">すべて表示</a>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table" id="recent-users-table">
                                <thead>
                                    <tr>
                                        <th>ユーザー</th>
                                        <th>登録日</th>
                                        <th>ステータス</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-users-tbody">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="p-3">
                                                <div class="loading-spinner"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>システム活動ログ</h3>
                        <a href="#" class="btn btn-sm btn-outline" data-section="logs">すべて表示</a>
                    </div>
                    <div class="card-body">
                        <ul class="activity-feed" id="recent-activity-feed">
                            <li class="text-center p-3">
                                <div class="loading-spinner"></div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- クイックアクション -->
            <div class="card-section">
                <div class="section-header">
                    <h2 class="section-title">クイックアクション</h2>
                </div>
                
                <div class="d-flex flex-wrap gap-3">
                    <button class="btn btn-primary" id="new-announcement-btn">
                        <i class="fas fa-bullhorn"></i> お知らせを作成
                    </button>
                    <button class="btn btn-info" id="export-users-btn">
                        <i class="fas fa-file-export"></i> ユーザーリストをエクスポート
                    </button>
                    <button class="btn btn-success" id="usage-report-btn">
                        <i class="fas fa-chart-pie"></i> 利用状況レポート
                    </button>
                    <button class="btn btn-warning" id="system-check-btn">
                        <i class="fas fa-check-circle"></i> システム状態確認
                    </button>
                </div>
            </div>
            
            <!-- システム通知 -->
            <div class="card">
                <div class="card-header">
                    <h3>システム通知</h3>
                </div>
                <div class="card-body">
                    <div id="system-notifications">
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-center">
                                <i class="fas fa-info-circle mr-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div style="font-weight: 500; margin-bottom: 0.25rem;">システム更新のお知らせ</div>
                                    <div style="font-size: 0.875rem;">KatsujiRingXシステムはメンテナンスモードが予定されています。詳細はシステム設定をご確認ください。</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-center">
                                <i class="fas fa-exclamation-triangle mr-3" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div style="font-weight: 500; margin-bottom: 0.25rem;">当WEBサイトについて</div>
                                    <div style="font-size: 0.875rem;"><ul>緊急のお問い合わせは下記にご連絡ください</ul>
                                    <li>Mail：yuya-i2002@outlook.com</li>
                                    <li>TEL：080-9835-0833</li>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ユーザー管理セクション -->
        <div id="users-section" class="content-section">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="#">管理者パネル</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>ユーザー管理</span>
                </div>
                <h1 class="page-title">ユーザー管理</h1>
            </div>
            
            <!-- 検索・フィルター -->
            <div class="filter-panel">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> 検索とフィルター
                </div>
                <div class="d-flex flex-wrap gap-3">
                    <div class="flex-1">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="user-search" placeholder="名前、メールアドレスで検索...">
                        </div>
                    </div>
                    <div>
                        <select class="form-select" id="user-status-filter">
                            <option value="">すべてのステータス</option>
                            <option value="active">アクティブ</option>
                            <option value="inactive">非アクティブ</option>
                            <option value="suspended">停止</option>
                        </select>
                    </div>
                    <div>
                        <select class="form-select" id="user-role-filter">
                            <option value="">すべてのロール</option>
                            <option value="student">学生</option>
                            <option value="teacher">教師</option>
                            <option value="researcher">研究者</option>
                            <option value="admin">管理者</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="apply-user-filters">
                            <i class="fas fa-filter"></i> 適用
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ユーザーリスト -->
            <div class="card">
                <div class="card-header">
                    <h3>ユーザーリスト</h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline" id="bulk-action-btn">
                            <i class="fas fa-cog"></i> 一括操作
                        </button>
                        <button class="btn btn-sm btn-primary" id="add-user-btn">
                            <i class="fas fa-user-plus"></i> 新規ユーザー
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="users-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-users"></th>
                                    <th>ユーザー</th>
                                    <th>ロール</th>
                                    <th>登録日</th>
                                    <th>最終ログイン</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="p-3">
                                            <div class="loading-spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ページネーション -->
                    <div class="pagination" id="users-pagination">
                        <ul class="d-flex">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ユーザー詳細モーダル -->
            <div class="modal-backdrop" id="user-detail-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">ユーザー詳細</h3>
                        <button class="modal-close" id="user-detail-close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="user-detail-content">
                            <div class="d-flex align-center mb-4">
                                <div id="user-detail-avatar" class="table-avatar" style="width: 4rem; height: 4rem; font-size: 1.5rem; margin-right: 1rem;">
                                    U
                                </div>
                                <div>
                                    <h4 id="user-detail-name">ユーザー名</h4>
                                    <div id="user-detail-email" class="text-muted">user@example.com</div>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">ユーザーID</label>
                                    <div id="user-detail-id" class="form-control">UID12345</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ステータス</label>
                                    <div id="user-detail-status" class="form-control">アクティブ</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">登録日</label>
                                    <div id="user-detail-created" class="form-control">2023-01-01</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">最終ログイン</label>
                                    <div id="user-detail-login" class="form-control">2023-03-15</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ロール</label>
                                    <div id="user-detail-roles" class="form-control">学生</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">所属グループ</label>
                                    <div id="user-detail-groups" class="form-control">なし</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">活動統計</label>
                                <div class="d-flex flex-wrap gap-3 mt-2">
                                    <div class="stat-card" style="flex: 1; min-width: 120px;">
                                        <div class="stat-content">
                                            <div id="user-detail-docs" class="stat-value">0</div>
                                            <div class="stat-label">文書数</div>
                                        </div>
                                    </div>
                                    <div class="stat-card" style="flex: 1; min-width: 120px;">
                                        <div class="stat-content">
                                            <div id="user-detail-posts" class="stat-value">0</div>
                                            <div class="stat-label">投稿数</div>
                                        </div>
                                    </div>
                                    <div class="stat-card" style="flex: 1; min-width: 120px;">
                                        <div class="stat-content">
                                            <div id="user-detail-points" class="stat-value">0</div>
                                            <div class="stat-label">ポイント</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 class="mt-4 mb-3">最近の活動</h4>
                            <ul class="activity-feed" id="user-detail-activity">
                                <li class="text-center p-3">
                                    <div class="loading-spinner"></div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="user-detail-cancel-btn">閉じる</button>
                        <button class="btn btn-primary" id="user-detail-edit-btn">編集</button>
                    </div>
                </div>
            </div>
            
            <!-- ユーザー編集モーダル -->
            <div class="modal-backdrop" id="user-edit-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">ユーザー編集</h3>
                        <button class="modal-close" id="user-edit-close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="user-edit-form">
                            <input type="hidden" id="user-edit-id">
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="user-edit-name" class="form-label">ユーザー名</label>
                                    <input type="text" id="user-edit-name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="user-edit-email" class="form-label">メールアドレス</label>
                                    <input type="email" id="user-edit-email" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="user-edit-status" class="form-label">ステータス</label>
                                    <select id="user-edit-status" class="form-select">
                                        <option value="active">アクティブ</option>
                                        <option value="inactive">非アクティブ</option>
                                        <option value="suspended">停止</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="user-edit-role" class="form-label">ロール</label>
                                    <select id="user-edit-role" class="form-select">
                                        <option value="student">学生</option>
                                        <option value="teacher">教師</option>
                                        <option value="researcher">研究者</option>
                                        <option value="admin">管理者</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="user-edit-groups" class="form-label">所属グループ</label>
                                <select id="user-edit-groups" class="form-select" multiple size="4">
                                    <!-- グループは動的に追加されます -->
                                </select>
                                <small class="text-muted">Ctrlキーを押しながら複数選択できます</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">アカウント操作</label>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <button type="button" class="btn btn-warning" id="user-reset-password-btn">
                                        <i class="fas fa-key"></i> パスワードリセット
                                    </button>
                                    <button type="button" class="btn btn-danger" id="user-suspend-btn">
                                        <i class="fas fa-ban"></i> アカウント停止
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="user-edit-cancel-btn">キャンセル</button>
                        <button class="btn btn-primary" id="user-edit-save-btn">保存</button>
                    </div>
                </div>
            </div>
            
            <!-- 新規ユーザー追加モーダル -->
            <div class="modal-backdrop" id="add-user-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">新規ユーザー追加</h3>
                        <button class="modal-close" id="add-user-close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="add-user-form">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="add-user-name" class="form-label">ユーザー名</label>
                                    <input type="text" id="add-user-name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-user-email" class="form-label">メールアドレス</label>
                                    <input type="email" id="add-user-email" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="add-user-password" class="form-label">パスワード</label>
                                    <input type="password" id="add-user-password" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="add-user-confirm-password" class="form-label">パスワード（確認）</label>
                                    <input type="password" id="add-user-confirm-password" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="add-user-role" class="form-label">ロール</label>
                                    <select id="add-user-role" class="form-select">
                                        <option value="student">学生</option>
                                        <option value="teacher">教師</option>
                                        <option value="researcher">研究者</option>
                                        <option value="admin">管理者</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="add-user-groups" class="form-label">所属グループ</label>
                                    <select id="add-user-groups" class="form-select" multiple size="4">
                                        <!-- グループは動的に追加されます -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="add-user-send-email" class="form-check-input" checked>
                                    <label for="add-user-send-email" class="form-check-label">招待メールを送信する</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="add-user-cancel-btn">キャンセル</button>
                        <button class="btn btn-primary" id="add-user-save-btn">ユーザーを作成</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- お知らせ管理セクション -->
        <div id="announcements-section" class="content-section">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="#">管理者パネル</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>お知らせ管理</span>
                </div>
                <h1 class="page-title">お知らせ管理</h1>
            </div>
            
            <!-- お知らせリスト -->
            <div class="card">
                <div class="card-header">
                    <h3>お知らせリスト</h3>
                    <button class="btn btn-primary" id="create-announcement-btn">
                        <i class="fas fa-plus"></i> 新規お知らせ
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="announcements-table">
                            <thead>
                                <tr>
                                    <th>タイトル</th>
                                    <th>公開日</th>
                                    <th>終了日</th>
                                    <th>対象</th>
                                    <th>ステータス</th>
                                    <th>優先度</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="announcements-tbody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="p-3">
                                            <div class="loading-spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- お知らせ作成/編集モーダル -->
            <div class="modal-backdrop" id="announcement-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title" id="announcement-modal-title">新規お知らせ作成</h3>
                        <button class="modal-close" id="announcement-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="announcement-form">
                            <input type="hidden" id="announcement-id">
                            
                            <div class="form-group">
                                <label for="announcement-title" class="form-label">タイトル</label>
                                <input type="text" id="announcement-title" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="announcement-content" class="form-label">内容</label>
                                <textarea id="announcement-content" class="form-control" rows="5" required></textarea>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="announcement-start-date" class="form-label">公開開始日</label>
                                    <input type="date" id="announcement-start-date" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="announcement-end-date" class="form-label">公開終了日</label>
                                    <input type="date" id="announcement-end-date" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="announcement-priority" class="form-label">優先度</label>
                                <select id="announcement-priority" class="form-select">
                                    <option value="low">低</option>
                                    <option value="medium" selected>中</option>
                                    <option value="high">高</option>
                                    <option value="urgent">緊急</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">対象ユーザー</label>
                                <div class="form-check">
                                    <input type="radio" id="target-all" name="target" value="all" class="form-check-input" checked>
                                    <label for="target-all" class="form-check-label">すべてのユーザー</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="target-specific" name="target" value="specific" class="form-check-input">
                                    <label for="target-specific" class="form-check-label">特定のユーザーグループ</label>
                                </div>
                            </div>
                            
                            <div id="specific-targets" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">ユーザーグループを選択</label>
                                    <div class="form-check">
                                        <input type="checkbox" id="target-students" class="form-check-input">
                                        <label for="target-students" class="form-check-label">学生</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" id="target-teachers" class="form-check-input">
                                        <label for="target-teachers" class="form-check-label">教師</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" id="target-researchers" class="form-check-input">
                                        <label for="target-researchers" class="form-check-label">研究者</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" id="target-new-users" class="form-check-input">
                                        <label for="target-new-users" class="form-check-label">新規ユーザー (30日以内)</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="target-custom-list" class="form-label">特定のユーザーリスト</label>
                                    <textarea id="target-custom-list" class="form-control" placeholder="ユーザーIDをカンマ区切りで入力..."></textarea>
                                    <small class="text-muted">複数のユーザーIDをカンマで区切って入力してください。</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="announcement-push" class="form-check-input">
                                    <label for="announcement-push" class="form-check-label">プッシュ通知を送信</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="announcement-email" class="form-check-input">
                                    <label for="announcement-email" class="form-check-label">メール通知を送信</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="announcement-cancel">キャンセル</button>
                        <button class="btn btn-primary" id="announcement-save">保存</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- システムログセクション -->
        <div id="logs-section" class="content-section">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="#">管理者パネル</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>システムログ</span>
                </div>
                <h1 class="page-title">システムログ</h1>
            </div>
            
            <!-- フィルター -->
            <div class="filter-panel">
                <div class="d-flex flex-wrap gap-3">
                    <div class="flex-1">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="log-search" placeholder="ログメッセージで検索...">
                        </div>
                    </div>
                    <div>
                        <select class="form-select" id="log-level-filter">
                            <option value="">すべてのレベル</option>
                            <option value="info">情報</option>
                            <option value="warning">警告</option>
                            <option value="error">エラー</option>
                            <option value="critical">重大</option>
                        </select>
                    </div>
                    <div>
                        <select class="form-select" id="log-date-filter">
                            <option value="today">今日</option>
                            <option value="yesterday">昨日</option>
                            <option value="week" selected>過去7日間</option>
                            <option value="month">過去30日間</option>
                            <option value="custom">カスタム期間</option>
                        </select>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="apply-log-filters">
                            <i class="fas fa-filter"></i> 適用
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline" id="export-logs-btn">
                            <i class="fas fa-file-export"></i> エクスポート
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ログテーブル -->
            <div class="card">
                <div class="card-header">
                    <h3>システムログ</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="logs-table">
                            <thead>
                                <tr>
                                    <th>タイムスタンプ</th>
                                    <th>レベル</th>
                                    <th>ソース</th>
                                    <th>メッセージ</th>
                                    <th>ユーザー</th>
                                    <th>IPアドレス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="p-3">
                                            <div class="loading-spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ページネーション -->
                    <div class="pagination" id="logs-pagination">
                        <ul class="d-flex">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ログ詳細モーダル -->
            <div class="modal-backdrop" id="log-detail-modal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">ログ詳細</h3>
                        <button class="modal-close" id="log-detail-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">タイムスタンプ</label>
                            <div id="log-detail-timestamp" class="form-control">2023-09-01 09:42:15</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">レベル</label>
                            <div id="log-detail-level" class="form-control">情報</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ソース</label>
                            <div id="log-detail-source" class="form-control">認証</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">メッセージ</label>
                            <div id="log-detail-message" class="form-control">ユーザーがログインしました</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ユーザー</label>
                            <div id="log-detail-user" class="form-control">tanaka@example.com</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">IPアドレス</label>
                            <div id="log-detail-ip" class="form-control">192.168.1.10</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">詳細情報</label>
                            <pre id="log-detail-extra" class="form-control" style="min-height: 150px; white-space: pre-wrap;">{
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",
    "requestUrl": "/login",
    "method": "POST",
    "responseCode": 200,
    "processingTime": "235ms"
}</pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="log-detail-close">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- レポート・分析セクション -->
<div id="reports-section" class="content-section">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="#">管理者パネル</a>
            <i class="fas fa-chevron-right"></i>
            <span>レポート・分析</span>
        </div>
        <h1 class="page-title">レポート・分析</h1>
    </div>
    
    <!-- レポートタイプ選択 -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>レポート種別</h3>
        </div>
        <div class="card-body">
            <div class="tabs">
                <div class="tab active" data-tab="user-reports">ユーザー分析</div>
                <div class="tab" data-tab="content-reports">コンテンツ分析</div>
                <div class="tab" data-tab="activity-reports">活動分析</div>
                <div class="tab" data-tab="custom-reports">カスタムレポート</div>
            </div>
            
            <!-- 日付範囲フィルター（共通） -->
            <div class="filter-panel mt-3">
                <div class="d-flex flex-wrap gap-3 align-center">
                    <div>
                        <label class="form-label">期間</label>
                        <select class="form-select" id="report-date-range">
                            <option value="7">過去7日間</option>
                            <option value="30" selected>過去30日間</option>
                            <option value="90">過去3ヶ月</option>
                            <option value="180">過去6ヶ月</option>
                            <option value="365">過去1年</option>
                            <option value="custom">カスタム期間</option>
                        </select>
                    </div>
                    
                    <div id="custom-date-range" style="display: none;" class="d-flex gap-2 align-center">
                        <div>
                            <label class="form-label">開始日</label>
                            <input type="date" id="report-start-date" class="form-control">
                        </div>
                        <div>
                            <label class="form-label">終了日</label>
                            <input type="date" id="report-end-date" class="form-control">
                        </div>
                    </div>
                    
                    <div class="ml-auto">
                        <button class="btn btn-primary" id="generate-report-btn">
                            <i class="fas fa-chart-bar"></i> レポート生成
                        </button>
                        <button class="btn btn-outline ml-2" id="export-report-btn">
                            <i class="fas fa-file-export"></i> エクスポート
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- レポートコンテンツ -->
    <div class="tab-content active" id="user-reports-content">
        <div class="grid-2">
            <!-- ユーザー登録推移 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>ユーザー登録推移</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="user-registration-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- アクティブユーザー -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>アクティブユーザー</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="active-users-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ユーザー属性分析 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>ユーザー属性分析</h3>
            </div>
            <div class="card-body">
                <div class="grid-3">
                    <div>
                        <h4 class="mb-3 text-center">ロール分布</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="user-roles-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-3 text-center">アクティビティレベル</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="user-activity-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-3 text-center">デバイス分布</h4>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="user-devices-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ユーザーリテンション分析 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>ユーザーリテンション分析</h3>
                <div class="d-flex align-center">
                    <span class="text-muted">週次コホート分析</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="data-table" id="retention-table">
                        <thead>
                            <tr>
                                <th>コホート</th>
                                <th>ユーザー数</th>
                                <th>Week 1</th>
                                <th>Week 2</th>
                                <th>Week 3</th>
                                <th>Week 4</th>
                                <th>Week 5</th>
                                <th>Week 6</th>
                                <th>Week 7</th>
                                <th>Week 8</th>
                            </tr>
                        </thead>
                        <tbody id="retention-tbody">
                            <!-- 動的に生成されます -->
                            <tr>
                                <td colspan="10" class="text-center p-3">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="content-reports-content">
        <div class="grid-2">
            <!-- コンテンツ作成推移 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>コンテンツ作成推移</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="content-creation-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 人気コンテンツ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>人気コンテンツ分析</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="content-popularity-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- コンテンツカテゴリ分析 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>コンテンツカテゴリ分析</h3>
            </div>
            <div class="card-body">
                <div class="grid-2">
                    <div>
                        <h4 class="mb-3 text-center">カテゴリ分布</h4>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="content-category-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-3 text-center">カテゴリ別閲覧数</h4>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="category-views-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 上位コンテンツ -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>上位コンテンツ</h3>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="data-table" id="top-content-table">
                        <thead>
                            <tr>
                                <th>タイトル</th>
                                <th>作成者</th>
                                <th>カテゴリ</th>
                                <th>作成日</th>
                                <th>閲覧数</th>
                                <th>評価</th>
                                <th>コメント数</th>
                            </tr>
                        </thead>
                        <tbody id="top-content-tbody">
                            <!-- 動的に生成されます -->
                            <tr>
                                <td colspan="7" class="text-center p-3">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="activity-reports-content">
        <div class="grid-2">
            <!-- ログイン活動 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>ログイン活動</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="login-activity-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 時間帯別使用状況 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>時間帯別使用状況</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hourly-usage-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 機能別使用状況 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>機能別使用状況</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="feature-usage-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ユーザーエンゲージメントスコア -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>ユーザーエンゲージメントスコア</h3>
            </div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="engagement-trend-chart"></canvas>
                    </div>
                    <div>
                        <div class="stat-card mb-3">
                            <div class="stat-icon stat-primary">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="avg-engagement-score">--.--%</div>
                                <div class="stat-label">平均エンゲージメントスコア</div>
                            </div>
                        </div>
                        
                        <div class="stat-card mb-3">
                            <div class="stat-icon stat-success">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="engagement-change">--.--%</div>
                                <div class="stat-label">前月比</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon stat-info">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="retention-rate">--.--%</div>
                                <div class="stat-label">1ヶ月後リテンション率</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- アクセス地域分析 -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>アクセス地域分析</h3>
            </div>
            <div class="card-body">
                <div class="grid-2">
                    <div>
                        <h4 class="mb-3 text-center">地域別ユーザー分布</h4>
                        <div class="table-container">
                            <table class="data-table" id="region-table">
                                <thead>
                                    <tr>
                                        <th>地域</th>
                                        <th>ユーザー数</th>
                                        <th>割合</th>
                                        <th>前月比</th>
                                    </tr>
                                </thead>
                                <tbody id="region-tbody">
                                    <!-- 動的に生成されます -->
                                    <tr>
                                        <td colspan="4" class="text-center p-3">
                                            <div class="loading-spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-3 text-center">地域別分布</h4>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="region-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="custom-reports-content">
        <!-- カスタムレポートビルダー -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>カスタムレポートビルダー</h3>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <p>分析したいデータとメトリクスを選択して、カスタムレポートを作成できます。</p>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">データソース</label>
                        <select class="form-select" id="custom-data-source">
                            <option value="users">ユーザーデータ</option>
                            <option value="content">コンテンツデータ</option>
                            <option value="activity">活動データ</option>
                            <option value="engagement">エンゲージメントデータ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">メトリクス</label>
                        <select class="form-select" id="custom-metrics" multiple size="4">
                            <option value="registrations">登録数</option>
                            <option value="active_users">アクティブユーザー</option>
                            <option value="retention">リテンション率</option>
                            <option value="engagement">エンゲージメントスコア</option>
                            <option value="views">閲覧数</option>
                            <option value="ratings">評価</option>
                            <option value="comments">コメント数</option>
                        </select>
                        <small class="text-muted">Ctrlキーを押しながら複数選択できます</small>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">グループ化</label>
                        <select class="form-select" id="custom-grouping">
                            <option value="daily">日別</option>
                            <option value="weekly">週別</option>
                            <option value="monthly" selected>月別</option>
                            <option value="quarterly">四半期別</option>
                            <option value="yearly">年別</option>
                            <option value="category">カテゴリ別</option>
                            <option value="role">ユーザーロール別</option>
                            <option value="region">地域別</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">表示形式</label>
                        <select class="form-select" id="custom-visualization">
                            <option value="line">折れ線グラフ</option>
                            <option value="bar">棒グラフ</option>
                            <option value="pie">円グラフ</option>
                            <option value="table">テーブル</option>
                            <option value="heatmap">ヒートマップ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">フィルター（オプション）</label>
                    <div class="d-flex gap-3 mb-2">
                        <select class="form-select" id="custom-filter-field">
                            <option value="">フィールド選択...</option>
                            <option value="role">ユーザーロール</option>
                            <option value="category">コンテンツカテゴリ</option>
                            <option value="region">地域</option>
                            <option value="device">デバイス</option>
                            <option value="registration_date">登録日</option>
                        </select>
                        
                        <select class="form-select" id="custom-filter-operator">
                            <option value="equals">等しい</option>
                            <option value="not_equals">等しくない</option>
                            <option value="contains">含む</option>
                            <option value="greater_than">より大きい</option>
                            <option value="less_than">より小さい</option>
                        </select>
                        
                        <input type="text" class="form-control" id="custom-filter-value" placeholder="値を入力...">
                        
                        <button class="btn btn-outline" id="add-filter-btn">
                            <i class="fas fa-plus"></i> 追加
                        </button>
                    </div>
                    
                    <div id="applied-filters" class="mb-3">
                        <!-- 適用されたフィルターがここに表示されます -->
                    </div>
                </div>
                
                <div class="d-flex justify-center mt-4">
                    <button class="btn btn-primary" id="build-custom-report-btn">
                        <i class="fas fa-chart-pie"></i> レポート生成
                    </button>
                </div>
            </div>
        </div>
        
        <!-- カスタムレポート結果 -->
        <div class="card mb-4" id="custom-report-results" style="display: none;">
            <div class="card-header">
                <h3>カスタムレポート結果</h3>
            </div>
            <div class="card-body">
                <div id="custom-report-header" class="mb-4">
                    <h4 id="custom-report-title">レポートタイトル</h4>
                    <p id="custom-report-description">レポート期間: 2023年10月1日 - 2023年12月31日</p>
                </div>
                
                <div id="custom-report-visualization">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="custom-report-chart"></canvas>
                    </div>
                </div>
                
                <div id="custom-report-table-container" class="mt-4" style="display: none;">
                    <div class="table-container">
                        <table class="data-table" id="custom-report-table">
                            <thead>
                                <tr id="custom-report-table-header">
                                    <!-- 動的に生成されるヘッダー -->
                                </tr>
                            </thead>
                            <tbody id="custom-report-table-body">
                                <!-- 動的に生成されるテーブル本体 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 保存済みレポート -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>保存済みレポート</h3>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="data-table" id="saved-reports-table">
                        <thead>
                            <tr>
                                <th>レポート名</th>
                                <th>作成日</th>
                                <th>データソース</th>
                                <th>作成者</th>
                                <th>最終更新</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="saved-reports-tbody">
                            <!-- 動的に生成されます -->
                            <tr>
                                <td colspan="6" class="text-center p-3">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- エクスポートモーダル -->
<div class="modal-backdrop" id="export-modal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">レポートのエクスポート</h3>
            <button class="modal-close" id="export-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>エクスポート形式を選択してください：</p>
            <div class="d-flex flex-column gap-3 mt-3">
                <button class="btn btn-outline w-100 text-left export-format-btn" data-format="csv">
                    <i class="fas fa-file-csv mr-2"></i> CSV形式
                    <div class="text-muted" style="font-size: 0.8rem;">スプレッドシートでの解析に最適</div>
                </button>
                <button class="btn btn-outline w-100 text-left export-format-btn" data-format="pdf">
                    <i class="fas fa-file-pdf mr-2"></i> PDF形式
                    <div class="text-muted" style="font-size: 0.8rem;">印刷やプレゼンテーション用</div>
                </button>
                <button class="btn btn-outline w-100 text-left export-format-btn" data-format="excel">
                    <i class="fas fa-file-excel mr-2"></i> Excel形式
                    <div class="text-muted" style="font-size: 0.8rem;">詳細な分析や計算用</div>
                </button>
                <button class="btn btn-outline w-100 text-left export-format-btn" data-format="image">
                    <i class="fas fa-file-image mr-2"></i> 画像形式 (PNG)
                    <div class="text-muted" style="font-size: 0.8rem;">チャート・グラフのみをエクスポート</div>
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" id="export-modal-cancel">キャンセル</button>
        </div>
    </div>
</div>

    <!-- JavaScripts -->
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
            authDomain: "katsujiringx.firebaseapp.com",
            projectId: "katsujiringx",
            storageBucket: "katsujiringx.firebasestorage.app",
            messagingSenderId: "831784731743",
            appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
            measurementId: "G-LPCRE3WYZR"
        };

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Firebaseサービスへの参照
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 日本語ロケールの設定
        auth.languageCode = 'ja';

        // DOM要素
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const logoutBtn = document.getElementById('logout-btn');
        const menuItems = document.querySelectorAll('.menu-item[data-section]');
        const contentSections = document.querySelectorAll('.content-section');
        const systemNotificationContainer = document.getElementById('system-notification-container');
        
        // モーダル関連の要素
        const announcementModal = document.getElementById('announcement-modal');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userEditModal = document.getElementById('user-edit-modal');
        const addUserModal = document.getElementById('add-user-modal');
        const logDetailModal = document.getElementById('log-detail-modal');
        
        // ボタン
        const createAnnouncementBtn = document.getElementById('create-announcement-btn');
        const newAnnouncementBtn = document.getElementById('new-announcement-btn');
        const announcementModalClose = document.getElementById('announcement-modal-close');
        const announcementCancel = document.getElementById('announcement-cancel');
        const announcementSave = document.getElementById('announcement-save');
        const addUserBtn = document.getElementById('add-user-btn');
        const exportUsersBtn = document.getElementById('export-users-btn');
        const usageReportBtn = document.getElementById('usage-report-btn');
        const systemCheckBtn = document.getElementById('system-check-btn');
        
        // フォーム関連
        const targetAllRadio = document.getElementById('target-all');
        const targetSpecificRadio = document.getElementById('target-specific');
        const specificTargets = document.getElementById('specific-targets');
        
        // ユーザー管理関連
        let currentUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        
        // お知らせ管理関連
        let currentAnnouncements = [];
        
        // ログ管理関連
        let currentLogs = [];
        let currentLogPage = 1;
        const logsPerPage = 10;
        
        // チャート
        let activityChart = null;

        // 認証状態の監視
        auth.onAuthStateChanged(user => {
            if (user) {
                // 管理者権限確認
                checkAdminRole(user.uid);
                // ユーザー情報読み込み
                loadUserInfo(user);
                // ダッシュボードデータ読み込み
                loadDashboardData();
            } else {
                // ログインページにリダイレクト
                window.location.href = 'login.html';
            }
        });

        // 管理者権限の確認
        async function checkAdminRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // 管理者ではない場合
                    if (!userData.roles || !userData.roles.includes('admin')) {
                        showSystemNotification('管理者権限がありません。メインページにリダイレクトします。', 'danger');
                        setTimeout(() => {
                            window.location.href = 'mainpage.html';
                        }, 3000);
                    }
                } else {
                    showSystemNotification('ユーザー情報が見つかりません。', 'danger');
                    setTimeout(() => {
                        window.location.href = 'mainpage.html';
                    }, 3000);
                }
            } catch (error) {
                console.error('管理者権限確認エラー:', error);
                showSystemNotification('エラーが発生しました。', 'danger');
                setTimeout(() => {
                    window.location.href = 'mainpage.html';
                }, 3000);
            }
        }

        // ユーザー情報の読み込み
        function loadUserInfo(user) {
            const userInitial = document.getElementById('user-initial');
            const sidebarUserName = document.getElementById('sidebar-user-name');
            
            if (user.displayName) {
                const initial = user.displayName.charAt(0).toUpperCase();
                if (userInitial) userInitial.textContent = initial;
                if (sidebarUserName) sidebarUserName.textContent = user.displayName;
            } else if (user.email) {
                const initial = user.email.charAt(0).toUpperCase();
                if (userInitial) userInitial.textContent = initial;
                if (sidebarUserName) sidebarUserName.textContent = user.email;
            }
        }

        // システム通知を表示
        function showSystemNotification(message, type = 'info') {
            if (!systemNotificationContainer) return;
            
            // 通知タイプに応じたクラス
            let alertClass = 'alert-info';
            let iconClass = 'fas fa-info-circle';
            
            switch (type) {
                case 'success':
                    alertClass = 'alert-success';
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'danger':
                    alertClass = 'alert-danger';
                    iconClass = 'fas fa-exclamation-circle';
                    break;
            }
            
            // 通知HTML作成
            const notificationHTML = `
                <div class="alert ${alertClass} mb-3">
                    <div class="d-flex align-center">
                        <i class="${iconClass} mr-3" style="font-size: 1.5rem;"></i>
                        <div>
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            // 通知コンテナに追加
            systemNotificationContainer.innerHTML = notificationHTML;
            systemNotificationContainer.style.display = 'block';
            
            // 3秒後に自動消去（成功・情報通知のみ）
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    systemNotificationContainer.style.display = 'none';
                }, 3000);
            }
        }

        // ダッシュボードデータの読み込み
        async function loadDashboardData() {
            try {
                const stats = await fetchStatistics();
                displayStatistics(stats);
                
                await Promise.all([
                    fetchRecentUsers(),
                    fetchRecentActivities(),
                    createActivityChart()
                ]);
                
                // システム通知
                showSystemNotification('ダッシュボードが更新されました', 'success');
            } catch (error) {
                console.error('ダッシュボードデータ読み込みエラー:', error);
                showSystemNotification('データの読み込み中にエラーが発生しました', 'danger');
            }
        }

        // 統計データの取得
        async function fetchStatistics() {
            // ユーザー総数
            const usersSnapshot = await db.collection('users').get();
            const totalUsers = usersSnapshot.size;
            
            // ドキュメント総数
            const documentsSnapshot = await db.collection('documents').get();
            const totalDocuments = documentsSnapshot.size;
            
            // アクティブユーザー数（過去30日間にログインしたユーザー）
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const activeUsersSnapshot = await db.collection('users')
                .where('lastLoginAt', '>=', thirtyDaysAgo)
                .get();
            const activeUsers = activeUsersSnapshot.size;
            
            // コミュニティ投稿数
            const postsSnapshot = await db.collection('posts').get();
            const totalPosts = postsSnapshot.size;
            
            return {
                totalUsers,
                totalDocuments,
                activeUsers,
                totalPosts
            };
        }

        // 統計データの表示
        function displayStatistics(stats) {
            document.getElementById('total-users').textContent = stats.totalUsers;
            document.getElementById('total-documents').textContent = stats.totalDocuments;
            document.getElementById('active-users').textContent = stats.activeUsers;
            document.getElementById('total-posts').textContent = stats.totalPosts;
        }

        // 最近のユーザーを取得
        async function fetchRecentUsers() {
            try {
                const recentUsersSnapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();
                
                const recentUsersTbody = document.getElementById('recent-users-tbody');
                
                if (recentUsersSnapshot.empty) {
                    recentUsersTbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">ユーザーが見つかりません</td>
                        </tr>
                    `;
                    return;
                }
                
                recentUsersTbody.innerHTML = '';
                
                recentUsersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userId = doc.id;
                    
                    // 登録日のフォーマット
                    const createdAt = userData.createdAt ? userData.createdAt.toDate() : new Date();
                    const formattedDate = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    }).format(createdAt);
                    
                    // ユーザーの初期文字
                    const userInitial = userData.displayName ? 
                        userData.displayName.charAt(0).toUpperCase() : 
                        (userData.email ? userData.email.charAt(0).toUpperCase() : 'U');
                    
                    // ステータスバッジ
                    let statusBadge = '<span class="badge badge-success">アクティブ</span>';
                    if (userData.status === 'inactive') {
                        statusBadge = '<span class="badge badge-secondary">非アクティブ</span>';
                    } else if (userData.status === 'suspended') {
                        statusBadge = '<span class="badge badge-danger">停止</span>';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="user-name-cell">
                            <div class="table-avatar">${userInitial}</div>
                            <div class="user-info">
                                <div>${userData.displayName || '名前なし'}</div>
                                <div class="user-email">${userData.email || ''}</div>
                            </div>
                        </td>
                        <td>${formattedDate}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline btn-icon view-user-btn" data-user-id="${userId}" title="詳細">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline btn-icon edit-user-btn" data-user-id="${userId}" title="編集">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    recentUsersTbody.appendChild(row);
                });
                
                // ユーザー詳細ボタンにイベントリスナーを追加
                document.querySelectorAll('.view-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userId;
                        openUserDetailModal(userId);
                    });
                });
                
                // ユーザー編集ボタンにイベントリスナーを追加
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userId;
                        openUserEditModal(userId);
                    });
                });
            } catch (error) {
                console.error('最近のユーザー取得エラー:', error);
                
                const recentUsersTbody = document.getElementById('recent-users-tbody');
                recentUsersTbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">ユーザーデータの読み込み中にエラーが発生しました</td>
                    </tr>
                `;
            }
        }

        // 最近の活動を取得
        async function fetchRecentActivities() {
            try {
                // activityコレクションから最新5件を取得
                const recentActivitySnapshot = await db.collection('activities')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                const recentActivityFeed = document.getElementById('recent-activity-feed');
                
                if (recentActivitySnapshot.empty) {
                    recentActivityFeed.innerHTML = `<li class="text-center">活動記録が見つかりません</li>`;
                    return;
                }
                
                recentActivityFeed.innerHTML = '';
                
                recentActivitySnapshot.forEach(doc => {
                    const activity = doc.data();
                    
                    // 日時のフォーマット
                    const timestamp = activity.timestamp ? activity.timestamp.toDate() : new Date();
                    const formattedDate = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(timestamp);
                    
                    // アクティビティタイプに応じたアイコン
                    let iconClass = 'fas fa-history';
                    
                    switch (activity.type) {
                        case 'document_created':
                            iconClass = 'fas fa-file-alt';
                            break;
                        case 'document_edited':
                            iconClass = 'fas fa-edit';
                            break;
                        case 'login':
                            iconClass = 'fas fa-sign-in-alt';
                            break;
                        case 'logout':
                            iconClass = 'fas fa-sign-out-alt';
                            break;
                        case 'account_created':
                            iconClass = 'fas fa-user-plus';
                            break;
                        case 'post_created':
                            iconClass = 'fas fa-comment-alt';
                            break;
                        case 'announcement_created':
                            iconClass = 'fas fa-bullhorn';
                            break;
                    }
                    
                    const activityItem = document.createElement('li');
                    activityItem.className = 'activity-item';
                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title || 'アクティビティ'}</div>
                            <div class="activity-meta">
                                <span class="activity-user">${activity.userName || activity.userId || 'ユーザー'}</span>
                                <span class="activity-time">${formattedDate}</span>
                            </div>
                            <div class="activity-description">${activity.description || ''}</div>
                        </div>
                    `;
                    
                    recentActivityFeed.appendChild(activityItem);
                });
            } catch (error) {
                console.error('最近の活動取得エラー:', error);
                
                const recentActivityFeed = document.getElementById('recent-activity-feed');
                recentActivityFeed.innerHTML = `<li class="text-center">活動データの読み込み中にエラーが発生しました</li>`;
            }
        }

        // 活動チャートの作成
        async function createActivityChart() {
            try {
                const canvas = document.getElementById('activity-chart');
                if (!canvas) return;
                
                // チャート期間（デフォルトは30日）
                const days = parseInt(document.getElementById('activity-chart-period').value) || 30;
                
                // 日付ラベルを作成
                const labels = [];
                const now = new Date();
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    labels.push(new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(date));
                }
                
                // 活動データを取得
                const loginData = await getActivityCountByDate('login', days);
                const documentData = await getActivityCountByDate('document_created', days);
                const postData = await getActivityCountByDate('post_created', days);
                
                // 既存のチャートを破棄
                if (activityChart) {
                    activityChart.destroy();
                }
                
                // チャート作成
                activityChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ログイン',
                                data: loginData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '文書作成',
                                data: documentData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: '投稿',
                                data: postData,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
                
                // チャート期間変更イベントリスナー
                document.getElementById('activity-chart-period').addEventListener('change', createActivityChart);
            } catch (error) {
                console.error('活動チャート作成エラー:', error);
            }
        }

        // 日付ごとの活動数を取得
        async function getActivityCountByDate(activityType, days) {
            const result = new Array(days).fill(0);
            
            try {
                // 期間の開始日を計算
                const now = new Date();
                const startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                startDate.setDate(startDate.getDate() - (days - 1));
                
                // 活動データをFirestoreから取得
                const activitiesSnapshot = await db.collection('activities')
                    .where('type', '==', activityType)
                    .where('timestamp', '>=', startDate)
                    .orderBy('timestamp', 'asc')
                    .get();
                
                // 各活動を日付ごとにカウント
                activitiesSnapshot.forEach(doc => {
                    const activity = doc.data();
                    const timestamp = activity.timestamp.toDate();
                    const dayDiff = Math.floor((timestamp - startDate) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff >= 0 && dayDiff < days) {
                        result[dayDiff]++;
                    }
                });
            } catch (error) {
                console.error(`${activityType}の活動データ取得エラー:`, error);
            }
            
            return result;
        }

        // ユーザー一覧の読み込み
        async function loadUsers() {
            try {
                const usersTbody = document.getElementById('users-tbody');
                usersTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="p-3">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // フィルター条件の取得
                const searchTerm = document.getElementById('user-search').value.toLowerCase();
                const statusFilter = document.getElementById('user-status-filter').value;
                const roleFilter = document.getElementById('user-role-filter').value;
                
                // Firestoreクエリの構築
                let query = db.collection('users').orderBy('createdAt', 'desc');
                
                // ステータスフィルター
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                // クエリ実行
                const snapshot = await query.get();
                
                // 結果をフィルタリング（クライアントサイドでロールフィルタリング）
                currentUsers = [];
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    userData.id = doc.id;
                    
                    // 検索語でフィルタリング
                    if (searchTerm) {
                        const displayName = (userData.displayName || '').toLowerCase();
                        const email = (userData.email || '').toLowerCase();
                        
                        if (!displayName.includes(searchTerm) && !email.includes(searchTerm)) {
                            return;
                        }
                    }
                    
                    // ロールでフィルタリング
                    if (roleFilter && (!userData.roles || !userData.roles.includes(roleFilter))) {
                        return;
                    }
                    
                    currentUsers.push(userData);
                });
                
                // ページネーション更新
                updateUsersPagination();
                
                // 現在のページのユーザーを表示
                displayUsers();
            } catch (error) {
                console.error('ユーザーリスト読み込みエラー:', error);
                showSystemNotification('ユーザーデータの読み込み中にエラーが発生しました', 'danger');
                
                const usersTbody = document.getElementById('users-tbody');
                usersTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">データの読み込み中にエラーが発生しました</td>
                    </tr>
                `;
            }
        }

        // ユーザーページネーションの更新
        function updateUsersPagination() {
            const totalPages = Math.ceil(currentUsers.length / usersPerPage);
            const pagination = document.getElementById('users-pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let paginationHTML = `
                <ul class="d-flex">
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
            `;
            
            // ページ番号を表示
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // 最初のページ
                    i === totalPages || // 最後のページ
                    (i >= currentPage - 1 && i <= currentPage + 1) // 現在のページの前後
                ) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                } else if (
                    (i === 2 && currentPage > 3) || // 最初のページの後に...
                    (i === totalPages - 1 && currentPage < totalPages - 2) // 最後のページの前に...
                ) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `;
                }
            }
            
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
            `;
            
            pagination.innerHTML = paginationHTML;
            
            // ページ切り替えイベントリスナー
            document.querySelectorAll('#users-pagination .page-link').forEach(link => {
                if (!link.parentElement.classList.contains('disabled')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.currentTarget.dataset.page);
                        
                        if (page && page !== currentPage) {
                            currentPage = page;
                            displayUsers();
                            updateUsersPagination();
                        }
                    });
                }
            });
        }

        // 現在のページのユーザーを表示
        function displayUsers() {
            const usersTbody = document.getElementById('users-tbody');
            
            if (currentUsers.length === 0) {
                usersTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">ユーザーが見つかりません</td>
                    </tr>
                `;
                return;
            }
            
            // 現在のページのユーザーを取得
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = Math.min(startIndex + usersPerPage, currentUsers.length);
            const pageUsers = currentUsers.slice(startIndex, endIndex);
            
            usersTbody.innerHTML = '';
            
            pageUsers.forEach((user) => {
                // ユーザーの初期文字
                const userInitial = user.displayName ? 
                    user.displayName.charAt(0).toUpperCase() : 
                    (user.email ? user.email.charAt(0).toUpperCase() : 'U');
                
                // 登録日のフォーマット
                const createdAt = user.createdAt ? user.createdAt.toDate() : new Date();
                const formattedCreatedAt = new Intl.DateTimeFormat('ja-JP', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(createdAt);
                
                // 最終ログイン日のフォーマット
                let formattedLastLogin = '未ログイン';
                if (user.lastLoginAt) {
                    const lastLoginAt = user.lastLoginAt.toDate();
                    formattedLastLogin = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(lastLoginAt);
                }
                
                // ステータスバッジ
                let statusBadge = '<span class="badge badge-success">アクティブ</span>';
                if (user.status === 'inactive') {
                    statusBadge = '<span class="badge badge-secondary">非アクティブ</span>';
                } else if (user.status === 'suspended') {
                    statusBadge = '<span class="badge badge-danger">停止</span>';
                }
                
                // ロールの表示
                let roleText = '一般';
                if (user.roles) {
                    if (user.roles.includes('admin')) {
                        roleText = '管理者';
                    } else if (user.roles.includes('teacher')) {
                        roleText = '教師';
                    } else if (user.roles.includes('researcher')) {
                        roleText = '研究者';
                    } else if (user.roles.includes('student')) {
                        roleText = '学生';
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="user-select-checkbox" data-user-id="${user.id}"></td>
                    <td class="user-name-cell">
                        <div class="table-avatar">${userInitial}</div>
                        <div class="user-info">
                            <div>${user.displayName || '名前なし'}</div>
                            <div class="user-email">${user.email || ''}</div>
                        </div>
                    </td>
                    <td>${roleText}</td>
                    <td>${formattedCreatedAt}</td>
                    <td>${formattedLastLogin}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline btn-icon view-user-btn" data-user-id="${user.id}" title="詳細">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline btn-icon edit-user-btn" data-user-id="${user.id}" title="編集">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline btn-icon delete-user-btn" data-user-id="${user.id}" title="削除">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                usersTbody.appendChild(row);
            });
            
            // 全選択チェックボックスのイベントリスナー
            const selectAllCheckbox = document.getElementById('select-all-users');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    document.querySelectorAll('.user-select-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }
            
            // 各ボタンにイベントリスナーを追加
            document.querySelectorAll('.view-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userId;
                    openUserDetailModal(userId);
                });
            });
            
            document.querySelectorAll('.edit-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userId;
                    openUserEditModal(userId);
                });
            });
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userId;
                    if (confirm('このユーザーを削除してもよろしいですか？この操作は元に戻せません。')) {
                        deleteUser(userId);
                    }
                });
            });
        }

        // ユーザー詳細モーダルを開く
        async function openUserDetailModal(userId) {
            try {
                // ユーザーデータを取得
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    showSystemNotification('ユーザーが見つかりません', 'warning');
                    return;
                }
                
                const userData = userDoc.data();
                
                // ユーザー詳細を表示
                const userDetailAvatar = document.getElementById('user-detail-avatar');
                const userDetailName = document.getElementById('user-detail-name');
                const userDetailEmail = document.getElementById('user-detail-email');
                const userDetailId = document.getElementById('user-detail-id');
                const userDetailStatus = document.getElementById('user-detail-status');
                const userDetailCreated = document.getElementById('user-detail-created');
                const userDetailLogin = document.getElementById('user-detail-login');
                const userDetailRoles = document.getElementById('user-detail-roles');
                const userDetailGroups = document.getElementById('user-detail-groups');
                const userDetailDocs = document.getElementById('user-detail-docs');
                const userDetailPosts = document.getElementById('user-detail-posts');
                const userDetailPoints = document.getElementById('user-detail-points');
                
                // ユーザーの初期文字
                const userInitial = userData.displayName ? 
                    userData.displayName.charAt(0).toUpperCase() : 
                    (userData.email ? userData.email.charAt(0).toUpperCase() : 'U');
                
                userDetailAvatar.textContent = userInitial;
                userDetailName.textContent = userData.displayName || '名前なし';
                userDetailEmail.textContent = userData.email || '';
                userDetailId.textContent = userId;
                
                // ステータス
                let statusText = 'アクティブ';
                if (userData.status === 'inactive') {
                    statusText = '非アクティブ';
                } else if (userData.status === 'suspended') {
                    statusText = '停止';
                }
                userDetailStatus.textContent = statusText;
                
                // 日付
                const createdAt = userData.createdAt ? userData.createdAt.toDate() : new Date();
                userDetailCreated.textContent = new Intl.DateTimeFormat('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(createdAt);
                
                // 最終ログイン
                let lastLoginText = '未ログイン';
                if (userData.lastLoginAt) {
                    const lastLoginAt = userData.lastLoginAt.toDate();
                    lastLoginText = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(lastLoginAt);
                }
                userDetailLogin.textContent = lastLoginText;
                
                // ロール
                let rolesText = '一般';
                if (userData.roles && userData.roles.length > 0) {
                    rolesText = userData.roles.map(role => {
                        switch (role) {
                            case 'admin': return '管理者';
                            case 'teacher': return '教師';
                            case 'researcher': return '研究者';
                            case 'student': return '学生';
                            default: return role;
                        }
                    }).join(', ');
                }
                userDetailRoles.textContent = rolesText;
                
                // グループ
                let groupsText = 'なし';
                if (userData.groups && userData.groups.length > 0) {
                    groupsText = userData.groups.join(', ');
                }
                userDetailGroups.textContent = groupsText;
                
                // 統計
                userDetailDocs.textContent = userData.documentCount || '0';
                userDetailPosts.textContent = userData.communityPosts || '0';
                userDetailPoints.textContent = userData.points || '0';
                
                // 最近の活動を読み込み
                await loadUserActivity(userId);
                
                // 編集ボタンにユーザーIDを設定
                document.getElementById('user-detail-edit-btn').dataset.userId = userId;
                
                // モーダルを表示
                userDetailModal.classList.add('show');
            } catch (error) {
                console.error('ユーザー詳細読み込みエラー:', error);
                showSystemNotification('ユーザー詳細の読み込み中にエラーが発生しました', 'danger');
            }
        }

        // ユーザーの最近の活動を読み込み
        async function loadUserActivity(userId) {
            try {
                const activityList = document.getElementById('user-detail-activity');
                activityList.innerHTML = `
                    <li class="text-center p-3">
                        <div class="loading-spinner"></div>
                    </li>
                `;
                
                // ユーザーの最近の活動を取得
                const activitySnapshot = await db.collection('activities')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                if (activitySnapshot.empty) {
                    activityList.innerHTML = `<li class="text-center">活動記録が見つかりません</li>`;
                    return;
                }
                
                activityList.innerHTML = '';
                
                activitySnapshot.forEach(doc => {
                    const activity = doc.data();
                    
                    // 日時のフォーマット
                    const timestamp = activity.timestamp ? activity.timestamp.toDate() : new Date();
                    const formattedDate = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(timestamp);
                    
                    // アクティビティタイプに応じたアイコン
                    let iconClass = 'fas fa-history';
                    
                    switch (activity.type) {
                        case 'document_created':
                            iconClass = 'fas fa-file-alt';
                            break;
                        case 'document_edited':
                            iconClass = 'fas fa-edit';
                            break;
                        case 'login':
                            iconClass = 'fas fa-sign-in-alt';
                            break;
                        case 'logout':
                            iconClass = 'fas fa-sign-out-alt';
                            break;
                        case 'post_created':
                            iconClass = 'fas fa-comment-alt';
                            break;
                    }
                    
                    const activityItem = document.createElement('li');
                    activityItem.className = 'activity-item';
                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title || 'アクティビティ'}</div>
                            <div class="activity-time">${formattedDate}</div>
                            <div class="activity-description">${activity.description || ''}</div>
                        </div>
                    `;
                    
                    activityList.appendChild(activityItem);
                });
            } catch (error) {
                console.error('ユーザー活動読み込みエラー:', error);
                
                const activityList = document.getElementById('user-detail-activity');
                activityList.innerHTML = `<li class="text-center">活動データの読み込み中にエラーが発生しました</li>`;
            }
        }

        // ユーザー編集モーダルを開く
        async function openUserEditModal(userId) {
            try {
                // ユーザーデータを取得
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    showSystemNotification('ユーザーが見つかりません', 'warning');
                    return;
                }
                
                const userData = userDoc.data();
                
                // フォームに値を設定
                document.getElementById('user-edit-id').value = userId;
                document.getElementById('user-edit-name').value = userData.displayName || '';
                document.getElementById('user-edit-email').value = userData.email || '';
                
                // ステータス
                const statusSelect = document.getElementById('user-edit-status');
                statusSelect.value = userData.status || 'active';
                
                // ロール
                const roleSelect = document.getElementById('user-edit-role');
                if (userData.roles && userData.roles.length > 0) {
                    if (userData.roles.includes('admin')) {
                        roleSelect.value = 'admin';
                    } else if (userData.roles.includes('teacher')) {
                        roleSelect.value = 'teacher';
                    } else if (userData.roles.includes('researcher')) {
                        roleSelect.value = 'researcher';
                    } else if (userData.roles.includes('student')) {
                        roleSelect.value = 'student';
                    } else {
                        roleSelect.value = 'student';
                    }
                } else {
                    roleSelect.value = 'student';
                }
                
                // グループを読み込み
                await loadGroups('user-edit-groups');
                
                // ユーザーのグループを選択
                if (userData.groups && userData.groups.length > 0) {
                    const groupSelect = document.getElementById('user-edit-groups');
                    
                    Array.from(groupSelect.options).forEach(option => {
                        option.selected = userData.groups.includes(option.value);
                    });
                }
                
                // モーダルを表示
                userEditModal.classList.add('show');
            } catch (error) {
                console.error('ユーザー編集画面読み込みエラー:', error);
                showSystemNotification('ユーザー情報の読み込み中にエラーが発生しました', 'danger');
            }
        }

        // グループリストを読み込み
        async function loadGroups(selectId) {
            try {
                const groupSelect = document.getElementById(selectId);
                
                if (!groupSelect) return;
                
                // グループ一覧を取得
                const groupsSnapshot = await db.collection('groups').get();
                
                // グループが無い場合
                if (groupsSnapshot.empty) {
                    groupSelect.innerHTML = '<option value="">グループがありません</option>';
                    return;
                }
                
                // 既存のオプションをクリア
                groupSelect.innerHTML = '';
                
                groupsSnapshot.forEach(doc => {
                    const group = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = group.name || doc.id;
                    groupSelect.appendChild(option);
                });
            } catch (error) {
                console.error('グループ一覧読み込みエラー:', error);
                
                const groupSelect = document.getElementById(selectId);
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">読み込みエラー</option>';
                }
            }
        }

        // ユーザー編集フォームを保存
        async function saveUserEdit() {
            try {
                // フォームデータの取得
                const userId = document.getElementById('user-edit-id').value;
                const displayName = document.getElementById('user-edit-name').value;
                const email = document.getElementById('user-edit-email').value;
                const status = document.getElementById('user-edit-status').value;
                const role = document.getElementById('user-edit-role').value;
                
                // グループ選択（複数選択）
                const groupSelect = document.getElementById('user-edit-groups');
                const selectedGroups = Array.from(groupSelect.selectedOptions).map(option => option.value);
                
                // ロールの設定
                let roles = ['user'];
                if (role !== 'user') {
                    roles.push(role);
                }
                
                // 更新データの作成
                const updateData = {
                    displayName,
                    status,
                    roles,
                    groups: selectedGroups,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Firestoreを更新
                await db.collection('users').doc(userId).update(updateData);
                
                // 管理ログを記録
                await db.collection('adminLogs').add({
                    action: 'edit_user',
                    adminId: auth.currentUser.uid,
                    adminEmail: auth.currentUser.email,
                    targetUserId: userId,
                    details: {
                        displayName,
                        status,
                        roles,
                        groups: selectedGroups
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // モーダルを閉じる
                userEditModal.classList.remove('show');
                
                // ユーザーリストを再読み込み
                loadUsers();
                
                showSystemNotification('ユーザー情報を更新しました', 'success');
            } catch (error) {
                console.error('ユーザー編集保存エラー:', error);
                showSystemNotification('ユーザー情報の保存中にエラーが発生しました', 'danger');
            }
        }

        // 新規ユーザー追加モーダルを開く
        async function openAddUserModal() {
            try {
                // フォームをリセット
                document.getElementById('add-user-form').reset();
                
                // グループを読み込み
                await loadGroups('add-user-groups');
                
                // モーダルを表示
                addUserModal.classList.add('show');
            } catch (error) {
                console.error('ユーザー追加モーダル表示エラー:', error);
                showSystemNotification('モーダルの表示中にエラーが発生しました', 'danger');
            }
        }

        // 新規ユーザーを作成
        async function createUser() {
            try {
                // フォームデータの取得
                const displayName = document.getElementById('add-user-name').value;
                const email = document.getElementById('add-user-email').value;
                const password = document.getElementById('add-user-password').value;
                const confirmPassword = document.getElementById('add-user-confirm-password').value;
                const role = document.getElementById('add-user-role').value;
                const sendEmail = document.getElementById('add-user-send-email').checked;
                
                // グループ選択（複数選択）
                const groupSelect = document.getElementById('add-user-groups');
                const selectedGroups = Array.from(groupSelect.selectedOptions).map(option => option.value);
                
                // バリデーション
                if (!displayName || !email || !password) {
                    showSystemNotification('必須項目を入力してください', 'warning');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showSystemNotification('パスワードが一致しません', 'warning');
                    return;
                }
                
                // ユーザー作成用の関数を呼び出す
                // 注：ブラウザ側から直接ユーザーを作成することはセキュリティ上推奨されないため、
                // 実際の実装ではCloud FunctionsなどのサーバーサイドAPIを使用することをお勧めします
                
                // この例では簡易的にフロントエンドで処理していますが、本番環境では適切に実装してください
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;
                
                // ユーザープロフィールを更新
                await newUser.updateProfile({
                    displayName: displayName
                });
                
                // ロールの設定
                const roles = ['user'];
                if (role !== 'user') {
                    roles.push(role);
                }
                
                // Firestoreにユーザーデータを保存
                await db.collection('users').doc(newUser.uid).set({
                    uid: newUser.uid,
                    email: email,
                    displayName: displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    roles: roles,
                    groups: selectedGroups,
                    documentCount: 0,
                    communityPosts: 0,
                    points: 0
                });
                
                // 招待メールを送信
                if (sendEmail) {
                    // 本番環境ではCloud Functionsなどを使って実装する必要があります
                    // ここではメール送信をシミュレーションします
                    console.log(`招待メールを ${email} に送信`);
                }
                
                // 管理ログを記録
                await db.collection('adminLogs').add({
                    action: 'create_user',
                    adminId: auth.currentUser.uid,
                    adminEmail: auth.currentUser.email,
                    targetUserId: newUser.uid,
                    details: {
                        email,
                        displayName,
                        roles,
                        groups: selectedGroups
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // モーダルを閉じる
                addUserModal.classList.remove('show');
                
                // 現在の管理者に戻す（新規ユーザー作成時に切り替わるため）
                await auth.signOut();
                await auth.signInWithEmailAndPassword(tempAdminEmail, tempAdminPassword);
                
                // ユーザーリストを再読み込み
                loadUsers();
                
                showSystemNotification('新規ユーザーを作成しました', 'success');
            } catch (error) {
                console.error('ユーザー作成エラー:', error);
                let errorMessage = 'ユーザーの作成中にエラーが発生しました';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'このメールアドレスは既に使用されています';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '無効なメールアドレスです';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'パスワードが弱すぎます';
                }
                
                showSystemNotification(errorMessage, 'danger');
            }
        }

        // お知らせ一覧の読み込み
        async function loadAnnouncements() {
            try {
                const announcementsTbody = document.getElementById('announcements-tbody');
                announcementsTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="p-3">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // お知らせを取得
                const snapshot = await db.collection('announcements')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                currentAnnouncements = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    currentAnnouncements.push(data);
                });
                
                if (currentAnnouncements.length === 0) {
                    announcementsTbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">お知らせが見つかりません</td>
                        </tr>
                    `;
                    return;
                }
                
                announcementsTbody.innerHTML = '';
                
                currentAnnouncements.forEach(announcement => {
                    // 公開日のフォーマット
                    const startDate = announcement.startDate ? announcement.startDate.toDate() : new Date();
                    const formattedStartDate = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    }).format(startDate);
                    
                    // 終了日のフォーマット
                    let formattedEndDate = '無期限';
                    if (announcement.endDate) {
                        const endDate = announcement.endDate.toDate();
                        formattedEndDate = new Intl.DateTimeFormat('ja-JP', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }).format(endDate);
                    }
                    
                    // 対象ユーザー
                    let targetText = 'すべて';
                    if (announcement.targetUsers === 'specific') {
                        if (announcement.specificTargets && announcement.specificTargets.length > 0) {
                            const targetCount = announcement.specificTargets.length;
                            targetText = `特定 (${targetCount}名)`;
                        } else {
                            targetText = '特定ユーザー';
                        }
                    }
                    
                    // ステータス
                    let statusText = '<span class="badge badge-success">公開中</span>';
                    const now = new Date();
                    
                    if (announcement.startDate && announcement.startDate.toDate() > now) {
                        statusText = '<span class="badge badge-info">予約</span>';
                    } else if (announcement.endDate && announcement.endDate.toDate() < now) {
                        statusText = '<span class="badge badge-secondary">終了</span>';
                    } else if (!announcement.active) {
                        statusText = '<span class="badge badge-warning">非公開</span>';
                    }
                    
                    // 優先度
                    let priorityText = '<span class="badge badge-secondary">低</span>';
                    
                    switch(announcement.priority) {
                        case 'medium':
                            priorityText = '<span class="badge badge-info">中</span>';
                            break;
                        case 'high':
                            priorityText = '<span class="badge badge-warning">高</span>';
                            break;
                        case 'urgent':
                            priorityText = '<span class="badge badge-danger">緊急</span>';
                            break;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${announcement.title}</td>
                        <td>${formattedStartDate}</td>
                        <td>${formattedEndDate}</td>
                        <td>${targetText}</td>
                        <td>${statusText}</td>
                        <td>${priorityText}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline btn-icon edit-announcement-btn" data-id="${announcement.id}" title="編集">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline btn-icon delete-announcement-btn" data-id="${announcement.id}" title="削除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    announcementsTbody.appendChild(row);
                });
                
                // 編集ボタンのイベントリスナー
                document.querySelectorAll('.edit-announcement-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        openAnnouncementModal(id);
                    });
                });
                
                // 削除ボタンのイベントリスナー
                document.querySelectorAll('.delete-announcement-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        if (confirm('このお知らせを削除してもよろしいですか？この操作は元に戻せません。')) {
                            deleteAnnouncement(id);
                        }
                    });
                });
            } catch (error) {
                console.error('お知らせ一覧読み込みエラー:', error);
                
                const announcementsTbody = document.getElementById('announcements-tbody');
                announcementsTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">データの読み込み中にエラーが発生しました</td>
                    </tr>
                `;
                
                showSystemNotification('お知らせデータの読み込み中にエラーが発生しました', 'danger');
            }
        }

        // お知らせモーダルを開く
        async function openAnnouncementModal(announcementId = null) {
            try {
                // フォームをリセット
                document.getElementById('announcement-form').reset();
                document.getElementById('announcement-id').value = '';
                document.getElementById('specific-targets').style.display = 'none';
                
                // 現在の日付を設定
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('announcement-start-date').value = today;
                
                // 既存のお知らせを編集する場合
                if (announcementId) {
                    const announcementDoc = await db.collection('announcements').doc(announcementId).get();
                    
                    if (!announcementDoc.exists) {
                        showSystemNotification('お知らせが見つかりません', 'warning');
                        return;
                    }
                    
                    const announcement = announcementDoc.data();
                    
                    // モーダルタイトルを変更
                    document.getElementById('announcement-modal-title').textContent = 'お知らせを編集';
                    
                    // フォームに値を設定
                    document.getElementById('announcement-id').value = announcementId;
                    document.getElementById('announcement-title').value = announcement.title || '';
                    document.getElementById('announcement-content').value = announcement.content || '';
                    
                    // 日付の設定
                    if (announcement.startDate) {
                        const startDate = announcement.startDate.toDate();
                        document.getElementById('announcement-start-date').value = startDate.toISOString().split('T')[0];
                    }
                    
                    if (announcement.endDate) {
                        const endDate = announcement.endDate.toDate();
                        document.getElementById('announcement-end-date').value = endDate.toISOString().split('T')[0];
                    }
                    
                    // 優先度
                    document.getElementById('announcement-priority').value = announcement.priority || 'medium';
                    
                    // 対象ユーザー
                    if (announcement.targetUsers === 'specific') {
                        document.getElementById('target-specific').checked = true;
                        document.getElementById('specific-targets').style.display = 'block';
                        
                        // 特定のターゲットを設定
                        if (announcement.specificTargets && announcement.specificTargets.length > 0) {
                            // グループごとのチェックボックス
                            document.getElementById('target-students').checked = announcement.specificTargets.includes('students');
                            document.getElementById('target-teachers').checked = announcement.specificTargets.includes('teachers');
                            document.getElementById('target-researchers').checked = announcement.specificTargets.includes('researchers');
                            document.getElementById('target-new-users').checked = announcement.specificTargets.includes('new-users');
                            
                            // カスタムユーザーリストを設定
                            const customUserIds = announcement.specificTargets.filter(target => 
                                !['students', 'teachers', 'researchers', 'new-users'].includes(target)
                            );
                            
                            document.getElementById('target-custom-list').value = customUserIds.join(', ');
                        }
                    } else {
                        document.getElementById('target-all').checked = true;
                    }
                    
                    // 通知設定
                    document.getElementById('announcement-push').checked = announcement.notifications ? announcement.notifications.push : false;
                    document.getElementById('announcement-email').checked = announcement.notifications ? announcement.notifications.email : false;
                } else {
                    // 新規作成の場合
                    document.getElementById('announcement-modal-title').textContent = '新規お知らせ作成';
                }
                
                // モーダルを表示
                announcementModal.classList.add('show');
            } catch (error) {
                console.error('お知らせモーダル表示エラー:', error);
                showSystemNotification('モーダルの表示中にエラーが発生しました', 'danger');
            }
        }

        // お知らせを保存
        async function saveAnnouncement() {
            try {
                // フォームデータの取得
                const announcementId = document.getElementById('announcement-id').value;
                const title = document.getElementById('announcement-title').value;
                const content = document.getElementById('announcement-content').value;
                const startDateStr = document.getElementById('announcement-start-date').value;
                const endDateStr = document.getElementById('announcement-end-date').value;
                const priority = document.getElementById('announcement-priority').value;
                
                // バリデーション
                if (!title || !content || !startDateStr) {
                    showSystemNotification('必須項目を入力してください', 'warning');
                    return;
                }
                
                // 日付の変換
                const startDate = new Date(startDateStr);
                startDate.setHours(0, 0, 0, 0);
                
                let endDate = null;
                if (endDateStr) {
                    endDate = new Date(endDateStr);
                    endDate.setHours(23, 59, 59, 999);
                    
                    // 終了日が開始日より前の場合はエラー
                    if (endDate < startDate) {
                        showSystemNotification('終了日は開始日より後の日付を指定してください', 'warning');
                        return;
                    }
                }
                
                // 対象ユーザーの設定
                const targetUsers = document.getElementById('target-specific').checked ? 'specific' : 'all';
                let specificTargets = [];
                
                if (targetUsers === 'specific') {
                    // グループごとのチェックボックス
                    if (document.getElementById('target-students').checked) {
                        specificTargets.push('students');
                    }
                    
                    if (document.getElementById('target-teachers').checked) {
                        specificTargets.push('teachers');
                    }
                    
                    if (document.getElementById('target-researchers').checked) {
                        specificTargets.push('researchers');
                    }
                    
                    if (document.getElementById('target-new-users').checked) {
                        specificTargets.push('new-users');
                    }
                    
                    // カスタムユーザーリスト
                    const customList = document.getElementById('target-custom-list').value;
                    if (customList.trim()) {
                        const customUserIds = customList.split(',').map(id => id.trim()).filter(id => id);
                        specificTargets = [...specificTargets, ...customUserIds];
                    }
                    
                    // 特定ターゲットが指定されていない場合はエラー
                    if (specificTargets.length === 0) {
                        showSystemNotification('特定のユーザーグループを選択してください', 'warning');
                        return;
                    }
                }
                
                // 通知設定
                const notifications = {
                    push: document.getElementById('announcement-push').checked,
                    email: document.getElementById('announcement-email').checked
                };
                
                // お知らせデータの作成
                const announcementData = {
                    title,
                    content,
                    startDate: firebase.firestore.Timestamp.fromDate(startDate),
                    endDate: endDate ? firebase.firestore.Timestamp.fromDate(endDate) : null,
                    priority,
                    targetUsers,
                    specificTargets,
                    notifications,
                    active: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!announcementId) {
                    // 新規作成の場合
                    announcementData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    announcementData.createdBy = auth.currentUser.uid;
                    
                    await db.collection('announcements').add(announcementData);
                    
                    // 管理ログを記録
                    await db.collection('adminLogs').add({
                        action: 'create_announcement',
                        adminId: auth.currentUser.uid,
                        adminEmail: auth.currentUser.email,
                        details: {
                            title,
                            targetUsers,
                            priority
                        },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // 既存のお知らせを更新
                    await db.collection('announcements').doc(announcementId).update(announcementData);
                    
                    // 管理ログを記録
                    await db.collection('adminLogs').add({
                        action: 'update_announcement',
                        adminId: auth.currentUser.uid,
                        adminEmail: auth.currentUser.email,
                        targetId: announcementId,
                        details: {
                            title,
                            targetUsers,
                            priority
                        },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // モーダルを閉じる
                announcementModal.classList.remove('show');
                
                // お知らせリストを再読み込み
                loadAnnouncements();
                
                showSystemNotification('お知らせを保存しました', 'success');
            } catch (error) {
                console.error('お知らせ保存エラー:', error);
                showSystemNotification('お知らせの保存中にエラーが発生しました', 'danger');
            }
        }

        // お知らせを削除
        async function deleteAnnouncement(announcementId) {
            try {
                await db.collection('announcements').doc(announcementId).delete();
                
                // 管理ログを記録
                await db.collection('adminLogs').add({
                    action: 'delete_announcement',
                    adminId: auth.currentUser.uid,
                    adminEmail: auth.currentUser.email,
                    targetId: announcementId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // お知らせリストを再読み込み
                loadAnnouncements();
                
                showSystemNotification('お知らせを削除しました', 'success');
            } catch (error) {
                console.error('お知らせ削除エラー:', error);
                showSystemNotification('お知らせの削除中にエラーが発生しました', 'danger');
            }
        }

        // システムログの読み込み
        async function loadLogs() {
            try {
                const logsTbody = document.getElementById('logs-tbody');
                logsTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="p-3">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // フィルター条件の取得
                const searchTerm = document.getElementById('log-search').value.toLowerCase();
                const levelFilter = document.getElementById('log-level-filter').value;
                const dateFilter = document.getElementById('log-date-filter').value;
                
                // 日付範囲の設定
                let startDate = new Date();
                startDate.setHours(0, 0, 0, 0);
                
                switch (dateFilter) {
                    case 'today':
                        // 今日（デフォルト）
                        break;
                    case 'yesterday':
                        startDate.setDate(startDate.getDate() - 1);
                        break;
                    case 'week':
                        startDate.setDate(startDate.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case 'custom':
                        // カスタム期間は別途実装
                        break;
                }
                
                // Firestoreクエリの構築
                let query = db.collection('logs').orderBy('timestamp', 'desc');
                
                // 日付フィルター
                query = query.where('timestamp', '>=', startDate);
                
                // レベルフィルター
                if (levelFilter) {
                    query = query.where('level', '==', levelFilter);
                }
                
                // クエリ実行
                const snapshot = await query.limit(100).get();
                
                // 結果をフィルタリング
                currentLogs = [];
                
                snapshot.forEach(doc => {
                    const logData = doc.data();
                    logData.id = doc.id;
                    
                    // 検索語でフィルタリング
                    if (searchTerm) {
                        const message = (logData.message || '').toLowerCase();
                        const source = (logData.source || '').toLowerCase();
                        const user = (logData.user || '').toLowerCase();
                        
                        if (!message.includes(searchTerm) && !source.includes(searchTerm) && !user.includes(searchTerm)) {
                            return;
                        }
                    }
                    
                    currentLogs.push(logData);
                });
                
                // ページネーション更新
                updateLogsPagination();
                
                // 現在のページのログを表示
                displayLogs();
            } catch (error) {
                console.error('システムログ読み込みエラー:', error);
                
                const logsTbody = document.getElementById('logs-tbody');
                logsTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">データの読み込み中にエラーが発生しました</td>
                    </tr>
                `;
                
                showSystemNotification('システムログの読み込み中にエラーが発生しました', 'danger');
            }
        }

        // ログページネーションの更新
        function updateLogsPagination() {
            const totalPages = Math.ceil(currentLogs.length / logsPerPage);
            const pagination = document.getElementById('logs-pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let paginationHTML = `
                <ul class="d-flex">
                    <li class="page-item ${currentLogPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentLogPage - 1}" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
            `;
            
            // ページ番号を表示
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // 最初のページ
                    i === totalPages || // 最後のページ
                    (i >= currentLogPage - 1 && i <= currentLogPage + 1) // 現在のページの前後
                ) {
                    paginationHTML += `
                        <li class="page-item ${i === currentLogPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                } else if (
                    (i === 2 && currentLogPage > 3) || // 最初のページの後に...
                    (i === totalPages - 1 && currentLogPage < totalPages - 2) // 最後のページの前に...
                ) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `;
                }
            }
            
            paginationHTML += `
                <li class="page-item ${currentLogPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentLogPage + 1}" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
            `;
            
            pagination.innerHTML = paginationHTML;
            
            // ページ切り替えイベントリスナー
            document.querySelectorAll('#logs-pagination .page-link').forEach(link => {
                if (!link.parentElement.classList.contains('disabled')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.currentTarget.dataset.page);
                        
                        if (page && page !== currentLogPage) {
                            currentLogPage = page;
                            displayLogs();
                            updateLogsPagination();
                        }
                    });
                }
            });
        }

        // 現在のページのログを表示
        function displayLogs() {
            const logsTbody = document.getElementById('logs-tbody');
            
            if (currentLogs.length === 0) {
                logsTbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">ログが見つかりません</td>
                    </tr>
                `;
                return;
            }
            
            // 現在のページのログを取得
            const startIndex = (currentLogPage - 1) * logsPerPage;
            const endIndex = Math.min(startIndex + logsPerPage, currentLogs.length);
            const pageLogs = currentLogs.slice(startIndex, endIndex);
            
            logsTbody.innerHTML = '';
            
            pageLogs.forEach(log => {
                // タイムスタンプのフォーマット
                const timestamp = log.timestamp ? log.timestamp.toDate() : new Date();
                const formattedTimestamp = new Intl.DateTimeFormat('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).format(timestamp);
                
                // レベルに応じたバッジ
                let levelBadge = '<span class="badge badge-info">情報</span>';
                
                switch (log.level) {
                    case 'warning':
                        levelBadge = '<span class="badge badge-warning">警告</span>';
                        break;
                    case 'error':
                        levelBadge = '<span class="badge badge-danger">エラー</span>';
                        break;
                    case 'critical':
                        levelBadge = '<span class="badge badge-danger">重大</span>';
                        break;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formattedTimestamp}</td>
                    <td>${levelBadge}</td>
                    <td>${log.source || '-'}</td>
                    <td>${log.message || '-'}</td>
                    <td>${log.user || '-'}</td>
                    <td>${log.ip || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline btn-icon view-log-btn" data-log-id="${log.id}" title="詳細">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                logsTbody.appendChild(row);
            });
            
            // ログ詳細ボタンのイベントリスナー
            document.querySelectorAll('.view-log-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const logId = e.currentTarget.dataset.logId;
                    openLogDetailModal(logId);
                });
            });
        }

        // ログ詳細モーダルを開く
        function openLogDetailModal(logId) {
            const log = currentLogs.find(log => log.id === logId);
            
            if (!log) {
                showSystemNotification('ログが見つかりません', 'warning');
                return;
            }
            
            // タイムスタンプのフォーマット
            const timestamp = log.timestamp ? log.timestamp.toDate() : new Date();
            const formattedTimestamp = new Intl.DateTimeFormat('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            }).format(timestamp);
            
            // モーダルに値を設定
            document.getElementById('log-detail-timestamp').textContent = formattedTimestamp;
            document.getElementById('log-detail-level').textContent = log.level || 'info';
            document.getElementById('log-detail-source').textContent = log.source || '-';
            document.getElementById('log-detail-message').textContent = log.message || '-';
            document.getElementById('log-detail-user').textContent = log.user || '-';
            document.getElementById('log-detail-ip').textContent = log.ip || '-';
            
            // 詳細情報
            const extraInfo = log.details || {};
            document.getElementById('log-detail-extra').textContent = JSON.stringify(extraInfo, null, 4);
            
            // モーダルを表示
            logDetailModal.classList.add('show');
        }

        // 一時的な管理者アカウント情報（本番環境では使用しないでください）
        let tempAdminEmail = '';
        let tempAdminPassword = '';

        // サイドバー切替
        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }

        // セクション切替
        function switchSection(sectionId) {
            // メニューアイテムの活性状態を更新
            menuItems.forEach(item => {
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // コンテンツセクションの表示/非表示を切り替え
            contentSections.forEach(section => {
                if (section.id === `${sectionId}-section`) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
            
            // セクション固有の初期化処理
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'users') {
                loadUsers();
            } else if (sectionId === 'announcements') {
                loadAnnouncements();
            } else if (sectionId === 'logs') {
                loadLogs();
            }
        }

        // テーマ切替
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // アイコンとテキストを切り替え
            if (themeToggle) {
                if (newTheme === 'dark') {
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
                } else {
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
                }
            }
        }

        // テーマ初期化
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // アイコンとテキストを設定
            if (themeToggle) {
                if (savedTheme === 'dark') {
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i> ライトモード';
                } else {
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i> ダークモード';
                }
            }
        }

        // ログアウト処理
        async function logout() {
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ログアウトエラー:', error);
                showSystemNotification('ログアウト中にエラーが発生しました', 'danger');
            }
        }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', () => {
            // テーマ初期化
            initTheme();
            
            // サイドバー切替ボタン
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // テーマ切替ボタン
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // ログアウトボタン
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
            
            // メニューアイテムのクリックイベント
            menuItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = item.dataset.section;
                    switchSection(sectionId);
                });
            });
            
            // ユーザー管理関連
            document.getElementById('apply-user-filters')?.addEventListener('click', loadUsers);
            document.getElementById('add-user-btn')?.addEventListener('click', openAddUserModal);
            document.getElementById('add-user-save-btn')?.addEventListener('click', createUser);
            document.getElementById('add-user-cancel-btn')?.addEventListener('click', () => {
                addUserModal.classList.remove('show');
            });
            document.getElementById('add-user-close-btn')?.addEventListener('click', () => {
                addUserModal.classList.remove('show');
            });
            document.getElementById('user-detail-edit-btn')?.addEventListener('click', (e) => {
                const userId = e.currentTarget.dataset.userId;
                userDetailModal.classList.remove('show');
                openUserEditModal(userId);
            });
            document.getElementById('user-detail-cancel-btn')?.addEventListener('click', () => {
                userDetailModal.classList.remove('show');
            });
            document.getElementById('user-detail-close-btn')?.addEventListener('click', () => {
                userDetailModal.classList.remove('show');
            });
            document.getElementById('user-edit-save-btn')?.addEventListener('click', saveUserEdit);
            document.getElementById('user-edit-cancel-btn')?.addEventListener('click', () => {
                userEditModal.classList.remove('show');
            });
            document.getElementById('user-edit-close-btn')?.addEventListener('click', () => {
                userEditModal.classList.remove('show');
            });
            document.getElementById('user-reset-password-btn')?.addEventListener('click', () => {
                const userId = document.getElementById('user-edit-id').value;
                if (confirm('このユーザーのパスワードをリセットしますか？リセット用のメールが送信されます。')) {
                    // パスワードリセットの処理（Firebase Authenticationの機能）
                    // 実際の実装ではCloud Functionsなどを使います
                    alert('本番環境ではCloud Functions経由でリセットメールを送信します');
                }
            });
            document.getElementById('user-suspend-btn')?.addEventListener('click', () => {
                const userId = document.getElementById('user-edit-id').value;
                if (confirm('このユーザーアカウントを停止しますか？ユーザーはログインできなくなります。')) {
                    document.getElementById('user-edit-status').value = 'suspended';
                    alert('ステータスを「停止」に変更しました。保存ボタンをクリックして変更を確定してください。');
                }
            });
            
            // お知らせ管理関連
            document.getElementById('create-announcement-btn')?.addEventListener('click', () => {
                openAnnouncementModal();
            });
            document.getElementById('new-announcement-btn')?.addEventListener('click', () => {
                switchSection('announcements');
                setTimeout(() => {
                    openAnnouncementModal();
                }, 300);
            });
            document.getElementById('announcement-modal-close')?.addEventListener('click', () => {
                announcementModal.classList.remove('show');
            });
            document.getElementById('announcement-cancel')?.addEventListener('click', () => {
                announcementModal.classList.remove('show');
            });
            document.getElementById('announcement-save')?.addEventListener('click', saveAnnouncement);
            document.getElementById('target-all')?.addEventListener('change', () => {
                document.getElementById('specific-targets').style.display = 'none';
            });
            document.getElementById('target-specific')?.addEventListener('change', () => {
                document.getElementById('specific-targets').style.display = 'block';
            });
            
            // ログ管理関連
            document.getElementById('apply-log-filters')?.addEventListener('click', loadLogs);
            document.getElementById('export-logs-btn')?.addEventListener('click', () => {
                // CSVエクスポート機能
                alert('ログをCSVとしてエクスポートします');
            });
            document.getElementById('log-detail-close')?.addEventListener('click', () => {
                logDetailModal.classList.remove('show');
            });
            document.getElementById('log-detail-modal-close')?.addEventListener('click', () => {
                logDetailModal.classList.remove('show');
            });
            
            // 他のボタン
            document.getElementById('export-users-btn')?.addEventListener('click', () => {
                // CSVエクスポート機能
                alert('ユーザーリストをCSVとしてエクスポートします');
            });
            document.getElementById('usage-report-btn')?.addEventListener('click', () => {
                // 利用状況レポート表示
                switchSection('reports');
            });
            document.getElementById('system-check-btn')?.addEventListener('click', async () => {
                // システム状態確認
                showSystemNotification('システム状態を確認しています...', 'info');
                
                // 各種Firebaseサービスの状態確認
                try {
                    // Authenticationの状態確認
                    const authUser = auth.currentUser;
                    if (!authUser) {
                        throw new Error('認証状態が無効です');
                    }
                    
                    // Firestoreの状態確認
                    await db.collection('system').doc('status').get();
                    
                    // ストレージの状態確認
                    await storage.ref().child('system/heartbeat.txt').getMetadata();
                    
                    showSystemNotification('すべてのシステムは正常に動作しています', 'success');
                } catch (error) {
                    console.error('システム状態確認エラー:', error);
                    showSystemNotification('システム状態の確認中にエラーが発生しました: ' + error.message, 'danger');
                }
            });
            
            // 画面クリックでサイドバーを閉じる（モバイル用）
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    sidebar && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    e.target !== sidebarToggle) {
                    sidebar.classList.remove('active');
                }
            });
        });

        /**レポート・分析セクションの機能
const ReportingModule = (function() {
    // プライベート変数
    let activeCharts = {}; // 現在表示中のすべてのチャート
    let currentDateRange = null; // 現在選択されている日付範囲
    
    /**
     * 初期化処理
     */
    function init() {
        console.log('レポート・分析モジュールを初期化しています...');
        
        // タブ切り替え
        initTabs();
        
        // 日付範囲選択の初期化
        initDateRange();
        
        // レポート生成ボタン
        initReportButtons();
        
        // カスタムレポートビルダーの初期化
        initCustomReportBuilder();
        
        // エクスポートモーダルの初期化
        initExportModal();
        
        // 初期データを読み込み（ユーザーレポート）
        loadReportData('user-reports');
        
        // 保存済みレポートの読み込み
        loadSavedReports();
    }
    
    /**
     * タブ切り替えの初期化
     */
    function initTabs() {
        const reportTabs = document.querySelectorAll('#reports-section .tab');
        const reportContents = document.querySelectorAll('#reports-section .tab-content');
        
        reportTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // タブのアクティブ状態を更新
                reportTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // コンテンツの表示/非表示を切り替え
                reportContents.forEach(content => {
                    if (content.id === `${tabId}-content`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
                
                // タブに応じたレポートを読み込み
                loadReportData(tabId);
            });
        });
    }
    
    /**
     * 日付範囲選択の初期化
     */
    function initDateRange() {
        const dateRangeSelect = document.getElementById('report-date-range');
        const customDateRange = document.getElementById('custom-date-range');
        
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', () => {
                if (dateRangeSelect.value === 'custom') {
                    customDateRange.style.display = 'flex';
                    
                    // 現在の日付とデフォルトの範囲を設定
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
                    document.getElementById('report-start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
                } else {
                    customDateRange.style.display = 'none';
                }
                
                // 日付範囲が変更されたら現在の範囲を更新
                currentDateRange = getSelectedDateRange();
            });
            
            // 初期の日付範囲を設定
            currentDateRange = getSelectedDateRange();
        }
    }
    
    /**
     * レポート関連ボタンの初期化
     */
    function initReportButtons() {
        // レポート生成ボタン
        const generateReportBtn = document.getElementById('generate-report-btn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', () => {
                // 現在アクティブなタブを取得
                const activeTab = document.querySelector('#reports-section .tab.active');
                if (activeTab) {
                    // 日付範囲を更新
                    currentDateRange = getSelectedDateRange();
                    // レポートデータを読み込み
                    loadReportData(activeTab.dataset.tab);
                    showSystemNotification('レポートを生成しています...', 'info');
                }
            });
        }
        
        // エクスポートボタン
        const exportReportBtn = document.getElementById('export-report-btn');
        if (exportReportBtn) {
            exportReportBtn.addEventListener('click', () => {
                showExportModal();
            });
        }
    }
    
    /**
     * カスタムレポートビルダーの初期化
     */
    function initCustomReportBuilder() {
        // データソース変更時にメトリクスを更新
        const customDataSource = document.getElementById('custom-data-source');
        if (customDataSource) {
            customDataSource.addEventListener('change', () => {
                updateAvailableMetrics(customDataSource.value);
            });
            
            // 初期メトリクスを設定
            updateAvailableMetrics(customDataSource.value);
        }
        
        // フィルター追加ボタン
        const addFilterBtn = document.getElementById('add-filter-btn');
        if (addFilterBtn) {
            addFilterBtn.addEventListener('click', () => {
                addCustomFilter();
            });
        }
        
        // カスタムレポート生成ボタン
        const buildCustomReportBtn = document.getElementById('build-custom-report-btn');
        if (buildCustomReportBtn) {
            buildCustomReportBtn.addEventListener('click', () => {
                buildCustomReport();
            });
        }
    }
    
    /**
     * エクスポートモーダルの初期化
     */
    function initExportModal() {
        const exportModal = document.getElementById('export-modal');
        const closeBtn = document.getElementById('export-modal-close');
        const cancelBtn = document.getElementById('export-modal-cancel');
        const formatBtns = document.querySelectorAll('.export-format-btn');
        
        if (exportModal) {
            // 閉じるボタン
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    exportModal.style.display = 'none';
                });
            }
            
            // キャンセルボタン
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    exportModal.style.display = 'none';
                });
            }
            
            // フォーマットボタン
            formatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const format = btn.dataset.format;
                    exportReportAs(format);
                    exportModal.style.display = 'none';
                });
            });
        }
    }
    
    /**
     * 選択されたデータソースに基づいて利用可能なメトリクスを更新
     */
    function updateAvailableMetrics(dataSource) {
        const metricsSelect = document.getElementById('custom-metrics');
        if (!metricsSelect) return;
        
        // 現在の選択を保存
        const selectedOptions = Array.from(metricsSelect.selectedOptions).map(option => option.value);
        
        // メトリクスをクリア
        metricsSelect.innerHTML = '';
        
        // データソースに応じたメトリクスを追加
        let metrics = [];
        
        switch(dataSource) {
            case 'users':
                metrics = [
                    { value: 'registrations', label: '登録数' },
                    { value: 'active_users', label: 'アクティブユーザー' },
                    { value: 'retention', label: 'リテンション率' },
                    { value: 'engagement', label: 'エンゲージメントスコア' },
                    { value: 'login_count', label: 'ログイン回数' },
                    { value: 'user_growth', label: 'ユーザー増加率' }
                ];
                break;
            case 'content':
                metrics = [
                    { value: 'content_count', label: 'コンテンツ数' },
                    { value: 'views', label: '閲覧数' },
                    { value: 'ratings', label: '評価' },
                    { value: 'comments', label: 'コメント数' },
                    { value: 'shares', label: 'シェア数' },
                    { value: 'favorites', label: 'お気に入り登録数' }
                ];
                break;
            case 'activity':
                metrics = [
                    { value: 'logins', label: 'ログイン数' },
                    { value: 'session_duration', label: 'セッション時間' },
                    { value: 'page_views', label: 'ページビュー' },
                    { value: 'feature_usage', label: '機能使用率' },
                    { value: 'search_queries', label: '検索クエリ数' },
                    { value: 'downloads', label: 'ダウンロード数' }
                ];
                break;
            case 'engagement':
                metrics = [
                    { value: 'engagement_score', label: 'エンゲージメントスコア' },
                    { value: 'active_days', label: '月間アクティブ日数' },
                    { value: 'content_created', label: '作成コンテンツ数' },
                    { value: 'interactions', label: '総インタラクション数' },
                    { value: 'retention_rate', label: 'リテンション率' },
                    { value: 'conversion_rate', label: 'コンバージョン率' }
                ];
                break;
        }
        
        // メトリクスをセレクトボックスに追加
        metrics.forEach(metric => {
            const option = document.createElement('option');
            option.value = metric.value;
            option.textContent = metric.label;
            option.selected = selectedOptions.includes(metric.value);
            metricsSelect.appendChild(option);
        });
    }
    
    /**
     * カスタムフィルターを追加
     */
    function addCustomFilter() {
        const filterField = document.getElementById('custom-filter-field');
        const filterOperator = document.getElementById('custom-filter-operator');
        const filterValue = document.getElementById('custom-filter-value');
        const appliedFilters = document.getElementById('applied-filters');
        
        if (!filterField.value || !filterValue.value) {
            showSystemNotification('フィールドと値を入力してください', 'warning');
            return;
        }
        
        // フィールド名の表示用テキスト
        const fieldLabel = filterField.options[filterField.selectedIndex].text;
        
        // 演算子の表示用テキスト
        const operatorLabel = (() => {
            switch(filterOperator.value) {
                case 'equals': return '等しい';
                case 'not_equals': return '等しくない';
                case 'contains': return '含む';
                case 'greater_than': return 'より大きい';
                case 'less_than': return 'より小さい';
                default: return filterOperator.value;
            }
        })();
        
        // フィルターバッジを作成
        const filterId = `filter-${Date.now()}`;
        const filterBadge = document.createElement('div');
        filterBadge.id = filterId;
        filterBadge.className = 'badge badge-info mr-2 mb-2 p-2';
        filterBadge.style.display = 'inline-flex';
        filterBadge.style.alignItems = 'center';
        filterBadge.innerHTML = `
            <span>${fieldLabel} ${operatorLabel} "${filterValue.value}"</span>
            <button class="btn btn-sm ml-2" style="padding: 0; background: none; color: inherit;" onclick="ReportingModule.removeFilter('${filterId}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // フィルターをデータ属性に保存
        filterBadge.dataset.field = filterField.value;
        filterBadge.dataset.operator = filterOperator.value;
        filterBadge.dataset.value = filterValue.value;
        
        appliedFilters.appendChild(filterBadge);
        
        // 入力をクリア
        filterValue.value = '';
    }
    
    /**
     * カスタムフィルターを削除
     */
    function removeFilter(filterId) {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.remove();
        }
    }
    
    /**
     * 選択された日付範囲を取得
     */
    function getSelectedDateRange() {
        const dateRangeSelect = document.getElementById('report-date-range');
        
        if (dateRangeSelect.value === 'custom') {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (startDate && endDate) {
                return {
                    type: 'custom',
                    startDate: new Date(startDate),
                    endDate: new Date(endDate)
                };
            }
        }
        
        // 事前定義の範囲
        const days = parseInt(dateRangeSelect.value);
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        return {
            type: dateRangeSelect.value,
            days: days,
            startDate: startDate,
            endDate: endDate
        };
    }
    
    /**
     * レポートタイプに応じたデータを読み込み
     */
    function loadReportData(reportType) {
        console.log(`Loading report data for: ${reportType}`);
        
        // まだ初期化されていない場合は初期化
        if (!currentDateRange) {
            currentDateRange = getSelectedDateRange();
        }
        
        switch(reportType) {
            case 'user-reports':
                loadUserReports(currentDateRange);
                break;
            case 'content-reports':
                loadContentReports(currentDateRange);
                break;
            case 'activity-reports':
                loadActivityReports(currentDateRange);
                break;
            case 'custom-reports':
                // カスタムレポートは別途ビルダーで処理
                break;
        }
    }
    
    /**
     * ユーザーレポートを読み込み
     */
    function loadUserReports(dateRange) {
        // ユーザー登録推移チャート
        loadUserRegistrationData(dateRange).then(data => {
            createUserRegistrationChart(data);
        });
        
        // アクティブユーザーチャート
        loadActiveUsersData(dateRange).then(data => {
            createActiveUsersChart(data);
        });
        
        // ユーザー属性分析チャート
        loadUserRolesData().then(data => {
            createUserRolesChart(data);
        });
        
        loadUserActivityData().then(data => {
            createUserActivityChart(data);
        });
        
        loadUserDevicesData().then(data => {
            createUserDevicesChart(data);
        });
        
        // ユーザーリテンション分析
        loadRetentionData().then(data => {
            updateRetentionTable(data);
        });
    }
    
    /**
     * コンテンツレポートを読み込み
     */
    function loadContentReports(dateRange) {
        // コンテンツ作成推移チャート
        loadContentCreationData(dateRange).then(data => {
            createContentCreationChart(data);
        });
        
        // 人気コンテンツチャート
        loadContentPopularityData(dateRange).then(data => {
            createContentPopularityChart(data);
        });
        
        // コンテンツカテゴリ分析
        loadContentCategoryData().then(data => {
            createContentCategoryChart(data);
        });
        
        loadCategoryViewsData().then(data => {
            createCategoryViewsChart(data);
        });
        
        // 上位コンテンツテーブル
        loadTopContentData().then(data => {
            updateTopContentTable(data);
        });
    }
    
    /**
     * 活動レポートを読み込み
     */
    function loadActivityReports(dateRange) {
        // ログイン活動チャート
        loadLoginActivityData(dateRange).then(data => {
            createLoginActivityChart(data);
        });
        
        // 時間帯別使用状況チャート
        loadHourlyUsageData().then(data => {
            createHourlyUsageChart(data);
        });
        
        // 機能別使用状況チャート
        loadFeatureUsageData().then(data => {
            createFeatureUsageChart(data);
        });
        
        // エンゲージメントスコアチャート
        loadEngagementData(dateRange).then(data => {
            createEngagementTrendChart(data);
            updateEngagementStats(data);
        });
        
        // アクセス地域分析
        loadRegionData().then(data => {
            updateRegionTable(data.tableData);
            createRegionDistributionChart(data.chartData);
        });
    }
    
    /**
     * 保存済みレポートを読み込み
     */
    function loadSavedReports() {
        try {
            // Firebaseからレポートを取得
            db.collection('savedReports')
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    const tbody = document.getElementById('saved-reports-tbody');
                    
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">保存されたレポートはありません</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const report = doc.data();
                        const reportId = doc.id;
                        
                        // 日付のフォーマット
                        const createdAt = report.createdAt ? report.createdAt.toDate() : new Date();
                        const formattedCreatedAt = new Intl.DateTimeFormat('ja-JP', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }).format(createdAt);
                        
                        const updatedAt = report.updatedAt ? report.updatedAt.toDate() : createdAt;
                        const formattedUpdatedAt = new Intl.DateTimeFormat('ja-JP', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }).format(updatedAt);
                        
                        // データソースの日本語表記
                        const dataSourceText = (() => {
                            switch(report.dataSource) {
                                case 'users': return 'ユーザーデータ';
                                case 'content': return 'コンテンツデータ';
                                case 'activity': return '活動データ';
                                case 'engagement': return 'エンゲージメントデータ';
                                default: return report.dataSource || '-';
                            }
                        })();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${report.name}</td>
                            <td>${formattedCreatedAt}</td>
                            <td>${dataSourceText}</td>
                            <td>${report.createdBy || '管理者'}</td>
                            <td>${formattedUpdatedAt}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-outline btn-icon view-report-btn" data-report-id="${reportId}" title="表示">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline btn-icon edit-report-btn" data-report-id="${reportId}" title="編集">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline btn-icon delete-report-btn" data-report-id="${reportId}" title="削除">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    // ボタンにイベントリスナーを追加
                    addReportButtonListeners();
                })
                .catch(error => {
                    console.error('保存済みレポート読み込みエラー:', error);
                    const tbody = document.getElementById('saved-reports-tbody');
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">レポートの読み込み中にエラーが発生しました</td></tr>';
                });
        } catch (error) {
            console.error('保存済みレポート読み込みエラー:', error);
            const tbody = document.getElementById('saved-reports-tbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">レポートの読み込み中にエラーが発生しました</td></tr>';
        }
    }
    
    /**
     * 保存済みレポートのボタンにイベントリスナーを追加
     */
    function addReportButtonListeners() {
        // 表示ボタン
        document.querySelectorAll('.view-report-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const reportId = e.currentTarget.dataset.reportId;
                loadSavedReport(reportId);
            });
        });
        
        // 編集ボタン
        document.querySelectorAll('.edit-report-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const reportId = e.currentTarget.dataset.reportId;
                editSavedReport(reportId);
            });
        });
        
        // 削除ボタン
        document.querySelectorAll('.delete-report-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const reportId = e.currentTarget.dataset.reportId;
                if (confirm('このレポートを削除してもよろしいですか？この操作は元に戻せません。')) {
                    deleteSavedReport(reportId);
                }
            });
        });
    }
    
    /**
     * 保存済みレポートを読み込む
     */
    function loadSavedReport(reportId) {
        try {
            db.collection('savedReports').doc(reportId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showSystemNotification('レポートが見つかりません', 'warning');
                        return;
                    }
                    
                    const report = doc.data();
                    
                    // カスタムレポートタブに切り替え
                    const customTab = document.querySelector('#reports-section .tab[data-tab="custom-reports"]');
                    if (customTab) {
                        customTab.click();
                    }
                    
                    // レポート設定をフォームに適用
                    document.getElementById('custom-data-source').value = report.dataSource || 'users';
                    updateAvailableMetrics(report.dataSource || 'users');
                    
                    // メトリクスの選択
                    const metricsSelect = document.getElementById('custom-metrics');
                    if (metricsSelect && report.metrics) {
                        Array.from(metricsSelect.options).forEach(option => {
                            option.selected = report.metrics.includes(option.value);
                        });
                    }
                    
                    // グループ化と表示形式
                    document.getElementById('custom-grouping').value = report.grouping || 'monthly';
                    document.getElementById('custom-visualization').value = report.visualization || 'line';
                    
                    // フィルターの適用
                    const appliedFilters = document.getElementById('applied-filters');
                    appliedFilters.innerHTML = '';
                    
                    if (report.filters && report.filters.length > 0) {
                        report.filters.forEach(filter => {
                            // フィールド名の表示用テキスト
                            const fieldSelect = document.getElementById('custom-filter-field');
                            const fieldOption = Array.from(fieldSelect.options).find(opt => opt.value === filter.field);
                            const fieldLabel = fieldOption ? fieldOption.text : filter.field;
                            
                            // 演算子の表示用テキスト
                            const operatorLabel = (() => {
                                switch(filter.operator) {
                                    case 'equals': return '等しい';
                                    case 'not_equals': return '等しくない';
                                    case 'contains': return '含む';
                                    case 'greater_than': return 'より大きい';
                                    case 'less_than': return 'より小さい';
                                    default: return filter.operator;
                                }
                            })();
                            
                            // フィルターバッジを作成
                            const filterId = `filter-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                            const filterBadge = document.createElement('div');
                            filterBadge.id = filterId;
                            filterBadge.className = 'badge badge-info mr-2 mb-2 p-2';
                            filterBadge.style.display = 'inline-flex';
                            filterBadge.style.alignItems = 'center';
                            filterBadge.innerHTML = `
                                <span>${fieldLabel} ${operatorLabel} "${filter.value}"</span>
                                <button class="btn btn-sm ml-2" style="padding: 0; background: none; color: inherit;" onclick="ReportingModule.removeFilter('${filterId}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            
                            // フィルターをデータ属性に保存
                            filterBadge.dataset.field = filter.field;
                            filterBadge.dataset.operator = filter.operator;
                            filterBadge.dataset.value = filter.value;
                            
                            appliedFilters.appendChild(filterBadge);
                        });
                    }
                    
                    // レポートを生成
                    buildCustomReport();
                    
                    showSystemNotification('保存済みレポートを読み込みました', 'success');
                })
                .catch(error => {
                    console.error('レポート読み込みエラー:', error);
                    showSystemNotification('レポートの読み込み中にエラーが発生しました', 'danger');
                });
        } catch (error) {
            console.error('レポート読み込みエラー:', error);
            showSystemNotification('レポートの読み込み中にエラーが発生しました', 'danger');
        }
    }
    
    /**
     * 保存済みレポートを編集する
     */
    function editSavedReport(reportId) {
        // 表示と同じ処理を行った後、編集モードに入る
        loadSavedReport(reportId);
        
        // レポートのIDを保存（実際の保存時に使用）
        document.getElementById('build-custom-report-btn').dataset.reportId = reportId;
        document.getElementById('build-custom-report-btn').textContent = 'レポートを更新';
    }
    
    /**
     * 保存済みレポートを削除する
     */
    function deleteSavedReport(reportId) {
        try {
            db.collection('savedReports').doc(reportId).delete()
                .then(() => {
                    showSystemNotification('レポートを削除しました', 'success');
                    // 保存済みレポートリストを更新
                    loadSavedReports();
                })
                .catch(error => {
                    console.error('レポート削除エラー:', error);
                    showSystemNotification('レポートの削除中にエラーが発生しました', 'danger');
                });
        } catch (error) {
            console.error('レポート削除エラー:', error);
            showSystemNotification('レポートの削除中にエラーが発生しました', 'danger');
        }
    }
    
    /**
     * カスタムレポートを構築
     */
    function buildCustomReport() {
        // 選択されたオプションの取得
        const dataSource = document.getElementById('custom-data-source').value;
        const metricsSelect = document.getElementById('custom-metrics');
        const selectedMetrics = Array.from(metricsSelect.selectedOptions).map(option => ({
            value: option.value,
            label: option.textContent
        }));
        const grouping = document.getElementById('custom-grouping').value;
        const visualization = document.getElementById('custom-visualization').value;
        
        // 選択内容の検証
        if (selectedMetrics.length === 0) {
            showSystemNotification('メトリクスを1つ以上選択してください', 'warning');
            return;
        }
        
        // フィルターの取得
        const filters = Array.from(document.getElementById('applied-filters').children).map(filter => ({
            field: filter.dataset.field,
            operator: filter.dataset.operator,
            value: filter.dataset.value
        }));
        
        // カスタムレポートのタイトルと説明を生成
        const dataSourceLabel = document.getElementById('custom-data-source').options[document.getElementById('custom-data-source').selectedIndex].text;
        const groupingLabel = document.getElementById('custom-grouping').options[document.getElementById('custom-grouping').selectedIndex].text;
        const dateRange = getSelectedDateRange();
        
        // 日付範囲のフォーマット
        const formattedStartDate = new Intl.DateTimeFormat('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }).format(dateRange.startDate);
        
        const formattedEndDate = new Intl.DateTimeFormat('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }).format(dateRange.endDate);
        
        document.getElementById('custom-report-title').textContent = `${dataSourceLabel}の${groupingLabel}分析`;
        document.getElementById('custom-report-description').textContent = `レポート期間: ${formattedStartDate} - ${formattedEndDate}`;
        
        // データを読み込む
        loadCustomReportData(dataSource, selectedMetrics, grouping, filters, dateRange)
            .then(data => {
                // 選択したビジュアライゼーションに応じてレポートを表示
                const reportChart = document.getElementById('custom-report-chart');
                const tableContainer = document.getElementById('custom-report-table-container');
                
                if (visualization === 'table') {
                    // テーブル表示
                    reportChart.parentElement.style.display = 'none';
                    tableContainer.style.display = 'block';
                    createCustomReportTable(data);
                } else {
                    // チャート表示
                    reportChart.parentElement.style.display = 'block';
                    tableContainer.style.display = 'none';
                    createCustomReportChart(reportChart, data, visualization);
                }
                
                // 結果を表示
                document.getElementById('custom-report-results').style.display = 'block';
                
                // 成功通知
                showSystemNotification('カスタムレポートを生成しました', 'success');
                
                // 保存ボタンにデータを設定
                const saveBtn = document.getElementById('build-custom-report-btn');
                const reportConfig = {
                    dataSource,
                    metrics: selectedMetrics.map(m => m.value),
                    grouping,
                    visualization,
                    filters,
                    dateRange: {
                        type: dateRange.type,
                        days: dateRange.days
                    }
                };
                saveBtn.dataset.config = JSON.stringify(reportConfig);
            })
            .catch(error => {
                console.error('カスタムレポートデータ読み込みエラー:', error);
                showSystemNotification('レポートデータの読み込み中にエラーが発生しました', 'danger');
            });
    }
    
    // ===== データ取得関数 =====
    
    /**
     * ユーザー登録データを取得
     */
    function loadUserRegistrationData(dateRange) {
        return new Promise((resolve, reject) => {
            try {
                // Firebaseからユーザー登録データを取得
                const startTimestamp = firebase.firestore.Timestamp.fromDate(dateRange.startDate);
                const endTimestamp = firebase.firestore.Timestamp.fromDate(dateRange.endDate);
                
                db.collection('users')
                    .where('createdAt', '>=', startTimestamp)
                    .where('createdAt', '<=', endTimestamp)
                    .orderBy('createdAt', 'asc')
                    .get()
                    .then(snapshot => {
                        // 日付ごとのユーザー登録数をカウント
                        const registrationsByDate = {};
                        
                        snapshot.forEach(doc => {
                            const userData = doc.data();
                            const createdAt = userData.createdAt.toDate();
                            const dateKey = createdAt.toISOString().split('T')[0];
                            
                            registrationsByDate[dateKey] = (registrationsByDate[dateKey] || 0) + 1;
                        });
                        
                        // 日付の範囲でループし、データがない日は0として埋める
                        const result = {
                            labels: [],
                            dailyRegistrations: [],
                            cumulativeRegistrations: []
                        };
                        
                        let cumulativeTotal = 0;
                        
                        for (let d = new Date(dateRange.startDate); d <= dateRange.endDate; d.setDate(d.getDate() + 1)) {
                            const dateKey = d.toISOString().split('T')[0];
                            const dateLabel = new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(d);
                            
                            result.labels.push(dateLabel);
                            
                            const dailyCount = registrationsByDate[dateKey] || 0;
                            result.dailyRegistrations.push(dailyCount);
                            
                            cumulativeTotal += dailyCount;
                            result.cumulativeRegistrations.push(cumulativeTotal);
                        }
                        
                        resolve(result);
                    })
                    .catch(error => {
                        console.error('ユーザー登録データ取得エラー:', error);
                        
                        // エラー時のフォールバック：サンプルデータを返す
                        const fallbackData = generateSampleUserRegistrationData(dateRange);
                        resolve(fallbackData);
                    });
            } catch (error) {
                console.error('ユーザー登録データ取得エラー:', error);
                
                // エラー時のフォールバック：サンプルデータを返す
                const fallbackData = generateSampleUserRegistrationData(dateRange);
                resolve(fallbackData);
            }
        });
    }
    
    /**
     * アクティブユーザーデータを取得
     */
    function loadActiveUsersData(dateRange) {
        return new Promise((resolve, reject) => {
            try {
                // アクティブユーザーデータを取得
                // 実際の実装では、ユーザーのログイン履歴や活動ログを使用して計算
                
                // サンプルデータ生成
                const result = generateSampleActiveUsersData(dateRange);
                resolve(result);
            } catch (error) {
                console.error('アクティブユーザーデータ取得エラー:', error);
                // エラー時のフォールバック：サンプルデータを返す
                const fallbackData = generateSampleActiveUsersData(dateRange);
                resolve(fallbackData);
            }
        });
    }
    
    /**
     * ユーザーロールデータを取得
     */
    function loadUserRolesData() {
        return new Promise((resolve, reject) => {
            try {
                db.collection('users')
                    .get()
                    .then(snapshot => {
                        // ロールごとのユーザー数をカウント
                        const roleCounts = {
                            student: 0,
                            teacher: 0,
                            researcher: 0,
                            admin: 0,
                            general: 0
                        };
                        
                        snapshot.forEach(doc => {
                            const userData = doc.data();
                            const roles = userData.roles || [];
                            
                            if (roles.includes('admin')) {
                                roleCounts.admin++;
                            } else if (roles.includes('teacher')) {
                                roleCounts.teacher++;
                            } else if (roles.includes('researcher')) {
                                roleCounts.researcher++;
                            } else if (roles.includes('student')) {
                                roleCounts.student++;
                            } else {
                                roleCounts.general++;
                            }
                        });
                        
                        // データを整形
                        const result = {
                            labels: ['学生', '教師', '研究者', '一般', '管理者'],
                            data: [
                                roleCounts.student,
                                roleCounts.teacher,
                                roleCounts.researcher,
                                roleCounts.general,
                                roleCounts.admin
                            ]
                        };
                        
                        resolve(result);
                    })
                    .catch(error => {
                        console.error('ユーザーロールデータ取得エラー:', error);
                        // エラー時のフォールバック：サンプルデータを返す
                        const fallbackData = generateSampleUserRolesData();
                        resolve(fallbackData);
                    });
            } catch (error) {
                console.error('ユーザーロールデータ取得エラー:', error);
                // エラー時のフォールバック：サンプルデータを返す
                const fallbackData = generateSampleUserRolesData();
                resolve(fallbackData);
            }
        });
    }
    
    /**
     * ユーザー活動レベルデータを取得
     */
    function loadUserActivityData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleUserActivityData());
    }
    
    /**
     * ユーザーデバイスデータを取得
     */
    function loadUserDevicesData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleUserDevicesData());
    }
    
    /**
     * リテンションデータを取得
     */
    function loadRetentionData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleRetentionData());
    }
    
    /**
     * コンテンツ作成データを取得
     */
    function loadContentCreationData(dateRange) {
        return new Promise((resolve, reject) => {
            try {
                // コンテンツ作成データを取得
                const startTimestamp = firebase.firestore.Timestamp.fromDate(dateRange.startDate);
                const endTimestamp = firebase.firestore.Timestamp.fromDate(dateRange.endDate);
                
                db.collection('documents')
                    .where('createdAt', '>=', startTimestamp)
                    .where('createdAt', '<=', endTimestamp)
                    .orderBy('createdAt', 'asc')
                    .get()
                    .then(snapshot => {
                        // 日付ごとのコンテンツ作成数をカウント
                        const contentByDate = {};
                        
                        snapshot.forEach(doc => {
                            const contentData = doc.data();
                            const createdAt = contentData.createdAt.toDate();
                            const dateKey = createdAt.toISOString().split('T')[0];
                            
                            contentByDate[dateKey] = (contentByDate[dateKey] || 0) + 1;
                        });
                        
                        // 日付の範囲でループし、データがない日は0として埋める
                        const result = {
                            labels: [],
                            data: []
                        };
                        
                        for (let d = new Date(dateRange.startDate); d <= dateRange.endDate; d.setDate(d.getDate() + 1)) {
                            const dateKey = d.toISOString().split('T')[0];
                            const dateLabel = new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(d);
                            
                            result.labels.push(dateLabel);
                            result.data.push(contentByDate[dateKey] || 0);
                        }
                        
                        resolve(result);
                    })
                    .catch(error => {
                        console.error('コンテンツ作成データ取得エラー:', error);
                        // エラー時のフォールバック：サンプルデータを返す
                        const fallbackData = generateSampleContentCreationData(dateRange);
                        resolve(fallbackData);
                    });
            } catch (error) {
                console.error('コンテンツ作成データ取得エラー:', error);
                // エラー時のフォールバック：サンプルデータを返す
                const fallbackData = generateSampleContentCreationData(dateRange);
                resolve(fallbackData);
            }
        });
    }
    
    /**
     * コンテンツ人気度データを取得
     */
    function loadContentPopularityData(dateRange) {
        // サンプルデータを返す
        return Promise.resolve(generateSampleContentPopularityData(dateRange));
    }
    
    /**
     * コンテンツカテゴリデータを取得
     */
    function loadContentCategoryData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleContentCategoryData());
    }
    
    /**
     * カテゴリ別閲覧数データを取得
     */
    function loadCategoryViewsData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleCategoryViewsData());
    }
    
    /**
     * トップコンテンツデータを取得
     */
    function loadTopContentData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleTopContentData());
    }
    
    /**
     * ログイン活動データを取得
     */
    function loadLoginActivityData(dateRange) {
        // サンプルデータを返す
        return Promise.resolve(generateSampleLoginActivityData(dateRange));
    }
    
    /**
     * 時間帯別使用状況データを取得
     */
    function loadHourlyUsageData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleHourlyUsageData());
    }
    
    /**
     * 機能別使用状況データを取得
     */
    function loadFeatureUsageData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleFeatureUsageData());
    }
    
    /**
     * エンゲージメントデータを取得
     */
    function loadEngagementData(dateRange) {
        // サンプルデータを返す
        return Promise.resolve(generateSampleEngagementData(dateRange));
    }
    
    /**
     * 地域データを取得
     */
    function loadRegionData() {
        // サンプルデータを返す
        return Promise.resolve(generateSampleRegionData());
    }
    
    /**
     * カスタムレポートデータを取得
     */
    function loadCustomReportData(dataSource, metrics, grouping, filters, dateRange) {
        return new Promise((resolve, reject) => {
            try {
                // 本番環境では、ここでFirebaseのクエリを構築し、適切なデータを取得
                // このサンプルでは、サンプルデータを生成
                
                // サンプルデータを生成
                const result = generateSampleCustomReportData(dataSource, metrics, grouping, filters, dateRange);
                setTimeout(() => resolve(result), 500); // 読み込み中の表示のため少し遅延
            } catch (error) {
                console.error('カスタムレポートデータ取得エラー:', error);
                reject(error);
            }
        });
    }
    
    // ===== チャート作成関数 =====
    
    /**
     * ユーザー登録チャートを作成
     */
    function createUserRegistrationChart(data) {
        const canvas = document.getElementById('user-registration-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.userRegistrationChart) {
            activeCharts.userRegistrationChart.destroy();
        }
        
        // チャート作成
        activeCharts.userRegistrationChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '日別登録数',
                        data: data.dailyRegistrations,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    },
                    {
                        label: '累計登録数',
                        data: data.cumulativeRegistrations,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.05)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '日別登録数'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '累計登録数'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * アクティブユーザーチャートを作成
     */
    function createActiveUsersChart(data) {
        const canvas = document.getElementById('active-users-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.activeUsersChart) {
            activeCharts.activeUsersChart.destroy();
        }
        
        // チャート作成
        activeCharts.activeUsersChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'DAU (日間アクティブユーザー)',
                        data: data.dau,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'WAU (週間アクティブユーザー)',
                        data: data.wau,
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'MAU (月間アクティブユーザー)',
                        data: data.mau,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * ユーザーロールチャートを作成
     */
    function createUserRolesChart(data) {
        const canvas = document.getElementById('user-roles-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.userRolesChart) {
            activeCharts.userRolesChart.destroy();
        }
        
        // チャート作成
        activeCharts.userRolesChart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4338ca',
                        '#0ea5e9',
                        '#10b981',
                        '#f97316',
                        '#ef4444'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round(context.raw / total * 100);
                                return `${context.label}: ${context.raw}人 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * ユーザー活動レベルチャートを作成
     */
    function createUserActivityChart(data) {
        const canvas = document.getElementById('user-activity-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.userActivityChart) {
            activeCharts.userActivityChart.destroy();
        }
        
        // チャート作成
        activeCharts.userActivityChart = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#10b981',
                        '#0ea5e9',
                        '#f59e0b',
                        '#f97316',
                        '#ef4444'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = Math.round(context.raw);
                                return `${context.label}: ${percentage}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * ユーザーデバイスチャートを作成
     */
    function createUserDevicesChart(data) {
        const canvas = document.getElementById('user-devices-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.userDevicesChart) {
            activeCharts.userDevicesChart.destroy();
        }
        
        // チャート作成
        activeCharts.userDevicesChart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4338ca',
                        '#0ea5e9',
                        '#10b981'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * リテンションテーブルを更新
     */
    function updateRetentionTable(data) {
        const retentionTbody = document.getElementById('retention-tbody');
        if (!retentionTbody) return;
        
        // テーブル内容をクリア
        retentionTbody.innerHTML = '';
        
        // コホートごとの行を追加
        data.forEach(cohort => {
            const row = document.createElement('tr');
            
            // コホート名と初期ユーザー数
            row.innerHTML = `
                <td>${cohort.cohort}</td>
                <td>${cohort.initialUsers.toLocaleString()}</td>
            `;
            
            // 週ごとのリテンション
            cohort.retention.forEach((retention, index) => {
                // リテンション率に応じた背景色を計算
                let bgColor, textColor;
                
                if (retention === null) {
                    row.innerHTML += `<td>-</td>`;
                    return;
                }
                
                // リテンション率に応じた色の濃さを計算
                const intensity = retention / 100;
                bgColor = `rgba(79, 70, 229, ${intensity.toFixed(2)})`;
                textColor = intensity > 0.5 ? 'white' : 'black';
                
                row.innerHTML += `<td style="background-color: ${bgColor}; color: ${textColor};">${retention}%</td>`;
            });
            
            retentionTbody.appendChild(row);
        });
    }
    
    /**
     * コンテンツ作成チャートを作成
     */
    function createContentCreationChart(data) {
        const canvas = document.getElementById('content-creation-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.contentCreationChart) {
            activeCharts.contentCreationChart.destroy();
        }
        
        // チャート作成
        activeCharts.contentCreationChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '新規コンテンツ数',
                        data: data.data,
                        backgroundColor: 'rgba(14, 165, 233, 0.7)',
                        borderColor: '#0ea5e9',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * コンテンツ人気度チャートを作成
     */
    function createContentPopularityChart(data) {
        const canvas = document.getElementById('content-popularity-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.contentPopularityChart) {
            activeCharts.contentPopularityChart.destroy();
        }
        
        // チャート作成
        activeCharts.contentPopularityChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '閲覧数',
                        data: data.views,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    },
                    {
                        label: 'いいね数',
                        data: data.likes,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'コメント数',
                        data: data.comments,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '閲覧数'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'いいね・コメント数'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * コンテンツカテゴリチャートを作成
     */
    function createContentCategoryChart(data) {
        const canvas = document.getElementById('content-category-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.contentCategoryChart) {
            activeCharts.contentCategoryChart.destroy();
        }
        
        // チャート作成
        activeCharts.contentCategoryChart = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4338ca',
                        '#0ea5e9',
                        '#10b981',
                        '#f97316',
                        '#f59e0b',
                        '#8b5cf6'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = Math.round(context.raw / context.dataset.data.reduce((a, b) => a + b, 0) * 100);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * カテゴリ別閲覧数チャートを作成
     */
    function createCategoryViewsChart(data) {
        const canvas = document.getElementById('category-views-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.categoryViewsChart) {
            activeCharts.categoryViewsChart.destroy();
        }
        
        // チャート作成
        activeCharts.categoryViewsChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '閲覧数',
                    data: data.data,
                    backgroundColor: [
                        'rgba(67, 56, 202, 0.7)',
                        'rgba(14, 165, 233, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(249, 115, 22, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(139, 92, 246, 0.7)'
                    ],
                    borderColor: [
                        '#4338ca',
                        '#0ea5e9',
                        '#10b981',
                        '#f97316','#f59e0b',
                        '#8b5cf6'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `閲覧数: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * トップコンテンツテーブルを更新
     */
    function updateTopContentTable(data) {
        const topContentTbody = document.getElementById('top-content-tbody');
        if (!topContentTbody) return;
        
        // テーブル内容をクリア
        topContentTbody.innerHTML = '';
        
        // コンテンツごとの行を追加
        data.forEach(content => {
            const row = document.createElement('tr');
            
            // 日付のフォーマット
            const createdAt = content.createdAt instanceof Date ? content.createdAt : new Date(content.createdAt);
            const formattedDate = new Intl.DateTimeFormat('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }).format(createdAt);
            
            row.innerHTML = `
                <td>${content.title}</td>
                <td>${content.author}</td>
                <td>${content.category}</td>
                <td>${formattedDate}</td>
                <td>${content.views.toLocaleString()}</td>
                <td>${content.rating} / 5.0</td>
                <td>${content.comments}</td>
            `;
            
            topContentTbody.appendChild(row);
        });
    }
    
    /**
     * ログイン活動チャートを作成
     */
    function createLoginActivityChart(data) {
        const canvas = document.getElementById('login-activity-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.loginActivityChart) {
            activeCharts.loginActivityChart.destroy();
        }
        
        // チャート作成
        activeCharts.loginActivityChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'ログイン数',
                        data: data.logins,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'ユニークユーザー',
                        data: data.uniqueUsers,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * 時間帯別使用状況チャートを作成
     */
    function createHourlyUsageChart(data) {
        const canvas = document.getElementById('hourly-usage-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.hourlyUsageChart) {
            activeCharts.hourlyUsageChart.destroy();
        }
        
        // チャート作成
        activeCharts.hourlyUsageChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'アクセス数',
                        data: data.data,
                        backgroundColor: 'rgba(14, 165, 233, 0.7)',
                        borderColor: '#0ea5e9',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `アクセス数: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * 機能別使用状況チャートを作成
     */
    function createFeatureUsageChart(data) {
        const canvas = document.getElementById('feature-usage-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.featureUsageChart) {
            activeCharts.featureUsageChart.destroy();
        }
        
        // チャート作成
        activeCharts.featureUsageChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '使用回数',
                        data: data.counts,
                        backgroundColor: 'rgba(67, 56, 202, 0.7)',
                        borderColor: '#4338ca',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'ユニークユーザー数',
                        data: data.uniqueUsers,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '使用回数'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'ユニークユーザー数'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    /**
     * エンゲージメントトレンドチャートを作成
     */
    function createEngagementTrendChart(data) {
        const canvas = document.getElementById('engagement-trend-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.engagementTrendChart) {
            activeCharts.engagementTrendChart.destroy();
        }
        
        // チャート作成
        activeCharts.engagementTrendChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'エンゲージメントスコア',
                        data: data.scores,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `エンゲージメントスコア: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'スコア (%)'
                        }
                    }
                }
            }
        });
    }
    
    /**
     * エンゲージメント統計を更新
     */
    function updateEngagementStats(data) {
        // 平均エンゲージメントスコア
        const avgEngagementScore = document.getElementById('avg-engagement-score');
        if (avgEngagementScore) {
            avgEngagementScore.textContent = `${data.averageScore.toFixed(1)}%`;
        }
        
        // 前月比
        const engagementChange = document.getElementById('engagement-change');
        if (engagementChange) {
            const changeValue = data.monthlyChange;
            const changeText = `${changeValue > 0 ? '+' : ''}${changeValue.toFixed(1)}%`;
            engagementChange.textContent = changeText;
            
            // 値に応じてクラスを変更
            if (changeValue > 0) {
                engagementChange.parentElement.querySelector('.stat-icon').className = 'stat-icon stat-success';
                engagementChange.parentElement.querySelector('.stat-icon i').className = 'fas fa-arrow-up';
            } else if (changeValue < 0) {
                engagementChange.parentElement.querySelector('.stat-icon').className = 'stat-icon stat-danger';
                engagementChange.parentElement.querySelector('.stat-icon i').className = 'fas fa-arrow-down';
            } else {
                engagementChange.parentElement.querySelector('.stat-icon').className = 'stat-icon stat-info';
                engagementChange.parentElement.querySelector('.stat-icon i').className = 'fas fa-minus';
            }
        }
        
        // リテンション率
        const retentionRate = document.getElementById('retention-rate');
        if (retentionRate) {
            retentionRate.textContent = `${data.retentionRate.toFixed(1)}%`;
        }
    }
    
    /**
     * 地域分布チャートを作成
     */
    function createRegionDistributionChart(data) {
        const canvas = document.getElementById('region-distribution-chart');
        if (!canvas) return;
        
        // 既存のチャートを破棄
        if (activeCharts.regionDistributionChart) {
            activeCharts.regionDistributionChart.destroy();
        }
        
        // チャート作成
        activeCharts.regionDistributionChart = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4338ca',
                        '#0ea5e9',
                        '#10b981',
                        '#f97316',
                        '#f59e0b',
                        '#8b5cf6'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * 地域テーブルを更新
     */
    function updateRegionTable(data) {
        const regionTbody = document.getElementById('region-tbody');
        if (!regionTbody) return;
        
        // テーブル内容をクリア
        regionTbody.innerHTML = '';
        
        // 地域ごとの行を追加
        data.forEach(region => {
            const row = document.createElement('tr');
            
            // 前月比のクラスを決定
            let changeClass = '';
            if (region.change > 0) {
                changeClass = 'text-success';
            } else if (region.change < 0) {
                changeClass = 'text-danger';
            }
            
            const changeText = `${region.change > 0 ? '+' : ''}${region.change.toFixed(1)}%`;
            
            row.innerHTML = `
                <td>${region.name}</td>
                <td>${region.users.toLocaleString()}</td>
                <td>${region.percentage.toFixed(1)}%</td>
                <td class="${changeClass}">${changeText}</td>
            `;
            
            regionTbody.appendChild(row);
        });
    }
    
    /**
     * カスタムレポートテーブルを作成
     */
    function createCustomReportTable(data) {
        const tableHeader = document.getElementById('custom-report-table-header');
        const tableBody = document.getElementById('custom-report-table-body');
        
        if (!tableHeader || !tableBody) return;
        
        // テーブルヘッダーをクリア
        tableHeader.innerHTML = '';
        
        // グループ列のヘッダー
        const groupTh = document.createElement('th');
        groupTh.textContent = data.groupLabel;
        tableHeader.appendChild(groupTh);
        
        // メトリクス列のヘッダー
        data.metrics.forEach(metric => {
            const th = document.createElement('th');
            th.textContent = metric.label;
            tableHeader.appendChild(th);
        });
        
        // テーブル本体をクリア
        tableBody.innerHTML = '';
        
        // データ行を追加
        data.items.forEach(item => {
            const tr = document.createElement('tr');
            
            // グループ列
            const groupTd = document.createElement('td');
            groupTd.textContent = item.group;
            tr.appendChild(groupTd);
            
            // メトリクス列
            data.metrics.forEach(metric => {
                const td = document.createElement('td');
                td.textContent = formatMetricValue(metric.value, item[metric.value]);
                tr.appendChild(td);
            });
            
            tableBody.appendChild(tr);
        });
    }
    
    /**
     * カスタムレポートチャートを作成
     */
    function createCustomReportChart(canvas, data, visualization) {
        // 既存のチャートを破棄
        if (activeCharts.customReportChart) {
            activeCharts.customReportChart.destroy();
        }
        
        // データセットを準備
        const datasets = data.metrics.map((metric, index) => {
            // チャートタイプに応じた色を生成
            const colors = ['#4338ca', '#0ea5e9', '#10b981', '#f97316', '#f59e0b', '#ef4444'];
            const color = colors[index % colors.length];
            
            // RGB値に変換（backgroundColorの計算用）
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            
            const dataset = {
                label: metric.label,
                data: data.items.map(item => item[metric.value]),
                borderColor: color,
                backgroundColor: visualization === 'pie' ? 
                    data.items.map((_, i) => {
                        const hue = (i * 360 / data.items.length);
                        return `hsl(${hue}, 70%, 60%)`;
                    }) :
                    `rgba(${r}, ${g}, ${b}, 0.1)`,
                borderWidth: 2
            };
            
            // 折れ線グラフの場合の設定
            if (visualization === 'line') {
                dataset.tension = 0.4;
                dataset.fill = true;
            }
            
            return dataset;
        });
        
        // チャートの種類を決定
        let chartType = 'line';
        let chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const metricType = data.metrics[context.datasetIndex].value;
                            label += formatMetricValue(metricType, context.raw);
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };
        
        switch(visualization) {
            case 'bar':
                chartType = 'bar';
                break;
            case 'pie':
                chartType = 'pie';
                // 円グラフの場合、最初のメトリクスのみ使用
                if (datasets.length > 1) {
                    datasets.splice(1);
                }
                // 円グラフのオプション
                chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const metricType = data.metrics[0].value;
                                    return `${context.label}: ${formatMetricValue(metricType, context.raw)}`;
                                }
                            }
                        }
                    }
                };
                break;
            case 'heatmap':
                // ヒートマップは特殊な実装
                return createHeatmapChart(canvas, data);
        }
        
        // チャートを作成
        activeCharts.customReportChart = new Chart(canvas, {
            type: chartType,
            data: {
                labels: data.items.map(item => item.group),
                datasets: datasets
            },
            options: chartOptions
        });
    }
    
    /**
     * ヒートマップチャートの作成（カスタム実装）
     */
    function createHeatmapChart(canvas, data) {
        // 最初のメトリクスのみ使用
        const metric = data.metrics[0];
        const values = data.items.map(item => item[metric.value]);
        const max = Math.max(...values);
        
        // データセット
        const dataset = {
            label: metric.label,
            data: values,
            backgroundColor: values.map(value => {
                const intensity = value / max;
                return `rgba(67, 56, 202, ${intensity.toFixed(2)})`;
            }),
            borderColor: 'rgba(255, 255, 255, 0.2)',
            borderWidth: 1
        };
        
        // チャート作成
        activeCharts.customReportChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.items.map(item => item.group),
                datasets: [dataset]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${metric.label}: ${formatMetricValue(metric.value, context.raw)}`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * エクスポートモーダルを表示
     */
    function showExportModal() {
        const exportModal = document.getElementById('export-modal');
        if (exportModal) {
            exportModal.style.display = 'flex';
        }
    }
    
    /**
     * 指定した形式でレポートをエクスポート
     */
    function exportReportAs(format) {
        // 現在アクティブなタブを取得
        const activeTab = document.querySelector('#reports-section .tab.active');
        const reportType = activeTab ? activeTab.dataset.tab : null;
        
        if (!reportType) {
            showSystemNotification('エクスポートするレポートが見つかりません', 'warning');
            return;
        }
        
        // 日付範囲を取得
        const dateRange = getSelectedDateRange();
        const formattedDate = new Intl.DateTimeFormat('ja-JP', { 
            year: 'numeric', month: '2-digit', day: '2-digit' 
        }).format(new Date()).replace(/\//g, '');
        
        // 実際のエクスポート処理（デモでは通知のみ）
        let fileName = `katsujiringx_report_${reportType}_${formattedDate}`;
        let message = '';
        
        switch(format) {
            case 'csv':
                fileName += '.csv';
                message = `CSVファイル「${fileName}」をエクスポートしました`;
                break;
            case 'pdf':
                fileName += '.pdf';
                message = `PDFファイル「${fileName}」をエクスポートしました`;
                break;
            case 'excel':
                fileName += '.xlsx';
                message = `Excelファイル「${fileName}」をエクスポートしました`;
                break;
            case 'image':
                fileName += '.png';
                message = `画像ファイル「${fileName}」をエクスポートしました`;
                break;
        }
        
        showSystemNotification(message, 'success');
        
        // 実際の実装では、選択されたフォーマットでデータを変換し、
        // ダウンロードを開始するコードがここに入ります
    }
    
    /**
     * メトリクス値をフォーマット
     */
    function formatMetricValue(metricType, value) {
        if (value === undefined || value === null) return '-';
        
        // メトリクスタイプに応じたフォーマット
        if (metricType.includes('rate') || metricType.includes('percentage')) {
            return `${value.toFixed(1)}%`;
        } else if (metricType.includes('duration')) {
            const minutes = Math.floor(value / 60);
            const seconds = Math.floor(value % 60);
            return `${minutes}分${seconds}秒`;
        } else if (metricType.includes('score')) {
            return value.toFixed(2);
        } else if (value > 1000) {
            return value.toLocaleString();
        }
        
        return value.toString();
    }
    
    // ===== サンプルデータ生成関数 =====
    
    /**
     * ユーザー登録のサンプルデータを生成
     */
    function generateSampleUserRegistrationData(dateRange) {
        const labels = [];
        const dailyRegistrations = [];
        const cumulativeRegistrations = [];
        
        let cumulativeTotal = 0;
        
        for (let d = new Date(dateRange.startDate); d <= dateRange.endDate; d.setDate(d.getDate() + 1)) {
            // 日付ラベル
            labels.push(new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(d));
            
            // 曜日と基本値でバリエーションを持たせる
            const dayOfWeek = d.getDay();
            const baseValue = dayOfWeek === 0 || dayOfWeek === 6 ? 5 : 10; // 週末は少なめ
            
            // ランダムなデータ生成
            const dailyCount = Math.floor(Math.random() * baseValue) + 5;
            dailyRegistrations.push(dailyCount);
            
            cumulativeTotal += dailyCount;
            cumulativeRegistrations.push(cumulativeTotal);
        }
        
        return {
            labels,
            dailyRegistrations,
            cumulativeRegistrations
        };
    }
    
    /**
     * アクティブユーザーのサンプルデータを生成
     */
    function generateSampleActiveUsersData(dateRange) {
        const labels = [];
        const dau = [];
        const wau = [];
        const mau = [];
        
        const daysCount = Math.floor((dateRange.endDate - dateRange.startDate) / (24 * 60 * 60 * 1000)) + 1;
        
        for (let i = 0; i < daysCount; i++) {
            const date = new Date(dateRange.startDate);
            date.setDate(date.getDate() + i);
            
            // 日付ラベル
            labels.push(new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(date));
            
            // 曜日と基本値でバリエーションを持たせる
            const dayOfWeek = date.getDay();
            const baseValue = dayOfWeek === 0 || dayOfWeek === 6 ? 80 : 100; // 週末は少なめ
            
            // ランダムなデータ生成
            const dauValue = baseValue + Math.floor(Math.random() * 30);
            const wauMultiplier = 3.5 + Math.random() * 0.5;
            const mauMultiplier = 8 + Math.random() * 1;
            
            dau.push(dauValue);
            wau.push(Math.floor(dauValue * wauMultiplier));
            mau.push(Math.floor(dauValue * mauMultiplier));
        }
        
        return {
            labels,
            dau,
            wau,
            mau
        };
    }
    
    /**
     * ユーザーロールのサンプルデータを生成
     */
    function generateSampleUserRolesData() {
        return {
            labels: ['学生', '教師', '研究者', '一般', '管理者'],
            data: [45, 20, 15, 18, 2]
        };
    }
    
    /**
     * ユーザー活動レベルのサンプルデータを生成
     */
    function generateSampleUserActivityData() {
        return {
            labels: ['非常にアクティブ', 'アクティブ', '普通', '低活動', '休眠'],
            data: [15, 25, 30, 20, 10]
        };
    }
    
    /**
     * ユーザーデバイスのサンプルデータを生成
     */
    function generateSampleUserDevicesData() {
        return {
            labels: ['デスクトップ', 'モバイル', 'タブレット'],
            data: [40, 45, 15]
        };
    }
    
    /**
     * リテンションのサンプルデータを生成
     */
    function generateSampleRetentionData() {
        const months = ['2023年9月', '2023年10月', '2023年11月', '2023年12月', '2024年1月', '2024年2月'];
        const result = [];
        
        months.forEach((month, index) => {
            // 初期ユーザー数（徐々に増加）
            const initialUsers = 120 + index * 20 + Math.floor(Math.random() * 20);
            
            // リテンション率を生成（時間が経つほど低下）
            const retention = [];
            for (let week = 0; week < 8; week++) {
                // 最大で8週間分のデータ
                if (index + week >= months.length + 3) {
                    // データがまだない期間
                    retention.push(null);
                } else {
                    // 初週は100%、以降は徐々に低下
                    const baseRetention = week === 0 ? 100 : 100 - week * 8;
                    // 最近の月ほどリテンション率が高い傾向
                    const monthBonus = index * 1.5;
                    // ランダム要素も加える
                    const randomFactor = Math.random() * 5 - 2.5;
                    
                    let value = baseRetention + monthBonus + randomFactor;
                    // 100%を超えないように、また極端に低くならないように
                    value = Math.min(100, Math.max(value, 30));
                    
                    retention.push(Math.round(value));
                }
            }
            
            result.push({
                cohort: month,
                initialUsers: initialUsers,
                retention: retention
            });
        });
        
        return result;
    }
    
    /**
     * コンテンツ作成のサンプルデータを生成
     */
    function generateSampleContentCreationData(dateRange) {
        const labels = [];
        const data = [];
        
        const daysCount = Math.floor((dateRange.endDate - dateRange.startDate) / (24 * 60 * 60 * 1000)) + 1;
        
        for (let i = 0; i < daysCount; i++) {
            const date = new Date(dateRange.startDate);
            date.setDate(date.getDate() + i);
            
            // 日付ラベル
            labels.push(new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(date));
            
            // 曜日でバリエーションを持たせる
            const dayOfWeek = date.getDay();
            const baseValue = dayOfWeek === 0 || dayOfWeek === 6 ? 2 : 5; // 週末は少なめ
            
            // ランダムなデータ生成
            data.push(Math.floor(Math.random() * baseValue) + 2);
        }
        
        return {
            labels,
            data
        };
    }
    
    /**
     * コンテンツ人気度のサンプルデータを生成
     */
    function generateSampleContentPopularityData(dateRange) {
        // 週単位のデータを生成
        const labels = [];
        const views = [];
        const likes = [];
        const comments = [];
        
        // 週数を計算
        const weekCount = Math.ceil((dateRange.endDate - dateRange.startDate) / (7 * 24 * 60 * 60 * 1000));
        
        for (let i = 0; i < weekCount; i++) {
            const weekStart = new Date(dateRange.startDate);
            weekStart.setDate(weekStart.getDate() + i * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // 週のラベル
            labels.push(`${new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(weekStart)} - ${new Intl.DateTimeFormat('ja-JP', { day: 'numeric' }).format(weekEnd)}`);
            
            // 徐々に増加する傾向にする
            const trend = 1 + i * 0.1; // 週が進むごとに10%増加
            
            // ランダムなデータ生成
            const baseViews = Math.floor((500 + Math.random() * 100) * trend);
            views.push(baseViews);
            likes.push(Math.floor(baseViews * (0.08 + Math.random() * 0.04))); // 8-12%がいいね
            comments.push(Math.floor(baseViews * (0.02 + Math.random() * 0.02))); // 2-4%がコメント
        }
        
        return {
            labels,
            views,
            likes,
            comments
        };
    }
    
    /**
     * コンテンツカテゴリのサンプルデータを生成
     */
    function generateSampleContentCategoryData() {
        return {
            labels: ['教育', 'ビジネス', '歴史', '文化', '文学', 'その他'],
            data: [35, 25, 15, 12, 8, 5]
        };
    }
    
    /**
     * カテゴリ別閲覧数のサンプルデータを生成
     */
    function generateSampleCategoryViewsData() {
        return {
            labels: ['教育', 'ビジネス', '歴史', '文化', '文学', 'その他'],
            data: [12500, 9800, 5400, 4200, 3100, 1800]
        };
    }
    
    /**
     * トップコンテンツのサンプルデータを生成
     */
    function generateSampleTopContentData() {
        const titles = [
            '「実用日本語」シリーズ 第1巻',
            'ビジネス文書の書き方ガイド',
            '古文書から学ぶ平安時代の言葉',
            '現代国語の表現技法',
            '日本語の方言と地域文化',
            '就活に役立つ敬語表現集',
            '文学作品に見る日本語の変遷',
            '初心者のための漢字学習法',
            '外国人向け日本語教授法',
            'デジタル時代の文章作成術'
        ];
        
        const authors = [
            '田中 教授',
            '佐藤 直子',
            '鈴木 史郎',
            '山本 文子',
            '伊藤 誠',
            '渡辺 京子',
            '高橋 学',
            '中村 晴子',
            '小林 拓也',
            '加藤 梨沙'
        ];
        
        const categories = ['教育', 'ビジネス', '歴史', '文化', '文学'];
        
        const result = [];
        
        // 現在日付から過去数ヶ月のランダムな日付を生成
        for (let i = 0; i < 5; i++) {
            const today = new Date();
            const randomDaysAgo = Math.floor(Math.random() * 180); // 過去180日以内
            const createdAt = new Date(today);
            createdAt.setDate(today.getDate() - randomDaysAgo);
            
            result.push({
                title: titles[i],
                author: authors[i],
                category: categories[i % categories.length],
                createdAt: createdAt,
                views: 3500 - i * 300 + Math.floor(Math.random() * 200), // 上位ほど閲覧数が多い
                rating: (5 - i * 0.1 + Math.random() * 0.2).toFixed(1), // 4.5-5.0の間でランダム
                comments: 180 - i * 20 + Math.floor(Math.random() * 30) // 上位ほどコメント数が多い
            });
        }
        
        return result;
    }
    
    /**
     * ログイン活動のサンプルデータを生成
     */
    function generateSampleLoginActivityData(dateRange) {
        const labels = [];
        const logins = [];
        const uniqueUsers = [];
        
        const daysCount = Math.floor((dateRange.endDate - dateRange.startDate) / (24 * 60 * 60 * 1000)) + 1;
        
        for (let i = 0; i < daysCount; i++) {
            const date = new Date(dateRange.startDate);
            date.setDate(date.getDate() + i);
            
            // 日付ラベル
            labels.push(new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(date));
            
            // 曜日でバリエーションを持たせる
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const factor = isWeekend ? 0.7 : 1; // 週末は70%程度
            
            // ランダムなデータ生成
            const uniqueUserCount = Math.floor((120 + Math.random() * 30) * factor);
            const loginPerUser = 1.5 + Math.random() * 0.5; // 平均1.5-2.0回/ユーザー
            
            uniqueUsers.push(uniqueUserCount);
            logins.push(Math.floor(uniqueUserCount * loginPerUser));
        }
        
        return {
            labels,
            logins,
            uniqueUsers
        };
    }
    
    /**
     * 時間帯別使用状況のサンプルデータを生成
     */
    function generateSampleHourlyUsageData() {
        const labels = [];
        const data = [];
        
        // 00:00-23:00の各時間帯
        for (let hour = 0; hour < 24; hour++) {
            labels.push(`${hour.toString().padStart(2, '0')}:00`);
            
            // 時間帯に応じたアクセス数のパターンを作成
            let baseAccess;
            if (hour >= 1 && hour <= 5) {
                // 深夜（少ない）
                baseAccess = 20 + Math.random() * 30;
            } else if (hour >= 6 && hour <= 8) {
                // 朝（増加）
                baseAccess = 50 + (hour - 6) * 50 + Math.random() * 50;
            } else if (hour >= 9 && hour <= 17) {
                // 日中（多い）
                baseAccess = 200 + Math.random() * 100;
            } else if (hour >= 18 && hour <= 22) {
                // 夕方〜夜（ピーク）
                baseAccess = 300 + Math.random() * 150;
            } else {
                // 深夜（減少）
                baseAccess = 150 + Math.random() * 50;
            }
            
            data.push(Math.floor(baseAccess));
        }
        
        return {
            labels,
            data
        };
    }
    
    /**
     * 機能別使用状況のサンプルデータを生成
     */
    function generateSampleFeatureUsageData() {
        const features = [
            'ドキュメント作成',
            '検索',
            'コミュニティ閲覧',
            'コミュニティ投稿',
            'ユーザープロフィール',
            'お気に入り登録',
            'コメント',
            'ダウンロード'
        ];
        
        const counts = [];
        const uniqueUsers = [];
        
        features.forEach((feature, index) => {
            // 機能の人気度に応じた使用回数とユニークユーザー数
            const popularity = 1 - index * 0.1; // 先頭の機能ほど人気
            
            counts.push(Math.floor((5000 + Math.random() * 1000) * popularity));
            uniqueUsers.push(Math.floor((800 + Math.random() * 200) * popularity));
        });
        
        return {
            labels: features,
            counts,
            uniqueUsers
        };
    }
    
    /**
     * エンゲージメントのサンプルデータを生成
     */
    function generateSampleEngagementData(dateRange) {
        const labels = [];
        const scores = [];
        
        // 週単位のデータを生成
        const weekCount = Math.ceil((dateRange.endDate - dateRange.startDate) / (7 * 24 * 60 * 60 * 1000));
        
        // 基準となるスコアと変動
        let baseScore = 65; // 基準スコア
        let trend = 0.5; // 週あたりの上昇傾向
        
        for (let i = 0; i < weekCount; i++) {
            const weekStart = new Date(dateRange.startDate);
            weekStart.setDate(weekStart.getDate() + i * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            // 週のラベル
            labels.push(`${new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(weekStart)} - ${new Intl.DateTimeFormat('ja-JP', { day: 'numeric' }).format(weekEnd)}`);
            
            // スコアを計算（上昇傾向 + ランダム変動）
            const weekScore = baseScore + i * trend + (Math.random() * 4 - 2);
            scores.push(Math.min(100, Math.max(0, weekScore))); // 0-100の範囲に収める
        }
        
        // 平均スコアと変化率
        const currentScore = scores[scores.length - 1];
        const previousScore = scores.length > 4 ? scores[scores.length - 5] : scores[0]; // 約1ヶ月前
        const monthlyChange = previousScore ? ((currentScore - previousScore) / previousScore) * 100 : 0;
        
        // 平均スコア（直近4週間）
        const recentScores = scores.slice(-4);
        const averageScore = recentScores.reduce((a, b) => a + b, 0) / recentScores.length;
        
        // リテンション率（エンゲージメントスコアに連動）
        const retentionRate = currentScore * 0.85; // エンゲージメントの85%がリテンションと仮定
        
        return {
            labels,
            scores,
            averageScore,
            monthlyChange,
            retentionRate
        };
    }
    
    /**
     * 地域データのサンプルデータを生成
     */
    function generateSampleRegionData() {
        // 地域別ユーザー分布（テーブル用）
        const regions = [
            { name: '東京都', users: 1245, percentage: 32.4, change: 5.2 },
            { name: '大阪府', users: 687, percentage: 17.9, change: 3.7 },
            { name: '神奈川県', users: 512, percentage: 13.3, change: 2.1 },
            { name: '愛知県', users: 438, percentage: 11.4, change: 4.5 },
            { name: '福岡県', users: 325, percentage: 8.5, change: -1.2 },
            { name: 'その他', users: 634, percentage: 16.5, change: 2.8 }
        ];
        
        // チャート用データ
        const chartData = {
            labels: regions.map(r => r.name),
            data: regions.map(r => r.percentage)
        };
        
        return {
            tableData: regions,
            chartData: chartData
        };
    }
    
    /**
     * カスタムレポートのサンプルデータを生成
     */
    function generateSampleCustomReportData(dataSource, metrics, grouping, filters, dateRange) {
        // グループラベル
        let groupLabel;
        switch(grouping) {
            case 'daily': groupLabel = '日付'; break;
            case 'weekly': groupLabel = '週'; break;
            case 'monthly': groupLabel = '月'; break;
            case 'quarterly': groupLabel = '四半期'; break;
            case 'yearly': groupLabel = '年'; break;
            case 'category': groupLabel = 'カテゴリ'; break;
            case 'role': groupLabel = 'ロール'; break;
            case 'region': groupLabel = '地域'; break;
            default: groupLabel = grouping;
        }
        
        // アイテムを生成
        const items = [];
        
        if (grouping === 'category') {
            // カテゴリ別
            const categories = ['教育', 'ビジネス', '歴史', '文化', '文学', 'その他'];
            
            categories.forEach(category => {
                const item = { group: category };
                
                // 各メトリクスのデータを生成
                metrics.forEach(metric => {
                    const baseValue = Math.random() * 100; // ベースライン値
                    
                    if (metric.value.includes('rate') || metric.value.includes('percentage')) {
                        // パーセンテージ値
                        item[metric.value] = Math.min(100, baseValue + Math.random() * 20);
                    } else if (metric.value.includes('score')) {
                        // スコア値
                        item[metric.value] = baseValue / 20 + Math.random();
                    } else if (metric.value.includes('count') || metric.value.includes('users')) {
                        // カウント値
                        item[metric.value] = Math.floor(baseValue * 50 + Math.random() * 1000);
                    } else if (metric.value.includes('duration')) {
                        // 時間値
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 60);
                    } else {
                        // その他
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 100);
                    }
                });
                
                items.push(item);
            });
        } else if (grouping === 'role') {
            // ロール別
            const roles = ['学生', '教師', '研究者', '一般', '管理者'];
            
            roles.forEach(role => {
                const item = { group: role };
                
                // 各メトリクスのデータを生成
                metrics.forEach(metric => {
                    const baseValue = Math.random() * 100; // ベースライン値
                    
                    if (metric.value.includes('rate') || metric.value.includes('percentage')) {
                        // パーセンテージ値
                        item[metric.value] = Math.min(100, baseValue + Math.random() * 20);
                    } else if (metric.value.includes('score')) {
                        // スコア値
                        item[metric.value] = baseValue / 20 + Math.random();
                    } else if (metric.value.includes('count') || metric.value.includes('users')) {
                        // カウント値
                        item[metric.value] = Math.floor(baseValue * 50 + Math.random() * 1000);
                    } else if (metric.value.includes('duration')) {
                        // 時間値
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 60);
                    } else {
                        // その他
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 100);
                    }
                });
                
                items.push(item);
            });
        } else if (grouping === 'region') {
            // 地域別
            const regions = ['東京都', '大阪府', '神奈川県', '愛知県', '福岡県', 'その他'];
            
            regions.forEach(region => {
                const item = { group: region };
                
                // 各メトリクスのデータを生成
                metrics.forEach(metric => {
                    const baseValue = Math.random() * 100; // ベースライン値
                    
                    if (metric.value.includes('rate') || metric.value.includes('percentage')) {
                        // パーセンテージ値
                        item[metric.value] = Math.min(100, baseValue + Math.random() * 20);
                    } else if (metric.value.includes('score')) {
                        // スコア値
                        item[metric.value] = baseValue / 20 + Math.random();
                    } else if (metric.value.includes('count') || metric.value.includes('users')) {
                        // カウント値
                        item[metric.value] = Math.floor(baseValue * 50 + Math.random() * 1000);
                    } else if (metric.value.includes('duration')) {
                        // 時間値
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 60);
                    } else {
                        // その他
                        item[metric.value] = Math.floor(baseValue * 10 + Math.random() * 100);
                    }
                });
                
                items.push(item);
            });
        } else {
            // 時系列データ（日別、週別、月別など）
            const periods = [];
            
            if (grouping === 'daily') {
                // 日別データ
                for (let d = new Date(dateRange.startDate); d <= dateRange.endDate; d.setDate(d.getDate() + 1)) {
                    periods.push({
                        date: new Date(d),
                        label: new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(d)
                    });
                }
            } else if (grouping === 'weekly') {
                // 週別データ
                const weekCount = Math.ceil((dateRange.endDate - dateRange.startDate) / (7 * 24 * 60 * 60 * 1000));
                
                for (let i = 0; i < weekCount; i++) {
                    const weekStart = new Date(dateRange.startDate);
                    weekStart.setDate(weekStart.getDate() + i * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    periods.push({
                        date: weekStart,
                        label: `${new Intl.DateTimeFormat('ja-JP', { month: 'short', day: 'numeric' }).format(weekStart)} - ${new Intl.DateTimeFormat('ja-JP', { day: 'numeric' }).format(weekEnd)}`
                    });
                }
            } else if (grouping === 'monthly') {
                // 月別データ
                const startYear = dateRange.startDate.getFullYear();
                const startMonth = dateRange.startDate.getMonth();
                const endYear = dateRange.endDate.getFullYear();
                const endMonth = dateRange.endDate.getMonth();
                
                for (let year = startYear; year <= endYear; year++) {
                    const monthStart = year === startYear ? startMonth : 0;
                    const monthEnd = year === endYear ? endMonth : 11;
                    
                    for (let month = monthStart; month <= monthEnd; month++) {
                        const date = new Date(year, month, 1);
                        periods.push({
                            date: date,
                            label: new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: 'long' }).format(date)
                        });
                    }
                }
            } else if (grouping === 'quarterly') {
                // 四半期データ
                const startYear = dateRange.startDate.getFullYear();
                const startQuarter = Math.floor(dateRange.startDate.getMonth() / 3);
                const endYear = dateRange.endDate.getFullYear();
                const endQuarter = Math.floor(dateRange.endDate.getMonth() / 3);
                
                for (let year = startYear; year <= endYear; year++) {
                    const quarterStart = year === startYear ? startQuarter : 0;
                    const quarterEnd = year === endYear ? endQuarter : 3;
                    
                    for (let quarter = quarterStart; quarter <= quarterEnd; quarter++) {
                        const date = new Date(year, quarter * 3, 1);
                        periods.push({
                            date: date,
                            label: `${year}年 Q${quarter + 1}`
                        });
                    }
                }
            } else if (grouping === 'yearly') {
                // 年別データ
                const startYear = dateRange.startDate.getFullYear();
                const endYear = dateRange.endDate.getFullYear();
                
                for (let year = startYear; year <= endYear; year++) {
                    periods.push({
                        date: new Date(year, 0, 1),
                        label: `${year}年`
                    });
                }
            }
            
            // 各期間のデータを生成
            periods.forEach((period, index) => {
                const item = { group: period.label };
                
                // トレンド要素（時間が経つほど値が変化）
                const trend = index / periods.length;
                
                // 各メトリクスのデータを生成
                metrics.forEach(metric => {
                    const baseValue = Math.random() * 100; // ベースライン値
                    
                    // データソースとメトリクスに応じたスケーリング
                    if (metric.value.includes('rate') || metric.value.includes('percentage')) {
                        // パーセンテージ値
                        item[metric.value] = Math.min(100, (baseValue + trend * 20) % 100);
                    } else if (metric.value.includes('score')) {
                        // スコア値
                        item[metric.value] = baseValue / 20 + trend * 2;
                    } else if (metric.value.includes('count') || metric.value.includes('users')) {
                        // カウント値
                        item[metric.value] = Math.floor(baseValue * 50 + trend * 5000);
                    } else if (metric.value.includes('duration')) {
                        // 時間値
                        item[metric.value] = Math.floor(baseValue * 10 + trend * 300);
                    } else {
                        // その他
                        item[metric.value] = Math.floor(baseValue * 10 + trend * 100);
                    }
                });
                
                items.push(item);
            });
        }
        
        return {
            dataSource,
            metrics,
            groupLabel,
            items
        };
    }
    

// グローバル変数を先に宣言
var ReportingModule;

// DOM読み込み後に初期化する関数
document.addEventListener('DOMContentLoaded', function() {
    // レポートモジュールを初期化
    ReportingModule.init();
});

/**
 * レポート・分析セクションの機能
 */
ReportingModule = (function() {
    // プライベート変数
    let activeCharts = {}; // 現在表示中のすべてのチャート
    let currentDateRange = null; // 現在選択されている日付範囲
    
    /**
     * 初期化処理
     */
    function init() {
        console.log('レポート・分析モジュールを初期化しています...');
        
        // タブ切り替え
        initTabs();
        
        // 日付範囲選択の初期化
        initDateRange();
        
        // レポート生成ボタン
        initReportButtons();
        
        // カスタムレポートビルダーの初期化
        initCustomReportBuilder();
        
        // エクスポートモーダルの初期化
        initExportModal();
        
        // 初期データを読み込み（ユーザーレポート）
        loadReportData('user-reports');
        
        // 保存済みレポートの読み込み
        loadSavedReports();
    }
    
    /**
     * タブ切り替えの初期化
     */
    function initTabs() {
        const reportTabs = document.querySelectorAll('#reports-section .tab');
        const reportContents = document.querySelectorAll('#reports-section .tab-content');
        
        reportTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // タブのアクティブ状態を更新
                reportTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // コンテンツの表示/非表示を切り替え
                reportContents.forEach(content => {
                    if (content.id === `${tabId}-content`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
                
                // タブに応じたレポートを読み込み
                loadReportData(tabId);
            });
        });
    }
    
    /**
     * 日付範囲選択の初期化
     */
    function initDateRange() {
        const dateRangeSelect = document.getElementById('report-date-range');
        const customDateRange = document.getElementById('custom-date-range');
        
        if (dateRangeSelect) {
            dateRangeSelect.addEventListener('change', () => {
                if (dateRangeSelect.value === 'custom') {
                    customDateRange.style.display = 'flex';
                    
                    // 現在の日付とデフォルトの範囲を設定
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    
                    document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
                    document.getElementById('report-start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
                } else {
                    customDateRange.style.display = 'none';
                }
                
                // 日付範囲が変更されたら現在の範囲を更新
                currentDateRange = getSelectedDateRange();
            });
            
            // 初期の日付範囲を設定
            currentDateRange = getSelectedDateRange();
        }
    }
    
    /**
     * レポート関連ボタンの初期化
     */
    function initReportButtons() {
        // レポート生成ボタン
        const generateReportBtn = document.getElementById('generate-report-btn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', () => {
                // 現在アクティブなタブを取得
                const activeTab = document.querySelector('#reports-section .tab.active');
                if (activeTab) {
                    // 日付範囲を更新
                    currentDateRange = getSelectedDateRange();
                    // レポートデータを読み込み
                    loadReportData(activeTab.dataset.tab);
                    showSystemNotification('レポートを生成しています...', 'info');
                }
            });
        }
        
        // エクスポートボタン
        const exportReportBtn = document.getElementById('export-report-btn');
        if (exportReportBtn) {
            exportReportBtn.addEventListener('click', () => {
                showExportModal();
            });
        }
    }
    
    /**
     * カスタムレポートビルダーの初期化
     */
    function initCustomReportBuilder() {
        // データソース変更時にメトリクスを更新
        const customDataSource = document.getElementById('custom-data-source');
        if (customDataSource) {
            customDataSource.addEventListener('change', () => {
                updateAvailableMetrics(customDataSource.value);
            });
            
            // 初期メトリクスを設定
            updateAvailableMetrics(customDataSource.value);
        }
        
        // フィルター追加ボタン
        const addFilterBtn = document.getElementById('add-filter-btn');
        if (addFilterBtn) {
            addFilterBtn.addEventListener('click', () => {
                addCustomFilter();
            });
        }
        
        // カスタムレポート生成ボタン
        const buildCustomReportBtn = document.getElementById('build-custom-report-btn');
        if (buildCustomReportBtn) {
            buildCustomReportBtn.addEventListener('click', () => {
                buildCustomReport();
            });
        }
    }
    
    /**
     * エクスポートモーダルの初期化
     */
    function initExportModal() {
        const exportModal = document.getElementById('export-modal');
        const closeBtn = document.getElementById('export-modal-close');
        const cancelBtn = document.getElementById('export-modal-cancel');
        const formatBtns = document.querySelectorAll('.export-format-btn');
        
        if (exportModal) {
            // 閉じるボタン
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    exportModal.style.display = 'none';
                });
            }
            
            // キャンセルボタン
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    exportModal.style.display = 'none';
                });
            }
            
            // フォーマットボタン
            formatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const format = btn.dataset.format;
                    exportReportAs(format);
                    exportModal.style.display = 'none';
                });
            });
        }
    }
    
    /**
     * カスタムフィルターを削除
     * ※グローバルに公開する必要があるため、他と分けて定義
     */
    function removeFilter(filterId) {
        const filter = document.getElementById(filterId);
        if (filter) {
            filter.remove();
        }
    }
    
    // 以下、その他の関数は変更なし（長さの都合で省略）
    // ...
    
    // 他のすべての関数はそのまま残します
    
    /**
     * 選択された日付範囲を取得
     */
    function getSelectedDateRange() {
        const dateRangeSelect = document.getElementById('report-date-range');
        
        if (dateRangeSelect.value === 'custom') {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (startDate && endDate) {
                return {
                    type: 'custom',
                    startDate: new Date(startDate),
                    endDate: new Date(endDate)
                };
            }
        }
        
        // 事前定義の範囲
        const days = parseInt(dateRangeSelect.value);
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);
        
        return {
            type: dateRangeSelect.value,
            days: days,
            startDate: startDate,
            endDate: endDate
        };
    }
    
    /**
     * レポートタイプに応じたデータを読み込み
     */
    function loadReportData(reportType) {
        console.log(`Loading report data for: ${reportType}`);
        
        // まだ初期化されていない場合は初期化
        if (!currentDateRange) {
            currentDateRange = getSelectedDateRange();
        }
        
        switch(reportType) {
            case 'user-reports':
                loadUserReports(currentDateRange);
                break;
            case 'content-reports':
                loadContentReports(currentDateRange);
                break;
            case 'activity-reports':
                loadActivityReports(currentDateRange);
                break;
            case 'custom-reports':
                // カスタムレポートは別途ビルダーで処理
                break;
        }
    }
    
    /**
     * 選択されたデータソースに基づいて利用可能なメトリクスを更新
     */
    function updateAvailableMetrics(dataSource) {
        const metricsSelect = document.getElementById('custom-metrics');
        if (!metricsSelect) return;
        
        // 現在の選択を保存
        const selectedOptions = Array.from(metricsSelect.selectedOptions).map(option => option.value);
        
        // メトリクスをクリア
        metricsSelect.innerHTML = '';
        
        // データソースに応じたメトリクスを追加
        let metrics = [];
        
        switch(dataSource) {
            case 'users':
                metrics = [
                    { value: 'registrations', label: '登録数' },
                    { value: 'active_users', label: 'アクティブユーザー' },
                    { value: 'retention', label: 'リテンション率' },
                    { value: 'engagement', label: 'エンゲージメントスコア' },
                    { value: 'login_count', label: 'ログイン回数' },
                    { value: 'user_growth', label: 'ユーザー増加率' }
                ];
                break;
            case 'content':
                metrics = [
                    { value: 'content_count', label: 'コンテンツ数' },
                    { value: 'views', label: '閲覧数' },
                    { value: 'ratings', label: '評価' },
                    { value: 'comments', label: 'コメント数' },
                    { value: 'shares', label: 'シェア数' },
                    { value: 'favorites', label: 'お気に入り登録数' }
                ];
                break;
            case 'activity':
                metrics = [
                    { value: 'logins', label: 'ログイン数' },
                    { value: 'session_duration', label: 'セッション時間' },
                    { value: 'page_views', label: 'ページビュー' },
                    { value: 'feature_usage', label: '機能使用率' },
                    { value: 'search_queries', label: '検索クエリ数' },
                    { value: 'downloads', label: 'ダウンロード数' }
                ];
                break;
            case 'engagement':
                metrics = [
                    { value: 'engagement_score', label: 'エンゲージメントスコア' },
                    { value: 'active_days', label: '月間アクティブ日数' },
                    { value: 'content_created', label: '作成コンテンツ数' },
                    { value: 'interactions', label: '総インタラクション数' },
                    { value: 'retention_rate', label: 'リテンション率' },
                    { value: 'conversion_rate', label: 'コンバージョン率' }
                ];
                break;
        }
        
        // メトリクスをセレクトボックスに追加
        metrics.forEach(metric => {
            const option = document.createElement('option');
            option.value = metric.value;
            option.textContent = metric.label;
            option.selected = selectedOptions.includes(metric.value);
            metricsSelect.appendChild(option);
        });
    }
    
    /**
     * カスタムフィルターを追加
     */
    function addCustomFilter() {
        const filterField = document.getElementById('custom-filter-field');
        const filterOperator = document.getElementById('custom-filter-operator');
        const filterValue = document.getElementById('custom-filter-value');
        const appliedFilters = document.getElementById('applied-filters');
        
        if (!filterField.value || !filterValue.value) {
            showSystemNotification('フィールドと値を入力してください', 'warning');
            return;
        }
        
        // フィールド名の表示用テキスト
        const fieldLabel = filterField.options[filterField.selectedIndex].text;
        
        // 演算子の表示用テキスト
        const operatorLabel = (() => {
            switch(filterOperator.value) {
                case 'equals': return '等しい';
                case 'not_equals': return '等しくない';
                case 'contains': return '含む';
                case 'greater_than': return 'より大きい';
                case 'less_than': return 'より小さい';
                default: return filterOperator.value;
            }
        })();
        
        // フィルターバッジを作成
        const filterId = `filter-${Date.now()}`;
        const filterBadge = document.createElement('div');
        filterBadge.id = filterId;
        filterBadge.className = 'badge badge-info mr-2 mb-2 p-2';
        filterBadge.style.display = 'inline-flex';
        filterBadge.style.alignItems = 'center';
        filterBadge.innerHTML = `
            <span>${fieldLabel} ${operatorLabel} "${filterValue.value}"</span>
            <button class="btn btn-sm ml-2" style="padding: 0; background: none; color: inherit;" onclick="ReportingModule.removeFilter('${filterId}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // フィルターをデータ属性に保存
        filterBadge.dataset.field = filterField.value;
        filterBadge.dataset.operator = filterOperator.value;
        filterBadge.dataset.value = filterValue.value;
        
        appliedFilters.appendChild(filterBadge);
        
        // 入力をクリア
        filterValue.value = '';
    }
    
    /**
     * エクスポートモーダルを表示
     */
    function showExportModal() {
        const exportModal = document.getElementById('export-modal');
        if (exportModal) {
            exportModal.style.display = 'flex';
        }
    }
    
    /**
     * 指定した形式でレポートをエクスポート
     */
    function exportReportAs(format) {
        // 現在アクティブなタブを取得
        const activeTab = document.querySelector('#reports-section .tab.active');
        const reportType = activeTab ? activeTab.dataset.tab : null;
        
        if (!reportType) {
            showSystemNotification('エクスポートするレポートが見つかりません', 'warning');
            return;
        }
        
        // 日付範囲を取得
        const dateRange = getSelectedDateRange();
        const formattedDate = new Intl.DateTimeFormat('ja-JP', { 
            year: 'numeric', month: '2-digit', day: '2-digit' 
        }).format(new Date()).replace(/\//g, '');
        
        // 実際のエクスポート処理（デモでは通知のみ）
        let fileName = `katsujiringx_report_${reportType}_${formattedDate}`;
        let message = '';
        
        switch(format) {
            case 'csv':
                fileName += '.csv';
                message = `CSVファイル「${fileName}」をエクスポートしました`;
                break;
            case 'pdf':
                fileName += '.pdf';
                message = `PDFファイル「${fileName}」をエクスポートしました`;
                break;
            case 'excel':
                fileName += '.xlsx';
                message = `Excelファイル「${fileName}」をエクスポートしました`;
                break;
            case 'image':
                fileName += '.png';
                message = `画像ファイル「${fileName}」をエクスポートしました`;
                break;
        }
        
        showSystemNotification(message, 'success');
        
        // 実際の実装では、選択されたフォーマットでデータを変換し、
        // ダウンロードを開始するコードがここに入ります
    }
    
    // ダミーのレポートデータ生成関数を追加（テスト用）
    function loadUserReports(dateRange) {
        console.log("ユーザーレポートを読み込みます", dateRange);
        // 実際のデータ取得やチャート作成コードはこちら
    }
    
    function loadContentReports(dateRange) {
        console.log("コンテンツレポートを読み込みます", dateRange);
        // 実際のデータ取得やチャート作成コードはこちら
    }
    
    function loadActivityReports(dateRange) {
        console.log("活動レポートを読み込みます", dateRange);
        // 実際のデータ取得やチャート作成コードはこちら
    }
    
    function loadSavedReports() {
        console.log("保存済みレポートを読み込みます");
        // 実際のデータ取得コードはこちら
    }
    
    function buildCustomReport() {
        console.log("カスタムレポートを構築します");
        // 実際のレポート構築コードはこちら
    }
    
    // システム通知を表示する関数
    function showSystemNotification(message, type = 'info') {
        // この関数は既存のダッシュボードコードにあるはずなので、ここでは仮の実装
        console.log(`[${type}] ${message}`);
        
        // システム通知コンテナがある場合
        const notificationContainer = document.getElementById('system-notification-container');
        if (notificationContainer) {
            // 通知タイプに応じたクラス
            let alertClass = 'alert-info';
            let iconClass = 'fas fa-info-circle';
            
            switch (type) {
                case 'success':
                    alertClass = 'alert-success';
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'danger':
                    alertClass = 'alert-danger';
                    iconClass = 'fas fa-exclamation-circle';
                    break;
            }
            
            // 通知HTML作成
            const notificationHTML = `
                <div class="alert ${alertClass} mb-3">
                    <div class="d-flex align-center">
                        <i class="${iconClass} mr-3" style="font-size: 1.5rem;"></i>
                        <div>
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            // 通知コンテナに追加
            notificationContainer.innerHTML = notificationHTML;
            notificationContainer.style.display = 'block';
            
            // 3秒後に自動消去（成功・情報通知のみ）
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    notificationContainer.style.display = 'none';
                }, 3000);
            }
        }
    }
    
    // ===== 公開API =====
    return {
        init,
        loadReportData,
        showExportModal,
        exportReportAs,
        removeFilter,  // フィルター削除関数は公開関数
        getSelectedDateRange
    };
})();
        </script>
        </body>
        </html>