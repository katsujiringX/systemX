// Canvas to Blob変換（サイズ制限付き）
        async function canvasToBlob(canvas) {
            return new Promise(resolve => {
                // 画像サイズが大きすぎる場<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>活字化エディタ | KatsujiRingX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>
    <style>
        /* デザインシステム変数 */
        :root {
            /* カラーパレット - 主要色 */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --primary-dark: #3730a3;
            --primary-transparent: rgba(79, 70, 229, 0.1);
            
            /* カラーパレット - 補助色 */
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --secondary-light: #e0f2fe;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --accent-light: #fff7ed;
            
            /* カラーパレット - 機能色 */
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;
            --info: #3b82f6;
            --info-hover: #2563eb;
            --info-light: #eff6ff;
            /* カラーパレット - グレースケール */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            /* テーマカラー */
            --bg-color: var(--gray-50);
            --bg-color-card: white;
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);
            /* レイアウト */
            --header-height: 4rem;
            --container-padding: 1.5rem;
            --element-gap: 1.25rem;
            --border-radius-xs: 0.25rem;
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            --border-radius-full: 9999px;
            /* アニメーション */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
            /* シャドウ */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-focus: 0 0 0 3px var(--primary-transparent);
        }
        /* ダークモード */
        [data-theme="dark"] {
            /* カラーパレット調整 */
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: rgba(99, 102, 241, 0.15);
            --primary-transparent: rgba(99, 102, 241, 0.2);
            /* テーマカラー調整 */
            --bg-color: #111827;
            --bg-color-card: #1f2937;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #374151;
            /* シャドウ調整 */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }
        /* ベーススタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        /* ヘッダー */
        .editor-header {
            height: var(--header-height);
            background-color: var(--bg-color-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 var(--container-padding);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        .editor-header .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: opacity var(--transition-fast);
        }
        .editor-header .logo:hover {
            opacity: 0.9;
        }
        .editor-header .logo img {
            width: 2.25rem;
            height: 2.25rem;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }
        .editor-header .actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        /* メインコンテンツエリア */
        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: var(--container-padding);
            gap: var(--element-gap);
        }
        /* 左側: 画像表示エリア */
        .image-pane {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
            min-width: 380px;
            overflow: hidden;
            position: relative;
        }
        .image-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .image-pane-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .image-pane-header h2 i {
            color: var(--primary);
            font-size: 1.125rem;
        }
        .image-viewport {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            cursor: grab;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(45deg, var(--gray-200) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--gray-200) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--gray-200) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--gray-200) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            transition: background-color var(--transition-normal);
        }
        [data-theme="dark"] .image-viewport {
            background-image: 
                linear-gradient(45deg, var(--gray-700) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--gray-700) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--gray-700) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--gray-700) 75%);
        }
        .image-viewport.grabbing {
            cursor: grabbing;
        }
        .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image-container img {
            transform-origin: center center;
            max-width: none;
            max-height: none;
            transition: transform var(--transition-fast);
            will-change: transform;
        }
        /* ズームコントロール */
        .zoom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
            z-index: 10;
        }
        .zoom-btn {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: var(--border-radius-full);
            background-color: var(--bg-color-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            color: var(--text-color);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }
        .zoom-btn:hover {
            background-color: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .zoom-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        .zoom-level {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background-color: var(--bg-color-card);
            color: var(--text-color);
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius-full);
            box-shadow: var(--shadow);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            border: 1px solid var(--border-color);
            transition: opacity var(--transition-normal);
        }
        .zoom-level i {
            color: var(--primary);
        }
        .image-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(var(--bg-color-card-rgb), 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            z-index: 20;
            backdrop-filter: blur(4px);
        }
        .image-loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid rgba(var(--primary-rgb), 0.2);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .image-loading-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-color);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .image-error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-align: center;
            max-width: 80%;
        }
        .image-error-message i {
            font-size: 3rem;
            color: var(--danger);
        }
        .image-error-message p {
            font-size: 0.875rem;
            color: var(--text-color);
        }
        /* 右側: テキスト・メタデータエリア */
        .text-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--element-gap);
            overflow: hidden;
            min-width: 300px;
            max-width: 40%;
        }
        /* タブスタイル */
        .tab-container {
            background-color: var(--bg-color-card);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            box-shadow: var(--shadow);
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
            overflow: hidden;
        }
        .tabs-header {
            display: flex;
            background-color: var(--bg-color-card);
            overflow: hidden;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            flex: 1;
            justify-content: center;
        }
        .tab-button:hover {
            color: var(--primary);
            background-color: var(--primary-light);
        }
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: var(--primary-light);
        }
        .tab-button i {
            font-size: 1rem;
        }
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .metadata-form, .text-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color-card);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border: 1px solid var(--border-color);
            border-top: none;
            box-shadow: var(--shadow);
            transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
            overflow: hidden;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-normal);
        }
        .card-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-header h2 i {
            color: var(--primary);
            font-size: 1.125rem;
        }
        .card-body {
            padding: 1.25rem;
        }
        /* メタデータフォーム */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-group {
            margin-bottom: 0.75rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--text-color);
        }
        .form-control {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            transition: all var(--transition-fast);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow-focus);
        }
        .form-control::placeholder {
            color: var(--text-muted);
        }
        /* 縦書きテキストエディタ */
        .text-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .text-editor .card-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            position: relative;
        }
        .vertical-text-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .text-editor textarea {
            width: 100%;
            height: 100%;
            padding: 1.25rem;
            border: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            font-family: 'Noto Serif JP', serif;
            line-height: 1.8;
            writing-mode: vertical-rl;
            text-orientation: upright;
            resize: none;
            overflow-x: auto;
            white-space: pre;
            transition: background-color var(--transition-normal);
            box-sizing: border-box;
        }
        .text-editor textarea:focus {
            outline: none;
        }
        .text-stats {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background-color: var(--bg-color-card);
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius-full);
            box-shadow: var(--shadow);
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            border: 1px solid var(--border-color);
        }
        .text-stats i {
            color: var(--primary);
        }
        /* ボタンスタイル */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            line-height: 1.5;
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background-color: var(--primary-light);
        }
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            border-radius: var(--border-radius-full);
        }
        .btn-icon i {
            margin-right: 0;
        }
        /* OCRボタン用スタイル */
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }
        /* ロード中の状態 */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 1rem;
            height: 1rem;
            top: calc(50% - 0.5rem);
            left: calc(50% - 0.5rem);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }
        .btn-outline.loading::after {
            border: 2px solid rgba(var(--text-color-rgb), 0.3);
            border-top-color: var(--text-color);
        }
        /* OCRモーダル */
        .ocr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
            backdrop-filter: blur(4px);
        }
        .ocr-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .ocr-modal-content {
            background-color: var(--bg-color-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease forwards;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .ocr-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .ocr-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ocr-modal-title i {
            color: var(--secondary);
        }
        .ocr-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        .ocr-modal-close:hover {
            color: var(--text-color);
        }
        .ocr-modal-body {
            padding: 1.5rem;
        }
        .ocr-preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .ocr-progress {
            margin: 1rem 0;
        }
        .ocr-progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: var(--gray-200);
            border-radius: var(--border-radius-full);
            overflow: hidden;
        }
        .ocr-progress-fill {
            height: 100%;
            background-color: var(--secondary);
            transition: width var(--transition-normal);
            width: 0%;
        }
        .ocr-progress-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            text-align: center;
        }
        .ocr-result {
            margin-top: 1rem;
        }
        .ocr-result-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        .ocr-result-text {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Serif JP', serif;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }
        .ocr-result-text:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow-focus);
        }
        .ocr-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* OCR設定用スタイル */
        .ocr-settings {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin: 0;
            width: 1rem;
            height: 1rem;
        }
        
        .confidence-score {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: var(--success-light);
            color: var(--success);
            border-radius: var(--border-radius-full);
        }
        
        .confidence-score.low {
            background-color: var(--warning-light);
            color: var(--warning);
        }
        
        .confidence-score.very-low {
            background-color: var(--danger-light);
            color: var(--danger);
        }
        
        .ocr-alternatives {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .alternatives-label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .alternatives-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .alternative-char {
            padding: 0.25rem 0.5rem;
            background-color: var(--primary-light);
            color: var(--primary);
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        
        .alternative-char:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-1px);
        }
        
        .alternative-char .confidence {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-left: 0.25rem;
        }
        /* ショートカットキー */
        .shortcut-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.5rem;
            padding: 0 0.375rem;
            background-color: var(--gray-200);
            color: var(--gray-700);
            border-radius: var(--border-radius-xs);
            font-size: 0.6875rem;
            font-weight: 600;
            box-shadow: var(--shadow-xs);
            margin-left: 0.375rem;
        }
        [data-theme="dark"] .shortcut-key {
            background-color: var(--gray-700);
            color: var(--gray-300);
        }
        /* トースト通知 */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-color-card);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid var(--info);
            animation: slideInRight 0.3s ease forwards, fadeOut 0.3s ease forwards 4.7s;
        }
        .toast-success {
            border-left-color: var(--success);
        }
        .toast-error {
            border-left-color: var(--danger);
        }
        .toast-warning {
            border-left-color: var(--warning);
        }
        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .toast-success .toast-icon {
            color: var(--success);
        }
        .toast-error .toast-icon {
            color: var(--danger);
        }
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        .toast-info .toast-icon {
            color: var(--info);
        }
        .toast-content {
            flex-grow: 1;
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        .toast-message {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        /* キーボードショートカットモーダル */
        .shortcut-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
            backdrop-filter: blur(4px);
        }
        .shortcut-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .shortcut-modal-content {
            background-color: var(--bg-color-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease forwards;
        }
        .shortcut-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .shortcut-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .shortcut-modal-title i {
            color: var(--primary);
        }
        .shortcut-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        .shortcut-modal-close:hover {
            color: var(--text-color);
        }
        .shortcut-modal-body {
            padding: 1.5rem;
        }
        .shortcut-group {
            margin-bottom: 1.5rem;
        }
        .shortcut-group-title {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .shortcut-item:last-child {
            border-bottom: none;
        }
        .shortcut-name {
            font-size: 0.875rem;
        }
        .shortcut-combo {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.75rem;
            height: 1.75rem;
            padding: 0 0.5rem;
            background-color: var(--gray-200);
            color: var(--gray-800);
            border-radius: var(--border-radius-xs);
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        [data-theme="dark"] .key {
            background-color: var(--gray-700);
            color: var(--gray-200);
        }
        .key-plus {
            color: var(--text-muted);
            margin: 0 0.25rem;
        }
        .key-or {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin: 0 0.375rem;
        }
        /* ツールチップ */
        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-0.5rem);
            background-color: var(--gray-800);
            color: white;
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast), visibility var(--transition-fast), transform var(--transition-fast);
            box-shadow: var(--shadow);
            z-index: 100;
        }
        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-0.25rem);
        }
        /* レスポンシブ対応 */
        @media (max-width: 992px) {
            .editor-container {
                flex-direction: column;
            }
            .image-pane, .text-pane {
                min-width: unset;
                max-width: unset;
                width: 100%;
            }
            .image-pane {
                height: 50vh;
            }
            .text-editor {
                height: 50vh;
            }
        }
        @media (max-width: 768px) {
            :root {
                --container-padding: 1rem;
                --element-gap: 1rem;
            }
            .editor-header {
                padding: 0 1rem;
            }
            .editor-header .actions {
                gap: 0.5rem;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .shortcut-key, .btn-text {
                display: none;
            }
            .btn i {
                margin-right: 0;
            }
            .btn {
                padding: 0.5rem 0.75rem;
            }
            .ocr-modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }
        }
        /* ユーティリティクラス */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        /* RGB変数の追加 (JSでのカラー操作用) */
        :root {
            --primary-rgb: 79, 70, 229;
            --bg-color-card-rgb: 255, 255, 255;
        }
        [data-theme="dark"] {
            --primary-rgb: 99, 102, 241;
            --bg-color-card-rgb: 31, 41, 55;
        }

        /* メタデータフォーム用追加スタイル */
        .mt-4 {
            margin-top: 1.5rem;
        }

        .form-control[type="date"] {
            font-family: 'Noto Sans JP', sans-serif;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.5;
            writing-mode: horizontal-tb; /* 横書き */
        }

        /* 数値入力フィールドのスタイル */
        input[type="number"].form-control {
            -moz-appearance: textfield; /* Firefox */
        }

        /* Chrome, Safari, Edge, Opera で矢印を非表示 */
        input[type="number"].form-control::-webkit-outer-spin-button,
        input[type="number"].form-control::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <header class="editor-header">
        <a href="mainpage.html" class="logo" title="トップページへ戻る">
            <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
            <span>KatsujiRingX エディタ</span>
        </a>
        <div class="actions">
            <button id="ocr-btn" class="btn btn-secondary">
                <i class="fas fa-eye"></i>
                <span class="btn-text">OCR実行</span>
                <span class="shortcut-key">Ctrl+O</span>
            </button>
            <button id="shortcuts-btn" class="btn btn-outline btn-icon tooltip" data-tooltip="ショートカット一覧">
                <i class="fas fa-keyboard"></i>
                <span class="visually-hidden">ショートカット</span>
            </button>
            <button id="back-to-documents" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                <span class="btn-text">資料管理へ戻る</span>
            </button>
            <button id="save-button" class="btn btn-primary">
                <i class="fas fa-save"></i>
                <span class="btn-text">保存</span>
                <span class="shortcut-key">Ctrl+S</span>
            </button>
            <button id="theme-toggle-editor" class="btn btn-outline btn-icon tooltip" data-tooltip="テーマ切替">
                <i class="fas fa-moon"></i>
                <span class="visually-hidden">ダークモード</span>
            </button>
        </div>
    </header>
    <div class="editor-container">
        <div class="image-pane">
            <div class="image-pane-header">
                <h2><i class="fas fa-image"></i> 画像表示</h2>
                <div class="image-actions">
                    <button id="fit-to-screen" class="btn btn-outline btn-sm tooltip" data-tooltip="画面に合わせる">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="image-viewport" id="image-viewport">
                <div class="image-container" id="image-container">
                    <img id="editor-image" src="" alt="活字化対象画像" style="display: none;">
                </div>
            </div>
            <div class="zoom-controls">
                <button class="zoom-btn tooltip" id="zoom-in" data-tooltip="拡大 (Mouse Wheel Up)">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="zoom-btn tooltip" id="zoom-out" data-tooltip="縮小 (Mouse Wheel Down)">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="zoom-btn tooltip" id="zoom-reset" data-tooltip="リセット (R)">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            <div class="zoom-level" id="zoom-level">
                <i class="fas fa-search"></i> 100%
            </div>
            <div class="image-loading-overlay" id="image-loading">
                <div class="image-loading-spinner"></div>
                <div class="image-loading-text">画像読み込み中...</div>
            </div>
        </div>
        <!-- ここから右側のタブ付きエリア -->
        <div class="text-pane">
            <!-- タブヘッダー -->
            <div class="tab-container">
                <div class="tabs-header">
                    <button class="tab-button" data-tab="metadata" id="metadata-tab-btn">
                        <i class="fas fa-info-circle"></i> 資料情報
                    </button>
                    <button class="tab-button active" data-tab="text" id="text-tab-btn">
                        <i class="fas fa-edit"></i> 活字化テキスト
                    </button>
                </div>
            </div>
            <!-- タブコンテンツ：メタデータフォーム -->
            <div class="tab-content" id="metadata-tab" style="display: none;">
                <div class="metadata-form">
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="metadata-doc-number" class="form-label">資料番号</label>
                                <input type="text" id="metadata-doc-number" class="form-control" placeholder="例: 12345 (半角数字)">
                            </div>
                            <div class="form-group">
                                <label for="metadata-doc-name" class="form-label">資料名</label>
                                <input type="text" id="metadata-doc-name" class="form-control" placeholder="資料名を入力">
                            </div>
                            <div class="form-group">
                                <label for="metadata-author" class="form-label">作者</label>
                                <input type="text" id="metadata-author" class="form-control" placeholder="作者名を入力">
                            </div>
                            <div class="form-group">
                                <label for="metadata-recipient" class="form-label">受信者</label>
                                <input type="text" id="metadata-recipient" class="form-control" placeholder="受信者名を入力">
                            </div>
                            <div class="form-group">
                                <label for="metadata-era" class="form-label">年代</label>
                                <input type="number" id="metadata-era" class="form-control" placeholder="例: 1999" min="1" max="9999">
                            </div>
                            <div class="form-group">
                                <label for="metadata-creation-date" class="form-label">作成年月日</label>
                                <input type="date" id="metadata-creation-date" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="metadata-source" class="form-label">所蔵</label>
                                <input type="text" id="metadata-source" class="form-control" placeholder="所蔵機関名などを入力">
                            </div>
                            <div class="form-group">
                                <label for="metadata-staff" class="form-label">担当者</label>
                                <input type="text" id="metadata-staff" class="form-control" placeholder="担当者名を入力">
                            </div>
                        </div>
                        <div class="form-group mt-4">
                            <label for="metadata-description" class="form-label">内容や形態等</label>
                            <textarea id="metadata-description" class="form-control" rows="4" placeholder="資料の内容や形態について記述してください"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- タブコンテンツ：テキストエディタ -->
            <div class="tab-content" id="text-tab">
                <div class="text-editor">
                    <div class="card-body">
                        <div class="vertical-text-container">
                            <textarea id="vertical-text" placeholder="ここに活字化したテキストを入力します..."></textarea>
                        </div>
                        <div class="text-stats" id="text-stats">
                            <i class="fas fa-font"></i>
                            <span id="char-count">0</span> 文字
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OCRモーダル -->
    <div class="ocr-modal" id="ocr-modal">
        <div class="ocr-modal-content">
            <div class="ocr-modal-header">
                <h2 class="ocr-modal-title"><i class="fas fa-eye"></i> OCR（光学文字認識）</h2>
                <button class="ocr-modal-close" id="ocr-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ocr-modal-body">
                <div class="ocr-settings">
                    <div class="form-group">
                        <label for="ocr-engine-select" class="form-label">文字認識エンジン</label>
                        <select id="ocr-engine-select" class="form-control">
                            <option value="google-vision">Google Vision API（高精度）</option>
                            <option value="kuzushiji">崩し字認識（KuroNet API）</option>
                            <option value="katsuji">歴史的活字認識（専用データセット）</option>
                            <option value="tesseract" selected>汎用OCR（Tesseract.js）</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ocr-preprocess" class="form-label">画像前処理</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enhance-contrast" checked>
                                <span class="checkmark"></span>
                                コントラスト強化
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="noise-reduction">
                                <span class="checkmark"></span>
                                ノイズ除去
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="binarization">
                                <span class="checkmark"></span>
                                二値化処理
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="era-hint-group">
                        <label for="era-hint" class="form-label">推定年代（認識精度向上）</label>
                        <select id="era-hint" class="form-control">
                            <option value="">自動推定</option>
                            <option value="edo">江戸時代（～1868）</option>
                            <option value="meiji">明治時代（1868-1912）</option>
                            <option value="taisho">大正時代（1912-1926）</option>
                            <option value="showa-early">昭和前期（1926-1945）</option>
                            <option value="showa-late">昭和後期（1945-1989）</option>
                        </select>
                    </div>
                </div>
                
                <div class="ocr-preview">
                    <img id="ocr-preview-image" class="ocr-preview-image" src="" alt="OCR対象画像">
                    <canvas id="ocr-preview-canvas" class="ocr-preview-image" style="display: none;"></canvas>
                </div>
                
                <div class="ocr-progress" id="ocr-progress" style="display: none;">
                    <div class="ocr-progress-bar">
                        <div class="ocr-progress-fill" id="ocr-progress-fill"></div>
                    </div>
                    <div class="ocr-progress-text" id="ocr-progress-text">OCR処理を開始しています...</div>
                </div>

                <div class="ocr-result" id="ocr-result" style="display: none;">
                    <div class="ocr-result-label">
                        認識結果（編集可能）:
                        <span class="confidence-score" id="confidence-score"></span>
                    </div>
                    <textarea id="ocr-result-text" class="ocr-result-text" placeholder="OCR結果がここに表示されます..."></textarea>
                    
                    <div class="ocr-alternatives" id="ocr-alternatives" style="display: none;">
                        <div class="alternatives-label">候補文字:</div>
                        <div class="alternatives-list" id="alternatives-list"></div>
                    </div>
                </div>
            </div>
            <div class="ocr-modal-footer">
                <button id="ocr-start-btn" class="btn btn-secondary">
                    <i class="fas fa-play"></i>
                    OCR開始
                </button>
                <button id="ocr-insert-btn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-plus"></i>
                    テキストに追加
                </button>
                <button id="ocr-replace-btn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-exchange-alt"></i>
                    テキストを置換
                </button>
                <button id="ocr-cancel-btn" class="btn btn-outline">
                    <i class="fas fa-times"></i>
                    キャンセル
                </button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>
    <div class="shortcut-modal" id="shortcut-modal">
        <div class="shortcut-modal-content">
            <div class="shortcut-modal-header">
                <h2 class="shortcut-modal-title"><i class="fas fa-keyboard"></i> キーボードショートカット</h2>
                <button class="shortcut-modal-close" id="shortcut-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="shortcut-modal-body">
                <div class="shortcut-group">
                    <h3 class="shortcut-group-title"><i class="fas fa-image"></i> 画像操作</h3>
                    <div class="shortcut-item">
                        <div class="shortcut-name">拡大</div>
                        <div class="shortcut-combo">
                            <span class="key">+</span>
                            <span class="key-or">or</span>
                            <span class="key">↑</span>
                            <span class="key-or">or</span>
                            <span class="key">Wheel ↑</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">縮小</div>
                        <div class="shortcut-combo">
                            <span class="key">-</span>
                            <span class="key-or">or</span>
                            <span class="key">↓</span>
                            <span class="key-or">or</span>
                            <span class="key">Wheel ↓</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">画像をリセット</div>
                        <div class="shortcut-combo">
                            <span class="key">R</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">画像を移動</div>
                        <div class="shortcut-combo">
                            <span class="key">ドラッグ</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">画面に合わせる</div>
                        <div class="shortcut-combo">
                            <span class="key">F</span>
                        </div>
                    </div>
                </div>
                <div class="shortcut-group">
                    <h3 class="shortcut-group-title"><i class="fas fa-edit"></i> エディタ操作</h3>
                    <div class="shortcut-item">
                        <div class="shortcut-name">OCR実行</div>
                        <div class="shortcut-combo">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">O</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">保存</div>
                        <div class="shortcut-combo">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">S</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">テーマ切替</div>
                        <div class="shortcut-combo">
                            <span class="key">Ctrl</span>
                            <span class="key-plus">+</span>
                            <span class="key">D</span>
                        </div>
                    </div>
                    <!-- タブ切替のショートカット追加 -->
                    <div class="shortcut-item">
                        <div class="shortcut-name">資料情報タブ</div>
                        <div class="shortcut-combo">
                            <span class="key">Alt</span>
                            <span class="key-plus">+</span>
                            <span class="key">1</span>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <div class="shortcut-name">テキストタブ</div>
                        <div class="shortcut-combo">
                            <span class="key">Alt</span>
                            <span class="key-plus">+</span>
                            <span class="key">2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Firebase設定
        const firebaseConfig = {
           apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
           authDomain: "katsujiringx.firebaseapp.com",
           projectId: "katsujiringx",
           storageBucket: "katsujiringx.firebasestorage.app",
           messagingSenderId: "831784731743",
           appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
           measurementId: "G-LPCRE3WYZR"
        };
        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        // Firebaseサービスへの参照
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // DOM要素（安全な初期化方法）
        let imageViewport = null;
        let imageContainer = null;
        let editorImage = null;
        let imageLoading = null;
        let verticalText = null;
        let docNumberInput = null;
        let docNameInput = null;
        let authorInput = null;
        let recipientInput = null;
        let eraInput = null;
        let creationDateInput = null;
        let sourceInput = null;
        let staffInput = null;
        let descriptionTextarea = null;
        let saveButton = null;
        let backButton = null;
        let themeToggleButton = null;
        let toastContainer = null;
        let zoomInBtn = null;
        let zoomOutBtn = null;
        let zoomResetBtn = null;
        let zoomLevelDisplay = null;
        let charCountEl = null;
        let fitToScreenBtn = null;
        let shortcutsBtn = null;
        let shortcutModal = null;
        let shortcutModalClose = null;
        let metadataTabBtn = null;
        let textTabBtn = null;
        let metadataTab = null;
        let textTab = null;
        // OCR関連のDOM要素
        let ocrBtn = null;
        let ocrModal = null;
        let ocrModalClose = null;
        let ocrPreviewImage = null;
        let ocrProgress = null;
        let ocrProgressFill = null;
        let ocrProgressText = null;
        let ocrResult = null;
        let ocrResultText = null;
        let ocrStartBtn = null;
        let ocrInsertBtn = null;
        let ocrReplaceBtn = null;
        let ocrCancelBtn = null;
        
        // DOM要素の初期化関数
        function initializeElements() {
            imageViewport = document.getElementById('image-viewport');
            imageContainer = document.getElementById('image-container');
            editorImage = document.getElementById('editor-image');
            imageLoading = document.getElementById('image-loading');
            verticalText = document.getElementById('vertical-text');
            docNumberInput = document.getElementById('metadata-doc-number');
            docNameInput = document.getElementById('metadata-doc-name');
            authorInput = document.getElementById('metadata-author');
            recipientInput = document.getElementById('metadata-recipient');
            eraInput = document.getElementById('metadata-era');
            creationDateInput = document.getElementById('metadata-creation-date');
            sourceInput = document.getElementById('metadata-source');
            staffInput = document.getElementById('metadata-staff');
            descriptionTextarea = document.getElementById('metadata-description');
            saveButton = document.getElementById('save-button');
            backButton = document.getElementById('back-to-documents');
            themeToggleButton = document.getElementById('theme-toggle-editor');
            toastContainer = document.getElementById('toast-container');
            zoomInBtn = document.getElementById('zoom-in');
            zoomOutBtn = document.getElementById('zoom-out');
            zoomResetBtn = document.getElementById('zoom-reset');
            zoomLevelDisplay = document.getElementById('zoom-level');
            charCountEl = document.getElementById('char-count');
            fitToScreenBtn = document.getElementById('fit-to-screen');
            shortcutsBtn = document.getElementById('shortcuts-btn');
            shortcutModal = document.getElementById('shortcut-modal');
            shortcutModalClose = document.getElementById('shortcut-modal-close');
            metadataTabBtn = document.getElementById('metadata-tab-btn');
            textTabBtn = document.getElementById('text-tab-btn');
            metadataTab = document.getElementById('metadata-tab');
            textTab = document.getElementById('text-tab');
            // OCR関連
            ocrBtn = document.getElementById('ocr-btn');
            ocrModal = document.getElementById('ocr-modal');
            ocrModalClose = document.getElementById('ocr-modal-close');
            ocrPreviewImage = document.getElementById('ocr-preview-image');
            ocrProgress = document.getElementById('ocr-progress');
            ocrProgressFill = document.getElementById('ocr-progress-fill');
            ocrProgressText = document.getElementById('ocr-progress-text');
            ocrResult = document.getElementById('ocr-result');
            ocrResultText = document.getElementById('ocr-result-text');
            ocrStartBtn = document.getElementById('ocr-start-btn');
            ocrInsertBtn = document.getElementById('ocr-insert-btn');
            ocrReplaceBtn = document.getElementById('ocr-replace-btn');
            ocrCancelBtn = document.getElementById('ocr-cancel-btn');
            
            // 要素のデバッグログ
            console.log('DOM要素初期化完了');
        }
        
        // 状態管理変数
        let currentFileId = null;
        let currentFile = null;
        let currentUser = null;
        let hasUnsavedChanges = false;
        
        // 画像ズーム・パン用の変数
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let originalImageWidth, originalImageHeight;
        let viewportWidth, viewportHeight;
        const MIN_ZOOM = 0.1;
        const MAX_ZOOM = 10;
        const ZOOM_STEP = 0.1;
        
        // OCR処理の状態
        let isOcrProcessing = false;
        
        // ------------------------
        // OCR機能
        // ------------------------
        function openOcrModal() {
            if (!ocrModal || !editorImage) {
                console.error("OCRモーダルまたは画像要素が見つかりません");
                return;
            }
            
            // 現在の画像がロードされているかチェック
            if (editorImage.style.display === 'none' || !editorImage.src) {
                showToast('画像が読み込まれていません。先に画像を読み込んでください。', 'warning');
                return;
            }
            
            // プレビュー画像を設定
            if (ocrPreviewImage) {
                ocrPreviewImage.src = editorImage.src;
            }
            
            // モーダルの初期状態をリセット
            resetOcrModal();
            
            // モーダルを表示
            ocrModal.classList.add('active');
        }
        
        function closeOcrModal() {
            if (!ocrModal) return;
            
            // 処理中の場合は確認
            if (isOcrProcessing) {
                const confirmed = confirm('OCR処理が実行中です。中止しますか？');
                if (!confirmed) return;
            }
            
            ocrModal.classList.remove('active');
            resetOcrModal();
        }
        
        function resetOcrModal() {
            // プログレスバーを非表示
            if (ocrProgress) ocrProgress.style.display = 'none';
            if (ocrProgressFill) ocrProgressFill.style.width = '0%';
            if (ocrProgressText) ocrProgressText.textContent = 'OCR処理を開始しています...';
            
            // 結果エリアを非表示
            if (ocrResult) ocrResult.style.display = 'none';
            if (ocrResultText) ocrResultText.value = '';
            
            // 候補文字エリアを非表示
            const alternativesContainer = document.getElementById('ocr-alternatives');
            if (alternativesContainer) alternativesContainer.style.display = 'none';
            
            // 信頼度スコアをリセット
            const scoreElement = document.getElementById('confidence-score');
            if (scoreElement) scoreElement.textContent = '';
            
            // ボタンの状態をリセット
            if (ocrStartBtn) {
                ocrStartBtn.style.display = 'inline-flex';
                ocrStartBtn.disabled = false;
                ocrStartBtn.classList.remove('loading');
            }
            if (ocrInsertBtn) ocrInsertBtn.style.display = 'none';
            if (ocrReplaceBtn) ocrReplaceBtn.style.display = 'none';
            
            // プレビューキャンバスを非表示
            const previewCanvas = document.getElementById('ocr-preview-canvas');
            if (previewCanvas) previewCanvas.style.display = 'none';
            if (ocrPreviewImage) ocrPreviewImage.style.display = 'block';
            
            // 年代ヒントを自動更新
            updateEraHintFromMetadata();
            
            isOcrProcessing = false;
        }
        
        function getEstimatedEra() {
            // メタデータから年代を推定
            const era = eraInput?.value;
            if (era) {
                return parseInt(era);
            }
            
            // 作成日から推定
            const creationDate = creationDateInput?.value;
            if (creationDate) {
                return new Date(creationDate).getFullYear();
            }
            
            return null;
        }
        
        // プレビュー更新機能
        function updatePreviewWithProcessing() {
            const previewCanvas = document.getElementById('ocr-preview-canvas');
            const previewImage = document.getElementById('ocr-preview-image');
            
            if (!previewCanvas || !previewImage || !editorImage) return;
            
            // 前処理が有効な場合のみプレビューを更新
            const hasProcessing = document.getElementById('enhance-contrast')?.checked ||
                                document.getElementById('noise-reduction')?.checked ||
                                document.getElementById('binarization')?.checked;
            
            if (hasProcessing) {
                const processedCanvas = preprocessImage(editorImage);
                previewCanvas.width = processedCanvas.width;
                previewCanvas.height = processedCanvas.height;
                
                const ctx = previewCanvas.getContext('2d');
                ctx.drawImage(processedCanvas, 0, 0);
                
                previewCanvas.style.display = 'block';
                previewImage.style.display = 'none';
            } else {
                previewCanvas.style.display = 'none';
                previewImage.style.display = 'block';
            }
        }
        
        function updateOcrProgress(progress, message) {
            if (ocrProgressFill) {
                ocrProgressFill.style.width = `${Math.round(progress * 100)}%`;
            }
            if (ocrProgressText) {
                ocrProgressText.textContent = message;
            }
        }
        
        async function startOcrProcessing() {
            if (!editorImage || !editorImage.src) {
                showToast('処理する画像が見つかりません。', 'error');
                return;
            }
            
            isOcrProcessing = true;
            
            // UIの更新
            if (ocrStartBtn) {
                ocrStartBtn.disabled = true;
                ocrStartBtn.classList.add('loading');
            }
            if (ocrProgress) ocrProgress.style.display = 'block';
            
            try {
                updateOcrProgress(0.1, '画像を準備しています...');
                
                // 選択されたOCRエンジンに基づいて処理を分岐
                const selectedEngine = document.getElementById('ocr-engine-select')?.value || 'tesseract';
                let result;
                
                switch (selectedEngine) {
                    case 'google-vision':
                        result = await processWithGoogleVision();
                        break;
                    case 'kuzushiji':
                        result = await processWithKuzushijiAPI();
                        break;
                    case 'katsuji':
                        result = await processWithKatsujiAPI();
                        break;
                    case 'tesseract':
                    default:
                        result = await processWithTesseract();
                        break;
                }
                
                updateOcrProgress(0.95, '結果を処理しています...');
                
                // 結果を表示
                if (ocrResultText) {
                    ocrResultText.value = result || '文字を認識できませんでした。';
                }
                
                // UI要素の表示切り替え
                if (ocrResult) ocrResult.style.display = 'block';
                if (ocrInsertBtn) ocrInsertBtn.style.display = 'inline-flex';
                if (ocrReplaceBtn) ocrReplaceBtn.style.display = 'inline-flex';
                if (ocrStartBtn) ocrStartBtn.style.display = 'none';
                
                updateOcrProgress(1.0, 'OCR処理が完了しました！');
                
                showToast('OCR処理が完了しました。', 'success');
                
            } catch (error) {
                console.error('OCR処理エラー:', error);
                showToast('OCR処理中にエラーが発生しました。ネットワーク接続を確認してください。', 'error');
                
                // エラー時のUI復元
                if (ocrStartBtn) {
                    ocrStartBtn.disabled = false;
                    ocrStartBtn.classList.remove('loading');
                    ocrStartBtn.style.display = 'inline-flex';
                }
                if (ocrProgress) ocrProgress.style.display = 'none';
            } finally {
                isOcrProcessing = false;
            }
        }
        
        // Google Vision API処理
        async function processWithGoogleVision() {
            const API_KEY = 'AIzaSyAOa2_P-5K4yTSfHBwX2orb1U4FBWU9XLI';
            
            updateOcrProgress(0.2, 'Google Vision APIに接続中...');
            
            try {
                // 画像を前処理
                const processedCanvas = preprocessImage(editorImage);
                const imageBlob = await canvasToBlob(processedCanvas);
                const base64Image = await blobToBase64(imageBlob);
                
                console.log('画像サイズ:', imageBlob.size, 'bytes');
                console.log('Base64長:', base64Image.length);
                
                updateOcrProgress(0.4, 'Google Visionで文字を認識中...');
                
                const requestBody = {
                    requests: [{
                        image: {
                            content: base64Image
                        },
                        features: [{
                            type: 'DOCUMENT_TEXT_DETECTION',
                            maxResults: 50
                        }],
                        imageContext: {
                            languageHints: ['ja', 'en']
                        }
                    }]
                };
                
                console.log('APIリクエスト準備完了');
                
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('APIレスポンス受信:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        console.error('APIエラー詳細:', errorData);
                        errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                updateOcrProgress(0.8, 'Google Vision結果を処理中...');
                
                const data = await response.json();
                console.log('API応答データ:', data);
                
                const textAnnotation = data.responses[0]?.textAnnotations?.[0];
                
                if (textAnnotation) {
                    const confidence = textAnnotation.confidence || 0.9;
                    displayConfidenceScore(confidence);
                    
                    const alternatives = [];
                    if (data.responses[0]?.textAnnotations?.length > 1) {
                        for (let i = 1; i < Math.min(6, data.responses[0].textAnnotations.length); i++) {
                            const alt = data.responses[0].textAnnotations[i];
                            if (alt.description && alt.description.length === 1) {
                                alternatives.push({
                                    char: alt.description,
                                    confidence: alt.confidence || 0.8
                                });
                            }
                        }
                    }
                    
                    if (alternatives.length > 0) {
                        displayAlternatives(alternatives);
                    }
                    
                    return textAnnotation.description || '';
                } else {
                    const fullTextAnnotation = data.responses[0]?.fullTextAnnotation;
                    if (fullTextAnnotation) {
                        displayConfidenceScore(0.8);
                        return fullTextAnnotation.text || '';
                    }
                    
                    // エラー情報がある場合は表示
                    if (data.responses[0]?.error) {
                        console.error('Vision API エラー:', data.responses[0].error);
                        throw new Error(`Vision API エラー: ${data.responses[0].error.message}`);
                    }
                    
                    return '文字を認識できませんでした。画像の品質を確認してください。';
                }
                
            } catch (error) {
                console.error('Google Vision API エラー詳細:', error);
                
                // ネットワークエラーの詳細な分類
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('ネットワーク接続エラー: インターネット接続を確認してください。CORSポリシーにより、一部の環境では直接APIアクセスができません。');
                } else if (error.message.includes('403')) {
                    throw new Error('認証エラー: APIキーが無効か、Vision APIが有効化されていません。Google Cloud Consoleで設定を確認してください。');
                } else if (error.message.includes('400')) {
                    throw new Error('リクエストエラー: 画像形式または画像サイズに問題があります。JPEG/PNG形式で10MB以下の画像を使用してください。');
                } else if (error.message.includes('429')) {
                    throw new Error('API制限エラー: 月1000回の無料制限に達しました。しばらく時間をおいてからお試しください。');
                } else if (error.message.includes('401')) {
                    throw new Error('認証エラー: APIキーが正しくありません。Google Cloud Consoleで新しいAPIキーを生成してください。');
                } else {
                    throw new Error(`Google Vision API エラー: ${error.message}。ブラウザの開発者ツール（F12）でコンソールログを確認してください。`);
                }
            }
        }
        
        // 崩し字認識API処理
        async function processWithKuzushijiAPI() {
            updateOcrProgress(0.2, '崩し字認識エンジンに接続中...');
            
            try {
                // 画像をBase64に変換
                const imageBlob = await imageToBlob(editorImage);
                const base64Image = await blobToBase64(imageBlob);
                
                updateOcrProgress(0.4, '崩し字を解析中...');
                
                // KuroNet API呼び出し（例）
                const response = await fetch('/api/ocr/kuzushiji', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        type: 'kuzushiji'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                updateOcrProgress(0.8, '崩し字認識結果を取得中...');
                
                const data = await response.json();
                return data.text || '';
                
            } catch (error) {
                console.error('崩し字認識エラー:', error);
                // フォールバックとしてTesseractを使用
                showToast('専用API接続失敗。汎用OCRで処理します...', 'warning');
                return await processWithTesseract();
            }
        }
        
        // 活字認識API処理
        async function processWithKatsujiAPI() {
            updateOcrProgress(0.2, '活字認識エンジンに接続中...');
            
            try {
                // 画像をBase64に変換
                const imageBlob = await imageToBlob(editorImage);
                const base64Image = await blobToBase64(imageBlob);
                
                updateOcrProgress(0.4, '歴史的活字を解析中...');
                
                // 活字認識API呼び出し（カスタム実装）
                const response = await fetch('/api/ocr/katsuji', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        type: 'historical_print',
                        era: getEstimatedEra() // メタデータから推定年代を取得
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                updateOcrProgress(0.8, '活字認識結果を取得中...');
                
                const data = await response.json();
                return data.text || '';
                
            } catch (error) {
                console.error('活字認識エラー:', error);
                // フォールバックとしてTesseractを使用
                showToast('専用API接続失敗。汎用OCRで処理します...', 'warning');
                return await processWithTesseract();
            }
        }
        
        // Tesseract.js処理（フォールバック）
        async function processWithTesseract() {
            updateOcrProgress(0.2, 'Tesseract.jsで文字認識中...');
            
            const result = await Tesseract.recognize(
                editorImage.src,
                'jpn', // 日本語認識
                {
                    logger: function(m) {
                        console.log(m);
                        if (m.status === 'recognizing text') {
                            const progress = 0.3 + (m.progress * 0.5); // 30%から80%まで
                            updateOcrProgress(progress, `文字を認識しています... ${Math.round(m.progress * 100)}%`);
                        }
                    }
                }
            );
            
            return result.data.text || '';
        }
        
        // ユーティリティ関数
        async function imageToBlob(imgElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;
            
            ctx.drawImage(imgElement, 0, 0);
            
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }
        
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // 画像前処理機能
        function preprocessImage(imageElement) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = imageElement.naturalWidth;
            canvas.height = imageElement.naturalHeight;
            
            // 元画像を描画
            ctx.drawImage(imageElement, 0, 0);
            
            // 前処理オプションを取得
            const enhanceContrast = document.getElementById('enhance-contrast')?.checked;
            const noiseReduction = document.getElementById('noise-reduction')?.checked;
            const binarization = document.getElementById('binarization')?.checked;
            
            if (enhanceContrast || noiseReduction || binarization) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // コントラスト強化
                if (enhanceContrast) {
                    const contrast = 1.5; // コントラスト係数
                    const intercept = 128 * (1 - contrast);
                    
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.max(0, Math.min(255, data[i] * contrast + intercept));     // R
                        data[i + 1] = Math.max(0, Math.min(255, data[i + 1] * contrast + intercept)); // G
                        data[i + 2] = Math.max(0, Math.min(255, data[i + 2] * contrast + intercept)); // B
                    }
                }
                
                // ノイズ除去（簡易的なメディアンフィルタ風処理）
                if (noiseReduction) {
                    const tempData = new Uint8ClampedArray(data);
                    const width = canvas.width;
                    
                    for (let y = 1; y < canvas.height - 1; y++) {
                        for (let x = 1; x < width - 1; x++) {
                            const i = (y * width + x) * 4;
                            
                            // 周囲のピクセルの平均値を計算（簡易的なスムージング）
                            let r = 0, g = 0, b = 0;
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    const ni = ((y + dy) * width + (x + dx)) * 4;
                                    r += tempData[ni];
                                    g += tempData[ni + 1];
                                    b += tempData[ni + 2];
                                }
                            }
                            
                            data[i] = r / 9;
                            data[i + 1] = g / 9;
                            data[i + 2] = b / 9;
                        }
                    }
                }
                
                // 二値化処理
                if (binarization) {
                    const threshold = 128;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        const value = gray > threshold ? 255 : 0;
                        
                        data[i] = value;     // R
                        data[i + 1] = value; // G
                        data[i + 2] = value; // B
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            return canvas;
        }
        
        // 信頼度スコアの表示
        function displayConfidenceScore(confidence) {
            const scoreElement = document.getElementById('confidence-score');
            if (!scoreElement) return;
            
            const percentage = Math.round(confidence * 100);
            scoreElement.textContent = `信頼度: ${percentage}%`;
            
            // 信頼度に応じてスタイルを変更
            scoreElement.className = 'confidence-score';
            if (confidence < 0.5) {
                scoreElement.classList.add('very-low');
            } else if (confidence < 0.7) {
                scoreElement.classList.add('low');
            }
        }
        
        // 候補文字の表示
        function displayAlternatives(alternatives) {
            const alternativesContainer = document.getElementById('ocr-alternatives');
            const alternativesList = document.getElementById('alternatives-list');
            
            if (!alternativesContainer || !alternativesList || !alternatives || alternatives.length === 0) {
                if (alternativesContainer) alternativesContainer.style.display = 'none';
                return;
            }
            
            alternativesList.innerHTML = '';
            
            alternatives.forEach(alt => {
                const charElement = document.createElement('span');
                charElement.className = 'alternative-char';
                charElement.innerHTML = `${alt.char}<span class="confidence">${Math.round(alt.confidence * 100)}%</span>`;
                
                charElement.addEventListener('click', () => {
                    // クリックされた文字をテキストエリアの現在の位置に挿入
                    const textarea = document.getElementById('ocr-result-text');
                    if (textarea) {
                        const start = textarea.selectionStart;
                        const end = textarea.selectionEnd;
                        const text = textarea.value;
                        
                        textarea.value = text.substring(0, start) + alt.char + text.substring(end);
                        textarea.focus();
                        textarea.setSelectionRange(start + 1, start + 1);
                    }
                });
                
                alternativesList.appendChild(charElement);
            });
            
            alternativesContainer.style.display = 'block';
        }
        
        // 年代ヒントの更新
        function updateEraHintFromMetadata() {
            const eraHintSelect = document.getElementById('era-hint');
            if (!eraHintSelect) return;
            
            const era = getEstimatedEra();
            if (era) {
                if (era <= 1868) {
                    eraHintSelect.value = 'edo';
                } else if (era <= 1912) {
                    eraHintSelect.value = 'meiji';
                } else if (era <= 1926) {
                    eraHintSelect.value = 'taisho';
                } else if (era <= 1945) {
                    eraHintSelect.value = 'showa-early';
                } else if (era <= 1989) {
                    eraHintSelect.value = 'showa-late';
                }
            }
        }
        
        // 改良された崩し字認識API処理
        async function processWithKuzushijiAPI() {
            updateOcrProgress(0.2, '崩し字認識エンジンに接続中...');
            
            try {
                // 画像を前処理
                const processedCanvas = preprocessImage(editorImage);
                const imageBlob = await canvasToBlob(processedCanvas);
                const base64Image = await blobToBase64(imageBlob);
                
                updateOcrProgress(0.4, '崩し字を解析中...');
                
                // 年代ヒントを取得
                const eraHint = document.getElementById('era-hint')?.value || getAutoEraHint();
                
                // KuroNet API呼び出し（実装例）
                const response = await fetch('/api/ocr/kuzushiji', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        type: 'kuzushiji',
                        era_hint: eraHint,
                        options: {
                            return_alternatives: true,
                            confidence_threshold: 0.3
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                updateOcrProgress(0.8, '崩し字認識結果を取得中...');
                
                const data = await response.json();
                
                // 信頼度と候補文字を表示
                if (data.confidence) {
                    displayConfidenceScore(data.confidence);
                }
                
                if (data.alternatives) {
                    displayAlternatives(data.alternatives);
                }
                
                return data.text || '';
                
            } catch (error) {
                console.error('崩し字認識エラー:', error);
                
                // デモ用のモックレスポンス（実際のAPIが利用できない場合）
                if (error.message.includes('fetch')) {
                    showToast('デモモード: 崩し字認識をシミュレーション中...', 'info');
                    
                    // モックデータでデモンストレーション
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    displayConfidenceScore(0.85);
                    displayAlternatives([
                        { char: '春', confidence: 0.92 },
                        { char: '昏', confidence: 0.85 },
                        { char: '養', confidence: 0.78 }
                    ]);
                    
                    return '春の訪れと共に、庭の花々が咲き誇っている。';
                }
                
                // フォールバックとしてTesseractを使用
                showToast('専用API接続失敗。汎用OCRで処理します...', 'warning');
                return await processWithTesseract();
            }
        }
        
        // Canvas to Blob変換
        async function canvasToBlob(canvas) {
            return new Promise(resolve => {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });
        }
        
        // 自動年代推定
        function getAutoEraHint() {
            const era = getEstimatedEra();
            if (!era) return '';
            
            if (era <= 1868) return 'edo';
            if (era <= 1912) return 'meiji';
            if (era <= 1926) return 'taisho';
            if (era <= 1945) return 'showa-early';
            if (era <= 1989) return 'showa-late';
            return '';
        }
        
        function insertOcrResult() {
            if (!ocrResultText || !verticalText) {
                console.error("テキストエリアが見つかりません");
                return;
            }
            
            const ocrText = ocrResultText.value.trim();
            if (!ocrText) {
                showToast('追加するテキストがありません。', 'warning');
                return;
            }
            
            // 現在のテキストの末尾に追加
            const currentText = verticalText.value;
            const separator = currentText ? '\n\n' : '';
            verticalText.value = currentText + separator + ocrText;
            
            // 変更フラグを設定
            setUnsavedChanges(true);
            updateCharCount();
            
            showToast('OCR結果をテキストに追加しました。', 'success');
            closeOcrModal();
        }
        
        function replaceWithOcrResult() {
            if (!ocrResultText || !verticalText) {
                console.error("テキストエリアが見つかりません");
                return;
            }
            
            const ocrText = ocrResultText.value.trim();
            if (!ocrText) {
                showToast('置換するテキストがありません。', 'warning');
                return;
            }
            
            // 既存のテキストがある場合は確認
            if (verticalText.value.trim()) {
                const confirmed = confirm('既存のテキストが削除されます。OCR結果で置き換えますか？');
                if (!confirmed) return;
            }
            
            // テキストを置換
            verticalText.value = ocrText;
            
            // 変更フラグを設定
            setUnsavedChanges(true);
            updateCharCount();
            
            showToast('テキストをOCR結果で置き換えました。', 'success');
            closeOcrModal();
        }
        
        // ------------------------
        // タブ切り替え機能
        // ------------------------
        function setupTabs() {
            if (!metadataTabBtn || !textTabBtn) {
                console.error("タブボタンが見つかりません");
                return;
            }
            
            // デフォルトでテキストタブを表示
            activateTab('text');
            
            // タブボタンにイベントリスナーを設定
            metadataTabBtn.addEventListener('click', () => activateTab('metadata'));
            textTabBtn.addEventListener('click', () => activateTab('text'));
        }
        
        function activateTab(tabId) {
            if (!metadataTabBtn || !textTabBtn || !metadataTab || !textTab) {
                console.error("タブ要素が見つかりません");
                return;
            }
            
            // タブボタンを切り替え
            if (tabId === 'metadata') {
                metadataTabBtn.classList.add('active');
                textTabBtn.classList.remove('active');
                metadataTab.style.display = 'flex';
                textTab.style.display = 'none';
            } else {
                metadataTabBtn.classList.remove('active');
                textTabBtn.classList.add('active');
                metadataTab.style.display = 'none';
                textTab.style.display = 'flex';
            }
            
            // ショートカットトーストを表示
            if (tabId === 'metadata') {
                showToast('資料情報タブに切り替えました', 'info');
            } else {
                showToast('テキストタブに切り替えました', 'info');
            }
        }
        
        // ------------------------
        // トースト通知システム
        // ------------------------
        function showToast(message, type = 'info', title = '') {
            if (!toastContainer) {
                console.error("トーストコンテナが見つかりません");
                return;
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = '';
            let titleText = title || '';
            
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle toast-icon"></i>';
                    if (!titleText) titleText = '成功';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle toast-icon"></i>';
                    if (!titleText) titleText = 'エラー';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>';
                    if (!titleText) titleText = '警告';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle toast-icon"></i>';
                    if (!titleText) titleText = '情報';
                    break;
            }
            
            toast.innerHTML = `
                ${icon}
                <div class="toast-content">
                    <div class="toast-title">${titleText}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        // ------------------------
        // 資料番号のバリデーション
        // ------------------------
        function setupDocNumberValidation() {
            if (!docNumberInput) {
                console.error("資料番号入力欄が見つかりません");
                return;
            }
            
            docNumberInput.addEventListener('input', (event) => {
                // 入力値から半角数字以外を除去
                const sanitizedValue = event.target.value.replace(/[^0-9]/g, '');
                if (event.target.value !== sanitizedValue) {
                    event.target.value = sanitizedValue;
                    showToast('資料番号は半角数字のみ入力可能です。', 'info');
                }
                setUnsavedChanges(true);
            });
        }
        
        // ------------------------
        // 文字数カウント機能
        // ------------------------
        function updateCharCount() {
            if (!verticalText || !charCountEl) {
                console.error("テキストエリアまたは文字数表示要素が見つかりません");
                return;
            }
            
            const count = verticalText.value.length;
            charCountEl.textContent = count.toLocaleString();
        }
        
        function setupCharCounter() {
            if (!verticalText) {
                console.error("テキストエリアが見つかりません");
                return;
            }
            
            verticalText.addEventListener('input', () => {
                updateCharCount();
                setUnsavedChanges(true);
            });
            
            // 初期カウント
            updateCharCount();
        }
        
        // ------------------------
        // 変更の追跡
        // ------------------------
        function setUnsavedChanges(value) {
            hasUnsavedChanges = value;
            
            // タイトルに「*」を付けて変更を示す
            const title = document.title;
            const hasAsterisk = title.startsWith('*');
            
            if (value && !hasAsterisk) {
                document.title = `*${title}`;
            } else if (!value && hasAsterisk) {
                document.title = title.substring(1);
            }
        }
        
        function setupChangeTracking() {
            // メタデータフォームのすべての入力フィールドに変更リスナーを追加
            const metadataInputs = document.querySelectorAll('.metadata-form .form-control');
            metadataInputs.forEach(input => {
                input.addEventListener('input', () => setUnsavedChanges(true));
            });
            
            // ページを離れる前の警告
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '変更が保存されていません。このページを離れますか？';
                    return e.returnValue;
                }
            });
        }
        
        // ------------------------
        // ファイルデータ読み込み
        // ------------------------
        async function loadFileData(fileId) {
            if (!imageLoading || !editorImage) {
                console.error("画像表示要素が見つかりません");
                return;
            }
            
            imageLoading.style.display = 'flex'; // ローディング表示開始
            editorImage.style.display = 'none';
            
            try {
                const fileDoc = await db.collection('files').doc(fileId).get();
                if (fileDoc.exists) {
                    currentFile = { id: fileDoc.id, ...fileDoc.data() };
                    
                    // タイトルを設定
                    const fileName = currentFile.name || currentFile.originalName || '名称未設定';
                    document.title = `編集: ${fileName} | KatsujiRingX`;
                    
                    if (currentFile.url && currentFile.fileType === 'image') {
                        editorImage.src = currentFile.url;
                        editorImage.alt = currentFile.name || '活字化対象画像';
                        
                        editorImage.onload = () => { // 画像読み込み完了後
                            imageLoading.style.display = 'none';
                            editorImage.style.display = 'block';
                            
                            // 画像の初期位置とサイズを設定
                            resetImagePosition();
                            showToast('画像の読み込みが完了しました', 'success');
                        };
                        
                        editorImage.onerror = () => { // 画像読み込みエラー
                            imageLoading.style.display = 'none';
                            if (imageViewport) {
                                imageViewport.innerHTML = `
                                    <div class="image-error-message">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <p>画像の読み込みに失敗しました。ページを再読み込みするか、管理者にお問い合わせください。</p>
                                    </div>
                                `;
                            }
                            showToast('画像の読み込みに失敗しました。', 'error');
                        };
                        
                        // メタデータの読み込み（安全に）
                        loadMetadata(currentFile);
                        
                        // 初期状態では変更なしとして扱う
                        setUnsavedChanges(false);
                    } else {
                        imageLoading.style.display = 'none';
                        if (imageViewport) {
                            imageViewport.innerHTML = `
                                <div class="image-error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>有効な画像ファイルが見つかりませんでした。資料管理ページから別の資料を選択してください。</p>
                                </div>
                            `;
                        }
                        showToast('有効な画像ファイルではありません。', 'warning', '読み込みエラー');
                    }
                } else {
                    imageLoading.style.display = 'none';
                    if (imageViewport) {
                        imageViewport.innerHTML = `
                            <div class="image-error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>指定されたファイルが見つかりません。資料管理ページから別の資料を選択してください。</p>
                            </div>
                        `;
                    }
                    showToast('指定されたファイルが見つかりません。', 'error', '読み込みエラー');
                }
            } catch (error) {
                console.error("ファイルデータ読み込みエラー:", error);
                imageLoading.style.display = 'none';
                if (imageViewport) {
                    imageViewport.innerHTML = `
                        <div class="image-error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>ファイルの読み込み中にエラーが発生しました。ネットワーク接続を確認するか、後ほど再試行してください。</p>
                        </div>
                    `;
                }
                showToast('ファイルの読み込みに失敗しました。', 'error', '読み込みエラー');
            }
        }
        
        // メタデータの読み込み（安全に）
        function loadMetadata(currentFile) {
            if (!currentFile) {
                console.warn('メタデータの読み込み: ファイルデータがありません');
                return;
            }
            
            // 安全に値を設定
            if (docNameInput) docNameInput.value = currentFile.name || '';
            if (docNumberInput) docNumberInput.value = currentFile.metadata?.docNumber || '';
            if (authorInput) authorInput.value = currentFile.metadata?.author || '';
            if (recipientInput) recipientInput.value = currentFile.metadata?.recipient || '';
            if (eraInput) eraInput.value = currentFile.metadata?.era || '';
            if (creationDateInput) creationDateInput.value = currentFile.metadata?.creationDate || '';
            if (sourceInput) sourceInput.value = currentFile.metadata?.source || '';
            if (staffInput) staffInput.value = currentFile.metadata?.staff || '';
            if (descriptionTextarea) descriptionTextarea.value = currentFile.metadata?.description || '';
            if (verticalText) verticalText.value = currentFile.transcribedText || '';
            
            // 文字数カウントを更新
            updateCharCount();
        }
        
        // ------------------------
        // データ保存処理
        // ------------------------
        async function saveData() {
            if (!currentFileId || !currentUser) {
                showToast('保存に必要な情報がありません。', 'error');
                return;
            }
            
            // 安全にメタデータを取得
            const metadata = {
                docNumber: docNumberInput ? docNumberInput.value : '',
                author: authorInput ? authorInput.value : '',
                recipient: recipientInput ? recipientInput.value : '',
                era: eraInput ? eraInput.value : '',
                creationDate: creationDateInput ? creationDateInput.value : '',
                source: sourceInput ? sourceInput.value : '',
                staff: staffInput ? staffInput.value : '',
                description: descriptionTextarea ? descriptionTextarea.value : '',
            };
            
            // 保存するデータ
            const dataToSave = {
                transcribedText: verticalText ? verticalText.value : '',
                metadata: metadata,
                // 資料名も更新
                name: (docNameInput ? docNameInput.value : '') || (currentFile ? currentFile.originalName : '') || '名称未設定',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastEditorId: currentUser.uid,
                lastEditorName: currentUser.displayName || currentUser.email || '不明なユーザー'
            };
            
            // ボタンをロード中表示に
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.classList.add('loading');
            }
            
            try {
                await db.collection('files').doc(currentFileId).update(dataToSave);
                showToast('データを保存しました。', 'success', '保存完了');
                
                // 保存成功後、currentFileの内容も更新
                if (currentFile) {
                    currentFile = { ...currentFile, ...dataToSave };
                }
                
                // 変更済みフラグをリセット
                setUnsavedChanges(false);
                
                // 資料名が変更された場合、タイトルを更新
                if (currentFile && currentFile.name) {
                    document.title = `編集: ${currentFile.name} | KatsujiRingX`;
                }
            } catch (error) {
                console.error("保存エラー:", error);
                showToast('保存に失敗しました。ネットワーク接続を確認して再試行してください。', 'error', '保存エラー');
            } finally {
                // ボタンを元に戻す
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.classList.remove('loading');
                }
            }
        }
        
        // ------------------------
        // テーマ設定
        // ------------------------
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
            
            // トーストメッセージ表示
            const themeText = newTheme === 'dark' ? 'ダークモード' : 'ライトモード';
            showToast(`${themeText}に切り替えました。`, 'info');
        }
        
        function updateThemeButton(theme) {
            if (!themeToggleButton) {
                console.error("テーマ切替ボタンが見つかりません");
                return;
            }
            
            const icon = themeToggleButton.querySelector('i');
            if (icon) {
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                    themeToggleButton.setAttribute('data-tooltip', 'ライトモードに切替');
                } else {
                    icon.className = 'fas fa-moon';
                    themeToggleButton.setAttribute('data-tooltip', 'ダークモードに切替');
                }
            }
        }
        
        // ------------------------
        // 画像操作機能
        // ------------------------
        function resetImagePosition() {
            if (!imageViewport || !editorImage) {
                console.error("画像表示要素が見つかりません");
                return;
            }
            
            // ビューポートのサイズを取得
            viewportWidth = imageViewport.clientWidth;
            viewportHeight = imageViewport.clientHeight;
            
            // 画像の元のサイズを保存
            originalImageWidth = editorImage.naturalWidth;
            originalImageHeight = editorImage.naturalHeight;
            
            // 画像をビューポートに合わせてリサイズ
            fitImageToViewport();
        }
        
        function fitImageToViewport() {
            if (!originalImageWidth || !originalImageHeight || !editorImage) {
                console.error("画像サイズが取得できません");
                return;
            }
            
            // ビューポートと画像の比率を計算
            const widthRatio = viewportWidth / originalImageWidth;
            const heightRatio = viewportHeight / originalImageHeight;
            
            // 小さい方の比率を使用して、画像が完全にビューポート内に収まるようにする
            const fitRatio = Math.min(widthRatio, heightRatio) * 0.9; // 90%のサイズにして少し余白を持たせる
            
            // 画像サイズをリセット
            currentZoom = fitRatio;
            translateX = 0;
            translateY = 0;
            
            updateImageTransform();
            updateZoomLevelDisplay();
            
            // アニメーション付きでトーストを表示
            showToast('画像を画面サイズに合わせました', 'info');
        }
        
        function zoomImage(zoomFactor) {
            if (!editorImage) {
                console.error("画像要素が見つかりません");
                return;
            }
            
            // ズーム前の中心位置を保存
            const viewportCenterX = viewportWidth / 2;
            const viewportCenterY = viewportHeight / 2;
            
            // ズーム値の範囲を制限
            const newZoom = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, currentZoom * zoomFactor));
            
            if (newZoom !== currentZoom) {
                // 新しいズーム値を設定
                currentZoom = newZoom;
                
                // 移動量を制限
                constrainTranslation();
                
                updateImageTransform();
                updateZoomLevelDisplay();
            }
        }
        
        function constrainTranslation() {
            if (!originalImageWidth || !originalImageHeight) {
                console.error("画像サイズが取得できません");
                return;
            }
            
            // 画像の現在のサイズを計算
            const scaledWidth = originalImageWidth * currentZoom;
            const scaledHeight = originalImageHeight * currentZoom;
            
            // 画像がビューポートよりも小さい場合は中央に配置
            if (scaledWidth <= viewportWidth) {
                translateX = 0;
            } else {
                // 画像の端がビューポートの外に出ないように制限
                const maxTranslateX = (scaledWidth - viewportWidth) / 2;
                translateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, translateX));
            }
            
            if (scaledHeight <= viewportHeight) {
                translateY = 0;
            } else {
                const maxTranslateY = (scaledHeight - viewportHeight) / 2;
                translateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, translateY));
            }
        }
        
        function updateImageTransform() {
            if (!editorImage) {
                console.error("画像要素が見つかりません");
                return;
            }
            
            editorImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        }
        
        function updateZoomLevelDisplay() {
            if (!zoomLevelDisplay) {
                console.error("ズーム表示要素が見つかりません");
                return;
            }
            
            const percentage = Math.round(currentZoom * 100);
            zoomLevelDisplay.innerHTML = `<i class="fas fa-search"></i> ${percentage}%`;
        }
        
        function startDrag(e) {
            if (!editorImage || !imageViewport) {
                console.error("画像表示要素が見つかりません");
                return;
            }
            
            // ドラッグ開始時に画像が表示されていない場合は処理しない
            if (editorImage.style.display === 'none') return;
            
            if (e.type === 'touchstart') {
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
            } else {
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
            }
            
            isDragging = true;
            imageViewport.classList.add('grabbing');
        }
        
        function drag(e) {
            if (!isDragging || !imageViewport) return;
            
            e.preventDefault();
            
            let newTranslateX, newTranslateY;
            
            if (e.type === 'touchmove') {
                newTranslateX = e.touches[0].clientX - startX;
                newTranslateY = e.touches[0].clientY - startY;
            } else {
                newTranslateX = e.clientX - startX;
                newTranslateY = e.clientY - startY;
            }
            
            // 移動量を設定
            translateX = newTranslateX;
            translateY = newTranslateY;
            
            // 移動量を制限
            constrainTranslation();
            
            updateImageTransform();
        }
        
        function endDrag() {
            isDragging = false;
            if (imageViewport) {
                imageViewport.classList.remove('grabbing');
            }
        }
        
        function wheelZoom(e) {
            e.preventDefault();
            
            // deltaYが正なら縮小、負なら拡大
            const zoomFactor = e.deltaY < 0 ? 1 + ZOOM_STEP : 1 - ZOOM_STEP;
            zoomImage(zoomFactor);
        }
        
        // ------------------------
        // ショートカットモーダル
        // ------------------------
        function openShortcutModal() {
            if (!shortcutModal) {
                console.error("ショートカットモーダルが見つかりません");
                return;
            }
            
            shortcutModal.classList.add('active');
        }
        
        function closeShortcutModal() {
            if (!shortcutModal) {
                console.error("ショートカットモーダルが見つかりません");
                return;
            }
            
            shortcutModal.classList.remove('active');
        }
        
        // ------------------------
        // キーボードショートカット
        // ------------------------
        function handleKeyboardShortcuts(e) {
            // テキストエリアでの入力中は一部ショートカットを無効化
            const isInputActive = document.activeElement.tagName === 'INPUT' || 
                                document.activeElement.tagName === 'TEXTAREA';
                                
            // Ctrl+S: 保存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveData();
                return;
            }
            
            // Ctrl+O: OCR実行
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                openOcrModal();
                return;
            }
            
            // Ctrl+D: テーマ切替
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
                return;
            }
            
            // Alt+1: メタデータタブ
            if (e.altKey && e.key === '1') {
                e.preventDefault();
                activateTab('metadata');
                return;
            }
            
            // Alt+2: テキストタブ
            if (e.altKey && e.key === '2') {
                e.preventDefault();
                activateTab('text');
                return;
            }
            
            // 入力中でない場合のみ有効なショートカット
            if (!isInputActive) {
                // +: 拡大
                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomImage(1 + ZOOM_STEP);
                }
                
                // -: 縮小
                if (e.key === '-') {
                    e.preventDefault();
                    zoomImage(1 - ZOOM_STEP);
                }
                
                // R: リセット
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    resetImagePosition();
                }
                
                // F: 画面に合わせる
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    fitImageToViewport();
                }
                
                // 矢印キーでのズーム
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    zoomImage(1 + ZOOM_STEP);
                }
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    zoomImage(1 - ZOOM_STEP);
                }
                
                // ESCキーでモーダルを閉じる
                if (e.key === 'Escape') {
                    if (shortcutModal && shortcutModal.classList.contains('active')) {
                        closeShortcutModal();
                    } else if (ocrModal && ocrModal.classList.contains('active')) {
                        closeOcrModal();
                    }
                }
            }
        }
        
        // ------------------------
        // イベントリスナーの設定
        // ------------------------
        function setupEventListeners() {
            // OCRボタン
            if (ocrBtn) {
                ocrBtn.addEventListener('click', openOcrModal);
            }
            
            // OCRモーダル関連
            if (ocrModalClose) {
                ocrModalClose.addEventListener('click', closeOcrModal);
            }
            
            if (ocrStartBtn) {
                ocrStartBtn.addEventListener('click', startOcrProcessing);
            }
            
            if (ocrInsertBtn) {
                ocrInsertBtn.addEventListener('click', insertOcrResult);
            }
            
            if (ocrReplaceBtn) {
                ocrReplaceBtn.addEventListener('click', replaceWithOcrResult);
            }
            
            if (ocrCancelBtn) {
                ocrCancelBtn.addEventListener('click', closeOcrModal);
            }
            
            // OCRモーダルの外側クリックで閉じる
            if (ocrModal) {
                ocrModal.addEventListener('click', (e) => {
                    if (e.target === ocrModal) {
                        closeOcrModal();
                    }
                });
            }
            
            // 前処理オプションの変更時にプレビューを更新
            const preprocessingCheckboxes = ['enhance-contrast', 'noise-reduction', 'binarization'];
            preprocessingCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', updatePreviewWithProcessing);
                }
            });
            
            // OCRエンジン選択の変更時に年代ヒント表示を制御
            const engineSelect = document.getElementById('ocr-engine-select');
            if (engineSelect) {
                engineSelect.addEventListener('change', (e) => {
                    const eraHintGroup = document.getElementById('era-hint-group');
                    if (eraHintGroup) {
                        // TesseractとGoogle Vision以外では年代ヒントを表示
                        const hideEraHint = e.target.value === 'tesseract' || e.target.value === 'google-vision';
                        eraHintGroup.style.display = hideEraHint ? 'none' : 'block';
                    }
                });
                
                // 初期状態を設定
                const eraHintGroup = document.getElementById('era-hint-group');
                if (eraHintGroup) {
                    const hideEraHint = engineSelect.value === 'tesseract' || engineSelect.value === 'google-vision';
                    eraHintGroup.style.display = hideEraHint ? 'none' : 'block';
                }
            }
            
            // 保存ボタン
            if (saveButton) {
                saveButton.addEventListener('click', saveData);
            }
            
            // 戻るボタン
            if (backButton) {
                backButton.addEventListener('click', () => {
                    // 変更が未保存の場合、確認ダイアログを表示
                    if (hasUnsavedChanges) {
                        const confirmed = confirm('変更が保存されていません。保存せずに戻りますか？');
                        if (!confirmed) return;
                    }
                    window.location.href = 'documents.html';
                });
            }
            
            // テーマ切替ボタン
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', toggleTheme);
            }
            
            // ズームボタン
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => zoomImage(1 + ZOOM_STEP));
            }
            
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => zoomImage(1 - ZOOM_STEP));
            }
            
            if (zoomResetBtn) {
                zoomResetBtn.addEventListener('click', resetImagePosition);
            }
            
            // フィットボタン
            if (fitToScreenBtn) {
                fitToScreenBtn.addEventListener('click', fitImageToViewport);
            }
            
            // ショートカットボタン
            if (shortcutsBtn) {
                shortcutsBtn.addEventListener('click', openShortcutModal);
            }
            
            if (shortcutModalClose) {
                shortcutModalClose.addEventListener('click', closeShortcutModal);
            }
            
            // ショートカットモーダルの外側クリックで閉じる
            if (shortcutModal) {
                shortcutModal.addEventListener('click', (e) => {
                    if (e.target === shortcutModal) {
                        closeShortcutModal();
                    }
                });
            }
            
            // マウス/タッチでのドラッグ操作
            if (imageViewport) {
                imageViewport.addEventListener('mousedown', startDrag);
                imageViewport.addEventListener('touchstart', startDrag, { passive: false });
                
                // ホイールでのズーム
                imageViewport.addEventListener('wheel', wheelZoom, { passive: false });
            }
            
            // ドラッグイベントはウィンドウに設定（ドラッグ中に要素外に出ても追従するため）
            window.addEventListener('mousemove', drag);
            window.addEventListener('touchmove', drag, { passive: false });
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);
            
            // ウィンドウリサイズ時に画像を再調整
            window.addEventListener('resize', () => {
                if (editorImage && imageViewport && editorImage.complete && editorImage.style.display !== 'none') {
                    viewportWidth = imageViewport.clientWidth;
                    viewportHeight = imageViewport.clientHeight;
                    constrainTranslation();
                    updateImageTransform();
                }
            });
            
            // キーボードショートカット
            window.addEventListener('keydown', handleKeyboardShortcuts);
        }
        
        // ------------------------
        // メイン実行部分
        // ------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // DOM要素の初期化
            initializeElements();
            
            // テーマ初期化
            initTheme();
            
            // 機能のセットアップ
            setupTabs();
            setupDocNumberValidation();
            setupCharCounter();
            setupChangeTracking();
            setupEventListeners();
            
            // 認証状態の監視
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user; // ログイン中のユーザー情報を保持
                    
                    // URLからファイルIDを取得
                    const urlParams = new URLSearchParams(window.location.search);
                    currentFileId = urlParams.get('file');
                    
                    if (currentFileId) {
                        loadFileData(currentFileId);
                    } else {
                        if (imageLoading) imageLoading.style.display = 'none';
                        if (imageViewport) {
                            imageViewport.innerHTML = `
                                <div class="image-error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>表示するファイルが指定されていません。資料管理ページから資料を選択してください。</p>
                                </div>
                            `;
                        }
                        showToast('ファイルIDが指定されていません。', 'error', 'エラー');
                    }
                } else {
                    // ログインしていない場合はログインページへリダイレクト
                    window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                }
            });
        });
    </script>
</body>
</html>