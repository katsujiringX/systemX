<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4338ca">
    <title>活字化エディタ | KatsujiRingX</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* documents.html からのスタイルを流用・調整 */
        :root {
            --primary: #4338ca;
            --primary-hover: #3730a3;
            --primary-light: #e0e7ff;
            --secondary: #0ea5e9;
            --secondary-hover: #0284c7;
            --secondary-light: #e0f2fe;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --accent-light: #fff7ed;
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --warning-light: #fffbeb;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;
            --info: #3b82f6;
            --info-hover: #2563eb;
            --info-light: #eff6ff;

            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            --bg-color: var(--gray-50);
            --text-color: var(--gray-800);
            --text-muted: var(--gray-500);
            --border-color: var(--gray-200);

            --header-height: 4rem;
            --transition-normal: 0.3s ease;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            --radius-sm: 0.25rem;
            --radius: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-full: 9999px;
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #2d2a63;

            --bg-color: #0f172a;
            --text-color: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #1f2937;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* ヘッダーとコンテンツを縦に並べる */
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }

        /* ヘッダー */
        .editor-header {
            height: var(--header-height);
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            box-shadow: var(--shadow-sm);
            position: sticky; /* ヘッダーを固定 */
            top: 0;
            z-index: 50;
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }

        [data-theme="dark"] .editor-header {
            background-color: var(--gray-800);
            border-bottom: 1px solid var(--border-color);
        }

        .editor-header .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .editor-header .logo img {
            width: 2rem;
            height: 2rem;
        }

        .editor-header .actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        /* メインコンテンツエリア */
        .editor-container {
            display: flex;
            flex: 1; /* 残りの高さをすべて使う */
            overflow: hidden; /* スクロールをコンテナ内で制御 */
            padding: 1.5rem;
            gap: 1.5rem;
        }

        /* 左側: 画像表示エリア */
        .image-pane {
            flex: 1; /* 幅を可変にする */
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* 画像が大きい場合にスクロール可能に */
            padding: 1rem;
            transition: background-color var(--transition-normal);
            position: relative; /* ローディング表示のため */
            min-width: 300px; /* 最小幅 */
        }

        [data-theme="dark"] .image-pane {
            background-color: var(--gray-800);
        }

        .image-pane img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* アスペクト比を保つ */
            display: block;
        }

        .image-pane .loading-spinner { /* ローディングスピナー */
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute; /* 中央に配置 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        [data-theme="dark"] .image-pane .loading-spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }


        /* 右側: テキスト・メタデータエリア */
        .text-pane {
            flex: 1; /* 幅を可変にする */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden; /* スクロールを内部で制御 */
            min-width: 300px; /* 最小幅 */
        }

        .metadata-form, .text-editor {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            transition: background-color var(--transition-normal);
        }

        [data-theme="dark"] .metadata-form,
        [data-theme="dark"] .text-editor {
            background-color: var(--gray-800);
        }

        /* メタデータフォーム */
        .metadata-form h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .metadata-form .form-group {
            margin-bottom: 0.75rem;
        }

        .metadata-form .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            font-size: 0.8125rem;
        }

        .metadata-form .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-color); /* 背景色を少し変える */
            color: var(--text-color);
            font-size: 0.875rem;
            transition: border-color var(--transition-normal), background-color var(--transition-normal);
        }

        .metadata-form .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white; /* フォーカス時に白く */
        }

        [data-theme="dark"] .metadata-form .form-control {
            background-color: var(--gray-700);
            border-color: var(--gray-600);
        }
        [data-theme="dark"] .metadata-form .form-control:focus {
             background-color: var(--gray-800);
             border-color: var(--primary);
        }


        /* 縦書きテキストエディタ */
        .text-editor {
            flex: 1; /* 残りの高さをすべて使う */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* スクロールをtextareaで制御 */
        }

        .text-editor h2 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .text-editor textarea {
            flex: 1; /* 高さをコンテナに合わせる */
            width: 100%;
            height: 100%; /* 重要 */
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem; /* 少し大きめに */
            font-family: 'Noto Serif JP', serif; /* 明朝体 */
            line-height: 1.8;
            writing-mode: vertical-rl; /* 縦書き（右から左へ） */
            text-orientation: upright; /* 文字を正立 */
            resize: none; /* リサイズ不可 */
            overflow-x: auto; /* 横スクロールを有効に */
            white-space: pre; /* 改行やスペースを保持 */
            transition: border-color var(--transition-normal), background-color var(--transition-normal);
            min-height: 200px; /* 最小高さ */
        }

        .text-editor textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
        }

        [data-theme="dark"] .text-editor textarea {
            background-color: var(--gray-700);
            border-color: var(--gray-600);
        }
        [data-theme="dark"] .text-editor textarea:focus {
            background-color: var(--gray-800);
            border-color: var(--primary);
        }


        /* ボタンスタイル */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: background-color var(--transition-normal), color var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            border: none;
            line-height: 1.5;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

         .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background-color: var(--primary-light);
        }
        [data-theme="dark"] .btn-outline:hover {
             background-color: rgba(99, 102, 241, 0.1);
             color: var(--primary);
        }


        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column; /* 縦並びにする */
                padding: 1rem;
                gap: 1rem;
            }
            .image-pane, .text-pane {
                 min-width: unset; /* 最小幅解除 */
                 height: auto; /* 高さを自動に */
            }
            .image-pane {
                max-height: 50vh; /* 画像エリアの高さを制限 */
            }
            .text-editor textarea {
                min-height: 300px; /* モバイルでの最小高さを確保 */
            }
            .editor-header .actions {
                 /* 必要に応じて調整 */
            }
        }

        /* トースト通知コンテナ (documents.htmlから流用) */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
         /* トースト (documents.htmlから流用) */
        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            background-color: white;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            animation: slideIn 0.3s forwards, slideOut 0.3s forwards 4.7s; /* 表示時間を少し長く */
        }

        [data-theme="dark"] .toast {
            background-color: var(--gray-800);
        }

        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%); } }

        .toast-icon { margin-right: 0.75rem; font-size: 1.25rem; }
        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--danger); }
        .toast-warning .toast-icon { color: var(--warning); }
        .toast-info .toast-icon { color: var(--info); }
    </style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <header class="editor-header">
        <a href="mainpage.html" class="logo">
            <img src="katsujiRingX.png" alt="KatsujiRingX Logo">
            <span>KatsujiRingX エディタ</span>
        </a>
        <div class="actions">
             <button id="back-to-documents" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> 資料管理へ戻る
            </button>
            <button id="save-button" class="btn btn-primary">
                <i class="fas fa-save"></i> 保存
            </button>
            <button id="theme-toggle-editor" class="btn btn-outline">
                 <i class="fas fa-moon"></i> <span class="theme-label">ダークモード</span>
            </button>
        </div>
    </header>

    <div class="editor-container">
        <div class="image-pane" id="image-pane">
            <div class="loading-spinner" id="image-loading"></div>
            <img id="editor-image" src="" alt="活字化対象画像" style="display: none;">
        </div>

        <div class="text-pane">
            <div class="metadata-form">
                <h2>資料情報</h2>
                <div class="form-group">
                    <label for="metadata-doc-number" class="form-label">資料番号</label>
                    <input type="text" id="metadata-doc-number" class="form-control" placeholder="例: 12345 (半角数字)">
                </div>
                <div class="form-group">
                    <label for="metadata-doc-name" class="form-label">資料名</label>
                    <input type="text" id="metadata-doc-name" class="form-control" placeholder="資料名を入力">
                </div>
                <div class="form-group">
                    <label for="metadata-era" class="form-label">年代</label>
                    <input type="text" id="metadata-era" class="form-control" placeholder="例: 明治時代, 1900年代">
                </div>
                <div class="form-group">
                    <label for="metadata-source" class="form-label">所蔵</label>
                    <input type="text" id="metadata-source" class="form-control" placeholder="所蔵機関名などを入力">
                </div>
                </div>

            <div class="text-editor">
                <h2>活字化テキスト (縦書き)</h2>
                <textarea id="vertical-text" placeholder="ここに活字化したテキストを入力します..."></textarea>
            </div>
        </div>
    </div>

     <div class="toast-container" id="toast-container"></div>

    <script>
        // Firebase設定 (documents.html と同じもの)
        const firebaseConfig = {
           apiKey: "AIzaSyD_K9J5W_AgEAHTHtjSXEwjbby9H0H8ak4",
           authDomain: "katsujiringx.firebaseapp.com",
           projectId: "katsujiringx",
           storageBucket: "katsujiringx.firebasestorage.app",
           messagingSenderId: "831784731743",
           appId: "1:831784731743:web:bfe3f8ec2344dedf2f07ea",
           measurementId: "G-LPCRE3WYZR"
        };

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Firebaseサービスへの参照
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM要素
        const imagePane = document.getElementById('image-pane');
        const editorImage = document.getElementById('editor-image');
        const imageLoading = document.getElementById('image-loading');
        const verticalText = document.getElementById('vertical-text');
        const docNumberInput = document.getElementById('metadata-doc-number');
        const docNameInput = document.getElementById('metadata-doc-name');
        const eraInput = document.getElementById('metadata-era');
        const sourceInput = document.getElementById('metadata-source');
        const saveButton = document.getElementById('save-button');
        const backButton = document.getElementById('back-to-documents');
        const themeToggleButton = document.getElementById('theme-toggle-editor');
        const toastContainer = document.getElementById('toast-container');

        let currentFileId = null;
        let currentFile = null;
        let currentUser = null;

         // トースト通知表示 (documents.htmlから流用)
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = '';
            switch (type) {
                case 'success': icon = '<i class="fas fa-check-circle toast-icon"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-circle toast-icon"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>'; break;
                default: icon = '<i class="fas fa-info-circle toast-icon"></i>';
            }

            toast.innerHTML = `${icon}<div>${message}</div>`;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // 資料番号の半角数字制限
        if (docNumberInput) {
            docNumberInput.addEventListener('input', (event) => {
                // 入力値から半角数字以外を除去
                const sanitizedValue = event.target.value.replace(/[^0-9]/g, '');
                if (event.target.value !== sanitizedValue) {
                    event.target.value = sanitizedValue;
                    // 必要であればユーザーに通知
                    // showToast('資料番号は半角数字で入力してください。', 'warning');
                }
            });
        }

        // ファイルデータを読み込む関数
        async function loadFileData(fileId) {
            imageLoading.style.display = 'block'; // ローディング表示開始
            editorImage.style.display = 'none';
            try {
                const fileDoc = await db.collection('files').doc(fileId).get();
                if (fileDoc.exists) {
                    currentFile = { id: fileDoc.id, ...fileDoc.data() };

                    if (currentFile.url && currentFile.fileType === 'image') {
                        editorImage.src = currentFile.url;
                        editorImage.alt = currentFile.name;
                        editorImage.onload = () => { // 画像読み込み完了後
                             imageLoading.style.display = 'none';
                             editorImage.style.display = 'block';
                        };
                        editorImage.onerror = () => { // 画像読み込みエラー
                             imageLoading.style.display = 'none';
                             imagePane.innerHTML = '<p style="color: var(--danger);">画像の読み込みに失敗しました。</p>';
                             showToast('画像の読み込みに失敗しました。', 'error');
                        }

                        // メタデータとテキストを読み込む (存在する場合)
                        docNameInput.value = currentFile.name || '';
                        docNumberInput.value = currentFile.metadata?.docNumber || '';
                        eraInput.value = currentFile.metadata?.era || '';
                        sourceInput.value = currentFile.metadata?.source || '';
                        verticalText.value = currentFile.transcribedText || '';

                    } else {
                        imageLoading.style.display = 'none';
                        imagePane.innerHTML = '<p>画像ファイルが見つからないか、画像タイプではありません。</p>';
                        showToast('有効な画像ファイルではありません。', 'warning');
                        // 必要なら資料管理ページへリダイレクトなど
                    }
                } else {
                     imageLoading.style.display = 'none';
                    imagePane.innerHTML = '<p>ファイルが見つかりません。</p>';
                     showToast('指定されたファイルが見つかりません。', 'error');
                }
            } catch (error) {
                 imageLoading.style.display = 'none';
                console.error("ファイルデータ読み込みエラー:", error);
                 imagePane.innerHTML = '<p>ファイルの読み込み中にエラーが発生しました。</p>';
                showToast('ファイルの読み込みに失敗しました。', 'error');
            }
        }

       // 保存処理
        async function saveData() {
            if (!currentFileId || !currentUser) {
                showToast('保存に必要な情報がありません。', 'error');
                return;
            }

            // 保存するデータ
            const dataToSave = {
                transcribedText: verticalText.value,
                metadata: {
                    docNumber: docNumberInput.value,
                    era: eraInput.value,
                    source: sourceInput.value,
                    // 必要に応じて他のメタデータを追加
                },
                // 資料名も更新する場合
                name: docNameInput.value || currentFile.originalName || '名称未設定',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                 lastEditorId: currentUser.uid, // 最終編集者ID
                 lastEditorName: currentUser.displayName || '不明なユーザー' // 最終編集者名
            };

             saveButton.disabled = true; // 保存中はボタンを無効化
             saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 保存中...';


            try {
                await db.collection('files').doc(currentFileId).update(dataToSave);
                showToast('保存しました。', 'success');
                // 保存成功後、currentFileの内容も更新（任意）
                currentFile = { ...currentFile, ...dataToSave };
                // 資料名が変更された場合、タイトルも更新（任意）
                if (currentFile.name) {
                     document.title = `編集: ${currentFile.name} | KatsujiRingX`;
                }

            } catch (error) {
                console.error("保存エラー:", error);
                showToast('保存に失敗しました。', 'error');
            } finally {
                 saveButton.disabled = false; // ボタンを再度有効化
                 saveButton.innerHTML = '<i class="fas fa-save"></i> 保存';
            }
        }

        // テーマ切替 (documents.htmlから流用・調整)
        function initThemeEditor() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        function toggleThemeEditor() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
             updateThemeButton(newTheme);
        }

         function updateThemeButton(theme){
             if (themeToggleButton) {
                 const icon = themeToggleButton.querySelector('i');
                 const label = themeToggleButton.querySelector('.theme-label');
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                     if(label) label.textContent = 'ライトモード';
                } else {
                     icon.className = 'fas fa-moon';
                     if(label) label.textContent = 'ダークモード';
                }
            }
         }

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
             initThemeEditor(); // テーマ初期化

            // 認証状態の監視
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user; // ログイン中のユーザー情報を保持

                    // URLからファイルIDを取得
                    const urlParams = new URLSearchParams(window.location.search);
                    currentFileId = urlParams.get('file');

                    if (currentFileId) {
                        loadFileData(currentFileId);
                    } else {
                         imageLoading.style.display = 'none';
                        imagePane.innerHTML = '<p>表示するファイルが指定されていません。</p>';
                         showToast('ファイルIDが指定されていません。', 'error');
                    }
                } else {
                    // ログインしていない場合はログインページへリダイレクト
                    window.location.href = 'login.html';
                }
            });

            // 保存ボタンのイベントリスナー
            if (saveButton) {
                saveButton.addEventListener('click', saveData);
            }

            // 戻るボタンのイベントリスナー
            if (backButton) {
                backButton.addEventListener('click', () => {
                    // 変更が未保存の場合、確認ダイアログを出すなどの処理を追加可能
                    window.location.href = 'documents.html'; // 資料管理ページへ
                });
            }

             // テーマ切替ボタン
             if (themeToggleButton) {
                 themeToggleButton.addEventListener('click', toggleThemeEditor);
             }
        });

    </script>
</body>
</html>